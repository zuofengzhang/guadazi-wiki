<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Guadazi">
<meta property="og:url" content="http://example.com/page/21/index.html">
<meta property="og:site_name" content="Guadazi">
<meta property="og:locale">
<meta property="article:author" content="aaronzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/21/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>Guadazi</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Guadazi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/memory/" class="post-title-link" itemprop="url">Java内存管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-03-04 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-04T00:00:00+08:00">2016-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java内存管理原理"><a href="#Java内存管理原理" class="headerlink" title="Java内存管理原理"></a>Java内存管理原理</h1><p>在Java运行体系结构中，存在Java程序、虚拟机和操作系统三个层次，Java程序与虚拟机交互(即<a href="/java-jni/" title="JNI：Java native interface ">JNI</a>)，虚拟机与操作系统间交互！这就保证了Java程序的平台无关性。</p>
<p>程序运行前，JVM向操作系统申请一定的内存空间，称为初始内存空间。</p>
<p>程序运行过程中，Java程序一直向Java虚拟机申请内存，当超过初始内存空间时，Java虚拟机再次向操作系统申请。当虚拟机已申请的内存超过规定的最大内存空间再申请时，将会出现内存溢出错误。</p>
<h1 id="内存的分配"><a href="#内存的分配" class="headerlink" title="内存的分配"></a>内存的分配</h1><p>Java内存可以分为方法区、heap(堆)和stack(栈)。</p>
<ul>
<li>方法区，默认64M，Java虚拟机会将加载的类存入，保存类的结构，静态成员等。</li>
<li>heap(堆)，默认64M，存放对象持有的数据，<strong>保持对原类的引用</strong> 。对象的属性值保存在堆中，对象调用的方法保存在方法区。通过<code>new</code>创建的对象都在堆中。方法中的局部变量使用final修饰后，放在堆中。</li>
<li>stack(栈), 默认为1M。</li>
<li>基础类型保存在栈中</li>
<li>局部变量保存在栈中<br>程序进入一个方法时，会为这个方法单独分配一块私属存储空间，用于存储这个方法内部的局部变量，当这个方法结束时，分配给这个方法的栈会释放，这个栈中的变量也将随之释放。</li>
</ul>
<h2 id="在堆上分配内存与赋值异步性"><a href="#在堆上分配内存与赋值异步性" class="headerlink" title="在堆上分配内存与赋值异步性"></a>在堆上分配内存与赋值异步性</h2><p>在Java的指令中，创建对象和赋值操作是分开进行的，如<code>instance=new Singleton();</code>语句是分为两步进行的，但是JVM并不保证这两个操作的先后顺序，也就是有可能JVM会为Singleton实例分配空间， 然后直接赋值给 <code>instance</code>成员，然后再去初始化这个Singleton实例。这样就可能出错了，我们以A、B两个线程为例：</p>
<ol>
<li>A、B线程同时进入了第一个if判断</li>
<li>A首先进入synchronized块，由于instance为null，所以它执行instance = new Singleton();</li>
<li>由于JVM内部的优化机制，JVM先画出了一些分配给Singleton实例的空白内存，并赋值给instance成员（注意此时JVM没有开始初始化这个实例），然后A离开了synchronized块。</li>
<li>B进入synchronized块，由于instance此时不是null，因此它马上离开了synchronized块并将结果返回给调用该方法的程序。</li>
<li>此时B线程打算使用Singleton实例，却发现它没有被初始化，于是错误发生了。</li>
</ol>
<h2 id="基础类型"><a href="#基础类型" class="headerlink" title="基础类型"></a>基础类型</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a=<span class="number">3</span>;</span><br><span class="line"><span class="keyword">int</span> b=<span class="number">3</span>;</span><br><span class="line">a=<span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>编译器先处理<code>int a=3;</code>:<br>首先，在栈中创建一个变量为a的引用，然后查找有没有字面量为3的地址。没有，则开辟一个存放3这个字面量的地址，然后将a指向这个地址。</p>
</li>
<li><p>再处理<code>int b=3;</code>:<br>首先创建一个变量为b的引用，然后查找发现已经存在字面量为3的地址，将b指向这个地址。</p>
</li>
<li><p>如果此时，再<code>a=4;</code>:<br>那么，虚拟机存在是否存在4这个字面量，如果存在，直接将a指向这个地址；否则，创建4这个字面量，将a指向这个字面量的地址。</p>
</li>
</ul>
<p>因此改变了a的值，只是a重新指向别的地方，不会影响b的值。</p>
<h2 id="对象存储"><a href="#对象存储" class="headerlink" title="对象存储"></a>对象存储</h2><blockquote>
<p>方法的存储</p>
</blockquote>
<p>定义如下类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoxSet</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> width=<span class="number">100</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> hight=<span class="number">200</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BoxSet</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.width=x;</span><br><span class="line">    <span class="keyword">this</span>.hight=y;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BoxSet boxSet; <span class="comment">// (1)</span></span><br><span class="line">boxSet=<span class="keyword">new</span> BoxSet(<span class="number">50</span>,<span class="number">50</span>); <span class="comment">// (2)</span></span><br></pre></td></tr></table></figure>
<p>两条语句:</p>
<ol>
<li>声明变量boxSet：</li>
</ol>
<ul>
<li>在栈内存中，为对象的引用变量<code>boxSet</code>分配内存空间。但是<code>boxSet</code>的值为空，称<code>boxSet</code>为一个空对象。空对象不能使用，因为它没有引用任何“实体”。</li>
</ul>
<ol start="2">
<li>会做两件事：</li>
</ol>
<ul>
<li>在堆内存中，为类的成员变量<code>width</code>和<code>hight</code>分配内存，并赋值为各数据类型的默认值。</li>
<li>显式初始化: 类定义时的初始化值，即<code>width</code>赋值为100，<code>hight</code>赋值为200</li>
<li>调用构造方法: 为<code>width</code>和<code>hight</code>分别赋值为50和50</li>
<li>返回堆内存中对象的引用给引用变量<code>boxSet</code></li>
</ul>
<h2 id="方法存储"><a href="#方法存储" class="headerlink" title="方法存储"></a>方法存储</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">  Collar c;</span><br><span class="line">  String name;</span><br><span class="line"><span class="comment">//1. main()方法位于栈上</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//2. 在栈上创建引用变量d,但Dog对象尚未存在</span></span><br><span class="line">    Dog d;</span><br><span class="line"><span class="comment">//3. 在堆上创建新的Dog对象，并将其赋予d引用变量</span></span><br><span class="line">    d = <span class="keyword">new</span> Dog();</span><br><span class="line"><span class="comment">//4. 将引用变量的一个副本传递给go()方法</span></span><br><span class="line">    d.go(d);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//5. 将go()方法置于栈上，并将dog参数作为局部变量(局部变量位于栈上)</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">go</span><span class="params">(Dog dog)</span></span>&#123;</span><br><span class="line"><span class="comment">//6. 在堆上创建新的Collar对象，并将其赋予Dog的实例变量</span></span><br><span class="line">    c =<span class="keyword">new</span> Collar();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//7.将setName()添加到栈上，并将dogName参数作为其局部变量</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setName</span><span class="params">(String dogName)</span></span>&#123;</span><br><span class="line"><span class="comment">//8. name的实例对象也引用String对象</span></span><br><span class="line">    name=dogName;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//9. 程序执行完成后，setName()将会完成并从栈中清除，</span></span><br><span class="line"><span class="comment">//此时，局部变量dogName也会消失，尽管它所引用的String仍在堆上</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="包装类"><a href="#包装类" class="headerlink" title="包装类"></a>包装类</h2><blockquote>
<p>2.String StringBuffered 与 StringBuilder 区别</p>
</blockquote>
<p>Java中的基本变量都存在包装类，如下表：</p>
<table>
<thead>
<tr>
<th>0</th>
<th>基本变量</th>
<th>包装类</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>int</td>
<td>Integer</td>
</tr>
<tr>
<td>2</td>
<td>long</td>
<td>Long</td>
</tr>
<tr>
<td>3</td>
<td>short</td>
<td>Short</td>
</tr>
<tr>
<td>4</td>
<td>float</td>
<td>Float</td>
</tr>
<tr>
<td>5</td>
<td>double</td>
<td>Double</td>
</tr>
<tr>
<td>6</td>
<td>boolean</td>
<td>Boolean</td>
</tr>
<tr>
<td>7</td>
<td>byte</td>
<td>Byte</td>
</tr>
<tr>
<td>8</td>
<td>char</td>
<td>Character</td>
</tr>
</tbody></table>
<h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s=<span class="string">&quot;abc&quot;</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>在栈内存中为对象的引用变量<code>s</code>分配内存</li>
<li>查找字面量<code>&quot;abc&quot;</code>，如果存在则将该地址赋值给s; 否则，新建字面量<code>&quot;abc&quot;</code>并将赋值给s。</li>
</ol>
<p>继续看下面的例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s=<span class="keyword">new</span> String(<span class="string">&quot;abc&quot;</span>); <span class="comment">//(2)</span></span><br></pre></td></tr></table></figure>
<p>方式2:</p>
<ol>
<li>在栈内存中为对象的引用变量<code>s</code>分配内存</li>
<li>在堆中新建String对象，并将地址赋值给栈中的s</li>
<li>在栈内存中，查找字面量”abc”, 如果存在则将字面量地址作为参数传递给赋值给栈中s指向的String对象；否则，新建字面量”abc”.<br>因此，在这个过程中共产生了两个对象。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str1 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">String str2 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">System.out.println(str1==str2);   <span class="comment">//true</span></span><br></pre></td></tr></table></figure>
<p>　　注意，我们这里并不用<code>str1.equals(str2)；</code>的方式，因为这将比较两个字符串的值是否相等。<code>==</code>号，根据JDK的说明，只有在两个引用都指向了同一个对象时才返回真值。而我们在这里要看的是，str1与str2是否都指向了同一个对象。<br>结果说明，JVM创建了两个引用str1和str2，但只创建了一个对象，而且两个引用都指向了这个对象。</p>
<p>String可以用<code>String str = new String(&quot;abc&quot;);</code>的形式来创建，也可以用<code>String str = &quot;abc&quot;；</code>的形式来创建，这种表达式是可以的！前者是规范的类的创建过程，即在Java中，一切都是对象，而对象是类的实例，全部通过new()的形式来创建。那为什么在<code>String str = &quot;abc&quot;；</code>中，并没有通过<code>new()</code>来创建实例，是不是违反了上述原则？其实没有。</p>
<p>我们再来更进一步，将以上代码改成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String str1 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">String str2 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">str1 = <span class="string">&quot;bcd&quot;</span>;</span><br><span class="line">System.out.println(str1==str2);   <span class="comment">//false</span></span><br><span class="line">System.out.println(str1 + <span class="string">&quot;,&quot;</span> + str2);   <span class="comment">//bcd, abc</span></span><br></pre></td></tr></table></figure>
<p>　　这就是说，赋值的变化导致了类对象引用的变化，str1指向了另外一个新对象！而str2仍旧指向原来的对象。上例中，当我们将str1的值改为”bcd”时，JVM发现在栈中没有存放该值的地址，便开辟了这个地址，并创建了一个新的对象，其字符串的值指向这个地址。<br>　　事实上，String类被设计成为不可改变(immutable)的类。如果你要改变其值，可以，但JVM在运行时根据新值悄悄创建了一个新对象，然后将这个对象的地址返回给原来类的引用。这个创建过程虽说是完全自动进行的，但它毕竟占用了更多的时间。在对时间要求比较敏感的环境中，会带有一定的不良影响。</p>
<p>　　再修改原来代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">　　String str1 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">　　String str2 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"></span><br><span class="line">　　str1 = <span class="string">&quot;bcd&quot;</span>;</span><br><span class="line"></span><br><span class="line">　　String str3 = str1;</span><br><span class="line">　　System.out.println(str3);   <span class="comment">//bcd</span></span><br><span class="line"></span><br><span class="line">　　String str4 = <span class="string">&quot;bcd&quot;</span>;</span><br><span class="line">　　System.out.println(str1 == str4);   <span class="comment">//true</span></span><br></pre></td></tr></table></figure>
<p>　　str3 这个对象的引用直接指向str1所指向的对象(注意，str3并没有创建新对象)。当str1改完其值后，再创建一个String的引用str4，并指向因str1修改值而创建的新的对象。可以发现，这回str4也没有创建新的对象，从而再次实现栈中数据的共享。</p>
<p>　　我们再接着看以下的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">　　String str1 = <span class="keyword">new</span> String(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">　　String str2 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">　　System.out.println(str1==str2);   <span class="comment">//false</span></span><br></pre></td></tr></table></figure>
<p>　　创建了两个引用。创建了两个对象。两个引用分别指向不同的两个对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">　　String str1 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">　　String str2 = <span class="keyword">new</span> String(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">　　System.out.println(str1==str2);   <span class="comment">//false</span></span><br></pre></td></tr></table></figure>
<p>　　创建了两个引用。创建了两个对象。两个引用分别指向不同的两个对象。</p>
<p>　　以上两段代码说明，<strong>只要是用new()来新建对象的，都会在堆中创建，而且其字符串是单独存值的，即使与栈中的数据相同，也不会与栈中的数据共享。</strong></p>
<p>　　6). <strong>数据类型包装类的值不可修改</strong>。不仅仅是String类的值不可修改，所有的数据类型包装类都不能更改其内部的值。</p>
<h2 id="volatile关键字"><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h2><p>Volatile修饰的成员变量在每次被线程访问时，都强迫从共享内存中重读该成员变量的值。而且，当成员变量发生变化时，强迫线程将变化值回写到共享内存。这样在任何时刻，两个不同的线程总是看到某个成员变量的同一个值。</p>
<p>首先, 应该明白计算机内部都做什么了。比如做了一个i++操作，计算机内部做了三次处理：读取－修改－写入。<br>同样，对于一个long型数据，做了个赋值操作，在32系统下需要经过两步才能完成，先修改低32位，然后修改高32位。<br>假想一下，当将以上的操作放到一个多线程环境下操作时候，有可能出现的问题，是这些步骤执行了一部分，而另外一个线程就已经引用了变量值，这样就导致了读取脏数据的问题。<br>通过这个设想，就不难理解volatile关键字了。</p>
<p>volatile可以用在任何变量前面，但不能用于final变量前面，因为final型的变量是禁止修改的。也不存在线程安全的问题。</p>
<h1 id="内存释放"><a href="#内存释放" class="headerlink" title="内存释放"></a>内存释放</h1><h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>垃圾回收是一种动态存储管理技术，它自动地释放不再被程序引用的对象，按照特定的垃圾收集算法来实现资源自动回收的功能。当一个对象不再被引用的时候，内存回收它占领的空间，以便空间被后来的新对象使用，以免造成内存泄露。</p>
<p>一般是在CPU空闲或空间不足时自动进行垃圾回收，而程序员无法精确控制垃圾回收的时机和顺序等。<br>当没有任何获得线程能访问一个对象时，该对象就符合垃圾回收条件。<br> 垃圾回收器如发现一个对象不能被任何活线程访问时，他将认为该对象符合删除条件，就将其加入回收队列，但不是立即销毁对象，何时销毁并释放内存是无法预知的。垃圾回收不能强制执行，然而Java提供了一些方法（如：System.gc()方法），允许你请求JVM执行垃圾回收，而不是要求，虚拟机会尽其所能满足请求，但是不能保证JVM从内存中删除所有不用的对象。</p>
<h3 id="符合垃圾回收的条件"><a href="#符合垃圾回收的条件" class="headerlink" title="符合垃圾回收的条件"></a>符合垃圾回收的条件</h3><ol>
<li>空引用</li>
<li>重新为引用变量赋值：可以通过设置引用变量引用另一个对象来解除该引用变量与一个对象间的引用关系。</li>
<li>方法内创建的对象：所创建的局部变量仅在该方法的作用期间内存在。一旦该方法返回，在这个方法内创建的对象就符合垃圾收集条件。有一种明显的例外情况，就是方法的返回对象。</li>
<li>隔离引用：这种情况中，被回收的对象仍具有引用，这种情况称作隔离岛。若存在这两个实例，他们互相引用，并且这两个对象的所有其他引用都删除，其他任何线程无法访问这两个对象中的任意一个。也可以符合垃圾回收条件。</li>
</ol>
<h3 id="强制垃圾回收"><a href="#强制垃圾回收" class="headerlink" title="强制垃圾回收"></a>强制垃圾回收</h3><h3 id="finalize"><a href="#finalize" class="headerlink" title="finalize()"></a>finalize()</h3><p>java提供了一种机制，使你能够在对象刚要被垃圾回收之前运行一些代码。这段代码位于名为finalize()的方法内，所有类从Object类继承这个方法。由于不能保证垃圾回收器会删除某个对象。因此放在finalize()中的代码无法保证运行。因此建议不要重写finalize();</p>
<h2 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h2><p>内存泄漏就是存在一些被分配的对象，这些对象有下面两个特点:<br>首先，这些对象是有被引用的，即在有向树形图中，存在树枝通路可以与其相连；<br>其次，这些对象是无用的，即程序以后不会再使用这些对象。<br>如果对象满足这两个条件，这些对象就可以判定为Java中的内存泄漏，这些对象不会被GC所回收，然而它却占用内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Vector v = <span class="keyword">new</span> Vector(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">Object o = <span class="keyword">new</span> Object();  </span><br><span class="line">v.add(o);  </span><br><span class="line">o = <span class="keyword">null</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>//此时，所有的Object对象都没有被释放，因为变量v引用这些对象。   实际上无用，而还被引用的对象，GC就无能为力了(事实上GC认为它还有用)，这一点是导致内存泄漏最重要的原因。</p>
<h1 id="优化编程"><a href="#优化编程" class="headerlink" title="优化编程"></a>优化编程</h1><h2 id="1-不要显式调用System-gc"><a href="#1-不要显式调用System-gc" class="headerlink" title="(1)不要显式调用System.gc()"></a>(1)不要显式调用System.gc()</h2><p>　　此函数建议JVM进行主GC,虽然只是建议而非一定,但很多情况下它会触发主GC,从而增加主GC的频率,也即增加了间歇性停顿的次数。</p>
<h2 id="2-尽量减少临时对象的使用"><a href="#2-尽量减少临时对象的使用" class="headerlink" title="(2)尽量减少临时对象的使用"></a>(2)尽量减少临时对象的使用</h2><p>　　临时对象在跳出函数调用后,会成为垃圾,少用临时变量就相当于减少了垃圾的产生,从而延长了出现上述第二个触发条件出现的时间,减少了主GC的机会。</p>
<h2 id="3-对象不用时最好显式置为Null"><a href="#3-对象不用时最好显式置为Null" class="headerlink" title="(3)对象不用时最好显式置为Null"></a>(3)对象不用时最好显式置为Null</h2><p>　　一般而言,为Null的对象都会被作为垃圾处理,所以将不用的对象显式地设为Null,有利于GC收集器判定垃圾,从而提高了GC的效率。</p>
<h2 id="4-尽量使用StringBuffer-而不用String来累加字符串"><a href="#4-尽量使用StringBuffer-而不用String来累加字符串" class="headerlink" title="(4)尽量使用StringBuffer,而不用String来累加字符串"></a>(4)尽量使用StringBuffer,而不用String来累加字符串</h2><p>   由于String是固定长的字符串对象,累加String对象时,并非在一个String对象中扩增,而是重新创建新的String对象,如Str5=Str1+Str2+Str3+Str4,这条语句执行过程中会产生多个垃圾对象,因为对次作“+”操作时都必须创建新的String对象,但这些过渡对象对系统来说是没有实际意义的,只会增加更多的垃圾。避免这种情况可以改用StringBuffer来累加字符串,因StringBuffer是可变长的,它在原有基础上进行扩增,不会产生中间对象。</p>
<h2 id="5-能用基本类型如Int-Long-就不用Integer-Long对象"><a href="#5-能用基本类型如Int-Long-就不用Integer-Long对象" class="headerlink" title="(5)能用基本类型如Int,Long,就不用Integer,Long对象"></a>(5)能用基本类型如Int,Long,就不用Integer,Long对象</h2><p>　　基本类型变量占用的内存资源比相应对象占用的少得多,如果没有必要,最好使用基本变量。</p>
<h2 id="6-尽量少用静态对象变量"><a href="#6-尽量少用静态对象变量" class="headerlink" title="(6)尽量少用静态对象变量"></a>(6)尽量少用静态对象变量</h2><p>　　静态变量属于全局变量,不会被GC回收,它们会一直占用内存。</p>
<h2 id="7-分散对象创建或删除的时间"><a href="#7-分散对象创建或删除的时间" class="headerlink" title="(7)分散对象创建或删除的时间"></a>(7)分散对象创建或删除的时间</h2><p>　集中在短时间内大量创建新对象,特别是大对象,会导致突然需要大量内存,JVM在面临这种情况时,只能进行主GC,以回收内存或整合内存碎片,从而增加主GC的频率。集中删除对象,道理也是一样的。它使得突然出现了大量的垃圾对象,空闲空间必然减少,从而大大增加了下一次创建新对象时强制主GC的机会。</p>
<hr>
<p>参考文献</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.codeceo.com/article/java-memory-model-volatile.html" title="Java内存模型与volatile关键字">Java内存模型与volatile关键字</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/generic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/generic/" class="post-title-link" itemprop="url">Java基础之泛型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-03-02 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-02T00:00:00+08:00">2016-03-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="普通泛型"><a href="#普通泛型" class="headerlink" title="普通泛型"></a>普通泛型</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>&lt;<span class="title">T</span>&gt;</span>&#123;       <span class="comment">// 此处可以随便写标识符号，T是type的名称参数</span></span><br><span class="line">   <span class="keyword">private</span> T <span class="keyword">var</span> ; <span class="comment">// var的类型由T指定，即：由外部指定</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;  <span class="comment">// 返回值的类型由外部决定</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">var</span> ;</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;  <span class="comment">// 设置的类型也由外部决定</span></span><br><span class="line">       <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo06</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">       Point&lt;String&gt; p = <span class="keyword">new</span> Point&lt;String&gt;() ; <span class="comment">// 里面的var类型为String类型</span></span><br><span class="line">       p.setVar(<span class="string">&quot;it&quot;</span>) ;        <span class="comment">// 设置字符串</span></span><br><span class="line">       System.out.println(p.getVar().length()) ;   <span class="comment">// 取得字符串的长度</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> ----------------------------------------------------------</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notepad</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span>&#123;       <span class="comment">// 此处指定了两个泛型类型</span></span><br><span class="line">     <span class="keyword">private</span> K key ;     <span class="comment">// 此变量的类型由外部决定</span></span><br><span class="line">     <span class="keyword">private</span> V value ;   <span class="comment">// 此变量的类型由外部决定</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> K <span class="title">getKey</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.key ;</span><br><span class="line">     &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.value ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(K key)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.key = key ;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(V value)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.value = value ;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo09</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">         Notepad&lt;String,Integer&gt; t = <span class="keyword">null</span> ;        <span class="comment">// 定义两个泛型类型的对象</span></span><br><span class="line">         t = <span class="keyword">new</span> Notepad&lt;String,Integer&gt;() ;       <span class="comment">// 里面的key为String，value为Integer</span></span><br><span class="line">        t.setKey(<span class="string">&quot;汤姆&quot;</span>) ;        <span class="comment">// 设置第一个内容</span></span><br><span class="line">         t.setValue(<span class="number">20</span>) ;            <span class="comment">// 设置第二个内容</span></span><br><span class="line">         System.out.print(<span class="string">&quot;姓名；&quot;</span> + t.getKey()) ;      <span class="comment">// 取得信息</span></span><br><span class="line">         System.out.print(<span class="string">&quot;，年龄；&quot;</span> + t.getValue()) ;       <span class="comment">// 取得信息</span></span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h1 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T <span class="keyword">var</span> ;     <span class="comment">// 定义泛型变量</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;   <span class="comment">// 直接打印</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span>.toString() ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo14</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Info&lt;String&gt; i = <span class="keyword">new</span> Info&lt;String&gt;() ;       <span class="comment">// 使用String为泛型类型</span></span><br><span class="line">        i.setVar(<span class="string">&quot;it&quot;</span>) ;                            <span class="comment">// 设置内容</span></span><br><span class="line">        fun(i) ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fun</span><span class="params">(Info&lt;?&gt; temp)</span></span>&#123;     <span class="comment">// 可以接收任意的泛型对象</span></span><br><span class="line">        System.out.println(<span class="string">&quot;内容：&quot;</span> + temp) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="受限泛型"><a href="#受限泛型" class="headerlink" title="受限泛型"></a>受限泛型</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">     <span class="keyword">private</span> T <span class="keyword">var</span> ;     <span class="comment">// 定义泛型变量</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;   <span class="comment">// 直接打印</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span>.toString() ;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo17</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Info&lt;Integer&gt; i1 = <span class="keyword">new</span> Info&lt;Integer&gt;() ;        <span class="comment">// 声明Integer的泛型对象</span></span><br><span class="line">         Info&lt;Float&gt; i2 = <span class="keyword">new</span> Info&lt;Float&gt;() ;            <span class="comment">// 声明Float的泛型对象</span></span><br><span class="line">         i1.setVar(<span class="number">30</span>) ;                                 <span class="comment">// 设置整数，自动装箱</span></span><br><span class="line">         i2.setVar(<span class="number">30.1f</span>) ;                              <span class="comment">// 设置小数，自动装箱</span></span><br><span class="line">         fun(i1) ;</span><br><span class="line">        fun(i2) ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fun</span><span class="params">(Info&lt;? extends Number&gt; temp)</span></span>&#123;  <span class="comment">// 只能接收Number及其Number的子类</span></span><br><span class="line">         System.out.print(temp + <span class="string">&quot;、&quot;</span>) ;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">     <span class="keyword">private</span> T <span class="keyword">var</span> ;     <span class="comment">// 定义泛型变量</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;   <span class="comment">// 直接打印</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span>.toString() ;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo21</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Info&lt;String&gt; i1 = <span class="keyword">new</span> Info&lt;String&gt;() ;      <span class="comment">// 声明String的泛型对象</span></span><br><span class="line">         Info&lt;Object&gt; i2 = <span class="keyword">new</span> Info&lt;Object&gt;() ;      <span class="comment">// 声明Object的泛型对象</span></span><br><span class="line">         i1.setVar(<span class="string">&quot;hello&quot;</span>) ;</span><br><span class="line">         i2.setVar(<span class="keyword">new</span> Object()) ;</span><br><span class="line">         fun(i1) ;</span><br><span class="line">        fun(i2) ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fun</span><span class="params">(Info&lt;? <span class="keyword">super</span> String&gt; temp)</span></span>&#123;    <span class="comment">// 只能接收String或Object类型的泛型</span></span><br><span class="line">         System.out.print(temp + <span class="string">&quot;、&quot;</span>) ;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h1 id="泛型无法向上转型"><a href="#泛型无法向上转型" class="headerlink" title="泛型无法向上转型"></a>泛型无法向上转型</h1> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">     <span class="keyword">private</span> T <span class="keyword">var</span> ;     <span class="comment">// 定义泛型变量</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;   <span class="comment">// 直接打印</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span>.toString() ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo23</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Info&lt;String&gt; i1 = <span class="keyword">new</span> Info&lt;String&gt;() ;      <span class="comment">// 泛型类型为String</span></span><br><span class="line">        Info&lt;Object&gt; i2 = <span class="keyword">null</span> ;</span><br><span class="line">        i2 = i1 ;                               <span class="comment">//这句会出错 incompatible types</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="泛型接口"><a href="#泛型接口" class="headerlink" title="泛型接口"></a>泛型接口</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">interface</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;        <span class="comment">// 在接口上定义泛型</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span> </span>; <span class="comment">// 定义抽象方法，抽象方法的返回值就是泛型类型</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InfoImpl</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;   <span class="comment">// 定义泛型接口的子类</span></span><br><span class="line">   <span class="keyword">private</span> T <span class="keyword">var</span> ;             <span class="comment">// 定义属性</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">InfoImpl</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;     <span class="comment">// 通过构造方法设置属性内容</span></span><br><span class="line">       <span class="keyword">this</span>.setVar(<span class="keyword">var</span>) ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo24</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String arsg[])</span></span>&#123;</span><br><span class="line">         Info&lt;String&gt; i = <span class="keyword">null</span>;        <span class="comment">// 声明接口对象</span></span><br><span class="line">         i = <span class="keyword">new</span> InfoImpl&lt;String&gt;(<span class="string">&quot;汤姆&quot;</span>) ;  <span class="comment">// 通过子类实例化对象</span></span><br><span class="line">         System.out.println(<span class="string">&quot;内容：&quot;</span> + i.getVar()) ;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> ----------------------------------------------------------</span><br><span class="line"> <span class="class"><span class="keyword">interface</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;        <span class="comment">// 在接口上定义泛型</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span> </span>; <span class="comment">// 定义抽象方法，抽象方法的返回值就是泛型类型</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">InfoImpl</span> <span class="keyword">implements</span> <span class="title">Info</span>&lt;<span class="title">String</span>&gt;</span>&#123;   <span class="comment">// 定义泛型接口的子类</span></span><br><span class="line">     <span class="keyword">private</span> String <span class="keyword">var</span> ;                <span class="comment">// 定义属性</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">InfoImpl</span><span class="params">(String <span class="keyword">var</span>)</span></span>&#123;        <span class="comment">// 通过构造方法设置属性内容</span></span><br><span class="line">         <span class="keyword">this</span>.setVar(<span class="keyword">var</span>) ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(String <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo25</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String arsg[])</span></span>&#123;</span><br><span class="line">         Info i = <span class="keyword">null</span>;      <span class="comment">// 声明接口对象</span></span><br><span class="line">         i = <span class="keyword">new</span> InfoImpl(<span class="string">&quot;汤姆&quot;</span>) ;    <span class="comment">// 通过子类实例化对象</span></span><br><span class="line">         System.out.println(<span class="string">&quot;内容：&quot;</span> + i.getVar()) ;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<h1 id="泛型方法"><a href="#泛型方法" class="headerlink" title="泛型方法"></a>泛型方法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">fun</span><span class="params">(T t)</span></span>&#123;            <span class="comment">// 可以接收任意类型的数据</span></span><br><span class="line">        <span class="keyword">return</span> t ;                  <span class="comment">// 直接把参数返回</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo26</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Demo d = <span class="keyword">new</span> Demo() ;   <span class="comment">// 实例化Demo对象</span></span><br><span class="line">        String str = d.fun(<span class="string">&quot;汤姆&quot;</span>) ; <span class="comment">//   传递字符串</span></span><br><span class="line">        <span class="keyword">int</span> i = d.fun(<span class="number">30</span>) ;     <span class="comment">// 传递数字，自动装箱</span></span><br><span class="line">        System.out.println(str) ;   <span class="comment">// 输出内容</span></span><br><span class="line">        System.out.println(i) ;     <span class="comment">// 输出内容</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="通过泛型方法返回泛型类型实例"><a href="#通过泛型方法返回泛型类型实例" class="headerlink" title="通过泛型方法返回泛型类型实例"></a>通过泛型方法返回泛型类型实例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Number</span>&gt;</span>&#123; <span class="comment">// 指定上限，只能是数字类型</span></span><br><span class="line">    <span class="keyword">private</span> T <span class="keyword">var</span> ;     <span class="comment">// 此类型由外部决定</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;       <span class="comment">// 覆写Object类中的toString()方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span>.toString() ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo27</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Info&lt;Integer&gt; i = fun(<span class="number">30</span>) ;</span><br><span class="line">        System.out.println(i.getVar()) ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Number&gt; <span class="function">Info&lt;T&gt; <span class="title">fun</span><span class="params">(T param)</span></span>&#123;<span class="comment">//方法中传入或返回的泛型类型由调用方法时所设置的参数类型决定</span></span><br><span class="line">        Info&lt;T&gt; temp = <span class="keyword">new</span> Info&lt;T&gt;() ;      <span class="comment">// 根据传入的数据类型实例化Info</span></span><br><span class="line">        temp.setVar(param) ;        <span class="comment">// 将传递的内容设置到Info对象的var属性之中</span></span><br><span class="line">        <span class="keyword">return</span> temp ;   <span class="comment">// 返回实例化对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="使用泛型统一传入的参数类型"><a href="#使用泛型统一传入的参数类型" class="headerlink" title="使用泛型统一传入的参数类型"></a>使用泛型统一传入的参数类型</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt;</span>&#123;    <span class="comment">// 指定上限，只能是数字类型</span></span><br><span class="line">    <span class="keyword">private</span> T <span class="keyword">var</span> ;     <span class="comment">// 此类型由外部决定</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;       <span class="comment">// 覆写Object类中的toString()方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span>.toString() ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo28</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Info&lt;String&gt; i1 = <span class="keyword">new</span> Info&lt;String&gt;() ;</span><br><span class="line">        Info&lt;String&gt; i2 = <span class="keyword">new</span> Info&lt;String&gt;() ;</span><br><span class="line">        i1.setVar(<span class="string">&quot;HELLO&quot;</span>) ;        <span class="comment">// 设置内容</span></span><br><span class="line">        i2.setVar(<span class="string">&quot;汤姆&quot;</span>) ;       <span class="comment">// 设置内容</span></span><br><span class="line">        add(i1,i2) ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(Info&lt;T&gt; i1,Info&lt;T&gt; i2)</span></span>&#123;</span><br><span class="line">        System.out.println(i1.getVar() + <span class="string">&quot; &quot;</span> + i2.getVar()) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="泛型数组"><a href="#泛型数组" class="headerlink" title="泛型数组"></a>泛型数组</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo30</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Integer i[] = fun1(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>) ;   <span class="comment">// 返回泛型数组</span></span><br><span class="line">        fun2(i) ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T[] fun1(T...arg)&#123;  <span class="comment">// 接收可变参数</span></span><br><span class="line">      <span class="keyword">return</span> arg ;            <span class="comment">// 返回泛型数组</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">fun2</span><span class="params">(T param[])</span></span>&#123;   <span class="comment">// 输出</span></span><br><span class="line">      System.out.print(<span class="string">&quot;接收泛型数组：&quot;</span>) ;</span><br><span class="line">        <span class="keyword">for</span>(T t:param)&#123;</span><br><span class="line">            System.out.print(t + <span class="string">&quot;、&quot;</span>) ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="泛型的嵌套设置"><a href="#泛型的嵌套设置" class="headerlink" title="泛型的嵌套设置"></a>泛型的嵌套设置</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span>&lt;<span class="title">T</span>,<span class="title">V</span>&gt;</span>&#123;      <span class="comment">// 接收两个泛型类型</span></span><br><span class="line">    <span class="keyword">private</span> T <span class="keyword">var</span> ;</span><br><span class="line">    <span class="keyword">private</span> V value ;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Info</span><span class="params">(T <span class="keyword">var</span>,V value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setVar(<span class="keyword">var</span>) ;</span><br><span class="line">        <span class="keyword">this</span>.setValue(value) ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T <span class="keyword">var</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">var</span> = <span class="keyword">var</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(V value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">var</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span>&lt;<span class="title">S</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> S info ;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">(S info)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setInfo(info) ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInfo</span><span class="params">(S info)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.info = info ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> S <span class="title">getInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.info ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsDemo31</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        Demo&lt;Info&lt;String,Integer&gt;&gt; d = <span class="keyword">null</span> ;       <span class="comment">// 将Info作为Demo的泛型类型</span></span><br><span class="line">        Info&lt;String,Integer&gt; i = <span class="keyword">null</span> ;   <span class="comment">// Info指定两个泛型类型</span></span><br><span class="line">        i = <span class="keyword">new</span> Info&lt;String,Integer&gt;(<span class="string">&quot;汤姆&quot;</span>,<span class="number">30</span>) ;    <span class="comment">// 实例化Info对象</span></span><br><span class="line">        d = <span class="keyword">new</span> Demo&lt;Info&lt;String,Integer&gt;&gt;(i) ; <span class="comment">// 在Demo类中设置Info类的对象</span></span><br><span class="line">        System.out.println(<span class="string">&quot;内容一：&quot;</span> + d.getInfo().getVar()) ;</span><br><span class="line">        System.out.println(<span class="string">&quot;内容二：&quot;</span> + d.getInfo().getValue()) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 泛型方法不一定要通过参数来确定泛型准确类型，可以只通过返回值，比如：<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; <span class="function">ArrayList&lt;E&gt; <span class="title">newArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;E&gt;();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;PrepaidHistory&gt; <span class="title">queryHistories</span><span class="params">(Long skyid,PrepaidHistoryType type, Date from, Date end)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">　　　　。。。</span><br><span class="line">            <span class="keyword">return</span> Lists.newArrayList();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><br>这样<code>Lists.newArrayList()</code>;<br>智能的知道返回类型为<code>PrepaidHistory</code></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>//TODO 继承泛型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextFile</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">String</span>&gt;</span>&#123;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/network/base/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/network/base/" class="post-title-link" itemprop="url">计算机网络基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-02-02 00:00:00" itemprop="dateCreated datePublished" datetime="2016-02-02T00:00:00+08:00">2016-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="OSI七层模型-amp-常见五层模型"><a href="#OSI七层模型-amp-常见五层模型" class="headerlink" title="OSI七层模型 &amp; 常见五层模型"></a>OSI七层模型 &amp; 常见五层模型</h1><p>OSI（Open System Interconnection, 开放系统互连）七层网络模型称为开放式系统互联参考模型 , 是一个逻辑上的定义, 一个规范, 它把网络从逻辑上分为了7层. 每一层都有相关、相对应的物理设备, 比如路由器(网络层), 交换机(数据链路层). OSI 七层模型是一种框架性的设计方法 , 建立七层模型的主要目的是为解决异种网络互连时所遇到的兼容性问题, 其最主要的功能就是帮助不同类型的主机实现数据传输. 它的最大优点是将服务、接口和协议这三个概念明确地区分开来, 通过七个层次化的结构模型使不同的系统不同的网络之间实现可靠的通讯. </p>
<p><img src="/images/network/7.jpg"></p>
<table>
<thead>
<tr>
<th>应用层</th>
</tr>
</thead>
<tbody><tr>
<td>表示层</td>
</tr>
<tr>
<td>会话层</td>
</tr>
<tr>
<td>传输层：TCP/UDP</td>
</tr>
<tr>
<td>网络层: IP/ICMP</td>
</tr>
<tr>
<td>数据链路层: ARP/HDLC/PPP/SLIP</td>
</tr>
<tr>
<td>物理层</td>
</tr>
</tbody></table>
<p>图1 OSI七层模型</p>
<p>目前较为常用的5层模型, 模型分层如图2.</p>
<p><img src="/images/network/5.png"></p>
<table>
<thead>
<tr>
<th>应用层</th>
</tr>
</thead>
<tbody><tr>
<td>传输层</td>
</tr>
<tr>
<td>网络层</td>
</tr>
<tr>
<td>数据链路层</td>
</tr>
<tr>
<td>物理层</td>
</tr>
</tbody></table>
<h1 id="分层的好处"><a href="#分层的好处" class="headerlink" title="分层的好处"></a>分层的好处</h1><p>建立七层模型的主要目的是为解决异种网络互连时所遇到的兼容性问题. 它的最大优点是将服务、接口和协议这三个概念明确地区分开来：服务说明某一层为上一层提供一些什么功能, 接口说明上一层如何使用下层的服务, 而协议涉及如何实现本层的服务；这样各层之间具有很强的独立性, 互连网络中各实体采用什么样的协议是没有限制的, 只要向上提供相同的服务并且不改变相邻层的接口就可以了. 网络七层的划分也是为了使网络的不同功能模块（不同层次）分担起不同的职责, 从而带来如下好处：</p>
<ul>
<li>减轻问题的复杂程度, 一旦网络发生故障, 可迅速定位故障所处层次, 便于查找和纠错；</li>
<li>在各层分别定义标准接口, 使具备相同对等层的不同网络设备能实现互操作, 各层之间则相对独立, 一种高层协议可放在多种低层协议上运行；</li>
<li>能有效刺激网络技术革新, 因为每次更新都可以在小范围内进行, 不需对整个网络动大手术</li>
</ul>
<h1 id="各层功能说明"><a href="#各层功能说明" class="headerlink" title="各层功能说明"></a>各层功能说明</h1><ol>
<li><p>物理层</p>
<p>OSI 模型的最低层或第一层, 该层包括物理连网媒介, 如电缆连线连接器. 物理层的协议产生并检测电压以便发送和接收携带数据的信号. 在你的桌面PC 上插入网络接口卡, 你就建立了计算机连网的基础. 换言之, 你提供了一个物理层. 尽管物理层不提供纠错服务, 但它能够设定数据传输速率并监测数据出错率. 网络物理问题, 如电线断开, 将影响物理层. </p>
<p>用户要传递信息就要利用一些物理媒体, 如双绞线、同轴电缆等, 但具体的物理媒体并不在OSI的7层之内, 有人把物理媒体当做第0层, 物理层的任务就是为它的上一层提供一个物理连接, 以及它们的机械、电气、功能和过程特性. 如规定使用电缆和接头的类型、传送信号的电压等. 在这一层, 数据还没有被组织, 仅作为原始的位流或电气电压处理, 单位是bit比特. </p>
</li>
<li><p>数据链路层</p>
<p>OSI模型的第二层, 它控制网络层与物理层之间的通信. 它的主要功能是如何在不可靠的物理线路上进行数据的可靠传递. 为了保证传输, 从网络层接收到的数据被分割成特定的可被物理层传输的帧. 帧是用来移动数据的结构包, 它不仅包括原始数据, 还包括发送方和接收方的物理地址以及检错和控制信息. 其中的地址确定了帧将发送到何处, 而纠错和控制信息则确保帧无差错到达.  如果在传送数据时, 接收点检测到所传数据中有差错, 就要通知发送方重发这一帧. </p>
<p>数据链路层的功能独立于网络和它的节点和所采用的物理层类型, 它也不关心是否正在运行 Word 、Excel 或使用Internet. 有一些连接设备, 如交换机, 由于它们要对帧解码并使用帧信息将数据发送到正确的接收方, 所以它们是工作在数据链路层的. </p>
<p>在物理层提供比特流服务的基础上, 建立相邻结点之间的数据链路, 通过差错控制提供数据帧（Frame）在信道上无差错的传输, 并进行各电路上的动作系列. </p>
<p>数据链路层在不可靠的物理介质上提供可靠的传输. 该层的作用包括：物理地址寻址、数据的成帧、流量控制、数据的检错、重发等. </p>
<p>数据链路层协议的代表包括：SDLC、HDLC、PPP、STP、帧中继等. </p>
</li>
<li><p>网络层</p>
<p>OSI 模型的第三层, 其主要功能是决定如何将数据从发送方路由到接收方. </p>
<p>网络层通过综合考虑发送优先权、网络拥塞程度、服务质量以及可选路由的花费来决定从一个网络中节点A 到另一个网络中节点B 的最佳路径. 由于网络层处理, 并智能指导数据传送, 路由器连接网络各段, 所以路由器属于网络层. 在网络中, “路由”是基于编址方案、使用模式以及可达性来指引数据的发送. </p>
<p>网络层负责在源机器和目标机器之间建立它们所使用的路由. 这一层本身没有任何错误检测和修正机制, 因此, 网络层必须依赖于端端之间的由DLL提供的可靠传输服务. </p>
<p>网络层用于本地LAN网段之上的计算机系统建立通信, 它之所以可以这样做, 是因为它有自己的路由地址结构, 这种结构与第二层机器地址是分开的、独立的. 这种协议称为路由或可路由协议. 路由协议包括IP、Novell公司的IPX以及Apple Talk协议. </p>
<p>网络层是可选的, 它只用于当两个计算机系统处于不同的由路由器分割开的网段这种情况, 或者当通信应用要求某种网络层或传输层提供的服务、特性或者能力时. 例如, 当两台主机处于同一个LAN网段的直接相连这种情况, 它们之间的通信只使用LAN的通信机制就可以了(即OSI 参考模型的一二层). </p>
</li>
<li><p>传输层</p>
<p>传输协议同时进行流量控制或是基于接收方可接收数据的快慢程度规定适当的发送速率. 除此之外, 传输层按照网络能处理的最大尺寸将较长的数据包进行强制分割. 例如, 以太网无法接收大于1500字节的数据包. 发送方节点的传输层将数据分割成较小的数据片, 同时对每一数据片安排一序列号, 以便数据到达接收方节点的传输层时, 能以正确的顺序重组. 该过程即被称为排序. </p>
<p>工作在传输层的一种服务是 TCP/IP 协议套中的TCP （Transport Control Protocol, 传输控制协议）, UPD (User Packet Data, 用户数据报协议), 另一项传输层服务是IPX/SPX协议集的SPX（序列包交换）. </p>
</li>
</ol>
<h1 id="三次握手与四次挥手"><a href="#三次握手与四次挥手" class="headerlink" title="三次握手与四次挥手"></a>三次握手与四次挥手</h1><p><img src="/images/network/34.png"></p>
<h2 id="三次握手过程："><a href="#三次握手过程：" class="headerlink" title="三次握手过程："></a>三次握手过程：</h2><ul>
<li>第一次握手：host1发送一个TCP标志位SYN=1、ACK=0的数据包给host2, 并随机会产生一个Sequence number=3233.当host2接收到这个数据后, host2由SYN=1可知客户端是想要建立连接；</li>
<li>第二次握手：host2要对客户端的联机请求进行确认, 向host1发送应答号ACK=1、SYN=1、<br>确认号Acknowledge number=3234, 此值是host1的序列号加1, 还会产生一个随机的序列号Sequence number=36457, 这样就告诉host1可以进行连接；</li>
<li>第三次握手：host1收到数据后检查Acknowledge number是否是3233+1的值, 以及ACK的值是否为1, 若为1, host1会发送ACK=1、确认号码Acknowledge number=36457, 告诉host2,你的请求连接被确认, 连接可以建立. </li>
</ul>
<h2 id="四次挥手过程："><a href="#四次挥手过程：" class="headerlink" title="四次挥手过程："></a>四次挥手过程：</h2><ul>
<li>第一次挥手：当传输的数据到达尾部时, host1向host2发送FIN=1标志位；可理解成, host1向host2说, 我这边的数据传送完成了, 我准备断开了连接；</li>
<li>第二次挥手：因TCP的连接是全双工的双向连接, 关闭也是要从两边关闭；当host2收到host1发来的FIN=1的标志位后, host2不会立刻向host1发送FIND=1的请求关闭信息, 而是先向host1发送一个ACK=1的应答信息, 表示：你请求关闭的请求我已经收到, 但我可能还有数据没有完成传送, 你再等下, 等我数据传输完成了我就告诉你；</li>
<li>第三次挥手：host2数据传输完成, 向host1发送FIN=1, host1收到请求关闭连接的请求后, host1就明白host2的数据已传输完成, 现在可以断开连接了, </li>
<li>第四次挥手：host1收到FIND=1后, host1还是怕由于网络不稳定的原因, 怕host2不知道他要断开连接, 于是向host2发送ACK=1确认信息进行确认, 把自己设置成TIME_WAIT状态并启动定时器, 如果host2没有收到ACK, host2端TCP的定时器到达后, 会要求host1重新发送ACK, 当host2收到ACK后, host2就断开连接；当host1等待2MLS（2倍报文最大生存时间）后, 没有收到host2的重传请求后, 他就知道host2已收到了ACK, 所以host1此时才关闭自己的连接. </li>
</ul>
<h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><h2 id="HTTPS的工作原理"><a href="#HTTPS的工作原理" class="headerlink" title="HTTPS的工作原理"></a>HTTPS的工作原理</h2><p>HTTPS在传输数据之前需要客户端(浏览器)与服务端(网站)之间进行一次握手,  在握手过程中将确立双方加密传输数据的密码信息. TLS/SSL协议不仅仅是一套加密传输的协议, 更是一件经过艺术家精心设计的艺术品, TLS/SSL中使用了非对称加密, 对称加密以及HASH算法. 握手过程的具体描述如下：</p>
<ol>
<li>浏览器将自己支持的一套加密规则发送给网站.</li>
<li>网站从中选出一组加密算法与HASH算法, 并将自己的身份信息以证书的形式发回给浏览器. 证书里面包含了网站地址, 加密公钥, 以及证书的颁发机构等信息.</li>
<li>浏览器获得网站证书之后浏览器要做以下工作：</li>
</ol>
<ul>
<li> 验证证书的合法性(颁发证书的机构是否合法, 证书中包含的网站地址是否与正在访问的地址一致等), 如果证书受信任, 则浏览器栏里面会显示一个小锁头, 否则会给出证书不受信的提示.</li>
<li> 如果证书受信任, 或者是用户接受了不受信的证书, 浏览器会生成一串随机数的密码, 并用证书中提供的公钥加密.</li>
<li> 使用约定好的HASH算法计算握手消息, 并使用生成的随机数对消息进行加密, 最后将之前生成的所有信息发送给网站.</li>
</ul>
<ol start="4">
<li>网站接收浏览器发来的数据之后要做以下的操作：</li>
</ol>
<ul>
<li>使用自己的私钥将信息解密取出密码, 使用密码解密浏览器发来的握手消息, 并验证HASH是否与浏览器发来的一致.</li>
<li>使用密码加密一段握手消息, 发送给浏览器.</li>
</ul>
<ol start="5">
<li>浏览器解密并计算握手消息的HASH, 如果与服务端发来的HASH一致, 此时握手过程结束, 之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密.  这里浏览器与网站互相发送加密的握手消息并验证, 目的是为了保证双方都获得了一致的密码, 并且可以正常的加密解密数据, 为后续真正数据的传输做一次测试. 另外, HTTPS一般使用的加密与HASH算法如下：</li>
</ol>
<ul>
<li><p>非对称加密算法：RSA, DSA/DSS</p>
</li>
<li><p>对称加密算法：AES, RC4, 3DES</p>
</li>
<li><p>HASH算法：MD5, SHA1, SHA256 HTTPS对应的通信时序图如下：</p>
<p><img src="/images/network/https-process.png"></p>
</li>
</ul>
<hr>
<p>【参考文献】:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.admin5.com/article/20150525/600230.shtml">HTTPS工作原理和TCP握手机制</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/network/HTTPS/optimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/network/HTTPS/optimization/" class="post-title-link" itemprop="url">【转】基于协议和配置的优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-02-02 00:00:00" itemprop="dateCreated datePublished" datetime="2016-02-02T00:00:00+08:00">2016-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>RTT(Round-Trip Time): 往返时延。表示从发送端发送数据开始，到发送端收到来自接收端的确认（接收端收到数据后便立即发送确认），总共经历的时延。</p>
<h2 id="HTTPS-访问速度优化"><a href="#HTTPS-访问速度优化" class="headerlink" title="HTTPS 访问速度优化"></a>HTTPS 访问速度优化</h2><h3 id="Tcp-fast-open"><a href="#Tcp-fast-open" class="headerlink" title="Tcp fast open"></a>Tcp fast open</h3><p>HTTPS 和 HTTP 使用 TCP 协议进行传输，也就意味着必须通过三次握手建立 TCP 连接，但一个 RTT 的时间内只传输一个 syn 包是不是太浪费？能不能在 syn 包发出的同时捎上应用层的数据？其实是可以的，这也是 tcp fast open 的思路，简称 TFO。具体原理可以参考 rfc7413。</p>
<p>遗憾的是 TFO 需要高版本内核的支持，linux 从 3.7 以后支持 TFO，但是目前的 windows 系统还不支持 TFO，所以只能在公司内部服务器之间发挥作用。</p>
<h3 id="HSTS"><a href="#HSTS" class="headerlink" title="HSTS"></a>HSTS</h3><p>前面提到过将用户 HTTP 请求 302 跳转到 HTTPS，这会有两个影响：</p>
<blockquote>
<p>1、不安全，302 跳转不仅暴露了用户的访问站点，也很容易被中间者支持。</p>
<p>2、降低访问速度，302 跳转不仅需要一个 RTT，浏览器执行跳转也需要执行时间。</p>
</blockquote>
<p>由于 302 跳转事实上是由浏览器触发的，服务器无法完全控制，这个需求导致了 HSTS 的诞生：</p>
<p>HSTS(HTTP Strict Transport Security)。服务端返回一个 HSTS 的 http header，浏览器获取到 HSTS 头部之后，在一段时间内，不管用户输入<a target="_blank" rel="noopener" href="http://www.baidu.com还是http//www.baidu.com%EF%BC%8C%E9%83%BD%E4%BC%9A%E9%BB%98%E8%AE%A4%E5%B0%86%E8%AF%B7%E6%B1%82%E5%86%85%E9%83%A8%E8%B7%B3%E8%BD%AC%E6%88%90https://www.baidu.com%E3%80%82">www.baidu.com还是http://www.baidu.com，都会默认将请求内部跳转成https://www.baidu.com。</a></p>
<p>Chrome, firefox, ie 都支持了 HSTS（<a target="_blank" rel="noopener" href="http://caniuse.com/#feat=stricttransportsecurity%EF%BC%89%E3%80%82">http://caniuse.com/#feat=stricttransportsecurity）。</a></p>
<h3 id="Session-resume"><a href="#Session-resume" class="headerlink" title="Session resume"></a>Session resume</h3><p>Session resume 顾名思义就是复用 session，实现简化握手。复用 session 的好处有两个：</p>
<blockquote>
<p>1、减少了 CPU 消耗，因为不需要进行非对称密钥交换的计算。</p>
<p>2、提升访问速度，不需要进行完全握手阶段二，节省了一个 RTT 和计算耗时。</p>
</blockquote>
<p>TLS 协议目前提供两种机制实现 session resume，分别介绍一下。</p>
<h4 id="Session-cache"><a href="#Session-cache" class="headerlink" title="Session cache"></a>Session cache</h4><p>Session cache 的原理是使用 client hello 中的 session id 查询服务端的 session cache, 如果服务端有对应的缓存，则直接使用已有的 session 信息提前完成握手，称为简化握手。</p>
<p>Session cache 有两个缺点：</p>
<blockquote>
<p>1、需要消耗服务端内存来存储 session 内容。</p>
<p>2、目前的开源软件包括 nginx,apache 只支持单机多进程间共享缓存，不支持多机间分布式缓存，对于百度或者其他大型互联网公司而言，单机 session cache 几乎没有作用。</p>
</blockquote>
<p>Session cache 也有一个非常大的优点：</p>
<blockquote>
<p>session id 是 TLS 协议的标准字段，市面上的浏览器全部都支持 session cache。</p>
</blockquote>
<p>百度通过对 TLS 握手协议及服务器端实现的优化，已经支持全局的 session cache，能够明显提升用户的访问速度，节省服务器计算资源。</p>
<h4 id="Session-ticket"><a href="#Session-ticket" class="headerlink" title="Session ticket"></a>Session ticket</h4><p>上节提到了 session cache 的两个缺点，session ticket 能够弥补这些不足。</p>
<p>Session ticket 的原理参考 RFC4507。简述如下：</p>
<blockquote>
<p>server 将 session 信息加密成 ticket 发送给浏览器，浏览器后续握手请求时会发送 ticket，server 端如果能成功解密和处理 ticket，就能完成简化握手。</p>
</blockquote>
<p>显然，session ticket 的优点是不需要服务端消耗大量资源来存储 session 内容。</p>
<p>Session ticket 的缺点：</p>
<blockquote>
<p>1、session ticket 只是 TLS 协议的一个扩展特性，目前的支持率不是很广泛，只有 60% 左右。</p>
<p>2、session ticket 需要维护一个全局的 key 来加解密，需要考虑 KEY 的安全性和部署效率。</p>
</blockquote>
<p>总体来讲，session ticket 的功能特性明显优于 session cache。希望客户端实现优先支持 session ticket。</p>
<h3 id="OCSP-stapling"><a href="#OCSP-stapling" class="headerlink" title="OCSP stapling"></a>OCSP stapling</h3><p>OCSP 全称在线证书状态检查协议 (rfc6960)，用来向 CA 站点查询证书状态，比如是否撤销。通常情况下，浏览器使用 OCSP 协议发起查询请求，CA 返回证书状态内容，然后浏览器接受证书是否可信的状态。</p>
<p>这个过程非常消耗时间，因为 CA 站点有可能在国外，网络不稳定，RTT 也比较大。那有没有办法不直接向 CA 站点请求 OCSP 内容呢？ocsp stapling 就能实现这个功能。</p>
<p>详细介绍参考 RFC6066 第 8 节。简述原理就是浏览器发起 client hello 时会携带一个 certificate status request 的扩展，服务端看到这个扩展后将 OCSP 内容直接返回给浏览器，完成证书状态检查。</p>
<p>由于浏览器不需要直接向 CA 站点查询证书状态，这个功能对访问速度的提升非常明显。</p>
<p>Nginx 目前已经支持这个 ocsp stapling file，只需要配置 ocsp stapling file 的指令就能开启这个功能：</p>
<blockquote>
<ul>
<li>ssl_stapling on;ssl_stapling_file ocsp.staple;</li>
</ul>
</blockquote>
<h3 id="False-start"><a href="#False-start" class="headerlink" title="False start"></a>False start</h3><p>通常情况下，应用层数据必须等完全握手全部结束之后才能传输。这个其实比较浪费时间，那能不能类似 TFO 一样，在完全握手的第二个阶段将应用数据一起发出来呢？google 提出了 false start 来实现这个功能。详细介绍参考<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/draft-bmoeller-tls-falsestart-00%E3%80%82">https://tools.ietf.org/html/draft-bmoeller-tls-falsestart-00。</a></p>
<p>简单概括 False start 的原理就是在 client_key_exchange 发出时将应用层数据一起发出来，能够节省一个 RTT。</p>
<p>False start 依赖于 PFS（perfect forward secrecy 完美前向加密），而 PFS 又依赖于 DHE 密钥交换系列算法（DHE_RSA, ECDHE_RSA, DHE_DSS, ECDHE_ECDSA），所以尽量优先支持 ECDHE 密钥交换算法实现 false start。</p>
<h3 id="使用-SPDY-或者-HTTP2"><a href="#使用-SPDY-或者-HTTP2" class="headerlink" title="使用 SPDY 或者 HTTP2"></a>使用 SPDY 或者 HTTP2</h3><p>SPDY 是 google 推出的优化 HTTP 传输效率的协议（<a target="_blank" rel="noopener" href="https://www.chromium.org/spdy%EF%BC%89%EF%BC%8C%E5%AE%83%E5%9F%BA%E6%9C%AC%E4%B8%8A%E6%B2%BF%E7%94%A8%E4%BA%86">https://www.chromium.org/spdy），它基本上沿用了</a> HTTP 协议的语义, 但是通过使用帧控制实现了多个特性，显著提升了 HTTP 协议的传输效率。</p>
<p>SPDY 最大的特性就是多路复用，能将多个 HTTP 请求在同一个连接上一起发出去，不像目前的 HTTP 协议一样，只能串行地逐个发送请求。Pipeline 虽然支持多个请求一起发送，但是接收时依然得按照顺序接收，本质上无法解决并发的问题。</p>
<p>HTTP2 是 IETF 2015 年 2 月份通过的 HTTP 下一代协议，它以 SPDY 为原型，经过两年多的讨论和完善最终确定。</p>
<p>本文就不过多介绍 SPDY 和 HTTP2 的收益，需要说明两点：</p>
<blockquote>
<p>1、SPDY 和 HTTP2 目前的实现默认使用 HTTPS 协议。</p>
<p>2、SPDY 和 HTTP2 都支持现有的 HTTP 语义和 API，对 WEB 应用几乎是透明的。</p>
</blockquote>
<p>Google 宣布 chrome 浏览器 2016 年将放弃 SPDY 协议，全面支持 HTTP2，但是目前国内部分浏览器厂商进度非常慢，不仅不支持 HTTP2，连 SPDY 都没有支持过。</p>
<p>百度服务端和百度手机浏览器现在都已经支持 SPDY3.1 协议。</p>
<h2 id="HTTPS-计算性能优化"><a href="#HTTPS-计算性能优化" class="headerlink" title="HTTPS 计算性能优化"></a>HTTPS 计算性能优化</h2><h3 id="优先使用-ECC"><a href="#优先使用-ECC" class="headerlink" title="优先使用 ECC"></a>优先使用 ECC</h3><p>ECC 椭圆加密算术相比普通的离散对数计算速度性能要强很多。下表是 NIST 推荐的密钥长度对照表。</p>
<p><img src="http://upload.chinaz.com/2015/0505/1430805926143.png" alt="HTTPS HTTPS协议 https和http有什么区别 HTTPS证书申请"></p>
<p>表格 2 NIST 推荐使用的密钥长度</p>
<p>对于 RSA 算法来讲，目前至少使用 2048 位以上的密钥长度才能保证安全性。ECC 只需要使用 224 位长度的密钥就能实现 RSA2048 位长度的安全强度。在进行相同的模指数运算时速度显然要快很多。</p>
<h3 id="使用最新版的-openssl"><a href="#使用最新版的-openssl" class="headerlink" title="使用最新版的 openssl"></a>使用最新版的 openssl</h3><p>一般来讲，新版的 openssl 相比老版的计算速度和安全性都会有提升。比如 openssl1.0.2 采用了 intel 最新的优化成果，椭圆曲线 p256 的计算性能提升了 4 倍。(<a target="_blank" rel="noopener" href="https://eprint.iacr.org/2013/816.pdf">https://eprint.iacr.org/2013/816.pdf</a>)</p>
<p>Openssl 2014 年就升级了 5 次，基本都是为了修复实现上的 BUG 或者算法上的漏洞而升级的。所以尽量使用最新版本，避免安全上的风险。</p>
<h3 id="硬件加速方案"><a href="#硬件加速方案" class="headerlink" title="硬件加速方案"></a>硬件加速方案</h3><p>现在比较常用的 TLS 硬件加速方案主要有两种：</p>
<blockquote>
<p>1、SSL 专用加速卡。</p>
<p>2、GPU SSL 加速。</p>
</blockquote>
<p>上述两个方案的主流用法都是将硬件插入到服务器的 PCI 插槽中，由硬件完成最消耗性能的计算。但这样的方案有如下缺点：</p>
<p>1、支持算法有限。比如不支持 ECC，不支持 GCM 等。</p>
<p>2、升级成本高。</p>
<blockquote>
<p>a)  出现新的加密算法或者协议时，硬件加速方案无法及时升级。</p>
<p>b)  出现比较大的安全漏洞时，部分硬件方案在无法在短期内升级解决。比如 2014 年暴露的 heartbleed 漏洞。</p>
</blockquote>
<p>3、无法充分利用硬件加速性能。硬件加速程序一般都运行在内核态，计算结果传递到应用层需要 IO 和内存拷贝开销，即使硬件计算性能非常好，上层的同步等待和 IO 开销也会导致整体性能达不到预期，无法充分利用硬件加速卡的计算能力。</p>
<p>4、维护性差。硬件驱动及应用层 API 大部分是由安全厂家提供，出现问题后还需要厂家跟进。用户无法掌握核心代码，比较被动。不像开源的 openssl，不管算法还是协议，用户都能掌握。</p>
<h3 id="TLS-远程代理计算"><a href="#TLS-远程代理计算" class="headerlink" title="TLS 远程代理计算"></a>TLS 远程代理计算</h3><p>也正是因为上述原因，百度实现了专用的 SSL 硬件加速集群。基本思路是：</p>
<p>1、优化 TLS 协议栈，剥离最消耗 CPU 资源的计算，主要有如下部分：</p>
<blockquote>
<p>a)  RSA 中的加解密计算。</p>
<p>b)  ECC 算法中的公私钥生成。</p>
<p>c)  ECC 算法中的共享密钥生成。</p>
</blockquote>
<p>2、优化硬件计算部分。硬件计算不涉及协议及状态交互，只需要处理大数运算。</p>
<p>3、Web server 到 TLS 计算集群之间的任务是异步的。即 web server 将待计算内容发送给加速集群后，依然可以继续处理其他请求，整个过程是异步非阻塞的。</p>
<h2 id="HTTPS-安全配置"><a href="#HTTPS-安全配置" class="headerlink" title="HTTPS 安全配置"></a>HTTPS 安全配置</h2><h3 id="协议版本选择"><a href="#协议版本选择" class="headerlink" title="协议版本选择"></a>协议版本选择</h3><p>SSL2.0 早就被证明是不安全的协议了，统计发现目前已经没有客户端支持 SSL2.0，所以可以放心地在服务端禁用 SSL2.0 协议。</p>
<p>2014 年爆发了 POODLE 攻击，SSL3.0 因此被证明是不安全的。但是统计发现依然有 0.5% 的流量只支持 SSL3.0。所以只能有选择地支持 SSL3.0。</p>
<p>TLS1.1 及 1.2 目前为止没有发现安全漏洞，建议优先支持。</p>
<h3 id="加密套件选择"><a href="#加密套件选择" class="headerlink" title="加密套件选择"></a>加密套件选择</h3><p>加密套件包含四个部分：</p>
<blockquote>
<p>1、非对称密钥交换算法。建议优先使用 ECDHE，禁用 DHE，次优先选择 RSA。</p>
<p>2、证书签名算法。由于部分浏览器及操作系统不支持 ECDSA 签名，目前默认都是使用 RSA 签名，其中 SHA1 签名已经不再安全，chrome 及微软 2016 年开始不再支持 SHA1 签名的证书 (<a target="_blank" rel="noopener" href="http://googleonlinesecurity.blogspot.jp/2014/09/gradually-sunsetting-sha-1.html)%E3%80%82">http://googleonlinesecurity.blogspot.jp/2014/09/gradually-sunsetting-sha-1.html)。</a></p>
<p>3、对称加解密算法。优先使用 AES-GCM 算法，针对 1.0 以上协议禁用 RC4（ rfc7465）。</p>
<p>4、内容一致性校验算法。Md5 和 sha1 都已经不安全，建议使用 sha2 以上的安全哈希函数。</p>
</blockquote>
<h2 id="HTTPS-防攻击"><a href="#HTTPS-防攻击" class="headerlink" title="HTTPS 防攻击"></a>HTTPS 防攻击</h2><h3 id="防止协议降级攻击"><a href="#防止协议降级攻击" class="headerlink" title="防止协议降级攻击"></a>防止协议降级攻击</h3><p>降级攻击一般包括两种：加密套件降级攻击 (cipher suite rollback) 和协议降级攻击（version roll back）。降级攻击的原理就是攻击者伪造或者修改 client hello 消息，使得客户端和服务器之间使用比较弱的加密套件或者协议完成通信。</p>
<p>为了应对降级攻击，现在 server 端和浏览器之间都实现了 SCSV 功能，原理参考<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00%E3%80%82">https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00。</a></p>
<p>一句话解释就是如果客户端想要降级，必须发送 TLS_SCSV 的信号，服务器如果看到 TLS_SCSV，就不会接受比服务端最高协议版本低的协议。</p>
<h3 id="防止重新协商攻击"><a href="#防止重新协商攻击" class="headerlink" title="防止重新协商攻击"></a>防止重新协商攻击</h3><p>重新协商（tls renegotiation）分为两种：加密套件重协商 (cipher suite renegotiation) 和协议重协商（protocol renegotiation）。</p>
<p>重新协商会有两个隐患：</p>
<blockquote>
<p>1、重协商后使用弱的安全算法。这样的后果就是传输内容很容易泄露。</p>
<p>2、重协商过程中不断发起完全握手请求，触发服务端进行高强度计算并引发服务拒绝。</p>
</blockquote>
<p>对于重协商，最直接的保护手段就是禁止客户端主动重协商，当然出于特殊场景的需求，应该允许服务端主动发起重协商。</p>
<p><strong>结束语</strong></p>
<p>HTTPS 的实践和优化涉及到了非常多的知识点，由于篇幅关系，本文对很多优化策略只是简单介绍了一下. 如果想要了解协议背后的原理，还是需要详细阅读 TLS 协议及 PKI 知识。对于大型站点来说，如果希望做到极致，HTTPS 的部署需要结合产品和基础设施的架构来进行详细的考虑，比起部署支持 HTTPS 的接入和对它的优化，在产品和运维层面上花费的功夫会更多</p>
<hr>
<p>【参考文献】:</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/other/other-family-genealogy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/other/other-family-genealogy/" class="post-title-link" itemprop="url">张氏族谱辈分</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-01-20 00:00:00" itemprop="dateCreated datePublished" datetime="2016-01-20T00:00:00+08:00">2016-01-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/wiki/" itemprop="url" rel="index"><span itemprop="name">wiki</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问我故乡在何处，山西洪洞大槐树"><a href="#问我故乡在何处，山西洪洞大槐树" class="headerlink" title="问我故乡在何处，山西洪洞大槐树"></a>问我故乡在何处，山西洪洞大槐树</h1><p>据多方家谱记载，大约500年前，明朝靖难之役前后，明朝政府征调山西省洪洞县乡民迁往今河北、山东、河南、湖北、江西等地，史称“大槐树移民”。如今大槐树移民的后裔占这几个省的大部分。<br>移民是被明朝政府所迫，背井离乡，骨肉分离，是我们的祖先所经历的辛酸和苦楚。<br>每当本宗族黑白喜事，总要拿出族谱，勾起对祖先的思念和怜惜, 也让自己徐徐感觉到作为传承人的自豪。</p>
<h1 id="张氏族谱辈分"><a href="#张氏族谱辈分" class="headerlink" title="张氏族谱辈分"></a>张氏族谱辈分</h1><table>
<thead>
<tr>
<th>伟</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td>瑾</td>
<td>起</td>
<td>广</td>
</tr>
<tr>
<td>鼐</td>
<td>世</td>
<td>得</td>
<td>士</td>
<td>凤</td>
</tr>
<tr>
<td>国</td>
<td>云</td>
<td>锺</td>
<td>光</td>
<td>亦</td>
</tr>
<tr>
<td>方(思)</td>
<td>玉(欲)</td>
<td>再</td>
<td>显</td>
<td>传</td>
</tr>
<tr>
<td>兴</td>
<td>茂</td>
<td>恒</td>
<td>祚</td>
<td>延</td>
</tr>
<tr>
<td>庆</td>
<td>祥</td>
<td>恩</td>
<td>嘉</td>
<td>澍</td>
</tr>
<tr>
<td>令(零)</td>
<td>儒(罗)</td>
<td>肇(兆)</td>
<td>复(补)</td>
<td>天</td>
</tr>
<tr>
<td>立</td>
<td>志</td>
<td>新</td>
<td>法</td>
<td>邦</td>
</tr>
<tr>
<td>登</td>
<td>殿</td>
<td>瑞</td>
<td>义</td>
<td>祯</td>
</tr>
<tr>
<td>保</td>
<td>善</td>
<td>绪</td>
<td>洪</td>
<td>德</td>
</tr>
<tr>
<td>昌</td>
<td>凡</td>
<td>要</td>
<td>英</td>
<td>先</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/jni/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/jni/" class="post-title-link" itemprop="url">JNI：Java native interface</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-15 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-15T00:00:00+08:00">2015-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="JNI-–-Java-Native-Interface"><a href="#JNI-–-Java-Native-Interface" class="headerlink" title="JNI – Java Native Interface"></a>JNI – Java Native Interface</h2><p>JNI 是 Java 与本地代码通信的桥梁，因此，也是 Java 调用操作系统 API 的接口。<br>因为 jvm 也是采用 C 实现的，通过JNI，可以达到调用 jvm 的目的。</p>
<h2 id="JNI调用过程"><a href="#JNI调用过程" class="headerlink" title="JNI调用过程"></a>JNI调用过程</h2><ol>
<li>当加载 Java 类时，运行静态代码段。 在静态代码段中，调用<code>System.loadLibrary(&quot;&lt;jni_lib_name&gt;&quot;)</code>方法，加载动态库。</li>
<li>Java 自动在库中查找<code>JNI_OnLoad()</code>函数。 <code>JNI_OnLoad()</code>函数主要有两个作用：</li>
</ol>
<ul>
<li>判断 JNI 版本</li>
<li>初始化，如注册函数</li>
</ul>
<ol>
<li>当调用 native 方法时，Java 将去查找注册的函数。有两种注册函数的方法，静态注册和动态注册。</li>
</ol>
<ul>
<li><p>静态注册是指在 C 里面以JNI默认的函数名定义与 java 中对对应的函数</p>
</li>
<li><p>而动态注册是指在调用<code>JNI_OnLoad()</code>函数时，调用<code>(*env)-&gt;RegisterNatives()</code>函数，将方法注册。</p>
<p>当Java去查找注册函数，首先判断是不是存在动态注册函数，如果不存在再查找静态注册函数。<br>如果查找不到，将报出异常。</p>
</li>
</ul>
<ol>
<li>执行C 函数，Java接收返回结果。</li>
</ol>
<h3 id="动态注册"><a href="#动态注册" class="headerlink" title="动态注册"></a>动态注册</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">  System.loadLibrary(<span class="string">&quot;native_native&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">callNativeMethod</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">double</span> y)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod gMethods[] = &#123;          </span><br><span class="line">  &#123;<span class="string">&quot;callNativeMethod&quot;</span>, <span class="string">&quot;(ID)Ljava/lang/String;&quot;</span>,  (<span class="keyword">void</span> *)abc&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//真正的实现方法</span></span><br><span class="line"><span class="function">JNIExport jstring <span class="title">abc</span><span class="params">(JNIEnv *env, jobject obj,jint x,jdouble y)</span></span>&#123;</span><br><span class="line"><span class="comment">//TODO 实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span> </span>&#123;</span><br><span class="line"> JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line"> jint result = <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">//获取JNI环境对象</span></span><br><span class="line"> <span class="comment">//  if(vm-&gt;GetEnv((void**)&amp;env,JNI_VERSION_1_4)!=JNI_OK)&#123; //C++</span></span><br><span class="line"> <span class="keyword">if</span> ((*vm)-&gt;GetEnv(vm,(<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123;<span class="comment">//C</span></span><br><span class="line">     <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//如果要注册, 只需要两步骤, 首先FindClass, 然后RegisterNatives就可以了</span></span><br><span class="line"> <span class="comment">//注册本地方法.Load 目标类</span></span><br><span class="line"> <span class="keyword">char</span> className[<span class="number">20</span>] = &#123;<span class="string">&quot;club/guadazi/wiki/MyFirstActivity&quot;</span>&#125;;</span><br><span class="line"> <span class="comment">// jclass clazz = (env)-&gt;FindClass( (const char*)className);// C++</span></span><br><span class="line"> jclass clazz = (*env)-&gt;FindClass(env,(<span class="keyword">const</span> <span class="keyword">char</span> *)className);<span class="comment">//C</span></span><br><span class="line"> <span class="comment">//注册本地native方法</span></span><br><span class="line"> <span class="keyword">if</span>((*env)-&gt;RegisterNatives(env,clazz, gMethods, <span class="number">1</span>)&lt; <span class="number">0</span>)</span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//一定要返回版本号, 否则会出错.</span></span><br><span class="line"> result = JNI_VERSION_1_4;</span><br><span class="line"> <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="静态注册"><a href="#静态注册" class="headerlink" title="静态注册"></a>静态注册</h3><p>在生成的头文件中会含有静态注册函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JNIExport jstring</span><br><span class="line"> Java_club_guadazi_wiki_MyFirstActivity_callNativeMethod(</span><br><span class="line">   JNIEnv *env, jobject obj,jint x,jdouble y);</span><br></pre></td></tr></table></figure>
<p>写法是Java+Android工程的包名+Android工程的Activity名+方法名,点号用下划线表示，这个写法很严格。 包名：com_conowen_helloworld， Activity名：HelloWorldActivity， 方法名：helloWorldFromJNI</p>
<p>函数名称可以通过<code>javah</code>生成:</p>
<ul>
<li> 编译该java文件成class文件</li>
<li> 利用命令生成h头文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javah MyFirstActivity</span><br></pre></td></tr></table></figure>

<h2 id="java-调用-c"><a href="#java-调用-c" class="headerlink" title="java 调用 c"></a>java 调用 c</h2><p>上面的实现即为 java 调用 C</p>
<h2 id="c-调用-java"><a href="#c-调用-java" class="headerlink" title="c 调用 java"></a>c 调用 java</h2><h3 id="普通函数"><a href="#普通函数" class="headerlink" title="普通函数"></a>普通函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIInstanceVariable</span> </span>&#123;</span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">      <span class="comment">// myjni.dll (Windows) or libmyjni.so (Unixes)</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Instance variables</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">88</span>;</span><br><span class="line">   <span class="keyword">private</span> String message = <span class="string">&quot;Hello from Java&quot;</span>;</span><br><span class="line">   <span class="comment">// Native method that modifies the instance variables</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">modifyInstanceVariable</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">      TestJNIInstanceVariable test = <span class="keyword">new</span> TestJNIInstanceVariable();</span><br><span class="line">      test.modifyInstanceVariable();</span><br><span class="line">      System.out.println(<span class="string">&quot;In Java, int is &quot;</span> + test.number);</span><br><span class="line">      System.out.println(<span class="string">&quot;In Java, String is &quot;</span> + test.message);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIInstanceVariable.h&quot;</span></span></span><br><span class="line"><span class="comment">// jni方法的静态实现</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line"> Java_TestJNIInstanceVariable_modifyInstanceVariable</span><br><span class="line">          (JNIEnv *env, jobject thisObj) &#123;</span><br><span class="line">   <span class="comment">// Get a reference to this object&#x27;s class</span></span><br><span class="line">   jclass thisClass = (*env)-&gt;GetObjectClass(env, thisObj);</span><br><span class="line">   <span class="comment">// int</span></span><br><span class="line">   <span class="comment">// Get the Field ID of the instance variables &quot;number&quot;</span></span><br><span class="line">   jfieldID fidNumber = (*env)-&gt;GetFieldID(env, thisClass, <span class="string">&quot;number&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == fidNumber) <span class="keyword">return</span>;</span><br><span class="line">   <span class="comment">// Get the int given the Field ID</span></span><br><span class="line">   jint number = (*env)-&gt;GetIntField(env, thisObj, fidNumber);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the int is %d\n&quot;</span>, number);</span><br><span class="line">   <span class="comment">// Change the variable</span></span><br><span class="line">   number = <span class="number">99</span>;</span><br><span class="line">   (*env)-&gt;SetIntField(env, thisObj, fidNumber, number);</span><br><span class="line">   <span class="comment">// Get the Field ID of the instance variables &quot;message&quot;</span></span><br><span class="line">   jfieldID fidMessage = (*env)-&gt;GetFieldID(env, thisClass, <span class="string">&quot;message&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == fidMessage) <span class="keyword">return</span>;</span><br><span class="line">   <span class="comment">// String</span></span><br><span class="line">   <span class="comment">// Get the object given the Field ID</span></span><br><span class="line">   jstring message = (*env)-&gt;GetObjectField(env, thisObj, fidMessage);</span><br><span class="line">   <span class="comment">// Create a C-string with the JNI String</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *cStr = (*env)-&gt;GetStringUTFChars(env, message, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == cStr) <span class="keyword">return</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the string is %s\n&quot;</span>, cStr);</span><br><span class="line">   (*env)-&gt;ReleaseStringUTFChars(env, message, cStr);</span><br><span class="line">   <span class="comment">// Create a new C-string and assign to the JNI string</span></span><br><span class="line">   message = (*env)-&gt;NewStringUTF(env, <span class="string">&quot;Hello from C&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == message) <span class="keyword">return</span>;</span><br><span class="line">   <span class="comment">// modify the instance variables</span></span><br><span class="line">   (*env)-&gt;SetObjectField(env, thisObj, fidMessage, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li>c 调用 java 的方法，类似于反射。 首先，需要获得类对象，然后再获取函数 id。<br>再调用get 和 set 函数，操作数据。</li>
<li>如果建立了局部对象， 需要释放空间， 以防数据泄露。</li>
</ol>
<h3 id="访问静态变量和静态函数"><a href="#访问静态变量和静态函数" class="headerlink" title="访问静态变量和静态函数"></a>访问静态变量和静态函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIStaticVariable</span> </span>&#123;</span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      System.loadLibrary(<span class="string">&quot;myjni&quot;</span>); <span class="comment">// nyjni.dll (Windows) or libmyjni.so (Unixes)</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Static variables</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> number = <span class="number">55.66</span>;</span><br><span class="line">   <span class="comment">// Native method that modifies the instance variables</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">modifyStaticVariable</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">      TestJNIStaticVariable test = <span class="keyword">new</span> TestJNIStaticVariable();</span><br><span class="line">      test.modifyStaticVariable();</span><br><span class="line">      System.out.println(<span class="string">&quot;In Java, the double is &quot;</span> + number);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIStaticVariable.h&quot;</span></span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_TestJNIStaticVariable_modifyStaticVariable</span><br><span class="line">          (JNIEnv *env, jobject thisObj) &#123;</span><br><span class="line">   <span class="comment">// Get a reference to this object&#x27;s class</span></span><br><span class="line">   jclass cls = (*env)-&gt;GetObjectClass(env, thisObj);</span><br><span class="line">   <span class="comment">// Read the int static variable and modify its value</span></span><br><span class="line">   jfieldID fidNumber = (*env)-&gt;GetStaticFieldID(env, cls, <span class="string">&quot;number&quot;</span>, <span class="string">&quot;D&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == fidNumber) <span class="keyword">return</span>;</span><br><span class="line">   jdouble number = (*env)-&gt;GetStaticDoubleField(env, thisObj, fidNumber);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the double is %f\n&quot;</span>, number);</span><br><span class="line">   number = <span class="number">77.88</span>;</span><br><span class="line">   (*env)-&gt;SetStaticDoubleField(env, thisObj, fidNumber, number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="调用实例方法和静态方法"><a href="#调用实例方法和静态方法" class="headerlink" title="调用实例方法和静态方法"></a>调用实例方法和静态方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNICallBackMethod</span> </span>&#123;</span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">      <span class="comment">// myjni.dll (Windows) or libmyjni.so (Unixes)</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Native method that calls back the Java methods below</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeMethod</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="comment">// To be called back by the native code</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;In Java&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callback</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;In Java with &quot;</span> + message);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">callbackAverage</span><span class="params">(<span class="keyword">int</span> n1, <span class="keyword">int</span> n2)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ((<span class="keyword">double</span>)n1 + n2) / <span class="number">2.0</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Static method to be called back</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">callbackStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;From static Java method&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">      <span class="keyword">new</span> TestJNICallBackMethod().nativeMethod();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNICallBackMethod.h&quot;</span></span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_TestJNICallBackMethod_nativeMethod</span><br><span class="line">          (JNIEnv *env, jobject thisObj) &#123;</span><br><span class="line">   <span class="comment">// Get a class reference for this object</span></span><br><span class="line">   jclass thisClass = (*env)-&gt;GetObjectClass(env, thisObj);</span><br><span class="line">   <span class="comment">// Get the Method ID for method &quot;callback&quot;, which takes no arg and return void</span></span><br><span class="line">   jmethodID midCallBack = (*env)-&gt;GetMethodID(env, thisClass, <span class="string">&quot;callback&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midCallBack) <span class="keyword">return</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, call back Java&#x27;s callback()\n&quot;</span>);</span><br><span class="line">   <span class="comment">// Call back the method (which returns void), baed on the Method ID</span></span><br><span class="line">   (*env)-&gt;CallVoidMethod(env, thisObj, midCallBack);</span><br><span class="line">   jmethodID midCallBackStr = (*env)-&gt;GetMethodID(env, thisClass,</span><br><span class="line">                               <span class="string">&quot;callback&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midCallBackStr) <span class="keyword">return</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, call back Java&#x27;s called(String)\n&quot;</span>);</span><br><span class="line">   jstring message = (*env)-&gt;NewStringUTF(env, <span class="string">&quot;Hello from C&quot;</span>);</span><br><span class="line">   (*env)-&gt;CallVoidMethod(env, thisObj, midCallBackStr, message);</span><br><span class="line">   jmethodID midCallBackAverage = (*env)-&gt;GetMethodID(env, thisClass,</span><br><span class="line">                                  <span class="string">&quot;callbackAverage&quot;</span>, <span class="string">&quot;(II)D&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midCallBackAverage) <span class="keyword">return</span>;</span><br><span class="line">   jdouble average = (*env)-&gt;CallDoubleMethod(env, thisObj, midCallBackAverage, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the average is %f\n&quot;</span>, average);</span><br><span class="line">   jmethodID midCallBackStatic = (*env)-&gt;GetStaticMethodID(env, thisClass,</span><br><span class="line">                                 <span class="string">&quot;callbackStatic&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midCallBackStatic) <span class="keyword">return</span>;</span><br><span class="line">   jstring resultJNIStr = (*env)-&gt;CallStaticObjectMethod(env, thisObj, midCallBackStatic);</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *resultCStr = (*env)-&gt;GetStringUTFChars(env, resultJNIStr, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == resultCStr) <span class="keyword">return</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the returned string is %s\n&quot;</span>, resultCStr);</span><br><span class="line">   (*env)-&gt;ReleaseStringUTFChars(env, resultJNIStr, resultCStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="回调覆盖的父类的实例方法"><a href="#回调覆盖的父类的实例方法" class="headerlink" title="回调覆盖的父类的实例方法"></a>回调覆盖的父类的实例方法</h3><p>//TODO</p>
<h2 id="jni-数据类型"><a href="#jni-数据类型" class="headerlink" title="jni 数据类型"></a>jni 数据类型</h2><p>jni在本地系统中定义了与java总的基本数据类型相对应的数据类型。</p>
<ol>
<li><p>基本类型: <code>jint</code> <code>jbyte</code> <code>jshort</code> <code>jlong</code> <code>jdouble</code> <code>jchar</code> <code>jboolean</code>与java中的<code>int</code> <code>byte</code> <code>short</code> <code>long</code> <code>double</code> <code>char</code> <code>boolean</code>对应。</p>
</li>
<li><p>引用类型: <code>jobject</code>与<code>java.lang.Object</code>也定义了如下的子类型:</p>
</li>
</ol>
<ul>
<li><code>jclass</code>与<code>java.lang.Class</code></li>
<li><code>jstring</code>与<code>java.lang.String</code></li>
<li><code>jthrowable</code>与<code>java.lang.Throwable</code></li>
<li><code>jarray</code>对应java数组。 java数组是包括8种基本类型数组与Object数组的应用类型。因此， 存在8个基本类型的数组: <code>jintArray</code>, <code>jbyteArray</code>, <code>jshortArray</code>, <code>jlongArray</code>, <code>jfloatArray</code>, <code>jdoubleArray</code>, <code>jcharArray</code>和<code>jbooleanArray</code>,以及<code>jobjectArray</code>.</li>
</ul>
<p>本地函数接收到上述的JNI类型的参数，返回JNI类型的数据。在本地函数处理自己的本地类型数据时，需要JNI类型与本地类型的转换。</p>
<h2 id="参数传递与数据类型转换"><a href="#参数传递与数据类型转换" class="headerlink" title="参数传递与数据类型转换"></a>参数传递与数据类型转换</h2><h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h3><p>Java基本数据类型可以直接传递。在本地系统中定义的<code>jXXX</code>类型, 如<code>jint</code>,<code>jbyte</code>,<code>jshort</code>,<code>jlong</code>,<code>jfloat</code>,<code>jdouble</code>,<code>jchar</code>和<code>jboolean</code>与java中基本数据类型<code>int</code>,<code>byte</code>,<code>short</code>,<code>long</code>,<code>float</code>,<code>double</code>,<code>char</code>和<code>boolean</code>对应.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In &quot;win\jni_mh.h&quot; - machine header which is machine dependent</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span>            jint;</span><br><span class="line"><span class="keyword">typedef</span> __int64         jlong;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">signed</span> <span class="keyword">char</span>     jbyte;</span><br><span class="line"><span class="comment">// In &quot;jni.h&quot;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>   jboolean;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span>  jchar;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">short</span>           jshort;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">float</span>           jfloat;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span>          jdouble;</span><br><span class="line"><span class="keyword">typedef</span> jint            jsize;</span><br></pre></td></tr></table></figure>
<h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIString</span> </span>&#123;</span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">      <span class="comment">// myjni.dll (Windows) or libmyjni.so (Unixes)</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Native method that receives a Java String and return a Java String</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> String <span class="title">sayHello</span><span class="params">(String msg)</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">      String result = <span class="keyword">new</span> TestJNIString().sayHello(<span class="string">&quot;Hello from Java&quot;</span>);</span><br><span class="line">      System.out.println(<span class="string">&quot;In Java, the returned string is: &quot;</span> + result);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL Java_TestJNIString_sayHello(JNIEnv *, jobject, jstring);</span><br></pre></td></tr></table></figure>
<p>Java的String是一个对象，而C里面的String是一个以 null 结束的字符数组(字符指针 char*)。JNI环境提供了转换用的函数:</p>
<ol>
<li><p>JNI String(jstring)转换为C String(char *): <code>const char* GetStringUTFChars(JNIEnv*, jstring, jboolean*)</code></p>
</li>
<li><p>C-String(char *)转换为JNI String(jstring): <code>jstring NewStringUTF(JNIEnv*, char*)</code></p>
<p> 注意: 当调用上面的函数产生了新的内存时，需要调用<code>(*env)-&gt;ReleaseStringUTFChars(env, &lt;&gt;, &lt;&gt;);</code></p>
</li>
</ol>
<h4 id="JNI本地字符串函数"><a href="#JNI本地字符串函数" class="headerlink" title="JNI本地字符串函数"></a>JNI本地字符串函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UTF-8 String (encoded to 1-3 byte, backward compatible with 7-bit ASCII)</span></span><br><span class="line"><span class="comment">// Can be mapped to null-terminated char-array C-string</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="title">GetStringUTFChars</span><span class="params">(JNIEnv *env, jstring <span class="built_in">string</span>, jboolean *isCopy)</span></span>;</span><br><span class="line"><span class="comment">// Returns a pointer to an array of bytes representing the string in modified UTF-8 encoding.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseStringUTFChars</span><span class="params">(JNIEnv *env, jstring <span class="built_in">string</span>, <span class="keyword">const</span> <span class="keyword">char</span> *utf)</span></span>;</span><br><span class="line"><span class="comment">// Informs the VM that the native code no longer needs access to utf.</span></span><br><span class="line"><span class="function">jstring <span class="title">NewStringUTF</span><span class="params">(JNIEnv *env, <span class="keyword">const</span> <span class="keyword">char</span> *bytes)</span></span>;</span><br><span class="line"><span class="comment">// Constructs a new java.lang.String object from an array of characters in modified UTF-8 encoding.</span></span><br><span class="line"><span class="function">jsize <span class="title">GetStringUTFLength</span><span class="params">(JNIEnv *env, jstring <span class="built_in">string</span>)</span></span>;</span><br><span class="line"><span class="comment">// Returns the length in bytes of the modified UTF-8 representation of a string.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetStringUTFRegion</span><span class="params">(JNIEnv *env, jstring str, jsize start, jsize length, <span class="keyword">char</span> *buf)</span></span>;</span><br><span class="line"><span class="comment">// Translates len number of Unicode characters beginning at offset start into modified UTF-8 encoding</span></span><br><span class="line"><span class="comment">// and place the result in the given buffer buf.</span></span><br><span class="line"><span class="comment">// Unicode Strings (16-bit character)</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> jchar * <span class="title">GetStringChars</span><span class="params">(JNIEnv *env, jstring <span class="built_in">string</span>, jboolean *isCopy)</span></span>;</span><br><span class="line"><span class="comment">// Returns a pointer to the array of Unicode characters</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseStringChars</span><span class="params">(JNIEnv *env, jstring <span class="built_in">string</span>, <span class="keyword">const</span> jchar *chars)</span></span>;</span><br><span class="line"><span class="comment">// Informs the VM that the native code no longer needs access to chars.</span></span><br><span class="line"><span class="function">jstring <span class="title">NewString</span><span class="params">(JNIEnv *env, <span class="keyword">const</span> jchar *unicodeChars, jsize length)</span></span>;</span><br><span class="line"><span class="comment">// Constructs a new java.lang.String object from an array of Unicode characters.</span></span><br><span class="line"><span class="function">jsize <span class="title">GetStringLength</span><span class="params">(JNIEnv *env, jstring <span class="built_in">string</span>)</span></span>;</span><br><span class="line"><span class="comment">// Returns the length (the count of Unicode characters) of a Java string.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetStringRegion</span><span class="params">(JNIEnv *env, jstring str, jsize start, jsize length, jchar *buf)</span></span>;</span><br><span class="line"><span class="comment">// Copies len number of Unicode characters beginning at offset start to the given buffer buf</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">double</span>[] sumAndAverage(<span class="keyword">int</span>[] numbers);</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span>[] numbers = &#123;<span class="number">22</span>, <span class="number">33</span>, <span class="number">33</span>&#125;;</span><br><span class="line"><span class="keyword">double</span>[] results = <span class="keyword">new</span> TestJNIPrimitiveArray().sumAndAverage(numbers);</span><br><span class="line">System.out.println(<span class="string">&quot;In Java, the sum is &quot;</span> + results[<span class="number">0</span>]);</span><br><span class="line">System.out.println(<span class="string">&quot;In Java, the average is &quot;</span> + results[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &quot;TestJNIPrimitiveArray.h&quot;</span><br><span class="line">JNIEXPORT jdoubleArray JNICALL Java_TestJNIPrimitiveArray_sumAndAverage</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jintArray inJNIArray) &#123;</span><br><span class="line">   &#x2F;&#x2F; Step 1: Convert the incoming JNI jintarray to C&#39;s jint[]</span><br><span class="line">   jint *inCArray &#x3D; (*env)-&gt;GetIntArrayElements(env, inJNIArray, NULL);</span><br><span class="line">   if (NULL &#x3D;&#x3D; inCArray) return NULL;</span><br><span class="line">   jsize length &#x3D; (*env)-&gt;GetArrayLength(env, inJNIArray);</span><br><span class="line">   &#x2F;&#x2F; Step 2: Perform its intended operations</span><br><span class="line">   jint sum &#x3D; 0;</span><br><span class="line">   int i;</span><br><span class="line">   for (i &#x3D; 0; i &lt; length; i++) &#123;</span><br><span class="line">      sum +&#x3D; inCArray[i];</span><br><span class="line">   &#125;</span><br><span class="line">   jdouble average &#x3D; (jdouble)sum &#x2F; length;</span><br><span class="line">   (*env)-&gt;ReleaseIntArrayElements(env, inJNIArray, inCArray, 0); &#x2F;&#x2F; release resources</span><br><span class="line">   jdouble outCArray[] &#x3D; &#123;sum, average&#125;;</span><br><span class="line">   &#x2F;&#x2F; Step 3: Convert the C&#39;s Native jdouble[] to JNI jdoublearray, and return</span><br><span class="line">   jdoubleArray outJNIArray &#x3D; (*env)-&gt;NewDoubleArray(env, 2);  &#x2F;&#x2F; allocate</span><br><span class="line">   if (NULL &#x3D;&#x3D; outJNIArray) return NULL;</span><br><span class="line">   (*env)-&gt;SetDoubleArrayRegion(env, outJNIArray, 0 , 2, outCArray);  &#x2F;&#x2F; copy</span><br><span class="line">   return outJNIArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JNI基本类型数组函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArrayType: jintArray, jbyteArray, jshortArray, jlongArray, jfloatArray, jdoubleArray, jcharArray, jbooleanArray</span></span><br><span class="line"><span class="comment">// PrimitiveType: int, byte, short, long, float, double, char, boolean</span></span><br><span class="line"><span class="comment">// NativeType: jint, jbyte, jshort, jlong, jfloat, jdouble, jchar, jboolean</span></span><br><span class="line">NativeType * Get&lt;PrimitiveType&gt;ArrayElements(JNIEnv *env, ArrayType <span class="built_in">array</span>, jboolean *isCopy);</span><br><span class="line"><span class="keyword">void</span> Release&lt;PrimitiveType&gt;ArrayElements(JNIEnv *env, ArrayType <span class="built_in">array</span>, NativeType *elems, jint mode);</span><br><span class="line"><span class="keyword">void</span> Get&lt;PrimitiveType&gt;ArrayRegion(JNIEnv *env, ArrayType <span class="built_in">array</span>, jsize start, jsize length, NativeType *buffer);</span><br><span class="line"><span class="keyword">void</span> Set&lt;PrimitiveType&gt;ArrayRegion(JNIEnv *env, ArrayType <span class="built_in">array</span>, jsize start, jsize length, <span class="keyword">const</span> NativeType *buffer);</span><br><span class="line">ArrayType New&lt;PrimitiveType&gt;Array(JNIEnv *env, jsize length);</span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">GetPrimitiveArrayCritical</span><span class="params">(JNIEnv *env, jarray <span class="built_in">array</span>, jboolean *isCopy)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleasePrimitiveArrayCritical</span><span class="params">(JNIEnv *env, jarray <span class="built_in">array</span>, <span class="keyword">void</span> *carray, jint mode)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="函数签名"><a href="#函数签名" class="headerlink" title="函数签名"></a>函数签名</h2><h2 id="创建对象与对象数组"><a href="#创建对象与对象数组" class="headerlink" title="创建对象与对象数组"></a>创建对象与对象数组</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIConstructor.h&quot;</span></span></span><br><span class="line">JNIEXPORT jobject JNICALL Java_TestJNIConstructor_getIntegerObject</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jint number) &#123;</span><br><span class="line">   <span class="comment">// Get a class reference for java.lang.Integer</span></span><br><span class="line">   jclass cls = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Integer&quot;</span>);</span><br><span class="line">   <span class="comment">// Get the Method ID of the constructor which takes an int</span></span><br><span class="line">   jmethodID midInit = (*env)-&gt;GetMethodID(env, cls, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midInit) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   <span class="comment">// Call back constructor to allocate a new instance, with an int argument</span></span><br><span class="line">   jobject newObj = (*env)-&gt;NewObject(env, cls, midInit, number);</span><br><span class="line">   <span class="comment">// Try runnning the toString() on this newly create object</span></span><br><span class="line">   jmethodID midToString = (*env)-&gt;GetMethodID(env, cls, <span class="string">&quot;toString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midToString) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   jstring resultStr = (*env)-&gt;CallObjectMethod(env, newObj, midToString);</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *resultCStr = (*env)-&gt;GetStringUTFChars(env, resultStr, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C: the number is %s\n&quot;</span>, resultCStr);</span><br><span class="line">   <span class="keyword">return</span> newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对象函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jclass <span class="title">FindClass</span><span class="params">(JNIEnv *env, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"><span class="function">jobject <span class="title">NewObject</span><span class="params">(JNIEnv *env, jclass cls, jmethodID methodID, ...)</span></span>;</span><br><span class="line"><span class="function">jobject <span class="title">NewObjectA</span><span class="params">(JNIEnv *env, jclass cls, jmethodID methodID, <span class="keyword">const</span> jvalue *args)</span></span>;</span><br><span class="line"><span class="function">jobject <span class="title">NewObjectV</span><span class="params">(JNIEnv *env, jclass cls, jmethodID methodID, va_list args)</span></span>;</span><br><span class="line"><span class="comment">//Constructs a new Java object.The method ID indicates which constructor method to invoke</span></span><br><span class="line"><span class="function">jobject <span class="title">AllocObject</span><span class="params">(JNIEnv *env, jclass cls)</span></span>;</span><br><span class="line"><span class="comment">//Allocates a new Java object without invoking any of the constructors for the object.</span></span><br></pre></td></tr></table></figure>
<p>对象数组</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIObjectArray.h&quot;</span></span></span><br><span class="line">JNIEXPORT jobjectArray JNICALL Java_TestJNIObjectArray_sumAndAverage</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jobjectArray inJNIArray) &#123;</span><br><span class="line">   <span class="comment">// Get a class reference for java.lang.Integer</span></span><br><span class="line">   jclass classInteger = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Integer&quot;</span>);</span><br><span class="line">   <span class="comment">// Use Integer.intValue() to retrieve the int</span></span><br><span class="line">   jmethodID midIntValue = (*env)-&gt;GetMethodID(env, classInteger, <span class="string">&quot;intValue&quot;</span>, <span class="string">&quot;()I&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midIntValue) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   <span class="comment">// Get the value of each Integer object in the array</span></span><br><span class="line">   jsize length = (*env)-&gt;GetArrayLength(env, inJNIArray);</span><br><span class="line">   jint sum = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">      jobject objInteger = (*env)-&gt;GetObjectArrayElement(env, inJNIArray, i);</span><br><span class="line">      <span class="keyword">if</span> (<span class="literal">NULL</span> == objInteger) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">      jint value = (*env)-&gt;CallIntMethod(env, objInteger, midIntValue);</span><br><span class="line">      sum += value;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">double</span> average = (<span class="keyword">double</span>)sum / length;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the sum is %d\n&quot;</span>, sum);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the average is %f\n&quot;</span>, average);</span><br><span class="line">   <span class="comment">// Get a class reference for java.lang.Double</span></span><br><span class="line">   jclass classDouble = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Double&quot;</span>);</span><br><span class="line">   <span class="comment">// Allocate a jobjectArray of 2 java.lang.Double</span></span><br><span class="line">   jobjectArray outJNIArray = (*env)-&gt;NewObjectArray(env, <span class="number">2</span>, classDouble, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="comment">// Construct 2 Double objects by calling the constructor</span></span><br><span class="line">   jmethodID midDoubleInit = (*env)-&gt;GetMethodID(env, classDouble, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(D)V&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midDoubleInit) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   jobject objSum = (*env)-&gt;NewObject(env, classDouble, midDoubleInit, (<span class="keyword">double</span>)sum);</span><br><span class="line">   jobject objAve = (*env)-&gt;NewObject(env, classDouble, midDoubleInit, average);</span><br><span class="line">   <span class="comment">// Set to the jobjectArray</span></span><br><span class="line">   (*env)-&gt;SetObjectArrayElement(env, outJNIArray, <span class="number">0</span>, objSum);</span><br><span class="line">   (*env)-&gt;SetObjectArrayElement(env, outJNIArray, <span class="number">1</span>, objAve);</span><br><span class="line">   <span class="keyword">return</span> outJNIArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>局部变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIReference</span> </span>&#123;</span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      System.loadLibrary(<span class="string">&quot;myjni&quot;</span>); <span class="comment">// myjni.dll (Windows) or libmyjni.so (Unixes)</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// A native method that returns a java.lang.Integer with the given int.</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> Integer <span class="title">getIntegerObject</span><span class="params">(<span class="keyword">int</span> number)</span></span>;</span><br><span class="line">   <span class="comment">// Another native method that also returns a java.lang.Integer with the given int.</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> Integer <span class="title">anotherGetIntegerObject</span><span class="params">(<span class="keyword">int</span> number)</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">      TestJNIReference test = <span class="keyword">new</span> TestJNIReference();</span><br><span class="line">      System.out.println(test.getIntegerObject(<span class="number">1</span>));</span><br><span class="line">      System.out.println(test.getIntegerObject(<span class="number">2</span>));</span><br><span class="line">      System.out.println(test.anotherGetIntegerObject(<span class="number">11</span>));</span><br><span class="line">      System.out.println(test.anotherGetIntegerObject(<span class="number">12</span>));</span><br><span class="line">      System.out.println(test.getIntegerObject(<span class="number">3</span>));</span><br><span class="line">      System.out.println(test.anotherGetIntegerObject(<span class="number">13</span>));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIReference.h&quot;</span></span></span><br><span class="line"><span class="comment">// Global Reference to the Java class &quot;java.lang.Integer&quot;</span></span><br><span class="line"><span class="keyword">static</span> jclass classInteger;</span><br><span class="line"><span class="keyword">static</span> jmethodID midIntegerInit;</span><br><span class="line"><span class="function">jobject <span class="title">getInteger</span><span class="params">(JNIEnv *env, jobject thisObj, jint number)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Get a class reference for java.lang.Integer if missing</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == classInteger) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Find java.lang.Integer\n&quot;</span>);</span><br><span class="line">      classInteger = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Integer&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == classInteger) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   <span class="comment">// Get the Method ID of the Integer&#x27;s constructor if missing</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midIntegerInit) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Get Method ID for java.lang.Integer&#x27;s constructor\n&quot;</span>);</span><br><span class="line">      midIntegerInit = (*env)-&gt;GetMethodID(env, classInteger, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midIntegerInit) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   <span class="comment">// Call back constructor to allocate a new instance, with an int argument</span></span><br><span class="line">   jobject newObj = (*env)-&gt;NewObject(env, classInteger, midIntegerInit, number);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, constructed java.lang.Integer with number %d\n&quot;</span>, number);</span><br><span class="line">   <span class="keyword">return</span> newObj;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jobject JNICALL Java_TestJNIReference_getIntegerObject</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jint number) &#123;</span><br><span class="line">   <span class="keyword">return</span> getInteger(env, thisObj, number);</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jobject JNICALL Java_TestJNIReference_anotherGetIntegerObject</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jint number) &#123;</span><br><span class="line">   <span class="keyword">return</span> getInteger(env, thisObj, number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Get a class reference for java.lang.Integer if missing</span><br><span class="line">if (NULL &#x3D;&#x3D; classInteger) &#123;</span><br><span class="line">   printf(&quot;Find java.lang.Integer\n&quot;);</span><br><span class="line">   &#x2F;&#x2F; FindClass returns a local reference</span><br><span class="line">   jclass classIntegerLocal &#x3D; (*env)-&gt;FindClass(env, &quot;java&#x2F;lang&#x2F;Integer&quot;);</span><br><span class="line">   &#x2F;&#x2F; Create a global reference from the local reference</span><br><span class="line">   classInteger &#x3D; (*env)-&gt;NewGlobalRef(env, classIntegerLocal);</span><br><span class="line">   &#x2F;&#x2F; No longer need the local reference, free it!</span><br><span class="line">   (*env)-&gt;DeleteLocalRef(env, classIntegerLocal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="相关问题"><a href="#相关问题" class="headerlink" title="相关问题"></a>相关问题</h1><h2 id="如何避免内存泄露"><a href="#如何避免内存泄露" class="headerlink" title="如何避免内存泄露"></a>如何避免内存泄露</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/reflection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/reflection/" class="post-title-link" itemprop="url">Java 反射</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-14 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-14T00:00:00+08:00">2015-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="在多级类继承中-如何找到方法是在哪个类实现的"><a href="#在多级类继承中-如何找到方法是在哪个类实现的" class="headerlink" title="在多级类继承中, 如何找到方法是在哪个类实现的?"></a>在多级类继承中, 如何找到方法是在哪个类实现的?</h2><p>currentObject 是ContextWrapper 的子类的对象, <code>mBase</code>是定义在 <code>currentObject</code>某一个父类的字段,<br><code>mBase</code>中的某个方法<code>getSharedPerences()</code>是定义在某个父类中的抽象方法,<br>如何确定该方法是在哪个父类中实现的?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  Field field = ContextWrapper.class.getDeclaredField(<span class="string">&quot;mBase&quot;</span>);</span><br><span class="line">  field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">  Object object = field.get(currentObject);</span><br><span class="line">  Log.i(TAG,<span class="string">&quot;the real implement class is &quot;</span> + filed.getClass().getName());</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getSharedPerences()</code>方法一定定义在<code>mBase</code>类中. 妙哉!<br>获得<code>mBase</code>对象的类名就是该方法的实现类.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/android-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/android-network/" class="post-title-link" itemprop="url">Android网络编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-09-23 00:00:00" itemprop="dateCreated datePublished" datetime="2015-09-23T00:00:00+08:00">2015-09-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Android 网络开发</p>
<p>网络功能是 Android 的最基本的功能之一, 本文将详细介绍 Android 网络开发.</p>
<ol>
<li>Android网络编程专题之二:搭建测试服务器 目的是为了测试 Android 网络代码</li>
<li>Android网络编程专题之三:模拟简单的网络应用</li>
</ol>
<ul>
<li>下载并显示图片</li>
<li>HttpURLConnection GET和POST请求</li>
<li>HttpClient: apache-commons-httpclient GET和POST请求</li>
<li>WebView</li>
</ul>
<ol start="3">
<li>Android网络编程专题之四:第三方框架</li>
</ol>
<ul>
<li>AsyncHttpClient<ul>
<li>post</li>
<li>get</li>
<li>文件上传</li>
</ul>
</li>
<li>SmartImage</li>
</ul>
<ol start="4">
<li>Android网络编程专题之五:多线程断点下载</li>
</ol>
<h1 id="Android配置"><a href="#Android配置" class="headerlink" title="Android配置"></a>Android配置</h1><p>网络连接需要声明网络服务权限:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="简单的服务器端"><a href="#简单的服务器端" class="headerlink" title="简单的服务器端"></a>简单的服务器端</h2><h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><p>为了支持Android的网络测试，搭建一个服务器端工程，满足如下几个要求：</p>
<ol>
<li>并支持Session和Cookie</li>
<li>支持文件上传</li>
<li>图片查看</li>
</ol>
<p>访问<code>/SimpleServer</code>进入登陆界面</p>
<p><img src="/images/android/network/android-network-SimpleServer-index.png"></p>
<p>登陆成功，显示相关的信息</p>
<p><img src="/images/android/network/android-network-SimpleServer-loginSuccess.png"></p>
<p>登陆失败，显示失败信息</p>
<p><img src="/images/android/network/android-network-SimpleServer-loginFailure.png"></p>
<p>下载图片地址</p>
<p><code>/SimpleServer/gyy.jpg</code></p>
<p><img src="/images/android/network/android-network-SimpleServer-image.png"></p>
<p>文件上传</p>
<p><code>/SimpleServer/uploadFile.jsp</code></p>
<p><img src="/images/android/network/android-network-SimpleServer-uploadServer1.png"></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>Eclipse工程目录如下</p>
<p><img src="/images/android/network/android-network-SimpleServer-project.png"></p>
<ol>
<li>创建打开<code>/SimpleServer/</code>的默认页面<code>login.jsp</code></li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;</span><br><span class="line">	pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>登陆<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span>&gt;</span></span><br><span class="line">		姓名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> &gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> &gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;get 提交&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">		姓名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> &gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> &gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;post 提交&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面有两个表单，分别用于使用<code>get</code>方法和<code>post</code>方法请求，发送请求到action–<code>login</code></p>
<ol start="2">
<li>在<code>web.xml</code>中注册</li>
</ol>
<p>在<code>web-app</code>节点下创建<code>welcome-file-list</code>子节点<br>添加页面</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>login.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>welcome-file</code>是默认的欢迎页面，在不指定子页面的情况下，按照<code>welcome-file-list</code>的顺序寻找页面，直到找到页面。<br>如果所有的页面都找不到，则只能显示404了</p>
<ol start="3">
<li>在<code>web.xml</code>中注册login action</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>login<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>club.guadazi.ss.LoginAction<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>login<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/login<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>LoginAction</li>
</ol>
<p>页面登陆，登陆成功后将用户名记录到Session中，如果Session中用户名不为null则代表已经登陆。<br>如果登陆失败，输出错误信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> club.guadazi.ss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginAction</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LoginAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		HttpSession session = req.getSession();</span><br><span class="line">		Object pwdAttribute = req.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">		Object nameAttribute = req.getParameter(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (pwdAttribute != <span class="keyword">null</span> &amp;&amp; <span class="string">&quot;abc.123&quot;</span>.equals((String) pwdAttribute)</span><br><span class="line">    &amp;&amp; nameAttribute != <span class="keyword">null</span>) &#123;</span><br><span class="line">			String name = (String) nameAttribute;</span><br><span class="line">			session.setAttribute(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">			resp.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">			resp.sendRedirect(<span class="string">&quot;info.jsp&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			resp.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">			PrintWriter writer = resp.getWriter();</span><br><span class="line">			writer.print(<span class="string">&quot;&lt;html&gt;&lt;head&gt;&quot;</span>);</span><br><span class="line">			writer.print(<span class="string">&quot;&lt;title&gt;&quot;</span> + <span class="string">&quot;欢迎 post&quot;</span> + <span class="string">&quot;&lt;/title&gt;&quot;</span>);</span><br><span class="line">			writer.print(<span class="string">&quot;&lt;/head&gt;&quot;</span>);</span><br><span class="line">			writer.print(<span class="string">&quot;&lt;center&gt;登陆失败!&lt;/center&gt;&quot;</span>);</span><br><span class="line">			writer.flush();</span><br><span class="line">			writer.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		doPost(req, resp);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Servlet实现的过程，继承HttpServlet，HttpServlet类含有处理post和get请求的方法，重写相应的方法即可。<br>Session用于保存一次会话的所有信息，Session以键值对的形式保存信息。常常用于记录登陆信息，当登陆成功后记录用户信息到Session，<br>在其他的页面上可以判断是否登陆，如果未登陆，则显示登陆页面。<br><code>HttpServletRequest.getParameter</code>可以获取页面表单在发请求时携带的参数。<br><code>resp.sendRedirect(&quot;info.jsp&quot;);</code>页面重定向</p>
<ol start="5">
<li>info.jsp 登陆成功后显示的页面</li>
</ol>
<p>需要在头部增加Session中用户名判断信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">	HttpSession session2 = request.getSession();</span><br><span class="line">	Object nameObject = session2.getAttribute(&quot;name&quot;);</span><br><span class="line">	if (nameObject == null) &#123;</span><br><span class="line">		/* 		response.sendRedirect(&quot;/SimpleServer&quot;); */</span><br><span class="line">%&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">	未登录 <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/SimpleServer&quot;</span>&gt;</span>点击登陆<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line">&lt;%</span><br><span class="line">	return;</span><br><span class="line">	&#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>当为登陆时不再显示下面的信息直接return</p>
<ol start="6">
<li>上传文件页面</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;uploadFileAction&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;filename&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">value</span>=<span class="string">&quot;Press&quot;</span>&gt;</span> to upload the file!</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>enctype</code>必须指定为<code>multipart/form-data</code></p>
<ol start="7">
<li>上传文件Action</li>
</ol>
<p>使用Apache的commons-fileupload工具包在doPost方法中实现上传文件<br>commons-fileupload依赖commons-io包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">ServletFileUpload fileUpload = <span class="keyword">new</span> ServletFileUpload(factory);</span><br><span class="line"><span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(req)) &#123;</span><br><span class="line">  PrintWriter writer = resp.getWriter();</span><br><span class="line">  writer.println(<span class="string">&quot;is not multipart content!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  List&lt;FileItem&gt; list = fileUpload.parseRequest(req);</span><br><span class="line">  <span class="keyword">for</span> (FileItem fileItem : list) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fileItem.isFormField()) &#123;</span><br><span class="line">      String name = fileItem.getName();</span><br><span class="line">      String value = fileItem.getString();</span><br><span class="line">      ServletOutputStream outputStream = resp.getOutputStream();</span><br><span class="line">      outputStream.write((name + <span class="string">&quot;:&quot;</span> + value).getBytes());</span><br><span class="line">      outputStream.close();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      String fileName = fileItem.getName();</span><br><span class="line">      String realPath = <span class="comment">/* this.getServletContext().getRealPath */</span>(<span class="string">&quot;/Users/Mariaaron/upload/&quot;</span>);</span><br><span class="line">      System.out.println(realPath);</span><br><span class="line">      FileOutputStream out = <span class="keyword">new</span> FileOutputStream(realPath + fileName);</span><br><span class="line">      InputStream in = fileItem.getInputStream();</span><br><span class="line">      <span class="keyword">byte</span> buffer[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">      <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((len = in.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">      &#125;</span><br><span class="line">      out.close();</span><br><span class="line">      in.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileUploadException e) &#123;</span><br><span class="line">  e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>源文件与war包的<a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1qW89zyc" title="SimpleServer源码与war包下载">下载地址</a></p>
<h1 id="简单网络操作"><a href="#简单网络操作" class="headerlink" title="简单网络操作"></a>简单网络操作</h1><p>Android 网络</p>
<h2 id="Android-网络连接线程"><a href="#Android-网络连接线程" class="headerlink" title="Android 网络连接线程"></a>Android 网络连接线程</h2><ol>
<li>在 Android 中, 主线程负责更新 UI, 因此,主线程也称为 UI 线程.</li>
<li>除了ProcessBar等几个少数的控件外, 几乎所有的 UI 控件必须在主线程更新.</li>
<li>为了防止 UI 载入和更新出现卡顿, 网络连接/大图片载入以及一些大型的计算必须在子线程进行.</li>
<li>网络操作必须放在子线程, 在子线程使用 Handler 更新 UI.<br>异步框架<code>AsyncHttpClient</code>就是基于这个原理实现的.</li>
</ol>
<p>Android提供了在子线程更新 UI 的 API:<br><code>Activity.runOnUiThread(Thread thread)</code> 方法,将 Runnable 中的任务放到UI 线程执行:<br/><br>// 如果当前线程就是UI 线程立即执行,否者将把 Runnable 线程 join 到UI 线程中执行.</p>
<h2 id="Java-Socket"><a href="#Java-Socket" class="headerlink" title="Java Socket"></a>Java Socket</h2><blockquote>
<p>android简单聊天工具</p>
</blockquote>
<h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><p>类 URL 代表一个统一资源定位符，它是指向互联网“资源”的指针。</p>
<p>创建一个到 URL 的连接需要几个步骤：</p>
<p>  openConnection() ———— 时间 —————-&gt;    connect()<br>对影响到远程资源连接的参数进行操作 ———— 时间 —————-&gt; 与资源交互；查询头字段和内容。</p>
<ol>
<li>通过在 URL 上调用 openConnection 方法创建连接对象。</li>
<li>处理设置参数和一般请求属性。</li>
<li>使用 connect 方法建立到远程对象的实际连接。</li>
<li>远程对象变为可用。远程对象的头字段和内容变为可访问。</li>
</ol>
<p>使用以下方法修改设置参数：</p>
<p>   setAllowUserInteraction<br>   setDoInput<br>   setDoOutput<br>   setIfModifiedSince<br>   setUseCaches</p>
<p>使用以下方法修改一般请求属性：</p>
<p>   setRequestProperty</p>
<p>使用 setDefaultAllowUserInteraction 和 setDefaultUseCaches 可设置 AllowUserInteraction 和 UseCaches 参数的默认值。</p>
<p>上面每个 set 方法都有一个用于获取参数值或一般请求属性值的对应 get 方法。适用的具体参数和一般请求属性取决于协议。</p>
<p>在建立到远程对象的连接后，以下方法用于访问头字段和内容：</p>
<p>   getContent<br>   getHeaderField<br>   getInputStream<br>   getOutputStream</p>
<p>某些头字段需要经常访问。以下方法：</p>
<p>   getContentEncoding<br>   getContentLength<br>   getContentType<br>   getDate<br>   getExpiration<br>   getLastModifed</p>
<p>提供对这些字段的便捷访问。getContent 方法使用 getContentType 方法以确定远程对象类型；子类重写 getContentType 方法很容易。</p>
<p>一般情况下，所有的预连接参数和一般请求属性都可忽略：预连接参数和一般请求属性默认为敏感值。对于此接口的大多数客户端而言，只有两个需要的方法：getInputStream 和 getContent，它们通过便捷方法镜像到 URL 类中。</p>
<h2 id="URLConnection"><a href="#URLConnection" class="headerlink" title="URLConnection"></a>URLConnection</h2><p>例子: 布局文件中的Button被调用时，调用loadImage方法</p>
<p>在loadImage方法中</p>
<ol>
<li>判断收入的图片地址是否为空</li>
<li>启动新的子线程，在子线程中</li>
</ol>
<p>`URLConnection urlConnection = url.openConnection();’<br>返回一个 URLConnection 对象，它表示到 URL 所引用的远程对象的连接。<br>每次调用此 URL 的协议处理程序的 openConnection 方法都打开一个新的连接。</p>
<p>如果 URL 的协议（例如，HTTP 或 JAR）存在属于以下包或其子包之一的公共、专用 URLConnection 子类：java.lang、java.io、java.util、java.net，<br>返回的连接将为该子类的类型。例如，对于 HTTP，将返回 HttpURLConnection，对于 JAR，将返回 JarURLConnection。</p>
<p>‘InputStream inputStream = urlConnection.getInputStream();’<br>从打开的连接读取输入流</p>
<blockquote>
<p>‘InputStream inputStream = urlConnection.openStream();’<br>是<code>openConnection().getInputStream()</code>的缩写形式。</p>
</blockquote>
<p>‘Bitmap bitmap = BitmapFactory.decodeStream(inputStream);`<br>把输入流解码成位图对象</p>
<ol start="3">
<li><p>创建Message，将位图对象作为<code>Message.obj</code>, 向Handler发送消息</p>
</li>
<li><p>Handler执行，更新UI</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ImageView imageView;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadImage</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> String imageUrl = imageUrlEdit.getText().toString().trim();</span><br><span class="line">   <span class="keyword">if</span> (TextUtils.isEmpty(imageUrl)) &#123;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               URL url = <span class="keyword">new</span> URL(imageUrl);</span><br><span class="line">               HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">               urlConnection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">               <span class="keyword">if</span> (urlConnection.getResponseCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                   InputStream inputStream = urlConnection.getInputStream();</span><br><span class="line">                   Bitmap bitmap;</span><br><span class="line">                   bitmap = BitmapFactory.decodeStream(inputStream);</span><br><span class="line">                   Message message = <span class="keyword">new</span> Message();</span><br><span class="line">                   message.what = SHOW_IMAGE_BY_URL;</span><br><span class="line">                   message.obj = bitmap;</span><br><span class="line">                   handler.sendMessage(message);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;请求失败!&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadImage2</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> String imageUrl = imageUrlEdit.getText().toString().trim();</span><br><span class="line">   <span class="keyword">if</span> (TextUtils.isEmpty(imageUrl)) &#123;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               URL url = <span class="keyword">new</span> URL(imageUrl);</span><br><span class="line">               HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">               urlConnection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">               <span class="keyword">if</span> (urlConnection.getResponseCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                   InputStream inputStream = urlConnection.getInputStream();</span><br><span class="line">                   <span class="keyword">final</span> Bitmap bitmap = BitmapFactory.decodeStream(inputStream);</span><br><span class="line">                   <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    * runOnUiThread 方法,将 Runnable 中的任务放到UI 线程执行:&lt;br/&gt;</span></span><br><span class="line"><span class="comment">                    * 如果当前线程就是UI 线程立即执行,否者将把 Runnable 线程 join 到UI 线程中执行.</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                   runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                           imageView.setImageBitmap(bitmap);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;.start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> Handler handler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> showImageByUrl:</span><br><span class="line">                Bitmap bitmap = (Bitmap) msg.obj;</span><br><span class="line">                imageView.setImageBitmap(bitmap);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    imageView = (ImageView) findViewById(R.id.iv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="HttpURLConnection"><a href="#HttpURLConnection" class="headerlink" title="HttpURLConnection"></a>HttpURLConnection</h2><p>对于上面的例子，URL的scheme是HTTP类型的，<code>URL.openConnection</code>返回的对象就是<code>HttpURLConnection</code>对象。</p>
<p>get和post方式发送登录请求的代码和纯Java环境是一模一样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loginUrlGet</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String path = loginPath + <span class="string">&quot;?name=&quot;</span> + name + <span class="string">&quot;&amp;password=&quot;</span> + password;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(path);</span><br><span class="line">        HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">        urlConnection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (urlConnection.getResponseCode() == <span class="number">200</span>) &#123;</span><br><span class="line">            InputStream inputStream = urlConnection.getInputStream();</span><br><span class="line">            String content = readAsString(inputStream);</span><br><span class="line">            showResponseOnWebView(content);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;请求失败!&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loginUrlPost</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; requestParams = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        requestParams.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        requestParams.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">        StringBuilder params = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : requestParams.entrySet()) &#123;</span><br><span class="line">            params.append(entry.getKey());</span><br><span class="line">            params.append(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">            params.append(URLEncoder.encode(entry.getValue(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            params.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (params.length() &gt; <span class="number">0</span>) params.deleteCharAt(params.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] data = params.toString().getBytes();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(loginPath);</span><br><span class="line">        HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">        conn.setRequestMethod(<span class="string">&quot;POST&quot;</span>);<span class="comment">//必须大写</span></span><br><span class="line">        conn.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">        conn.setRequestProperty(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;Keep-Alive&quot;</span>);<span class="comment">//维持长连接</span></span><br><span class="line">        conn.setRequestProperty(<span class="string">&quot;Charset&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        conn.setRequestProperty(<span class="string">&quot;Content-Length&quot;</span>, String.valueOf(data.length));</span><br><span class="line">        conn.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">        DataOutputStream outStream = <span class="keyword">new</span> DataOutputStream(conn.getOutputStream());</span><br><span class="line">        outStream.write(data);</span><br><span class="line">        outStream.flush();</span><br><span class="line">        <span class="keyword">if</span> (conn.getResponseCode() == <span class="number">200</span>) &#123;</span><br><span class="line">            String result = readAsString(conn.getInputStream());</span><br><span class="line">            outStream.close();</span><br><span class="line">            showResponseOnWebView(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的例子只是实现了登录，如果当服务器端使用了Session时，再访问其他页面登录信息是无法联系起来的。<br>而HttpClient可以</p>
<h3 id="多线程下载"><a href="#多线程下载" class="headerlink" title="多线程下载"></a>多线程下载</h3><p>见 <a href="#nulti_download">下文</a></p>
<h2 id="HttpClient-apache-commons-httpclient"><a href="#HttpClient-apache-commons-httpclient" class="headerlink" title="HttpClient: apache-commons-httpclient"></a>HttpClient: apache-commons-httpclient</h2><p>HttpClient类似于Http的客户端，也就是浏览器。<br>它会保存会话，记录登录信息，Cookie等</p>
<p>看登录并访问的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loginHttpClientPost</span><span class="params">(String name, String password)</span> </span>&#123;</span><br><span class="line">    HttpClient httpClient = <span class="keyword">new</span> DefaultHttpClient();</span><br><span class="line">    HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">    map.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    String path = loginPath;</span><br><span class="line">    path += <span class="string">&quot;?&quot;</span>;</span><br><span class="line">    Set&lt;Map.Entry&lt;String, String&gt;&gt; entries = map.entrySet();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : entries) &#123;</span><br><span class="line">        String key = entry.getKey();</span><br><span class="line">        String value = entry.getValue();</span><br><span class="line">        path += key + <span class="string">&quot;=&quot;</span> + value;</span><br><span class="line">        path += <span class="string">&quot;&amp;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    path = path.substring(<span class="number">0</span>, path.length() - <span class="number">1</span>);</span><br><span class="line">    HttpPost httpPost = <span class="keyword">new</span> HttpPost(path);</span><br><span class="line">    String responseString = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        HttpResponse response = httpClient.execute(httpPost);</span><br><span class="line">        <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">            responseString = EntityUtils.toString(response.getEntity());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            responseString = <span class="string">&quot;Error Response: &quot;</span></span><br><span class="line">                    + response.getStatusLine().toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    showResponseOnWebView(responseString);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loginHttpClientGet</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> String password)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 HttpParams 以用来设置 HTTP 参数（这一部分不是必需的）</span></span><br><span class="line">    BasicHttpParams httpParams = <span class="keyword">new</span> BasicHttpParams();</span><br><span class="line">    <span class="comment">// 设置连接超时和 Socket 超时，以及 Socket 缓存大小</span></span><br><span class="line">    HttpConnectionParams.setConnectionTimeout(httpParams, <span class="number">20</span> * <span class="number">1000</span>);</span><br><span class="line">    HttpConnectionParams.setSoTimeout(httpParams, <span class="number">20</span> * <span class="number">1000</span>);</span><br><span class="line">    HttpConnectionParams.setSocketBufferSize(httpParams, <span class="number">8192</span>);</span><br><span class="line">    <span class="comment">// 设置重定向，缺省为 true</span></span><br><span class="line">    HttpClientParams.setRedirecting(httpParams, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 设置 user agent</span></span><br><span class="line">    String userAgent = <span class="string">&quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.2) Gecko/20100115 Firefox/3.6&quot;</span>;</span><br><span class="line">    HttpProtocolParams.setUserAgent(httpParams, userAgent);</span><br><span class="line">    <span class="comment">// 创建一个 HttpClient 实例</span></span><br><span class="line">    <span class="comment">// 注意 HttpClient httpClient = new HttpClient(); 是Commons HttpClient</span></span><br><span class="line">    <span class="comment">// 中的用法，在 Android 1.5 中我们需要使用 Apache 的缺省实现 DefaultHttpClient</span></span><br><span class="line">    HttpClient httpClient = <span class="keyword">new</span> DefaultHttpClient(httpParams);</span><br><span class="line">    Map params2 = <span class="keyword">new</span> HashMap();</span><br><span class="line">    params2.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">    params2.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    String url = loginPath;</span><br><span class="line">     <span class="comment">/* 建立HTTPGet对象 */</span></span><br><span class="line">    String paramStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    Iterator iter = params2.entrySet().iterator();</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        Map.Entry entry = (Map.Entry) iter.next();</span><br><span class="line">        Object key = entry.getKey();</span><br><span class="line">        Object val = entry.getValue();</span><br><span class="line">        paramStr += paramStr = <span class="string">&quot;&amp;&quot;</span> + key + <span class="string">&quot;=&quot;</span> + val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!paramStr.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        paramStr = paramStr.replaceFirst(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;?&quot;</span>);</span><br><span class="line">        url += paramStr;</span><br><span class="line">    &#125;</span><br><span class="line">    HttpGet httpGet = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">    String strResult = <span class="string">&quot;doGetError&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/* 发送请求并等待响应 */</span></span><br><span class="line">        HttpResponse httpResponse = httpClient.execute(httpGet);</span><br><span class="line">        <span class="comment">/* 若状态码为200 ok */</span></span><br><span class="line">        <span class="keyword">if</span> (httpResponse.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">/* 读返回数据 */</span></span><br><span class="line">            strResult = EntityUtils.toString(httpResponse.getEntity());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            strResult = <span class="string">&quot;Error Response: &quot;</span></span><br><span class="line">                    + httpResponse.getStatusLine().toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClientProtocolException e) &#123;</span><br><span class="line">        strResult = e.getMessage().toString();</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        strResult = e.getMessage().toString();</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        strResult = e.getMessage().toString();</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    showResponseOnWebView(strResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<a href="3">示例工程</a>中, 服务器端在登录成功后会跳转到info.jsp页面，详见第一节</p>
<p>使用URLConnection是无法实现的。而HttpClient可以实现跳转并显示登录信息。</p>
<h2 id="WebView"><a href="#WebView" class="headerlink" title="WebView"></a>WebView</h2><p>WebView是Android内置的WebKit内核网页显示控件，使用WebView可以显示本地和网站页面。so powerful!<br>默认使用UTF-8编码</p>
<h3 id="显示本地页面中文乱码"><a href="#显示本地页面中文乱码" class="headerlink" title="显示本地页面中文乱码"></a>显示本地页面中文乱码</h3><p>显示本地页面可以使用的API有：loadData 和loadDataWithBaseURL</p>
<p>WebView.loadData(content, “text/html”, “UTF-8”);出现中文乱码了，<br>改成 loadData(data, “text/html; charset=UTF-8”, null);就不会乱码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WebView.loadDataWithBaseURL(basePath, content, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;utf-8&quot;</span>, <span class="keyword">null</span>);<span class="comment">// 可以正常显示</span></span><br><span class="line">WebView.loadDataWithBaseURL(<span class="keyword">null</span>, content, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;utf-8&quot;</span>, <span class="keyword">null</span>);<span class="comment">// 无乱码 但无法显示图片</span></span><br></pre></td></tr></table></figure>
<p>使用loadDataWithBaseURL时,如果不传入URL时,刷新会造成白屏,因为刷新时调用的的是reload方法,<br>reload是根据传入的URL进行一次重新加载即再次loadUrl(url),不传入URL时,默认的的URL是about:blank</p>
<p>使用loadData,刷新只是从缓存里面取，但是在4.0以上的,如果按照API里所写的loadData(data, “UTF-8”, null);时会乱码,<br>如果写成<code>loadData(data, &quot;text/html; charset=UTF-8&quot;, null);</code><br>loadData最终的机制是会把传入的三个参数拼接在一起,<br>然后再进行loadUrl操作,参数就是data, “text/html; charset=UTF-8”, null这三个进行拼装,加入text/html; charset=UTF-8就相当于限定了页面的字符</p>
<p>loadData(detail,”text/html;charset=UTF-8”, null); 在小米 One S上仍然存在中文乱码的情况，<br>改成 WebView.loadDataWithBaseURL(null, detail, “text/html”, “UTF-8”, null); 就没问题。<br>在小米手机上设置<code>settings.setDefaultTextEncodingName(&quot;utf-8&quot;)</code><br>在 webview 的 settings 属性里指定 utf-8 就可以了</p>
<h1 id="第三方框架"><a href="#第三方框架" class="headerlink" title="第三方框架"></a>第三方框架</h1><h2 id="AsyncHttpClient"><a href="#AsyncHttpClient" class="headerlink" title="AsyncHttpClient"></a>AsyncHttpClient</h2><p><a target="_blank" rel="noopener" href="https://github.com/loopj/android-async-http">Github的地址</a></p>
<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">loginASyncHttpGet</span><span class="params">(String name, String password)</span> </span>&#123;</span><br><span class="line">    AsyncHttpClient asyncHttpClient = <span class="keyword">new</span> AsyncHttpClient();</span><br><span class="line">    RequestParams requestParams = <span class="keyword">new</span> RequestParams();</span><br><span class="line">    requestParams.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">    requestParams.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    asyncHttpClient.get(loginPath, requestParams, <span class="keyword">new</span> AsyncHttpResponseHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="post"><a href="#post" class="headerlink" title="post"></a>post</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">loginASyncHttpPost</span><span class="params">(String name, String password)</span> </span>&#123;</span><br><span class="line">    AsyncHttpClient asyncHttpClient = <span class="keyword">new</span> AsyncHttpClient();</span><br><span class="line">    RequestParams requestParams = <span class="keyword">new</span> RequestParams();</span><br><span class="line">    requestParams.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">    requestParams.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    asyncHttpClient.post(loginPath, requestParams, <span class="keyword">new</span> AsyncHttpResponseHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadFileAsyncHttpClient</span><span class="params">(String  selectFilePath)</span> </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(selectFilePath);</span><br><span class="line">    <span class="keyword">if</span> (file.exists() &amp;&amp; file.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        AsyncHttpClient client = <span class="keyword">new</span> AsyncHttpClient();</span><br><span class="line">        RequestParams params = <span class="keyword">new</span> RequestParams();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            params.put(<span class="string">&quot;profile_picture&quot;</span>, file);</span><br><span class="line"></span><br><span class="line">            client.post(uploadUrlEditTex.getText().toString(), params, <span class="keyword">new</span> AsyncHttpResponseHandler() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">                    Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;文件上传成功!&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable throwable, String s)</span> </span>&#123;</span><br><span class="line">                    Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;文件上传失败!&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;文件不存在&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SmartImage"><a href="#SmartImage" class="headerlink" title="SmartImage"></a>SmartImage</h2><p><a target="_blank" rel="noopener" href="https://github.com/loopj/android-smart-image-view">Github地址</a></p>
<p><a target="_blank" rel="noopener" href="http://loopj.com/android-smart-image-view/">官网</a></p>
<h1 id="多线程断点下载"><a href="#多线程断点下载" class="headerlink" title="多线程断点下载"></a>多线程断点下载</h1><p><a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1pJDvG6Z" title="多线程下载">示例代码下载地址</a></p>
<h2 id="多线程下载-1"><a href="#多线程下载-1" class="headerlink" title="多线程下载"></a>多线程下载</h2><p><a name="nulti_download">多线程下载</a>即将一个文件分割成若干部分，交给多个线程同时去下载，每个线程下载文件的一部分。以达到提速的目的。</p>
<p>为了实现多线程下载，需要如下几个步骤：</p>
<ol>
<li>为每个线程分配要下载的文件的位置</li>
<li>在本地创建同等大小的文件区域</li>
<li>从服务器下载文件的某一段数据</li>
<li>每个线程下载指定位置的数据并写入文件对应的位置</li>
</ol>
<h3 id="为每个线程分配要下载的文件的位置"><a href="#为每个线程分配要下载的文件的位置" class="headerlink" title="为每个线程分配要下载的文件的位置"></a>为每个线程分配要下载的文件的位置</h3><p><img src="/images/android/network/android-network-multidownload-dispatcher.png"></p>
<h3 id="在本地创建同等大小的文件区域"><a href="#在本地创建同等大小的文件区域" class="headerlink" title="在本地创建同等大小的文件区域"></a>在本地创建同等大小的文件区域</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 创建文件，大小与待下载的文件大小一致</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> objPath 创建文件文件名，包含完整路径</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> fileLength 文件的长度</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createFile</span><span class="params">(String  objPath,<span class="keyword">long</span> fileLength)</span> </span>&#123;</span><br><span class="line">	RandomAccessFile raf = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		raf = <span class="keyword">new</span> RandomAccessFile(objPath, <span class="string">&quot;rwd&quot;</span>);</span><br><span class="line">		raf.setLength(fileLength);</span><br><span class="line">		raf.close();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="从服务器下载文件的某一段数据"><a href="#从服务器下载文件的某一段数据" class="headerlink" title="从服务器下载文件的某一段数据"></a>从服务器下载文件的某一段数据</h3><p>在HTTP协议中， RequestProperty <code>Range</code>用于指定下载文件片段的范围<br>格式为<code>&quot;bytes=&lt;开始位置&gt;-&lt;结束位置&gt;&quot;</code><br>一旦设定了Range属性，服务器会返回 206，表示支持部分下载。<br>不设定Range属性，服务器返回 200，表示连接正常, 可以下载。</p>
<p>因此发送请求的格式为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//downloadUrl为下载文件的网址</span></span><br><span class="line">URL url = <span class="keyword">new</span> URL(downloadUrl);</span><br><span class="line"><span class="comment">//打开远程连接</span></span><br><span class="line">HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">conn.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line"><span class="comment">//设置下载的位置</span></span><br><span class="line">conn.setRequestProperty(<span class="string">&quot;Range&quot;</span>, <span class="string">&quot;bytes=&quot;</span> + startPosition + <span class="string">&quot;-&quot;</span> + endPosition);</span><br><span class="line"><span class="keyword">if</span> (<span class="number">206</span> == conn.getResponseCode())</span><br><span class="line"><span class="comment">// DO SOMETHING</span></span><br></pre></td></tr></table></figure>
<h3 id="每个线程下载指定位置的数据并写入文件对应的位置"><a href="#每个线程下载指定位置的数据并写入文件对应的位置" class="headerlink" title="每个线程下载指定位置的数据并写入文件对应的位置"></a>每个线程下载指定位置的数据并写入文件对应的位置</h3><p>衔接上一段程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从打开的连接读入输入流</span></span><br><span class="line">InputStream inputStream = conn.getInputStream();</span><br><span class="line"><span class="comment">// 创建写入文件的RandomAccessFile对象</span></span><br><span class="line">RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(objPath, <span class="string">&quot;rwd&quot;</span>);</span><br><span class="line"><span class="comment">//随机写文件，跳到相应的位置</span></span><br><span class="line">raf.seek(startPosition);</span><br><span class="line"><span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> lenCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line"><span class="keyword">while</span> ((len = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">	lenCount += len;</span><br><span class="line">	raf.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//最后记得关闭掉输入流</span></span><br><span class="line">raf.close();</span><br><span class="line">inputStream.close();</span><br></pre></td></tr></table></figure>


<h3 id="RandomAccessFile"><a href="#RandomAccessFile" class="headerlink" title="RandomAccessFile"></a>RandomAccessFile</h3><p>RandomAccessFile是一个强大的随机文件读写API，创建该对象时的参数设置为<code>&quot;rwd&quot;</code>表示立即写入硬盘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">RandomAccessFile</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RandomAccessFile</span><span class="params">(File file,</span></span></span><br><span class="line"><span class="function"><span class="params">                        String mode)</span></span></span><br><span class="line"><span class="function">                 <span class="keyword">throws</span> FileNotFoundException</span></span><br><span class="line"><span class="function">创建从中读取和向其中写入（可选）的随机访问文件流，该文件由 File 参数指定。将创建一个新的 FileDescriptor 对象来表示此文件的连接。</span></span><br><span class="line"><span class="function">mode 参数指定用以打开文件的访问模式。允许的值及其含意为：</span></span><br><span class="line"><span class="function">值含意</span></span><br><span class="line"><span class="function">&quot;r&quot;	以只读方式打开。调用结果对象的任何 write 方法都将导致抛出 IOException。</span></span><br><span class="line"><span class="function">&quot;rw&quot;	打开以便读取和写入。如果该文件尚不存在，则尝试创建该文件。</span></span><br><span class="line"><span class="function">&quot;rws&quot;	打开以便读取和写入，对于 &quot;rw&quot;，还要求对文件的内容或元数据的每个更新都同步写入到底层存储设备。</span></span><br><span class="line"><span class="function">&quot;rwd&quot;  	打开以便读取和写入，对于 &quot;rw&quot;，还要求对文件内容的每个更新都同步写入到底层存储设备。 &quot;rws&quot; 和 &quot;rwd&quot; 模式的工作方式极其类似 FileChannel 类的 <span class="title">force</span><span class="params">(<span class="keyword">boolean</span>)</span> 方法，分别传递 <span class="keyword">true</span> 和 <span class="keyword">false</span> 参数，除非它们始终应用于每个 I/O 操作，并因此通常更为高效。如果该文件位于本地存储设备上，那么当返回此类的一个方法的调用时，可以保证由该调用对此文件所做的所有更改均被写入该设备。这对确保在系统崩溃时不会丢失重要信息特别有用。如果该文件不在本地设备上，则无法提供这样的保证。</span></span><br><span class="line"><span class="function">&quot;rwd&quot; 模式可用于减少执行的 I/O 操作数量。使用 &quot;rwd&quot; 仅要求更新要写入存储的文件的内容；使用 &quot;rws&quot; 要求更新要写入的文件内容及其元数据，这通常要求至少一个以上的低级别 I/O 操作。</span></span><br><span class="line"><span class="function">如果存在安全管理器，则使用 file 参数的路径名作为其参数调用它的 checkRead 方法，以查看是否允许对该文件进行读取访问。如果该模式允许写入，那么还使用该路径参数调用该安全管理器的 checkWrite 方法，以查看是否允许对该文件进行写入访问。</span></span><br><span class="line"><span class="function">参数：</span></span><br><span class="line"><span class="function">file - 该文件对象</span></span><br><span class="line"><span class="function">mode - 访问模式，如 上所述</span></span><br><span class="line"><span class="function">抛出：</span></span><br><span class="line"><span class="function">IllegalArgumentException - 如果此模式参数与 &quot;r&quot;、 &quot;rw&quot;、 &quot;rws&quot; 或 &quot;rwd&quot; 的其中一个不相等</span></span><br><span class="line"><span class="function">FileNotFoundException - 如果该模式为 &quot;r&quot;，但给定的文件对象不表示一个现有的常规文件，或者该模式以 &quot;rw&quot; 开头，但给定的文件对象不表示一个现有的可写常规文件，而且无法创建具有该名称的新常规文件，或者在打开或创建该文件时发生一些其他错误</span></span><br><span class="line"><span class="function">SecurityException - 如果存在安全管理器，并且其 checkRead 方法拒绝对该文件的读取访问，或者该模式为 &quot;rw&quot;，并且该安全管理器的 checkWrite 方法拒绝对该文件的写入访问</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seek</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">seek</span><span class="params">(<span class="keyword">long</span> pos)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> IOException</span></span><br></pre></td></tr></table></figure>
<p>seek是个牛逼的，像一个游标，跳到指定的位置写数据</p>
<h2 id="断点下载"><a href="#断点下载" class="headerlink" title="断点下载"></a>断点下载</h2><p>当下载大文件时，异常下载中断或暂停下载， 为了防止造成下载资源浪费，为每一个线程提供一个记录，用于记住已经下载文件的位置。当再次启动下载时，读取记录，从中断位置继续下载。</p>
<p>为了兼容不同设备(PC和Android)存储记录文件，本文定义一个接口为不同的存储提供不同的对象，类似于适配器模式.</p>
<ul>
<li>SameDirFileBreakPointManager： 在目标文件同目录下建立记录文件(PC和Android)</li>
<li>SqliteBreakPointManager： 使用Sqlite记录(Android)</li>
<li>PropertyFileBreakPointManager：使用SharedPerferences记录(Android)</li>
</ul>
<p><img src="/images/android/network/android-network-multidownload-breakpointmanager-uml.png"></p>
<p>工程的调用关系</p>
<p><img src="/images/android/network/android-network-multidownload-uml.png"></p>
<pre><code>参考文献</code></pre>
<ol>
<li><a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1sjOMIgl" title="Android network 项目工程">itheima的教程</a> (密码: yfqk)</li>
</ol>
<p><img src="/images/android/network/android-network-multidownload-itheima.png"></p>
<ol start="2">
<li><a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1qW89zyc">SimpleServer源码</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/multithread/running-in-turn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/multithread/running-in-turn/" class="post-title-link" itemprop="url">多线程等待的N中打开方式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-08-29 00:00:00" itemprop="dateCreated datePublished" datetime="2015-08-29T00:00:00+08:00">2015-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2个线程轮流输出"><a href="#2个线程轮流输出" class="headerlink" title="2个线程轮流输出"></a>2个线程轮流输出</h1><p> A、B两个线程轮流输出1~100的数字<br/><br> A线程输出: 1、3、5…47、49、    52、54…98、100 <br/><br> B线程输出: 2、4、6…48、50、51、53、55…97、99 两个线程输出个数相同</p>
<blockquote>
<p>分析：</p>
<ol>
<li>每个线程持有一把锁，运行时，首先获取自己的锁，运行完释放另一个线程的锁</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A、B两个线程轮流输出1~100的数字&lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * A线程输出: 1、3、5...47、49、    52、54...98、100 &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * B线程输出: 2、4、6...48、50、51、53、55...97、99 两个线程输出个数相同</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunningInTurn</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每个线程 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Semaphore thisSemaphore;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Semaphore nextSemaphore;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Worker</span><span class="params">(String name, Semaphore thisSemaphore, Semaphore nextSemaphore, <span class="keyword">int</span> initialValue)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">this</span>.thisSemaphore = thisSemaphore;</span><br><span class="line">            <span class="keyword">this</span>.nextSemaphore = nextSemaphore;</span><br><span class="line">            <span class="keyword">this</span>.value = initialValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (value &lt;= <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    thisSemaphore.acquire();</span><br><span class="line">                    System.out.println(name + <span class="string">&quot;:\t&quot;</span> + value);</span><br><span class="line">                    cnt++;</span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="number">50</span>) &#123;</span><br><span class="line">                        value = <span class="number">51</span>;</span><br><span class="line">                        System.out.println(name + <span class="string">&quot;:\t&quot;</span> + value);</span><br><span class="line">                        cnt++;</span><br><span class="line">                        value += <span class="number">2</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value == <span class="number">49</span>) &#123;</span><br><span class="line">                        value = <span class="number">52</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        value += <span class="number">2</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    nextSemaphore.release();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(name + <span class="string">&quot; cnt : &quot;</span> + cnt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Semaphore aSemaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">        Semaphore bSemaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">        Worker workerA = <span class="keyword">new</span> Worker(<span class="string">&quot;a&quot;</span>, aSemaphore, bSemaphore, <span class="number">1</span>);</span><br><span class="line">        Worker workerB = <span class="keyword">new</span> Worker(<span class="string">&quot;b&quot;</span>, bSemaphore, aSemaphore, <span class="number">2</span>);</span><br><span class="line">        bSemaphore.acquire();</span><br><span class="line">        workerA.start();</span><br><span class="line">        workerB.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/multithread/02.Lock-Semaphore-Atomic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/multithread/02.Lock-Semaphore-Atomic/" class="post-title-link" itemprop="url">Java多线程2: Lock、信号量、原子量与队列</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-08-29 00:00:00" itemprop="dateCreated datePublished" datetime="2015-08-29T00:00:00+08:00">2015-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-09 09:52:14" itemprop="dateModified" datetime="2021-02-09T09:52:14+08:00">2021-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/Java/advanced-engineer-outline/">&lt;&lt;Java高级软件工程师知识结构</a></p>
<pre><code>Java多线程是Java基础的重要的一部分，支持多线程是Java的重要特性之一. 主要包括如下内容:</code></pre>
<blockquote>
<ol>
<li><a href="/Java/multithread/01.base/">Java多线程1: 线程生命周期和多线程基础</a></li>
<li><a href="/Java/multithread/02.Lock-Semaphore-Atomic/">Java多线程2: Lock、信号量、原子量与队列</a></li>
<li><a href="/Java/multithread/03.volatile/">Java多线程3: volatile</a></li>
<li><a href="/Java/multithread/04.thread-synchronization/">Java多线程4: 同步锁与Java线程同步方法比较</a></li>
<li><a href="/Java/multithread/05.ThreadPool/">Java多线程5: 线程池</a></li>
<li><a href="/Java/multithread/06.BlockingQueue/">Java多线程6: Java阻塞队列与生产者消费者模式</a></li>
</ol>
</blockquote>
<p>更详细内容请参考博文 <a target="_blank" rel="noopener" href="http://www.cnblogs.com/dolphin0520/p/3923167.html">Java并发编程：Lock</a></p>
<p>Sun在Java5中, 对Java线程的类库做了大量的扩展</p>
<h1 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h1><p>在<code>java.util.concurrent.locks</code> 包下面, 里面有三个重要的接口<code>Condition</code>、<code>Lock</code>、<code>ReadWriteLock</code>.</p>
<h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p><code>Condition</code> 将 Object 监视器方法（<code>wait</code>、<code>notify</code> 和 <code>notifyAll</code>）分解成截然不同的对象, 以便通过将这些对象与任意 <code>Lock</code> 实现组合使用, 为每个对象提供多个等待 <code>set</code> （<code>wait-set</code>）.</p>
<h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><p><code>Lock</code>实现提供了比使用 <code>synchronized</code> 方法和语句可获得的更广泛的锁定操作.</p>
<h2 id="ReadWriteLock"><a href="#ReadWriteLock" class="headerlink" title="ReadWriteLock"></a>ReadWriteLock</h2><p><code>ReadWriteLock</code>维护了一对相关的锁定, 一个用于只读操作, 另一个用于写入操作.</p>
<h2 id="Lock-与-synchronized的区别"><a href="#Lock-与-synchronized的区别" class="headerlink" title="Lock 与 synchronized的区别"></a>Lock 与 synchronized的区别</h2><p>见文献 <a target="_blank" rel="noopener" href="http://blog.csdn.net/natian306/article/details/18504111">深入研究 Java Synchronize 和 Lock 的区别与用法</a></p>
<ol>
<li><p>用法上的区别<br><code>synchronized</code>可以加在方法或代码块上，而<code>Lock</code>必须指定起始位置，一般使用<code>ReentrantLock</code>类做为锁，多个线程中必须要使用一个<code>ReentrantLock</code>类做为对象才能保证锁的生效。且在加锁和解锁处需要通过<code>lock()</code>和<code>unlock()</code>显式指出。所以一般会在<code>finally</code>块中写<code>unlock()</code>以防死锁。</p>
<ol>
<li>ReentrantLock非阻塞</li>
<li>ReentrantLock CAS实现无锁</li>
<li>可以指定等待时间，可以中断</li>
<li>公平锁：按照申请顺序</li>
<li>可以指定条件</li>
<li><code>await</code>必须与<code>while</code>一起使用  </li>
<li>Lock可以知道线程有没有成功获取到锁。这个是synchronized无法办到的</li>
<li>synchronized在发生异常时，会自动释放线程占有的锁，不会导致死锁现象发生；<br>而Lock在发生异常时，如果没有主动通过unLock()去释放锁，则很可能造成死锁现象，因此使用Lock时需要在finally块中释放锁；</li>
</ol>
</li>
<li><p>性能上的区别<br><code>synchronized</code>是托管给JVM执行的，而lock是java写的控制锁的代码。<code>synchronized</code>是悲观锁，线程获取到的是<code>独占锁</code>。独占锁意味着其他线程只能依靠阻塞来等待线程释放锁。多个线程竞争资源，CPU频繁切换效率变低。</p>
<p><code>Lock</code>使用的是乐观锁，乐观锁就是CAS，调用CPU的指令，效率比较高。是非阻塞算法。 每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。乐观锁实现的机制就是CAS操作（Compare and Swap）。获得锁的一个方法是compareAndSetState. CPU提供了指令，可以自动更新共享数据，而且能够检测到其他线程的干扰，而 compareAndSet() 就用这些代替了锁定。这个算法称作<code>非阻塞算法</code>，意思是一个线程的失败或者挂起不应该影响其他线程的失败或挂起的算法。</p>
</li>
<li><p>用途上的区别<br>高并发情况下，比较适合使用Lock，特别是在下面的情况下:</p>
<ul>
<li>某个线程在等待一个锁的控制权的这段时间需要中断</li>
<li>需要分开处理一些<code>wait-notify</code>，<code>ReentrantLock</code>里面的<code>Condition</code>应用，能够控制<code>notify</code>哪个线程</li>
<li>具有公平锁功能，每个到来的线程都将排队等候</li>
</ul>
</li>
</ol>
<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p>ReentrantLock是唯一实现了Lock接口的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建并发访问的账户</span></span><br><span class="line">MyCount myCount = <span class="keyword">new</span> MyCount(<span class="string">&quot;95599200901215522&quot;</span>, <span class="number">10000</span>);</span><br><span class="line"><span class="comment">//创建一个锁对象</span></span><br><span class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="comment">//创建一个线程池</span></span><br><span class="line">ExecutorService pool = Executors.newCachedThreadPool();</span><br><span class="line"><span class="comment">//创建一些并发访问用户, 一个信用卡, 存的存, 取的取, 好热闹啊</span></span><br><span class="line">User u1 = <span class="keyword">new</span> User(<span class="string">&quot;张三&quot;</span>, myCount, -<span class="number">4000</span>, lock);</span><br><span class="line">User u2 = <span class="keyword">new</span> User(<span class="string">&quot;张三他爹&quot;</span>, myCount, <span class="number">6000</span>, lock);</span><br><span class="line">User u3 = <span class="keyword">new</span> User(<span class="string">&quot;张三他弟&quot;</span>, myCount, -<span class="number">8000</span>, lock);</span><br><span class="line">User u4 = <span class="keyword">new</span> User(<span class="string">&quot;张三&quot;</span>, myCount, <span class="number">800</span>, lock);</span><br><span class="line"><span class="comment">//在线程池中执行各个用户的操作</span></span><br><span class="line">pool.execute(u1);</span><br><span class="line">pool.execute(u2);</span><br><span class="line">pool.execute(u3);</span><br><span class="line">pool.execute(u4);</span><br><span class="line"><span class="comment">//关闭线程池</span></span><br><span class="line">pool.shutdown();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 信用卡的用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;                <span class="comment">//用户名</span></span><br><span class="line">  <span class="keyword">private</span> MyCount myCount;        <span class="comment">//所要操作的账户</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> iocash;                 <span class="comment">//操作的金额, 当然有正负之分了</span></span><br><span class="line">  <span class="keyword">private</span> Lock myLock;                <span class="comment">//执行操作所需的锁对象</span></span><br><span class="line">  User(String name, MyCount myCount, <span class="keyword">int</span> iocash, Lock myLock) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.myCount = myCount;</span><br><span class="line">    <span class="keyword">this</span>.iocash = iocash;</span><br><span class="line">    <span class="keyword">this</span>.myLock = myLock;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取锁</span></span><br><span class="line">    myLock.lock();</span><br><span class="line">    <span class="comment">//执行现金业务</span></span><br><span class="line">    System.out.println(name + <span class="string">&quot;正在操作&quot;</span> + myCount + <span class="string">&quot;账户, 金额为&quot;</span> + iocash + <span class="string">&quot;, 当前金额为&quot;</span> + myCount.getCash());</span><br><span class="line">    myCount.setCash(myCount.getCash() + iocash);</span><br><span class="line">    System.out.println(name + <span class="string">&quot;操作&quot;</span> + myCount + <span class="string">&quot;账户成功, 金额为&quot;</span> + iocash + <span class="string">&quot;, 当前金额为&quot;</span> + myCount.getCash());</span><br><span class="line">    <span class="comment">//释放锁, 否则别的线程没有机会执行了</span></span><br><span class="line">    myLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 信用卡账户, 可随意透支</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCount</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String oid;         <span class="comment">//账号</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> cash;             <span class="comment">//账户余额</span></span><br><span class="line">  MyCount(String oid, <span class="keyword">int</span> cash) &#123;</span><br><span class="line">          <span class="keyword">this</span>.oid = oid;</span><br><span class="line">          <span class="keyword">this</span>.cash = cash;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getOid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> oid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOid</span><span class="params">(String oid)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.oid = oid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> cash;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCash</span><span class="params">(<span class="keyword">int</span> cash)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.cash = cash;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;MyCount&#123;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;oid=&#x27;&quot;</span> + oid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&quot;, cash=&quot;</span> + cash +</span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程的中断"><a href="#线程的中断" class="headerlink" title="线程的中断"></a>线程的中断</h3><p>Java线程中的中断，提供了三个方法:</p>
<ul>
<li>interrupt()<br>  通知线程中断, 但是线程不会立即中断, 只会将interrupt标志位设置为  true, 当在线程中获取到这个标志位时自行判断</li>
<li>interrupted()<br>  判断是否中断, 如果未中断, 立即设置为中断</li>
<li>isInterrupted()<br>  判断是否中断</li>
</ul>
<p>这三个方法都不能使线程中断执行。而ReetrantLock提供了响应的方案。</p>
<p>ReentrantLock的lock机制有2种，忽略中断锁和响应中断锁，这给我们带来了很大的灵活性。</p>
<p>比如：如果A、B2个线程去竞争锁，A线程得到了锁，B线程等待，但是A线程这个时候实在有太多事情要处理，就是一直不返回，B线程可能就会等不及了，想中断自己，不再等待这个锁了，转而处理其他事情。这个时候ReentrantLock就提供了2种机制，</p>
<ul>
<li>第一，B线程中断自己（或者别的线程中断它），但是ReentrantLock不去响应，继续让B线程等待，你再怎么中断，我全当耳边风（synchronized原语就是如此）；Lock.lock()也不会响应中断操作</li>
<li>第二，B线程中断自己（或者别的线程中断它），ReentrantLock处理了这个中断，并且不再等待这个锁的到来，完全放弃。<br>  在Thread类中使用lock.lockInterruptibly();锁定时可以响应中断操作，当调用Thread.interupt()方法，该lock会放弃锁定，抛出InterruptedException异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> isProcess = <span class="keyword">false</span>;</span><br><span class="line">ReentrantLock lock  = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">Condition processReady = lock.newCondition();</span><br><span class="line">thread: run() &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    isProcess = <span class="keyword">true</span>;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(!isProcessReady) &#123;  </span><br><span class="line">    <span class="comment">//isProcessReady 是另外一个线程的控制变量</span></span><br><span class="line">      processReady.await();</span><br><span class="line">      <span class="comment">//释放了lock，在此等待signal</span></span><br><span class="line">     &#125;<span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          Thread.currentThread().interrupt();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          lock.unlock();</span><br><span class="line">          isProcess = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line">        Test test = <span class="keyword">new</span> Test();</span><br><span class="line">        MyThread thread1 = <span class="keyword">new</span> MyThread(test);</span><br><span class="line">        MyThread thread2 = <span class="keyword">new</span> MyThread(test);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        thread2.interrupt();</span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Thread thread)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        lock.lockInterruptibly();   </span><br><span class="line">        <span class="comment">//注意，如果需要正确中断等待锁的线程，必须将获取锁放在外面，然后将InterruptedException抛出</span></span><br><span class="line">        <span class="keyword">try</span> &#123;   </span><br><span class="line">            System.out.println(thread.getName()+<span class="string">&quot;得到了锁&quot;</span>);</span><br><span class="line">            <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span>(    ;     ;) &#123;</span><br><span class="line">                <span class="keyword">if</span>(System.currentTimeMillis() - startTime &gt;= Integer.MAX_VALUE)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//插入数据</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;执行finally&quot;</span>);</span><br><span class="line">            lock.unlock();</span><br><span class="line">            System.out.println(thread.getName()+<span class="string">&quot;释放了锁&quot;</span>);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Test test = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(Test test)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.test = test;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;       </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            test.insert(Thread.currentThread());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;被中断&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="读写锁-ReadWriteLock"><a href="#读写锁-ReadWriteLock" class="headerlink" title="读写锁 ReadWriteLock"></a>读写锁 ReadWriteLock</h2><p>为了提高性能, Java提供了读写锁, 在读的地方使用读锁, 在写的地方使用写锁, 灵活控制, 在一定程度上提高了程序的执行效率.<br>Java中读写锁有个接口<code>java.util.concurrent.locks.ReadWriteLock</code>, 也有具体的实现<code>ReentrantReadWriteLock</code></p>
<p>ReadWriteLock也是一个接口，在它里面只定义了两个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReadWriteLock</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the lock used for reading.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the lock used for reading.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Lock <span class="title">readLock</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the lock used for writing.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the lock used for writing.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">Lock <span class="title">writeLock</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ReentrantReadWriteLock里面提供了很多丰富的方法，不过最主要的有两个方法：readLock()和writeLock()用来获取读锁和写锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建并发访问的账户</span></span><br><span class="line">MyCount myCount = <span class="keyword">new</span> MyCount(<span class="string">&quot;95599200901215522&quot;</span>, <span class="number">10000</span>);</span><br><span class="line"><span class="comment">//创建一个锁对象</span></span><br><span class="line">ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">//创建一个线程池</span></span><br><span class="line">ExecutorService pool = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//创建一些并发访问用户, 一个信用卡, 存的存, 取的取, 好热闹啊</span></span><br><span class="line">User u1 = <span class="keyword">new</span> User(<span class="string">&quot;张三&quot;</span>, myCount, -<span class="number">4000</span>, lock, <span class="keyword">false</span>);</span><br><span class="line">User u2 = <span class="keyword">new</span> User(<span class="string">&quot;张三他爹&quot;</span>, myCount, <span class="number">6000</span>, lock, <span class="keyword">false</span>);</span><br><span class="line">User u3 = <span class="keyword">new</span> User(<span class="string">&quot;张三他弟&quot;</span>, myCount, -<span class="number">8000</span>, lock, <span class="keyword">false</span>);</span><br><span class="line">User u4 = <span class="keyword">new</span> User(<span class="string">&quot;张三&quot;</span>, myCount, <span class="number">800</span>, lock, <span class="keyword">false</span>);</span><br><span class="line">User u5 = <span class="keyword">new</span> User(<span class="string">&quot;张三他爹&quot;</span>, myCount, <span class="number">0</span>, lock, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//在线程池中执行各个用户的操作</span></span><br><span class="line">pool.execute(u1);</span><br><span class="line">pool.execute(u2);</span><br><span class="line">pool.execute(u3);</span><br><span class="line">pool.execute(u4);</span><br><span class="line">pool.execute(u5);</span><br><span class="line"><span class="comment">//关闭线程池</span></span><br><span class="line">pool.shutdown();</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 信用卡的用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;                <span class="comment">//用户名</span></span><br><span class="line">  <span class="keyword">private</span> MyCount myCount;        <span class="comment">//所要操作的账户</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> iocash;                 <span class="comment">//操作的金额, 当然有正负之分了</span></span><br><span class="line">  <span class="keyword">private</span> ReadWriteLock myLock;                <span class="comment">//执行操作所需的锁对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> ischeck;        <span class="comment">//是否查询</span></span><br><span class="line">  User(String name, MyCount myCount, <span class="keyword">int</span> iocash, ReadWriteLock myLock, <span class="keyword">boolean</span> ischeck) &#123;</span><br><span class="line">          <span class="keyword">this</span>.name = name;</span><br><span class="line">          <span class="keyword">this</span>.myCount = myCount;</span><br><span class="line">          <span class="keyword">this</span>.iocash = iocash;</span><br><span class="line">          <span class="keyword">this</span>.myLock = myLock;</span><br><span class="line">          <span class="keyword">this</span>.ischeck = ischeck;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ischeck) &#123;</span><br><span class="line">            <span class="comment">//获取读锁</span></span><br><span class="line">            myLock.readLock().lock();</span><br><span class="line">            System.out.println(<span class="string">&quot;读：&quot;</span> + name + <span class="string">&quot;正在查询&quot;</span> + myCount + <span class="string">&quot;账户, 当前金额为&quot;</span> + myCount.getCash());</span><br><span class="line">            <span class="comment">//释放读锁</span></span><br><span class="line">            myLock.readLock().unlock();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//获取写锁</span></span><br><span class="line">            myLock.writeLock().lock();</span><br><span class="line">            <span class="comment">//执行现金业务</span></span><br><span class="line">            System.out.println(<span class="string">&quot;写：&quot;</span> + name + <span class="string">&quot;正在操作&quot;</span> + myCount + <span class="string">&quot;账户, 金额为&quot;</span> + iocash + <span class="string">&quot;, 当前金额为&quot;</span> + myCount.getCash());</span><br><span class="line">            myCount.setCash(myCount.getCash() + iocash);</span><br><span class="line">            System.out.println(<span class="string">&quot;写：&quot;</span> + name + <span class="string">&quot;操作&quot;</span> + myCount + <span class="string">&quot;账户成功, 金额为&quot;</span> + iocash + <span class="string">&quot;, 当前金额为&quot;</span> + myCount.getCash());</span><br><span class="line">            <span class="comment">//释放写锁</span></span><br><span class="line">            myLock.writeLock().unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 信用卡账户, 可随意透支</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCount</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String oid;         <span class="comment">//账号</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> cash;             <span class="comment">//账户余额</span></span><br><span class="line">        MyCount(String oid, <span class="keyword">int</span> cash) &#123;</span><br><span class="line">                <span class="keyword">this</span>.oid = oid;</span><br><span class="line">                <span class="keyword">this</span>.cash = cash;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getOid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> oid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOid</span><span class="params">(String oid)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.oid = oid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> cash;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCash</span><span class="params">(<span class="keyword">int</span> cash)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.cash = cash;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&quot;MyCount&#123;&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;oid=&#x27;&quot;</span> + oid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                          <span class="string">&quot;, cash=&quot;</span> + cash +</span><br><span class="line">                          <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="条件变量-Condition"><a href="#条件变量-Condition" class="headerlink" title="条件变量 Condition"></a>条件变量 Condition</h1><p>条件变量就是表示条件的一种变量. 但是必须说明, 这里的条件是没有实际含义的, 仅仅是个标记而已, 并且条件的含义往往通过代码来赋予其含义.</p>
<p>条件变量都实现了<code>java.util.concurrent.locks.Condition</code>接口, 条件变量的实例化是<strong>通过一个<code>Lock</code>对象上调用<code>newCondition()</code>方法</strong>来获取的, 这样, 条件就和一个锁对象绑定起来了. 因此, Java中的条件变量只能和锁配合使用, 来控制并发程序访问竞争资源的安全.</p>
<p>在Java5中, 一个锁可以有多个条件, 每个条件上可以有多个线程等待, 通过调用<code>await()</code>方法, 可以让线程在该条件下等待. 当调用<code>signalAll()</code>方法, 又可以唤醒该条件下的等待的线程.</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>有一个账户, 多个用户（线程）在同时操作这个账户, 有的存款有的取款, 存款随便存, 取款有限制, 不能透支, 任何试图透支的操作都将等待里面有足够存款才执行操作.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建并发访问的账户</span></span><br><span class="line">MyCount myCount = <span class="keyword">new</span> MyCount(<span class="string">&quot;95599200901215522&quot;</span>, <span class="number">10000</span>);</span><br><span class="line"><span class="comment">//创建一个线程池</span></span><br><span class="line">ExecutorService pool = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">Thread t1 = <span class="keyword">new</span> SaveThread(<span class="string">&quot;张三&quot;</span>, myCount, <span class="number">2000</span>);</span><br><span class="line">Thread t2 = <span class="keyword">new</span> SaveThread(<span class="string">&quot;李四&quot;</span>, myCount, <span class="number">3600</span>);</span><br><span class="line">Thread t3 = <span class="keyword">new</span> DrawThread(<span class="string">&quot;王五&quot;</span>, myCount, <span class="number">2700</span>);</span><br><span class="line">Thread t4 = <span class="keyword">new</span> SaveThread(<span class="string">&quot;老张&quot;</span>, myCount, <span class="number">600</span>);</span><br><span class="line">Thread t5 = <span class="keyword">new</span> DrawThread(<span class="string">&quot;老牛&quot;</span>, myCount, <span class="number">1300</span>);</span><br><span class="line">Thread t6 = <span class="keyword">new</span> DrawThread(<span class="string">&quot;胖子&quot;</span>, myCount, <span class="number">800</span>);</span><br><span class="line"><span class="comment">//执行各个线程</span></span><br><span class="line">pool.execute(t1);</span><br><span class="line">pool.execute(t2);</span><br><span class="line">pool.execute(t3);</span><br><span class="line">pool.execute(t4);</span><br><span class="line">pool.execute(t5);</span><br><span class="line">pool.execute(t6);</span><br><span class="line"><span class="comment">//关闭线程池</span></span><br><span class="line">pool.shutdown();</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 存款线程类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SaveThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;     <span class="comment">//操作人</span></span><br><span class="line">  <span class="keyword">private</span> MyCount myCount; <span class="comment">//账户</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> x;   <span class="comment">//存款金额</span></span><br><span class="line">  SaveThread(String name, MyCount myCount, <span class="keyword">int</span> x) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.myCount = myCount;</span><br><span class="line">    <span class="keyword">this</span>.x = x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    myCount.saving(x, name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取款线程类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name; <span class="comment">//操作人</span></span><br><span class="line">  <span class="keyword">private</span> MyCount myCount; <span class="comment">//账户</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> x; <span class="comment">//存款金额</span></span><br><span class="line">  DrawThread(String name, MyCount myCount, <span class="keyword">int</span> x) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.myCount = myCount;</span><br><span class="line">    <span class="keyword">this</span>.x = x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    myCount.drawing(x, name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 普通银行账户, 不可透支</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCount</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String oid;                         <span class="comment">//账号</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> cash;                             <span class="comment">//账户余额</span></span><br><span class="line">  <span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();                <span class="comment">//账户锁</span></span><br><span class="line">  <span class="keyword">private</span> Condition _save = lock.newCondition();    <span class="comment">//存款条件</span></span><br><span class="line">  <span class="keyword">private</span> Condition _draw = lock.newCondition();    <span class="comment">//取款条件</span></span><br><span class="line">  MyCount(String oid, <span class="keyword">int</span> cash) &#123;</span><br><span class="line">    <span class="keyword">this</span>.oid = oid;</span><br><span class="line">    <span class="keyword">this</span>.cash = cash;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 存款</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> x        操作金额</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> name 操作人</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saving</span><span class="params">(<span class="keyword">int</span> x, String name)</span> </span>&#123;</span><br><span class="line">    lock.lock();                        <span class="comment">//获取锁</span></span><br><span class="line">    <span class="keyword">if</span> (x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      cash += x;                    <span class="comment">//存款</span></span><br><span class="line">      System.out.println(name + <span class="string">&quot;存款&quot;</span> + x + <span class="string">&quot;, 当前余额为&quot;</span> + cash);</span><br><span class="line">    &#125;</span><br><span class="line">    _draw.signalAll();            <span class="comment">//唤醒所有等待线程.</span></span><br><span class="line">    lock.unlock();                    <span class="comment">//释放锁</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 取款</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> x        操作金额</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> name 操作人</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawing</span><span class="params">(<span class="keyword">int</span> x, String name)</span> </span>&#123;</span><br><span class="line">    lock.lock();                                 <span class="comment">//获取锁</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (cash - x &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            _draw.await();             <span class="comment">//阻塞取款操作</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cash -= x;                     <span class="comment">//取款</span></span><br><span class="line">            System.out.println(name + <span class="string">&quot;取款&quot;</span> + x + <span class="string">&quot;, 当前余额为&quot;</span> + cash);</span><br><span class="line">          &#125;</span><br><span class="line">          _save.signalAll();             <span class="comment">//唤醒所有存款操作</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();                     <span class="comment">//释放锁</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h1><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/shihuacai/article/details/8856370">参考来源：未引入样例</a></p>
<p> 一个同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许一个或多个线程一直等待。用给定的计数初始化 CountDownLatch。由于调用了 countDown() 方法，所以在当前计数到达零之前，await 方法会一直受阻塞。之后，会释放所有等待的线程，await 的所有后续调用都将立即返回。这种现象只出现一次——计数无法被重置。 一个线程(或者多个)， 等待另外N个线程完成某个事情之后才能执行</p>
<p>在一些应用场合中，需要等待某个条件达到要求后才能做后面的事情；同时当线程都完成后也会触发事件，以便进行后面的操作。 这个时候就可以使用CountDownLatch。CountDownLatch最重要的方法是countDown()和await()，前者主要是倒数一次，后者是等待倒数到0，如果没有到达0，就只有阻塞等待了。</p>
<h2 id="主要方法"><a href="#主要方法" class="headerlink" title="主要方法"></a>主要方法</h2><p>countDown</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">递减锁存器的计数，如果计数到达零，则释放所有等待的线程。如果当前计数大于零，则将计数减少。</span></span><br><span class="line"><span class="function">如果新的计数为零，出于线程调度目的，将重新启用所有的等待线程。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">如果当前计数等于零，则不发生任何操作。</span></span><br></pre></td></tr></table></figure>
<p>await</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">                     TimeUnit unit)</span></span></span><br><span class="line"><span class="function">              <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">使当前线程在锁存器倒计数至零之前一直等待，除非线程被中断或超出了指定的等待时间。</span></span><br><span class="line"><span class="function">如果当前计数为零，则此方法立刻返回 <span class="keyword">true</span> 值。</span></span><br><span class="line"><span class="function">如果当前计数大于零，则出于线程调度目的，将禁用当前线程，</span></span><br><span class="line"><span class="function">且在发生以下三种情况之一前，该线程将一直处于休眠状态：</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">由于调用 <span class="title">countDown</span><span class="params">()</span> 方法，计数到达零；或者其他某个线程中断当前线程；</span></span><br><span class="line"><span class="function">或者已超出指定的等待时间。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">如果计数到达零，则该方法返回 <span class="keyword">true</span> 值。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">如果当前线程：</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">在进入此方法时已经设置了该线程的中断状态；或者在等待时被中断，</span></span><br><span class="line"><span class="function">则抛出 InterruptedException，并且清除当前线程的已中断状态。</span></span><br><span class="line"><span class="function">如果超出了指定的等待时间，则返回值为 <span class="keyword">false</span>。如果该时间小于等于零，则此方法根本不会等待。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">参数：</span></span><br><span class="line"><span class="function">    timeout - 要等待的最长时间</span></span><br><span class="line"><span class="function">    unit - timeout 参数的时间单位。</span></span><br><span class="line"><span class="function">返回：</span></span><br><span class="line"><span class="function">    如果计数到达零，则返回 <span class="keyword">true</span>；如果在计数到达零之前超过了等待时间，则返回 <span class="keyword">false</span></span></span><br><span class="line"><span class="function">抛出：</span></span><br><span class="line"><span class="function">    InterruptedException - 如果当前线程在等待时被中断</span></span><br></pre></td></tr></table></figure>


<h2 id="在控制访问量上的应用"><a href="#在控制访问量上的应用" class="headerlink" title="在控制访问量上的应用"></a>在控制访问量上的应用</h2><h1 id="信号量-Semaphore"><a href="#信号量-Semaphore" class="headerlink" title="信号量 Semaphore"></a>信号量 Semaphore</h1><p>Java的信号量实际上是一个功能完备的计数器, 对控制一定资源的消费与回收有着很重要的意义, 信号量常常用于多线程的代码中, 并能监控有多少数目的线程等待获取资源, 并且通过信号量可以得知<strong>可用资源的数目</strong>等等, 这里总是在强调“数目”二字, 但不能指出来有哪些在等待, 哪些资源可用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    MyPool myPool = <span class="keyword">new</span> MyPool(<span class="number">20</span>);</span><br><span class="line">    <span class="comment">//创建线程池</span></span><br><span class="line">    ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    MyThread t1 = <span class="keyword">new</span> MyThread(<span class="string">&quot;任务A&quot;</span>, myPool, <span class="number">3</span>);</span><br><span class="line">    MyThread t2 = <span class="keyword">new</span> MyThread(<span class="string">&quot;任务B&quot;</span>, myPool, <span class="number">12</span>);</span><br><span class="line">    MyThread t3 = <span class="keyword">new</span> MyThread(<span class="string">&quot;任务C&quot;</span>, myPool, <span class="number">7</span>);</span><br><span class="line">    <span class="comment">//在线程池中执行任务</span></span><br><span class="line">    threadPool.execute(t1);</span><br><span class="line">    threadPool.execute(t2);</span><br><span class="line">    threadPool.execute(t3);</span><br><span class="line">    <span class="comment">//关闭池</span></span><br><span class="line">    threadPool.shutdown();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Semaphore sp;     <span class="comment">//池相关的信号量</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 池的大小, 这个大小会传递给信号量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> size 池的大小</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  MyPool(<span class="keyword">int</span> size) &#123;</span><br><span class="line">    <span class="keyword">this</span>.sp = <span class="keyword">new</span> Semaphore(size);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Semaphore <span class="title">getSp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sp;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSp</span><span class="params">(Semaphore sp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sp = sp;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String threadname;            <span class="comment">//线程的名称</span></span><br><span class="line">  <span class="keyword">private</span> MyPool pool;                        <span class="comment">//自定义池</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> x;                                    <span class="comment">//申请信号量的大小</span></span><br><span class="line">  MyThread(String threadname, MyPool pool, <span class="keyword">int</span> x) &#123;</span><br><span class="line">    <span class="keyword">this</span>.threadname = threadname;</span><br><span class="line">    <span class="keyword">this</span>.pool = pool;</span><br><span class="line">    <span class="keyword">this</span>.x = x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//从此信号量获取给定数目的许可</span></span><br><span class="line">      pool.getSp().acquire(x);</span><br><span class="line">      <span class="comment">//TODO 也许这里可以做更复杂的业务</span></span><br><span class="line">      System.out.println(threadname + <span class="string">&quot;成功获取了&quot;</span> + x + <span class="string">&quot;个许可！&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">//释放给定数目的许可, 将其返回到信号量.</span></span><br><span class="line">      pool.getSp().release(x);</span><br><span class="line">      System.out.println(threadname + <span class="string">&quot;释放了&quot;</span> + x + <span class="string">&quot;个许可！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h1><h1 id="原子量"><a href="#原子量" class="headerlink" title="原子量"></a>原子量</h1><p>所谓的原子量即操作变量的操作是“原子的”, 该操作不可再分, 因此是线程安全的.<br>为何要使用原子变量呢, 原因是多个线程对单个变量操作也会引起一些问题.<br>Java5之后, 专门提供了用来进行单变量多线程并发安全访问的工具包<code>java.util.concurrent.atomic</code>, 其中的类也很简单.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原子量, 每个线程都可以自由操作</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> AtomicLong aLong = <span class="keyword">new</span> AtomicLong(<span class="number">10000</span>);</span><br><span class="line">lock.lock();</span><br><span class="line">System.out.println(name + <span class="string">&quot;执行了&quot;</span> + x + <span class="string">&quot;, 当前余额：&quot;</span> + aLong.addAndGet(x));</span><br><span class="line">lock.unlock();</span><br></pre></td></tr></table></figure>
<h1 id="锁-1"><a href="#锁-1" class="headerlink" title="锁"></a>锁</h1><h2 id="可重入锁"><a href="#可重入锁" class="headerlink" title="可重入锁"></a>可重入锁</h2><p>如果锁具备可重入性，则称作为可重入锁。像synchronized和ReentrantLock都是可重入锁，<br>可重入性 实际上表明了锁的分配机制：基于线程的分配，而不是基于方法调用的分配。<br>举个简单的例子，当一个线程执行到某个synchronized方法时，比如说method1，而在method1中会调用另外一个synchronized方法method2，<br>此时线程不必重新去申请锁，而是可以直接执行方法method2。</p>
<p>看下面这段代码就明白了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个方法method1和method2都用synchronized修饰了，假如某一时刻，线程A执行到了method1，此时线程A获取了这个对象的锁，<br>而由于method2也是synchronized方法，假如synchronized不具备可重入性，此时线程A需要重新申请锁。但是这就会造成一个问题，<br>因为线程A已经持有了该对象的锁，而又在申请获取该对象的锁，这样就会线程A一直等待永远不会获取到的锁。</p>
<p>由于synchronized和Lock都具备可重入性，所以不会发生上述现象。</p>
<h2 id="可中断锁"><a href="#可中断锁" class="headerlink" title="可中断锁"></a>可中断锁</h2><p>可中断锁：顾名思义，就是可以相应中断的锁。</p>
<p>在Java中，synchronized就不是可中断锁，而Lock是可中断锁。<br>如果某一线程A正在执行锁中的代码，另一线程B正在等待获取该锁，可能由于等待时间过长，线程B不想等待了，想先处理其他事情，<br>可以让它中断自己或者在别的线程中中断它，这种就是可中断锁。<br>lockInterruptibly()的用法时已经体现了Lock的可中断性。</p>
<h2 id="公平锁"><a href="#公平锁" class="headerlink" title="公平锁"></a>公平锁</h2><p>公平锁即尽量以请求锁的顺序来获取锁。比如同是有多个线程在等待一个锁，当这个锁被释放时，等待时间最久的线程（最先请求的线程）会获得该所，这种就是公平锁。</p>
<p>非公平锁即无法保证锁的获取是按照请求锁的顺序进行的。这样就可能导致某个或者一些线程永远获取不到锁。<br>在Java中，synchronized就是非公平锁，它无法保证等待的线程获取锁的顺序。</p>
<p>而对于ReentrantLock和ReentrantReadWriteLock，它默认情况下是非公平锁，但是可以设置为公平锁。</p>
<p>看一下这2个类的源代码就清楚了：</p>
<p><img src="/images/java/multithread/02.lock/1.jpg"></p>
<p>在ReentrantLock中定义了2个静态内部类，一个是<code>NotFairSync</code>，一个是<code>FairSync</code>，分别用来实现非公平锁和公平锁。</p>
<p>我们可以在创建ReentrantLock对象时，通过以下方式来设置锁的公平性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>如果参数为true表示为公平锁，为false为非公平锁。默认情况下，如果使用无参构造器，则是非公平锁。</p>
<p><img src="/images/java/multithread/02.lock/2.jpg"></p>
<p>另外在ReentrantLock类中定义了很多方法，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">isFair() &#x2F;&#x2F;判断锁是否是公平锁</span><br><span class="line">isLocked() &#x2F;&#x2F;判断锁是否被任何线程获取了</span><br><span class="line">isHeldByCurrentThread() &#x2F;&#x2F;判断锁是否被当前线程获取了</span><br><span class="line">hasQueuedThreads() &#x2F;&#x2F;判断是否有线程在等待该锁</span><br></pre></td></tr></table></figure>
<p>在ReentrantReadWriteLock中也有类似的方法，同样也可以设置为公平锁和非公平锁。不过要记住，ReentrantReadWriteLock并未实现Lock接口，它实现的是ReadWriteLock接口。</p>
<h2 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h2><p>读写锁将对一个资源（比如文件）的访问分成了2个锁，一个读锁和一个写锁。<br>正因为有了读写锁，才使得多个线程之间的读操作不会发生冲突。<br>ReadWriteLock就是读写锁，它是一个接口，ReentrantReadWriteLock实现了这个接口。<br>可以通过readLock()获取读锁，通过writeLock()获取写锁。</p>
<h1 id="减少锁带来的开销"><a href="#减少锁带来的开销" class="headerlink" title="减少锁带来的开销"></a>减少锁带来的开销</h1><h2 id="使用Java-API中的并发类库"><a href="#使用Java-API中的并发类库" class="headerlink" title="使用Java API中的并发类库"></a>使用Java API中的并发类库</h2><pre><code>可以采用java.util.concurrent等包下面的并发类，通常它们已经经过了充分的优化，能有效地支持高并发环境下的操作，并发类中大量采用了非阻塞算法，有些利用了CAS实现无锁。这里有一个小提示：使用并发哈希表时应优先采用ConcurrentHashMap而不是Hashtable，前者通过分解锁的方法使得效率更高。</code></pre>
<h2 id="用CAS代替锁"><a href="#用CAS代替锁" class="headerlink" title="用CAS代替锁"></a>用CAS代替锁</h2><pre><code>和第一点中提到的一样，CAS可以减小锁的开销，但是CAS本身是基于轮询的操作，实际使用中反而可能增加开销，这一点需要实验来测试。</code></pre>
<h2 id="减小锁的粒度"><a href="#减小锁的粒度" class="headerlink" title="减小锁的粒度"></a>减小锁的粒度</h2><pre><code>尽可能缩小锁定的范围，可以从两个方面入手。第一是只锁定所需的对象，少用synchronized(this)。第二是尽可能缩小锁定的方法块，缩小临界区大小，避免将不必要的操作也归入临界区。</code></pre>
<h2 id="拆分锁"><a href="#拆分锁" class="headerlink" title="拆分锁"></a>拆分锁</h2><pre><code>将普通的对象锁、互斥锁按照场景拆分为读写锁或像ConcurrentHashMap一样拆分为若干把锁。</code></pre>
<h2 id="利用写时复制"><a href="#利用写时复制" class="headerlink" title="利用写时复制"></a>利用写时复制</h2><pre><code>对于读操作次数远远大于写操作的场景，可以在读操作时不加锁，写操作时利用写时复制来完成，但是内存占用会相应上升。</code></pre>
<p>其次，系统中的线程数最好不是固定的，而是按CPU数来计算，这样当CPU增加时，相应的系统会自动增加线程提高并发率。<br>最后，如果对系统的CPU使用率还不满意，应当考虑分解一些单线程任务，改为多线程并发执行，以提高效率。<br>增加内存时，需要进行如下调整：<br>首先类似于线程数按CPU数计算，将Cache大小按内存大小计算，扩展内存后，Cache可以自动增长大小。<br>其次，可以分配更大的JVM堆内存给虚拟机，能减少OOM发生的几率。</p>
<hr>
<p>【参考文献】:</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/20/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/22/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">aaronzhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">222</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">114</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aaronzhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
