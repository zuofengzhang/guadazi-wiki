<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Guadazi">
<meta property="og:url" content="http://example.com/page/14/index.html">
<meta property="og:site_name" content="Guadazi">
<meta property="og:locale">
<meta property="article:author" content="aaronzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>Guadazi</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Guadazi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/lib/Jpa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/lib/Jpa/" class="post-title-link" itemprop="url">Java JPA</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-08-12 00:00:00" itemprop="dateCreated datePublished" datetime="2017-08-12T00:00:00+08:00">2017-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Jpa"><a href="#Jpa" class="headerlink" title="Jpa"></a>Jpa</h1><h2 id="创建时间-更新时间"><a href="#创建时间-更新时间" class="headerlink" title="创建时间 更新时间"></a>创建时间 更新时间</h2><p>1.实体类加注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 创建时间</span><br><span class="line"> *&#x2F;</span><br><span class="line">@CreatedDate</span><br><span class="line">@Column(name &#x3D; &quot;create_time&quot;)</span><br><span class="line">private Date createTime;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 修改时间</span><br><span class="line"> *&#x2F;</span><br><span class="line">@LastModifiedDate</span><br><span class="line">@Column(name &#x3D; &quot;modify_time&quot;)</span><br><span class="line">private Date modifyTime;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2.实体类头加注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@EntityListeners(AuditingEntityListener.class)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3.SpringBoot启动类加注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@EnableJpaAuditing</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>另外数据库添加相应控制也可以：<br>createTime ： CURRENT_TIMESTAMP<br>modifyTime ： CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/transaction/distributed-transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/transaction/distributed-transaction/" class="post-title-link" itemprop="url">分布式事务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-23 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-23T00:00:00+08:00">2017-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Distributed/" itemprop="url" rel="index"><span itemprop="name">Distributed</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="事务简介"><a href="#事务简介" class="headerlink" title="事务简介"></a>事务简介</h1><p>事务的核心是锁和并发, 采用同步控制的方式保证并发的情况下性能尽可能高, 且容易理解. 这种方式的优势是方便理解; 它的劣势是性能比较低.</p>
<p>计算机可以简单的理解为一个标准的打字机, 尽管看起来计算机可以并行处理很多事情, 但实际上每个CPU单位时间内只能做一件事, 要么读取数据、要么计算数据、要么写入数据, 所有的任务都可以看成这三件事的集合. 计算机的这种特性引出了一个问题：当多个人去读、算、写操作时, 如果不加访问控制, 系统势必会产生冲突. 而事务相当于在读、算、写操作之外增加了同步的模块, 进而保证只有一个线程进入事务当中, 而其他线程不会进入.</p>
<h2 id="单个事务单元"><a href="#单个事务单元" class="headerlink" title="单个事务单元"></a>单个事务单元</h2><p>事务的四大特性分别是：原子型、一致性、隔离性和持久性.<br><code>原子性</code>指的是事务中包含的所有操作要么全做, 要么全不做;<br><code>一致性</code>是指在事务开始以前, 数据库处于一致性的状态, 事务结束后, 数据库也必须处于一致性的状态;<br><code>隔离性</code>要求系统必须保证事务不受其他并发执行的事务的影响;<br><code>持久性</code>是指一个事务一旦成功完成, 它对数据库的改变必须是永久的, 即使是在系统遇到故障的情况下也不会丢失, 数据的重要性决定了事务的持久性的重要.</p>
<p><img src="/images/distributed/distributedTransaction/01.png"></p>
<p>事务单元是通过<code>Begin-Traction</code>, 然后<code>Commit</code>(<code>Begin-Traction</code>、<code>Commit</code>和<code>Rollback</code>之间所有针对数据的写入、读取的操作都应该添加同步访问), <code>Begin</code>和<code>Commit</code>之间就是一个同步的事务单元. 例如, Bob给Smith 100块钱就是一个事务单元, 这个过程中有很多步操作, 具体如上图所示; 但对业务来说, 仅是一个转账的操作.</p>
<h2 id="事务之间的关系"><a href="#事务之间的关系" class="headerlink" title="事务之间的关系"></a>事务之间的关系</h2><p>事务单元之间的happens-before关系: 《事务管理》</p>
<ul>
<li>读写</li>
<li>写读</li>
<li>写写</li>
<li>读读</li>
</ul>
<p><code>amdahl定律</code>: 最快并行, 最慢串行</p>
<p>最快的速度并保证逻辑顺序</p>
<p>目标–提高系统的易用性而不损失系统的性能</p>
<p><strong>数据库使用多线程的原因</strong></p>
<p>事务问题的来源</p>
<p>慢速设备：硬盘和网路 I/O PS过低,吞吐量很高</p>
<p>快速设备：内存</p>
<p><strong>一组事务单元</strong></p>
<p><img src="/images/distributed/distributedTransaction/02.png"></p>
<p>当三个账户都在进行转账操作时, 每个操作都涉及Smith账户, 所有的事务都会排队, 各自形成一组事务单元.</p>
<p>事务单元之间的<code>Happen-Before</code>关系中的四种可能性：<code>读写</code>、<code>写读</code>、<code>读读</code>、<code>写写</code>.<br>所有事务之间的关系都可以抽象成这四种之一, 来对应现在所有的业务逻辑处理. 在此基础之上, 需要用最快的速度处理多个事务单元之间的关系, 同时还能保障这四种操作的逻辑顺序.</p>
<p><strong>单个事务单元的其他例子</strong></p>
<p>除了转账操作是事务单元外, 诸如商品要建立一个基于<code>GMT_Modified</code>的索引、从数据库中读取一行记录、向数据库中写入一行记录, 同时更新这行记录的所有索引、删除整张表等都是一个事务单元.</p>
<p>也是一个事务单元:</p>
<ol>
<li>添加索引</li>
<li>从数据库读一条数据</li>
<li>向数据库写一条记录, 并更新索引</li>
<li>删除整张表</li>
</ol>
<h2 id="事务单元的实现方式"><a href="#事务单元的实现方式" class="headerlink" title="事务单元的实现方式"></a>事务单元的实现方式</h2><p><img src="/images/distributed/distributedTransaction/03.png"></p>
<p>Two Phase Lock(2PL)是数据库中非常重要的一个概念.<br><strong>数据库操作<code>Insert</code>、<code>Update</code>、<code>Delete</code>都是先读再写的操作</strong>, 例如<code>Insert</code>操作是先读取数据, 读取之后判读数据是否存在, 如果不存在, 则写入该数据, 如果数据存在, 则返回错误.<br>假设在该场景下没有读操作, 只是单纯写入数据, 则数据本身并没有事务操作, <code>Delete</code>、<code>Update</code>操作与之类似.<br><strong>数据库利用这些操作的特性, 在每一次查询过程中, 只要查到数据, 就会在该数据上加锁.理论上, 所有被读取的数据都已加锁, 不会再被其他人读到, 也就是说对数据进行的中间操作状态对所有人都不可见, 当所有中间状态完成后, 提交操作时, 解开锁, 此时数据对所有系统可见</strong> , 例如在转账过程中, 所有人只能看到两种状态：开始时, A有钱, B没钱; 结束时, B有钱, A没钱, 而中间A减掉钱, B尚未加上钱的状态被锁隐藏掉了, 这个操作就是数据库中处理事务的最标准的方式. 如上图所示：事务中的Trx2(JoeLock)与其他事务不相关, 因此可以并行执行; Trx1需要Lock两个数据Boblock和Smithlock, 而Trx3同样需要Lock这两个数据, 因此Trx3必须等待, 且等待在Boblock上; Joe事务会先结束, Trx3会等到Trx1完成后才会开始.</p>
<p>两阶段提交协议(基础是2pl): 事务单元内, 从读数据开始, 将所读的行锁住, 直到事务提交才释放.</p>
<h2 id="处理事务的常见方法"><a href="#处理事务的常见方法" class="headerlink" title="处理事务的常见方法"></a>处理事务的常见方法</h2><p>处理事务的常见方法有<code>排队法</code>、<code>排他锁</code>、<code>读写锁</code>、<code>MVCC</code>等方式, 下面来一一解析.</p>
<h3 id="排队法"><a href="#排队法" class="headerlink" title="排队法"></a>排队法</h3><p><img src="/images/distributed/distributedTransaction/04.png"></p>
<p>事务处理中最重要也是最简单的方案是排队法, 单线程地处理一堆数据. 在Redis中, 如果数据全部在内存中, 则单线程处理所有<code>Put</code>、<code>Get</code>操作效率最高.<br>这是因为多线程本质是CPU模拟多个线程, 这种模拟是以上下文切换为代价, 而对于内存的数据库来说, 没有上下文切换时效率最高. 因此, 单个CPU绑定一块内存的数据, 针对这块数据做多次读写操作时都是在单个CPU上完成的, 单线程处理方式在内存的情况是效率是最优的.</p>
<p>那么什么时候事务需要用到多线程呢？这个问题的本质取决于下层所使用的存储, 如果是内存操作, 则可以动态地申请和销毁内存块; 而磁盘的IOPS很低, 但吞吐量很高. 如果一个场景涉及多次读写操作, 单线程可以很高的效率对于内存进行读写操作; 但是, 由于磁盘的IOPS仅为内存的几千分之一, 如果依旧用操作内存的方式操作磁盘, 那系统的整体性能将会很低, 这意味着必须将大量的读写操作聚合成一个<code>Batch</code>后再提交时才能达到较好的性能. 而将大量请求攒到一起的方式一是<code>异步</code>, 也就是请求本身和线程不绑定, 线程可以不Block(本质来说还是一种多线程的方式), 处理完一个线程后再处理其他线程. 这种做法的核心是将大量不同的请求提交到一个Buffer中, 再由该Buffer统一读取或者写入磁盘, 从而提高效率. 在慢速设备中, 多线程或异步非常常见, 在设计系统时, 面对磁盘、网络、SSD等慢速设备必须考虑使用多线程.</p>
<h3 id="排他锁"><a href="#排他锁" class="headerlink" title="排他锁"></a>排他锁</h3><p><img src="/images/distributed/distributedTransaction/05.png"></p>
<p>有些场景不适合用单线程操作, 可以利用排他锁的方式来快速隔离并发读写事务. 数据库中有一些事务单元是共享的, 如图中的事务单元1是共享的, 事务单元2/3共享数据; 针对事务单元2/3共享数据的所有读写Block住, 事务单元1单独用一个锁来控制, 用这种方式完成系统的访问控制.</p>
<h3 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h3><p><img src="/images/distributed/distributedTransaction/06.png"></p>
<p>如果是一个只读的事务, 例如只对数据进行查询操作, 在该过程中数据一定不被修改, 因此多个查询操作可以并行执行, 因此一种针对读读场景的优化自然而然产生——读写锁. 读写锁的核心是在多次读的操作中, 同时允许多个读者来访问共享资源, 提高并发性.</p>
<h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><p><img src="/images/distributed/distributedTransaction/07.png"></p>
<p>在最初的数据库事务实现中是不存在MVCC的, 它是Oracle在八十年代新加的功能, 本质是<code>Copy On Write</code>, 也就是每次写都是以重新开始一个新的版本的方式写入数据,<br>因此, 数据库中也就包含了之前的所有版本. 在数据读的过程中, 先申请一个版本号, 如果该版本号小于正在写入的版本号, 则数据一定可以查询到, 无需等到新版本完全写完即可返回查询结果. 这种方式可以在读读不阻塞的前提下, 实现读写/写读不阻塞, 尽可能保证所有的读操作并行, 而写操作串行.</p>
<h2 id="事务的调优原则"><a href="#事务的调优原则" class="headerlink" title="事务的调优原则"></a>事务的调优原则</h2><p>事务的调优的思路是在不影响业务应用的前提下：</p>
<p>第一. 尽可能减少锁的覆盖范围, 例如 <code>Myisam表锁</code>到<code>Innodb行锁</code>就是一个减少锁覆盖范围的过程; 对于<code>原位锁</code>(<code>排他锁</code>、<code>读写锁</code>等)可变为<code>MVCC</code>多版本(本质仍然是减少锁的范围).<br>第二. 增加锁上可并行的线程数, 例如读锁和写锁的分离, 允许并行读取数据.<br>第三. 选择正确锁类型, 其中悲观锁适合并发争抢比较严重的场景; 乐观锁适合并发争抢不太严重的场景.</p>
<ul>
<li><p><code>悲观锁</code> 适合并发争抢比较严重的场景<br><code>Collections.sychronizedList(new ArrayList());</code></p>
</li>
<li><p><code>乐观锁</code> 适合并发争抢不太严重的场景, 如<code>自旋锁</code></p>
</li>
</ul>
<h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul>
<li>完整的事务支持<ul>
<li>像传统单机事务一样的操作方式</li>
<li>可按需无限扩展</li>
</ul>
</li>
</ul>
<p>容易理解的模型往往性能不好, 性能好的模型往往不容易理解—-这就是生活</p>
<h2 id="分布式事务带来的问题"><a href="#分布式事务带来的问题" class="headerlink" title="分布式事务带来的问题"></a>分布式事务带来的问题</h2><ul>
<li>网络带来的问题</li>
<li>基于锁的事务实现中遇到的问题<ul>
<li>从2PL到2PC</li>
<li>分布式事务的异常处理</li>
<li>分布式日志记录</li>
<li>分布式事务延迟变大的问题</li>
</ul>
</li>
<li>结合MVCC的事务实现中遇到的问题<ul>
<li>分布式顺序问题</li>
</ul>
</li>
</ul>
<p>并行与并发区别</p>
<h1 id="分布式事务-1"><a href="#分布式事务-1" class="headerlink" title="分布式事务"></a>分布式事务</h1><p>分布式事务服务(Distributed Transaction Service，DTS)</p>
<p>由于在分布式系统中经常发生丢包、网络故障，分区容忍性是必须要满足的，同时为了兼顾高可用性，绝大部分系统都将强一致性需求转化成最终一致性的需求，并通过幂等机制保证了数据的最终一致性。</p>
<p><strong>理解2PC和3PC协议</strong></p>
<p>为了解决分布式一致性问题，前人在性能和数据一致性的反反复复权衡过程中总结了许多典型的协议和算法。其中比较著名的有二阶提交协议(2 Phase Commitment Protocol)，三阶提交协议(3 Phase Commitment Protocol)。</p>
<p><strong>2PC</strong></p>
<p>分布式事务最常用的解决方案就是二阶段提交。在分布式系统中，每个节点虽然可以知晓自己的操作时成功或者失败，却无法知道其他节点的操作的成功或失败。当一个事务跨越多个节点时，为了保持事务的ACID特性，需要引入一个作为协调者的组件来统一掌控所有参与者节点的操作结果并最终指示这些节点是否要把操作结果进行真正的提交。</p>
<p>因此，二阶段提交的算法思路可以概括为：参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作。</p>
<p>所谓的两个阶段是指：第一阶段：准备阶段(投票阶段)和第二阶段：提交阶段(执行阶段)。</p>
<p><strong>第一阶段：投票阶段</strong></p>
<p>该阶段的主要目的在于打探数据库集群中的各个参与者是否能够正常的执行事务，具体步骤如下：</p>
<ol>
<li>协调者向所有的参与者发送事务执行请求，并等待参与者反馈事务执行结果。</li>
<li>事务参与者收到请求之后，执行事务，但不提交，并记录事务日志。</li>
<li>参与者将自己事务执行情况反馈给协调者，同时阻塞等待协调者的后续指令。</li>
</ol>
<p><strong>第二阶段：事务提交阶段</strong></p>
<p>在第一阶段协调者的询盘之后，各个参与者会回复自己事务的执行情况，这时候存在三种可能：</p>
<ol>
<li>所有的参与者回复能够正常执行事务。</li>
<li>一个或多个参与者回复事务执行失败。</li>
<li>协调者等待超时。</li>
</ol>
<p>对于第一种情况，协调者将向所有的参与者发出提交事务的通知，具体步骤如下：</p>
<ol>
<li>协调者向各个参与者发送commit通知，请求提交事务。</li>
<li>参与者收到事务提交通知之后，执行commit操作，然后释放占有的资源。</li>
<li>参与者向协调者返回事务commit结果信息。</li>
</ol>
<p><img src="/images/distributed/distributedTransaction/08.jpg"></p>
<p>对于第二、三种情况，协调者均认为参与者无法正常成功执行事务，为了整个集群数据的一致性，所以要向各个参与者发送事务回滚通知，具体步骤如下：</p>
<ol>
<li>协调者向各个参与者发送事务rollback通知，请求回滚事务。</li>
<li>参与者收到事务回滚通知之后，执行rollback操作，然后释放占有的资源。</li>
<li>参与者向协调者返回事务rollback结果信息。</li>
</ol>
<p><img src="/images/distributed/distributedTransaction/09.jpg"></p>
<p>两阶段提交协议解决的是分布式数据库数据强一致性问题，其原理简单，易于实现，但是缺点也是显而易见的，主要缺点如下：</p>
<ul>
<li>单点问题：协调者在整个两阶段提交过程中扮演着举足轻重的作用，一旦协调者所在服务器宕机，那么就会影响整个数据库集群的正常运行，比如在第二阶段中，如果协调者因为故障不能正常发送事务提交或回滚通知，那么参与者们将一直处于阻塞状态，整个数据库集群将无法提供服务。</li>
<li>同步阻塞：两阶段提交执行过程中，所有的参与者都需要听从协调者的统一调度，期间处于阻塞状态而不能从事其他操作，这样效率及其低下。</li>
<li>数据不一致性：两阶段提交协议虽然为分布式数据强一致性所设计，但仍然存在数据不一致性的可能，比如在第二阶段中，假设协调者发出了事务commit的通知，但是因为网络问题该通知仅被一部分参与者所收到并执行了commit操作，其余的参与者则因为没有收到通知一直处于阻塞状态，这时候就产生了数据的不一致性。</li>
</ul>
<p><strong>3PC</strong></p>
<p>针对两阶段提交存在的问题，三阶段提交协议通过引入一个“预询盘”阶段，以及超时策略来减少整个集群的阻塞时间，提升系统性能。三阶段提交的三个阶段分别为：can_commit，pre_commit，do_commit。</p>
<p><strong>第一阶段：can_commit</strong></p>
<p>该阶段协调者会去询问各个参与者是否能够正常执行事务，参与者根据自身情况回复一个预估值，相对于真正的执行事务，这个过程是轻量的，具体步骤如下：</p>
<ol>
<li>协调者向各个参与者发送事务询问通知，询问是否可以执行事务操作，并等待回复。</li>
<li>各个参与者依据自身状况回复一个预估值，如果预估自己能够正常执行事务就返回确定信息，并进入预备状态，否则返回否定信息。</li>
</ol>
<p><strong>第二阶段：pre_commit</strong></p>
<p>本阶段协调者会根据第一阶段的询盘结果采取相应操作，询盘结果主要有三种：</p>
<ol>
<li>所有的参与者都返回确定信息。</li>
<li>一个或多个参与者返回否定信息。</li>
<li>协调者等待超时。</li>
</ol>
<p>针对第一种情况，协调者会向所有参与者发送事务执行请求，具体步骤如下：</p>
<ol>
<li>协调者向所有的事务参与者发送事务执行通知。</li>
<li>参与者收到通知后，执行事务，但不提交。</li>
<li>参与者将事务执行情况返回给客户端。</li>
</ol>
<p>在上面的步骤中，如果参与者等待超时，则会中断事务。 针对第二、三种情况，协调者认为事务无法正常执行，于是向各个参与者发出abort通知，请求退出预备状态，具体步骤如下：</p>
<ol>
<li>协调者向所有事务参与者发送abort通知</li>
<li>参与者收到通知后，中断事务</li>
</ol>
<p><img src="/images/distributed/distributedTransaction/10.jpg"></p>
<p><strong>第三阶段：do_commit</strong></p>
<p>如果第二阶段事务未中断，那么本阶段协调者将会依据事务执行返回的结果来决定提交或回滚事务，分为三种情况：</p>
<ol>
<li>所有的参与者都能正常执行事务。</li>
<li>一个或多个参与者执行事务失败。</li>
<li>协调者等待超时。</li>
</ol>
<p>针对第一种情况，协调者向各个参与者发起事务提交请求，具体步骤如下：</p>
<ol>
<li>协调者向所有参与者发送事务commit通知。</li>
<li>所有参与者在收到通知之后执行commit操作，并释放占有的资源。</li>
<li>参与者向协调者反馈事务提交结果。</li>
</ol>
<p><img src="/images/distributed/distributedTransaction/11.jpg"></p>
<p>针对第二、三种情况，协调者认为事务无法正常执行，于是向各个参与者发送事务回滚请求，具体步骤如下：</p>
<ol>
<li>协调者向所有参与者发送事务rollback通知。</li>
<li>所有参与者在收到通知之后执行rollback操作，并释放占有的资源。</li>
<li>参与者向协调者反馈事务提交结果。</li>
</ol>
<p><img src="/images/distributed/distributedTransaction/12.jpg"></p>
<p>在本阶段如果因为协调者或网络问题，导致参与者迟迟不能收到来自协调者的commit或rollback请求，那么参与者将不会如两阶段提交中那样陷入阻塞，而是等待超时后继续commit。相对于两阶段提交虽然降低了同步阻塞，但仍然无法避免数据的不一致性。</p>
<p>高吞吐 高性能 和单机事务一样易用</p>
<p>ACID</p>
<p>spandex</p>
<p>xa</p>
<p>java 协调器</p>
<p>分布式日志记录</p>
<p>隔离级别 事务的传递性</p>
<p>幂等</p>
<hr>
<p>【相关文献】</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Kylin/01.kylin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Kylin/01.kylin/" class="post-title-link" itemprop="url">Kylin权威指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-20 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-20T00:00:00+08:00">2017-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Distributed/" itemprop="url" rel="index"><span itemprop="name">Distributed</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>apache Kylin 权威指南</p>
<p>各式各样的”SQL on Hadoop”技术应运而生，其中以Hive为代表，Impala、Presto、Phoenix、Drill、SparkSQL等紧随其后。它们的主要技术是”大规模并行处理”（Massive Parallel Processing，MPP）和”列式存储”（Columnar Storage）。大规模并行处理可以调动多台机器一起进行并行计算，用线性增加的资源来换取计算时间的线性下降。列式存储则将记录按列存放，这样做不仅可以在访问时只读取需要的列，还可以利用存储设备擅长连续读取的特点，大大提高读取的速率。这两项关键技术使得Hadoop上的SQL查询速度从小时提高到了分钟。</p>
<p>对于分析师来说，完备的、经过验证的数据模型比分析性能更加重要，直接访问纷繁复杂的原始数据并进行相关分析其实并不是很友好的体验，特别是在超大规模的数据集上，分析师将更多的精力花在了等待查询结果上，而不是在更加重要的建立领域模型上。</p>
<p>“预计算”就是Kylin在”大规模并行处理”和”列式存储”之外，提供给大数据分析的第三个关键技术。</p>
<p>Apache Kylin的工作原理本质上是MOLAP（Multidimensional Online Analytical Processing）Cube，也就是多维立方体分析。这是数据分析中相当经典的理论</p>
<p>Cube理论</p>
<p>星形模型（Star Schema）</p>
<p>MDX（MultiDimensional eXpressions）作为接口。虽然MDX作为OLAP查询语言</p>
<p>·大规模并行处理：可以通过增加机器的方式来扩容处理速度，在相同的时间里处理更多的数据。 ·列式存储：通过按列存储提高单位时间里数据的I/O吞吐率，还能跳过不需要访问的列。 ·索引：利用索引配合查询条件，可以迅速跳过不符合条件的数据块，仅扫描需要扫描的数据内容。 ·压缩：压缩数据然后存储，使得存储的密度更高，在有限的I/O速率下，在单位时间里读取更多的记录。</p>
<p>所有这些方法都只是提高了单位时间内处理数据的能力，当大家都一致采用这些技术时，它们之间的区别将只停留在实现层面的代码细节上。最重要的是，这些技术都不会改变一个事实，那就是处理时间与数据量之间的正比例关系。当数据量翻倍时，MPP（在不扩容的前提下）需要翻倍的时间来完成计算；列式存储需要翻倍的存储空间；索引下符合条件的记录数也会翻倍；压缩后的数据大小也还是之前的两倍。因此查询速度也会随之变成之前的两倍。当数据量成十倍百倍地增长时，这些技术的查询速度就会成十倍百倍地下降，最终变得不能接受。</p>
<p>Kylin对基数的计算方法采用的是HyperLogLog的近似算法</p>
<p>衍生维度 ??</p>
<h2 id="增量构建"><a href="#增量构建" class="headerlink" title="增量构建"></a>增量构建</h2><p>ETL</p>
<p>-</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/other/meiwen/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/other/meiwen/" class="post-title-link" itemprop="url">时光荏苒，岁月如梭</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-12 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-12T00:00:00+08:00">2017-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/wiki/" itemprop="url" rel="index"><span itemprop="name">wiki</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>时光荏苒，岁月如梭。素什锦年，稍纵即逝，半载青春年华，似沙漏般，弹指间，流在昨天。苦涩与喜悦，都不再去回忆，依然埋在时光的烟尘里。只知青丝变白发，冥冥之中，注定青春与那寂寞有染。</p>
<p>春去秋来，潮起潮落。往日里，天庭空旷，时光静谧；闲看云雾，静听风雨；可谓悠闲自得，其乐无穷。转眼，又至寂寞时节，秋风抚叶，泛成黄色，落了一地的沧桑；鸟落廊前，轻声一吟，留下几世的凄凉。如花美眷，敌不过似水流年。一切美好，都会悄然褪色，暗自凋零，最后落入尘埃。化作孤独，上了心头。</p>
<p>繁华落尽，乱世成殇。人生似列车，几经周转，穿行了多少过往。世人都是过客，到了青春驿站，转身何去何从。亲人，已挥手离去；朋友，也渐行渐远。风无定人无常，聚散两茫茫，留下寂寞的你我来来往往。看遍了人间繁华，城市的余辉，再美也终将落幕。远方飘来忧伤的夜曲，难得此生相逢，怎料寂寞如歌。待到繁华落尽，在这乱世，成殇。</p>
<p>寂寞流年，染泪红颜。 灯火阑珊，最难将息。下玄月，西风凉，此夜何人眠；别时易，见时难，相思系红颜。弱水三千，只取一瓢；梦有万千，只梦一朝。衣带渐宽，为得伊人憔悴；千年等待，只求揽你入怀。泪如烈酒，灼人心肺，谁知相思，已成灾。</p>
<p>往事成烟，宿命依旧。青春染指流年，流年染指红颜。画地为牢，锁我几春秋，染予寂寞。无奈拾起青春的记忆，等一阵清风扑面，挥挥衣袖，又是潇洒一片。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/log/log4j/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/log/log4j/" class="post-title-link" itemprop="url">log4j</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-06-29 12:26:00" itemprop="dateCreated datePublished" datetime="2017-06-29T12:26:00+08:00">2017-06-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>log4j 是目前最常见的日志系统之一，本文主要总结log4j的使用和配置.</p>
<h1 id="log4j的组件"><a href="#log4j的组件" class="headerlink" title="log4j的组件"></a>log4j的组件</h1><ul>
<li>logger</li>
<li>appender</li>
<li>level</li>
<li>layout</li>
</ul>
<h2 id="logger-记录器-打印事件"><a href="#logger-记录器-打印事件" class="headerlink" title="logger-记录器 打印事件"></a>logger-记录器 打印事件</h2><p>logger 可以理解为日志记录器，它有name、appender和level等属性.<br>当调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Logger logger = LoggerFactory.getLogger(AClass.class);</span><br></pre></td></tr></table></figure>
<p>时，<code>logger</code>变量即为名称为<code>AClass</code>类的全名的logger.</p>
<p>如果使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Logger logger = LoggerFactory.getLogger(<span class="string">&quot;myRedo&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>logger变量即为名称为myRedo的logger</p>
<ol>
<li>所有的logger的根都是rootLogger</li>
<li>一般情况下，取类名作为logger的名称. 父子关系遵从Java package的方法</li>
<li>子logger默认继承父logger的所有的配置. 子logger的配置会覆盖父logger的配置</li>
<li>logger的名称可以为任意字符串</li>
<li>log4j可以使用多种配置方式: properties文件、xml文件和Java代码</li>
<li>使用Java代码配置时，可以指定为基本配置: <code>BasicConfigurator.configure();</code></li>
<li>可以指定特定包的log<br>样例: 使用代码的方式配置特定包的logger<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  Logger.getRootLogger().setLevel(Level.WARN);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;cd.itcast.core&quot;</span>).setLevel(Level.DEBUG);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="appender-打印目的地"><a href="#appender-打印目的地" class="headerlink" title="appender 打印目的地"></a>appender 打印目的地</h2><p>log4j定义了多种appender:</p>
<ul>
<li>org.apache.log4j.ConsoleAppender(控制台)</li>
<li>org.apache.log4j.FileAppender(文件)</li>
<li>org.apache.log4j.DailyRollingFileAppender(每天产生一个日志文件)</li>
<li>org.apache.log4j.RollingFileAppender(文件大小到达指定尺寸的时候产生一个新的文件)</li>
<li>org.apache.log4j.WriterAppender(将日志信息以流格式发送到任意指定的地方)</li>
<li>org.apache.log4j.jdbc.JDBCAppender(将日志信息写入数据库)</li>
</ul>
<p>在properties文件中配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">log4j.appender.&lt;appenderName&gt;</span> = <span class="string">fully.qualified.name.of.appender.class</span></span><br></pre></td></tr></table></figure>
<p>Appender类的属性</p>
<h3 id="ConsoleAppender"><a href="#ConsoleAppender" class="headerlink" title="ConsoleAppender"></a>ConsoleAppender</h3><p>   Threshold=DEBUG :指定日志消息的输出最低层次.<br>   ImmediateFlush=true :默认值是true,意谓着所有的消息都会被立即输出.<br>   Target=System.err :默认情况下是:System.out,指定输出控制台</p>
<h3 id="FileAppender"><a href="#FileAppender" class="headerlink" title="FileAppender"></a>FileAppender</h3><p>   Threshold=DEBUF    :指定日志消息的输出最低层次.<br>   ImmediateFlush=true   :默认值是true,意谓着所有的消息都会被立即输出.<br>   File=mylog.txt   :指定消息输出到mylog.txt文件.<br>   Append=false   :默认值是true,即将消息增加到指定文件中，false指将消息覆盖指定的文件内容.</p>
<h3 id="RollingFileAppender"><a href="#RollingFileAppender" class="headerlink" title="RollingFileAppender"></a>RollingFileAppender</h3><p>   Threshold=DEBUG    :指定日志消息的输出最低层次.<br>   ImmediateFlush=true    :默认值是true,意谓着所有的消息都会被立即输出.<br>   File=mylog.txt    :指定消息输出到mylog.txt文件.<br>   Append=false    :默认值是true,即将消息增加到指定文件中，false指将消息覆盖指定的文件内容.<br>   MaxFileSize=100KB    : 后缀可以是KB, MB 或者是 GB. 在日志文件到达该大小时，将会自动滚动，即将原来的内容移到mylog.log.1文件.<br>   MaxBackupIndex=2   :指定可以产生的滚动文件的最大数.<br>   log4j.appender.A1.layout.ConversionPattern=%-4r %-5p %d{yyyy-MM-dd HH:mm:ssS} %c %m%n</p>
<h3 id="DailyRollingFileAppender"><a href="#DailyRollingFileAppender" class="headerlink" title="DailyRollingFileAppender"></a>DailyRollingFileAppender</h3><p>  DatePattern<br>  layout<br>  Encoding<br>  MaxBackupIndex</p>
<h2 id="level-输出级别"><a href="#level-输出级别" class="headerlink" title="level 输出级别"></a>level 输出级别</h2><p>ERROR、WARN、INFO、DEBUG</p>
<ul>
<li>ERROR 为严重错误 主要是程序的错误</li>
<li>WARN 为一般警告，比如session丢失</li>
<li>INFO 为一般要显示的信息，比如登录登出</li>
<li>DEBUG 为程序的调试信息</li>
</ul>
<h2 id="layout"><a href="#layout" class="headerlink" title="layout"></a>layout</h2><p>-X号: X信息输出时左对齐；</p>
<p>%p: 输出日志信息优先级，即DEBUG，INFO，WARN，ERROR，FATAL,<br>%d: 输出日志时间点的日期或时间，默认格式为ISO8601，也可以在其后指定格式，比如:%d{yyy MMM dd HH:mm:ss,SSS}，输出类似:2002年10月18日 22:10:28，921<br>%r: 输出自应用启动到输出该log信息耗费的毫秒数<br>%c: 输出日志信息所属的类目，通常就是所在类的全名<br>%t: 输出产生该日志事件的线程名<br>%l: 输出日志事件的发生位置，相当于%C.%M(%F:%L)的组合,包括类目名、发生的线程，以及在代码中的行数. 举例:Testlog4.main (TestLog4.java:10)<br>%x: 输出和当前线程相关联的NDC(嵌套诊断环境),尤其用到像java servlets这样的多客户多线程的应用中.<br>%%: 输出一个”%”字符<br>%F: 输出日志消息产生时所在的文件名称<br>%L: 输出代码中的行号<br>%m: 输出代码中指定的消息,产生的日志具体信息<br>%n: 输出一个回车换行符，Windows平台为”/r/n”，Unix平台为”/n”输出日志信息换行</p>
<p>日志信息格式中几个符号所代表的含义:<br>可以在%与模式字符之间加上修饰符来控制其最小宽度、最大宽度、和文本的对齐方式. 如:</p>
<ol>
<li>  %20c:指定输出category的名称，最小的宽度是20，如果category的名称小于20的话，默认的情况下右对齐.</li>
<li>  %-20c:指定输出category的名称，最小的宽度是20，如果category的名称小于20的话，”-“号指定左对齐.</li>
<li>  %.30c:指定输出category的名称，最大的宽度是30，如果category的名称大于30的话，就会将左边多出的字符截掉，但小于30的话也不会有空格.</li>
<li>  %20.30c:如果category的名称小于20就补空格，并且右对齐，如果其名称长于30字符，就从左边较远输出的字符截掉.</li>
</ol>
<h2 id="log4j性能优化"><a href="#log4j性能优化" class="headerlink" title="log4j性能优化"></a>log4j性能优化</h2><ol>
<li>为了避免多次打开文件引起资源的浪费，log4j当打开文件或连接数据库后，会始终保持着连接，直到引用关闭.<br>因此， 当引用运行过程中，删除文件. log4j不会再次创建该文件.</li>
<li>logger文件是懒生成模式:当打印时，判断是否需要创建新文件</li>
</ol>
<h1 id="典型应用"><a href="#典型应用" class="headerlink" title="典型应用"></a>典型应用</h1><h2 id="配置非类名logger及代码获取logger的信息"><a href="#配置非类名logger及代码获取logger的信息" class="headerlink" title="配置非类名logger及代码获取logger的信息"></a>配置非类名logger及代码获取logger的信息</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###################</span></span><br><span class="line"><span class="comment"># rootLogger的级别为INFO，appender为terminal01和allToFile</span></span><br><span class="line"><span class="comment">###################</span></span><br><span class="line"><span class="meta">log4j.rootLogger</span>=<span class="string">INFO,terminal01,allToFile</span></span><br><span class="line"><span class="comment">###################</span></span><br><span class="line"><span class="comment"># Console Appender</span></span><br><span class="line"><span class="comment">###################</span></span><br><span class="line"><span class="meta">log4j.appender.terminal01</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.terminal01.Target</span>=<span class="string">System.out</span></span><br><span class="line"><span class="meta">log4j.appender.terminal01.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.terminal01.layout.ConversionPattern</span>=<span class="string">%d&#123;yyyy-MM-dd HH:mm:ss.sss&#125;,%c,%-p,%m %n</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="comment"># Rolling File</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="meta">log4j.appender.allToFile</span>=<span class="string">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class="line"><span class="meta">log4j.appender.allToFile.File</span>=<span class="string">/data/logs/blog-all.log</span></span><br><span class="line"><span class="meta">log4j.appender.allToFile.Append</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">log4j.appender.allToFile.MaxFileSize</span>=<span class="string">100MB</span></span><br><span class="line"><span class="meta">log4j.appender.allToFile.MaxBackupIndex</span>=<span class="string">7</span></span><br><span class="line"><span class="meta">log4j.appender.allToFile.Encoding</span>=<span class="string">UTF-8  </span></span><br><span class="line"><span class="meta">log4j.appender.allToFile.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.allToFile.layout.ConversionPattern</span>=<span class="string">%d&#123;yyyy-MM-dd HH:mm:ss.sss&#125;,%c,%-p,%m %n</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="comment"># 指定某个包的logger</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="meta">log4j.logger.com.abc.engin</span>=<span class="string">INFO,engin</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="comment"># appender engin</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="meta">log4j.additivity.engin</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">## 是否追加到root appender中</span></span><br><span class="line"><span class="meta">log4j.appender.engin</span>=<span class="string">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class="line"><span class="meta">log4j.appender.engin.File</span>=<span class="string">/data/logs/engin.log</span></span><br><span class="line"><span class="meta">log4j.appender.engin.Append</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">log4j.appender.engin.MaxFileSize</span>=<span class="string">500MB</span></span><br><span class="line"><span class="meta">log4j.appender.engin.MaxBackupIndex</span>=<span class="string">7</span></span><br><span class="line"><span class="meta">log4j.appender.engin.Encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="meta">log4j.appender.engin.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.engin.layout.ConversionPattern</span>=<span class="string">%d&#123;yyyy-MM-dd HH:mm:ss.sss&#125;,%c,%-p,%m %n</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="comment"># 非类名logger</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="meta">log4j.logger.error</span>=<span class="string">ERROR,errorAppender</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="comment"># appender errorAppender</span></span><br><span class="line"><span class="comment">########################</span></span><br><span class="line"><span class="meta">log4j.appender.errorAppender</span>=<span class="string">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class="line"><span class="meta">log4j.appender.errorAppender.File</span>=<span class="string">/data/logs/blog-error.log</span></span><br><span class="line"><span class="meta">log4j.appender.errorAppender.Append</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">log4j.appender.errorAppender.MaxFileSize</span>=<span class="string">500MB</span></span><br><span class="line"><span class="meta">log4j.appender.errorAppender.MaxBackupIndex</span>=<span class="string">7</span></span><br><span class="line"><span class="meta">log4j.appender.errorAppender.Encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="meta">log4j.appender.errorAppender.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.errorAppender.layout.ConversionPattern</span>=<span class="string">%d&#123;yyyy-MM-dd HH:mm:ss.sss&#125;,%c,%-p,%m %n</span></span><br></pre></td></tr></table></figure>
<h3 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Logger logger = LoggerFactory.getLogger(AClass.class);</span><br><span class="line">logger.error(<span class="string">&quot;this is an error log&quot;</span>);</span><br><span class="line"><span class="comment">// 获取名称为error的logger</span></span><br><span class="line">Logger loggerError = LoggerFactory.getLogger(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">loggerError.error(<span class="string">&quot;this is an error log&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="从Java代码获取logger的配置信息"><a href="#从Java代码获取logger的配置信息" class="headerlink" title="从Java代码获取logger的配置信息"></a>从Java代码获取logger的配置信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">org.apache.log4j.Logger loggerError = org.apache.log4j.Logger.getLogger(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">Appender appender = loggerError.getAppender(<span class="string">&quot;errorAppender&quot;</span>);</span><br><span class="line">DailyRollingFileAppender errorAppender = (DailyRollingFileAppender) appender;</span><br><span class="line">String fileName = errorAppender.getFile();</span><br><span class="line">String datePattern = errorAppender.getDatePattern();</span><br></pre></td></tr></table></figure>

<h2 id="每个小时打印一个文件"><a href="#每个小时打印一个文件" class="headerlink" title="每个小时打印一个文件"></a>每个小时打印一个文件</h2><h3 id="配置文件的方式"><a href="#配置文件的方式" class="headerlink" title="配置文件的方式"></a>配置文件的方式</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">log4j.logger.redo</span>=<span class="string">ERROR,redoLogger</span></span><br><span class="line"><span class="comment"># appender for redo logger</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger</span>=<span class="string">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger.File</span>=<span class="string">/data/logs/my-redo.log</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger.Append</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger.MaxFileSize</span>=<span class="string">500MB</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger.MaxBackupIndex</span>=<span class="string">7</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger.Encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger.layout.ConversionPattern</span>=<span class="string">%d&#123;yyyy-MM-dd HH:mm:ss.sss&#125;,%c,%-p,%m \n</span></span><br><span class="line"><span class="meta">log4j.appender.redoLogger.DatePattern</span>=<span class="string">&#x27;.&#x27;yyyy-MM-dd-HH</span></span><br></pre></td></tr></table></figure>
<h3 id="Java代码的方式"><a href="#Java代码的方式" class="headerlink" title="Java代码的方式"></a>Java代码的方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DailyRollingFileAppender redoAppender = <span class="keyword">new</span> DailyRollingFileAppender();</span><br><span class="line">redoAppender.setDatePattern(<span class="string">&quot;&#x27;.&#x27;yyyy-MM-dd-HH&quot;</span>);</span><br><span class="line"></span><br><span class="line">Logger loggerRedo = Logger.getLogger(<span class="string">&quot;redo&quot;</span>);</span><br><span class="line">loggerRedo.addAppender(appender);</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger redoLogger = LoggerFactory.getLogger(<span class="string">&quot;redo&quot;</span>);</span><br><span class="line">...</span><br><span class="line">redoLogger.error(<span class="string">&quot;something is wrong&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>下面的列表<br>The following list shows all the date patterns which have defined by log4j,</p>
<table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">DatePattern</th>
<th align="left">sample</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Minutely</td>
<td align="left"><code>&#39;.&#39;yyyy-MM-dd-HH-mm</code></td>
<td align="left">application.log.2013-02-28-13-54</td>
</tr>
<tr>
<td align="left">Hourly</td>
<td align="left"><code>&#39;.&#39;yyyy-MM-dd-HH</code></td>
<td align="left">application.log.2013-02-28-13</td>
</tr>
<tr>
<td align="left">Half-daily</td>
<td align="left"><code>&#39;.&#39;yyyy-MM-dd-a</code></td>
<td align="left">application.log.2013-02-28-AM    app.log.2013-02-28-PM</td>
</tr>
<tr>
<td align="left">Daily</td>
<td align="left"><code>&#39;.&#39;yyyy-MM-dd</code></td>
<td align="left">application.log.2013-02-28</td>
</tr>
<tr>
<td align="left">Weekly</td>
<td align="left"><code>&#39;.&#39;yyyy-ww</code></td>
<td align="left">application.log.2013-07 app.log.2013-08</td>
</tr>
<tr>
<td align="left">Monthly</td>
<td align="left"><code>&#39;.&#39;yyyy-MM</code></td>
<td align="left">application.log.2013-01 app.log.2013-02</td>
</tr>
</tbody></table>
<h2 id="自定义-writerAppender"><a href="#自定义-writerAppender" class="headerlink" title="自定义 writerAppender"></a>自定义 writerAppender</h2><p>log4j将日志输出到swing控件</p>
<h3 id="自定义-writer"><a href="#自定义-writer" class="headerlink" title="自定义 writer"></a>自定义 writer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogWriter</span> <span class="keyword">extends</span> <span class="title">Writer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LogListModel model;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogWriter</span><span class="params">(LogListModel model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.model = model;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> c)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        model.addElement(<span class="string">&quot;&quot;</span> + c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span>[] cbuf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        model.addElement(<span class="keyword">new</span> String(cbuf));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String str)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        model.addElement(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String str, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        model.addElement(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span>[] cbuf, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        model.addElement(<span class="keyword">new</span> String(cbuf));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建logger与Swing组件"><a href="#创建logger与Swing组件" class="headerlink" title="创建logger与Swing组件"></a>创建logger与Swing组件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Logger loggerA = LoggerFactory.getLogger(<span class="string">&quot;A1&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> LogListModel logListModel;</span><br><span class="line"></span><br><span class="line">logListModel = <span class="keyword">new</span> LogListModel();</span><br><span class="line">JList ml = <span class="keyword">new</span> JList(logListModel);</span><br><span class="line"></span><br><span class="line">WriterAppender writeappender = <span class="keyword">new</span> WriterAppender(<span class="keyword">new</span> SimpleLayout(), <span class="keyword">new</span> LogWriter(logListModel));</span><br><span class="line">writeappender.setName(<span class="string">&quot;A1&quot;</span>);</span><br><span class="line">writeappender.setImmediateFlush(<span class="keyword">true</span>);</span><br><span class="line">Logger.getRootLogger().addAppender(writeappender);</span><br><span class="line">Logger.getRootLogger().setLevel(Level.INFO);</span><br></pre></td></tr></table></figure>







<p>-</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1711423/how-to-rotate-log-files-based-on-time-rather-than-size-in-log4j">How to rotate log files based on time rather than size in Log4j?
</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/ArtsCrafts/archive/2013/06/07/log4j5.html">Log4j详细介绍(五)—-输出地Appender</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/metric/jdk-inner-tools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/metric/jdk-inner-tools/" class="post-title-link" itemprop="url">JDK内置工具的使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-06-28 11:28:00" itemprop="dateCreated datePublished" datetime="2017-06-28T11:28:00+08:00">2017-06-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考: <a target="_blank" rel="noopener" href="http://blog.csdn.net/fenglibing/article/details/6411999">http://blog.csdn.net/fenglibing/article/details/6411999</a></p>
<ol>
<li>javah (C Header and Stub File Generator:用于生成native方法对应的C头文件,见<a href="/java-NIO/">JNI</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/fenglibing/article/details/6411932">jps (Java Virtual Machine Process Status Tool)</a></li>
<li><a href="/Java/tools/jstack/">jstack (Java Stack Trace)</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/fenglibing/article/details/6411951">jstat (Java Virtual Machine Statistics Monitoring Tool)</a></li>
<li>jmap (Java Memory Map)</li>
<li>jinfo (Java Configuration Info)</li>
<li>jconsole (Java Monitoring and Management Console)</li>
<li>jvisualvm (Java Virtual Machine Monitoring, Troubleshooting, and Profiling Tool)</li>
<li>jhat (Java Heap Analyse Tool)</li>
<li>Jdb (The Java Debugger)</li>
<li>Jstatd (Java Statistics Monitoring Daemon)</li>
</ol>
<p>//TODO<br>javap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">set JAVA_OPTS=-Xms%INITIAL_HEAP_SIZE% -Xmx%MAXIMUM_HEAP_SIZE% -Xss%STACK_SIZE%</span><br><span class="line">if not &quot;%USER_LANGUAGE%&quot;==&quot;&quot; set JAVA_OPTS=%JAVA_OPTS% -Duser.language=%USER_LANGUAGE%</span><br><span class="line">if not &quot;%USER_COUNTRY%&quot;==&quot;&quot; set JAVA_OPTS=%JAVA_OPTS% -Duser.country=%USER_COUNTRY%</span><br><span class="line"></span><br><span class="line">rem run Jude //注释 运行jude</span><br><span class="line">start javaw %JAVA_OPTS% -jar &quot;%JUDE_HOME%\%JUDE_JAR%&quot;  %1 %2 %3 //</span><br><span class="line">IF ERRORLEVEL 2 goto noJavaw</span><br><span class="line">goto end</span><br></pre></td></tr></table></figure>




<hr>
<p>[源码]:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1c0YLi4S">源码百度云链接</a>     密码：yfo5</li>
</ol>
<p>[参考文献]:</p>
<ol>
<li>Think in Java</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/metric/Java%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/metric/Java%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">【读书笔记】Java程序性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-06-27 00:00:00" itemprop="dateCreated datePublished" datetime="2017-06-27T00:00:00+08:00">2017-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java程序性能优化"><a href="#Java程序性能优化" class="headerlink" title="Java程序性能优化"></a>Java程序性能优化</h1><p><img src="/images/java/performance/Java%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%85%A8.png" alt="img"></p>
<h1 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h1><h2 id="OverStack"><a href="#OverStack" class="headerlink" title="OverStack"></a>OverStack</h2><p>默认xss</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal -version | grep -i &#x27;stack&#x27;</span><br><span class="line">     intx CompilerThreadStackSize                   = 0                                   &#123;pd product&#125;</span><br><span class="line">    uintx GCDrainStackTargetSize                    = 64                                  &#123;product&#125;</span><br><span class="line">     bool JavaMonitorsInStackTrace                  = true                                &#123;product&#125;</span><br><span class="line">    uintx MarkStackSize                             = 4194304                             &#123;product&#125;</span><br><span class="line">    uintx MarkStackSizeMax                          = 536870912                           &#123;product&#125;</span><br><span class="line">     intx MaxJavaStackTraceDepth                    = 1024                                &#123;product&#125;</span><br><span class="line">     bool OmitStackTraceInFastThrow                 = true                                &#123;product&#125;</span><br><span class="line">     intx OnStackReplacePercentage                  = 140                                 &#123;pd product&#125;</span><br><span class="line">     intx StackRedPages                             = 1                                   &#123;pd product&#125;</span><br><span class="line">     intx StackShadowPages                          = 20                                  &#123;pd product&#125;</span><br><span class="line">     bool StackTraceInThrowable                     = true                                &#123;product&#125;</span><br><span class="line">     intx StackYellowPages                          = 2                                   &#123;pd product&#125;</span><br><span class="line">     intx ThreadStackSize                           = 1024                                &#123;pd product&#125;</span><br><span class="line">     bool UseOnStackReplacement                     = true                                &#123;pd product&#125;</span><br><span class="line">     intx VMThreadStackSize                         = 1024                                &#123;pd product&#125;</span><br><span class="line">java version &quot;1.8.0_211&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_211-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
<p>-Xss is translated in a VM flag named ThreadStackSize, 是-XX:ThreadStackSize的简写形式, 即线程栈的大小,  单位kb</p>
<p>-Xsssize  </p>
<p>   Sets the thread stack size (in bytes). Append the<br>   letter k or K to indicate KB, m or M to indicate MB, g or G to<br>   indicate GB. The default value depends on the platform:</p>
<ul>
<li>Linux/ARM (32-bit): 320 KB</li>
<li>Linux/i386 (32-bit): 320 KB</li>
<li>Linux/x64 (64-bit): 1024 KB</li>
<li>OS X (64-bit): 1024 KB</li>
<li>Oracle Solaris/i386 (32-bit): 320 KB</li>
<li>Oracle Solaris/x64 (64-bit): 1024 KB</li>
</ul>
<p>The following examples set the thread stack size to 1024 KB in different units:</p>
<p>-Xss1m<br>-Xss1024k<br>-Xss1048576</p>
<p>This option is equivalent to -XX:ThreadStackSize.</p>
<h2 id="OverStack样例"><a href="#OverStack样例" class="headerlink" title="OverStack样例"></a>OverStack样例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverStackTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recursion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cnt++;</span><br><span class="line">        recursion();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testOverStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            recursion();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;deep of stack is &quot;</span> + cnt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> OverStackTest().testOverStack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> javac OverStackTest.java</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> java -Xss256k  OverStackTest</span></span><br><span class="line">deep of stack is 1887</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> java -Xss512k  OverStackTest</span></span><br><span class="line">deep of stack is 7428</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> java -Xss670k  OverStackTest</span></span><br><span class="line">deep of stack is 7616</span><br></pre></td></tr></table></figure>


<ul>
<li>标记复制: 新生代垃圾回收的通用算法</li>
<li>标记压缩: 老年代垃圾回收</li>
</ul>
<h2 id="CMS收集器"><a href="#CMS收集器" class="headerlink" title="CMS收集器"></a>CMS收集器</h2><p>三种操作:</p>
<ul>
<li>年轻代回收（暂停所有应用线程）</li>
<li>启动并发线程回收老年带空间</li>
<li>如有必要，full gc</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/metric/jstack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/metric/jstack/" class="post-title-link" itemprop="url">【转载】jstack和线程dump分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-06-27 00:00:00" itemprop="dateCreated datePublished" datetime="2017-06-27T00:00:00+08:00">2017-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="http://jameswxx.iteye.com/blog/1041173">http://jameswxx.iteye.com/blog/1041173</a></p>
<h1 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h1><p>jstack命令的语法格式： jstack  <pid>。可以用jps查看java进程id。这里要注意的是：</p>
<ol>
<li>不同的 JAVA虚机的线程 DUMP的创建方法和文件格式是不一样的, 不同的 JVM版本,  dump信息也有差别。本文中, 只以 SUN的 hotspot JVM 5.0_06 为例。</li>
<li>在实际运行中, 往往一次 dump的信息, 还不足以确认问题。建议产生三次 dump信息, 如果每次 dump都指向同一个问题, 我们才确定问题的典型性。</li>
</ol>
<h1 id="线程分析"><a href="#线程分析" class="headerlink" title="线程分析"></a>线程分析</h1><h2 id="JVM-线程"><a href="#JVM-线程" class="headerlink" title="JVM 线程"></a>JVM 线程</h2><p>在线程中, 有一些 JVM内部的后台线程, 来执行譬如垃圾回收, 或者低内存的检测等等任务, 这些线程往往在 JVM初始化的时候就存在, 如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&quot;Low Memory Detector&quot; daemon prio=10 tid=0x081465f8 nid=0x7 runnable [0x00000000..0x00000000]  </span><br><span class="line">​&quot;CompilerThread0&quot; daemon prio=10 tid=0x08143c58 nid=0x6 waiting on condition [0x00000000..0xfb5fd798]  </span><br><span class="line">​&quot;Signal Dispatcher&quot; daemon prio=10 tid=0x08142f08 nid=0x5 waiting on condition [0x00000000..0x00000000]  </span><br><span class="line">​&quot;Finalizer&quot; daemon prio=10 tid=0x08137ca0 nid=0x4 in Object.wait() [0xfbeed000..0xfbeeddb8]   ​</span><br><span class="line">​        at java.lang.Object.wait(Native Method)  </span><br><span class="line">​ ​        - waiting on &lt;0xef600848&gt; (a java.lang.ref.ReferenceQueue$Lock)  </span><br><span class="line">​ ​        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:116)  </span><br><span class="line">​ ​        - locked &lt;0xef600848&gt; (a java.lang.ref.ReferenceQueue$Lock)  </span><br><span class="line">​ ​        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:132)  </span><br><span class="line">​ ​        at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)   ​</span><br><span class="line">​&quot;Reference Handler&quot; daemon prio=10 tid=0x081370f0 nid=0x3 in Object.wait() [0xfbf4a000..0xfbf4aa38]  </span><br><span class="line">​ ​        at java.lang.Object.wait(Native Method)  </span><br><span class="line">​ ​        - waiting on &lt;0xef600758&gt; (a java.lang.ref.Reference$Lock)  </span><br><span class="line">​ ​        at java.lang.Object.wait(Object.java:474)  </span><br><span class="line">​ ​        at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)  </span><br><span class="line">​ ​        - locked &lt;0xef600758&gt; (a java.lang.ref.Reference$Lock)  </span><br><span class="line">&quot;VM Thread&quot; prio=10 tid=0x08134878 nid=0x2 runnable  </span><br><span class="line">&quot;VM Periodic Task Thread&quot; prio=10 tid=0x08147768 nid=0x8 waiting on condition&lt;/span&gt;  </span><br></pre></td></tr></table></figure>

<p>​     我们更多的是要观察用户级别的线程, 如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;Thread-1&quot; prio=10 tid=0x08223860 nid=0xa waiting on condition [0xef47a000..0xef47ac38]   ​</span><br><span class="line">​        at java.lang.Thread.sleep(Native Method)   ​</span><br><span class="line">​        at testthread.MySleepingThread.method2(MySleepingThread.java:53)  </span><br><span class="line">​ ​        - locked &lt;0xef63d600&gt; (a testthread.MySleepingThread)  </span><br><span class="line">​ ​        at testthread.MySleepingThread.run(MySleepingThread.java:35)   ​</span><br><span class="line">​        at java.lang.Thread.run(Thread.java:595) &lt;/span&gt;  </span><br></pre></td></tr></table></figure>
<p>我们能看到：<br>​    * 线程的状态： waiting on condition<br>​    * 线程的调用栈<br>​    * 线程的当前锁住的资源： &lt;0xef63d600&gt;</p>
<h2 id="线程的状态分析"><a href="#线程的状态分析" class="headerlink" title="线程的状态分析"></a>线程的状态分析</h2><p>正如我们刚看到的那样, 线程的状态是一个重要的指标, 它会显示在线程 Stacktrace 的头一行结尾的地方。那么线程常见的有哪些状态呢？线程在什么样的情况下会进入这种状态呢？我们能从中发现什么线索？</p>
<h3 id="Runnable"><a href="#Runnable" class="headerlink" title="Runnable"></a>Runnable</h3><p>该状态表示线程具备所有运行条件, 在运行队列中准备操作系统的调度, 或者正在运行。</p>
<h3 id="Wait-on-condition"><a href="#Wait-on-condition" class="headerlink" title="Wait on condition"></a>Wait on condition</h3><p>该状态出现在线程等待某个条件的发生。具体是什么原因, 可以结合 stacktrace 来分析。</p>
<p>最常见的情况是线程在等待网络的读写, 比如当网络数据没有准备好读时, 线程处于这种等待状态, 而一旦有数据准备好读之后, 线程会重新激活, 读取并处理数据。<br>在 Java引入 NewIO之前, 对于每个网络连接, 都有一个对应的线程来处理网络的读写操作, 即使没有可读写的数据, 线程仍然阻塞在读写操作上, 这样有可能造成资源浪费, 而且给操作系统的线程调度也带来压力。在 NewIO里采用了新的机制, 编写的服务器程序的性能和可扩展性都得到提高。<br>​<br>如果发现有大量的线程都在处在 Wait on condition, 从线程 stack看,  正等待网络读写, 这可能是一个网络瓶颈的征兆。因为网络阻塞导致线程无法执行。一种情况是网络非常忙, 几 乎消耗了所有的带宽, 仍然有大量数据等待网络读 写；另一种情况也可能是网络空闲, 但由于路由等问题, 导致包无法正常的到达。所以要结合系统的一些性能观察工具来综合分析, 比如 netstat统计单位时间的发送包的数目, 如果很明显超过了所在网络带宽的限制 ; 观察 cpu的利用率, 如果系统态的 CPU时间, 相对于用户态的 CPU时间比例较高；如果程序运行在 Solaris 10平台上, 可以用 dtrace工具看系统调用的情况, 如果观察到 read/write的系统调用的次数或者运行时间遥遥领先；这些都指向由于网络带宽所限导致的网络瓶颈。另外一种出现 Wait on condition的常见情况是该线程在 sleep, 等待 sleep的时间到了时候, 将被唤醒。</p>
<h3 id="Waiting-for-monitor-entry-和-in-Object-wait"><a href="#Waiting-for-monitor-entry-和-in-Object-wait" class="headerlink" title="Waiting for monitor entry 和 in Object.wait()"></a>Waiting for monitor entry 和 in Object.wait()</h3><p>​<br>在多线程的 JAVA程序中, 实现线程之间的同步, 就要说说 Monitor。 Monitor是 Java中用以实现线程之间的互斥与协作的主要手段, 它可以看成是对象或者 Class的锁。每一个对象都有, 也仅有一个 monitor。每个 Monitor在某个时刻, 只能被一个线程拥有, 该线程就是 “Active Thread”, 而其它线程都是 “Waiting Thread”, 分别在两个队列 “ Entry Set”和 “Wait Set”里面等候。在 “Entry Set”中等待的线程状态是 “Waiting for monitor entry”, 而在 “Wait Set”中等待的线程状态是 “in Object.wait()”。<br>​<br>先看 “Entry Set”里面的线程。我们称被 synchronized保护起来的代码段为临界区。当一个线程申请进入临界区时, 它就进入了 “Entry Set”队列。对应的 code就像：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">.........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时有两种可能性：</p>
<ol>
<li>该 monitor不被其它线程拥有,  Entry Set里面也没有其它等待线程。本线程即成为相应类或者对象的 Monitor的 Owner, 执行临界区的代码     </li>
<li>该 monitor被其它线程拥有, 本线程在 Entry Set队列中等待。*</li>
</ol>
<p>在第一种情况下, 线程将处于 “Runnable”的状态, 而第二种情况下, 线程 DUMP会显示处于 “waiting for monitor entry”。如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;Thread-0&quot; prio=10 tid=0x08222eb0 nid=0x9 waiting for monitor entry [0xf927b000..0xf927bdb8]  ​</span><br><span class="line"> at testthread.WaitThread.run(WaitThread.java:39)   ​</span><br><span class="line"> - waiting to lock &lt;0xef63bf08&gt; (a java.lang.Object)   ​</span><br><span class="line"> - locked &lt;0xef63beb8&gt; (a java.util.ArrayList)   ​</span><br><span class="line"> at java.lang.Thread.run(Thread.java:595)  </span><br></pre></td></tr></table></figure>
<p>​<br>临界区的设置, 是为了保证其内部的代码执行的原子性和完整性。但是因为临界区在任何时间只允许线程串行通过, 这 和我们多线程的程序的初衷是相反的。 如果在多线程的程序中, 大量使用 synchronized, 或者不适当的使用了它, 会造成大量线程在临界区的入口等待, 造成系统的性能大幅下降。如果在线程 DUMP中发现了这个情况, 应该审查源码, 改进程序。</p>
<p>现在我们再来看现在线程为什么会进入 “Wait Set”。当线程获得了 Monitor, 进入了临界区之后, 如果发现线程继续运行的条件没有满足, 它则调用对象（一般就是被 synchronized 的对象）的 wait() 方法, 放弃了 Monitor, 进入 “Wait Set”队列。只有当别的线程在该对象上调用了 notify() 或者 notifyAll() ,  “ Wait Set”队列中线程才得到机会去竞争, 但是只有一个线程获得对象的 Monitor, 恢复到运行态。在 “Wait Set”中的线程,  DUMP中表现为： in Object.wait(), 类似于：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;Thread-1&quot; prio=10 tid=0x08223250 nid=0xa in Object.wait() [0xef47a000..0xef47aa38]  </span><br><span class="line">​        at java.lang.Object.wait(Native Method)   ​</span><br><span class="line">​        - waiting on &lt;0xef63beb8&gt; (a java.util.ArrayList)   ​</span><br><span class="line">​        at java.lang.Object.wait(Object.java:474)   ​</span><br><span class="line">​        at testthread.MyWaitThread.run(MyWaitThread.java:40)   ​</span><br><span class="line">​        - locked &lt;0xef63beb8&gt; (a java.util.ArrayList)   ​</span><br><span class="line">​        at java.lang.Thread.run(Thread.java:595)  </span><br></pre></td></tr></table></figure>
<p>仔细观察上面的 DUMP信息, 你会发现它有以下两行：</p>
<ul>
<li>locked &lt;0xef63beb8&gt; (a java.util.ArrayList)</li>
<li>waiting on &lt;0xef63beb8&gt; (a java.util.ArrayList)<br>这里需要解释一下, 为什么先 lock了这个对象, 然后又 waiting on同一个对象呢？让我们看看这个线程对应的代码：</li>
</ul>
<p>Java代码  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(obj) &#123;  </span><br><span class="line">​       .........  </span><br><span class="line">​       obj.wait();  </span><br><span class="line">​       .........  </span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>
<p>线程的执行中, 先用 synchronized 获得了这个对象的 Monitor（对应于 locked &lt;0xef63beb8&gt; ）。当执行到 obj.wait(), 线程即放弃了 Monitor的所有权, 进入 “wait set”队列（对应于 waiting on &lt;0xef63beb8&gt; ）。<br>​         往往在你的程序中, 会出现多个类似的线程, 他们都有相似的 DUMP信息。这也可能是正常的。比如, 在程序中, 有多个服务线程, 设计成从一个队列里面读取请求数据。这个队列就是 lock以及 waiting on的对象。当队列为空的时候, 这些线程都会在这个队列上等待, 直到队列有了数据, 这些线程被 Notify, 当然只有一个线程获得了 lock, 继续执行, 而其它线程继续等待。</p>
<h2 id="JDK-5-0-的-lock"><a href="#JDK-5-0-的-lock" class="headerlink" title="JDK 5.0 的 lock"></a>JDK 5.0 的 lock</h2><p>​        上面我们提到如果 synchronized和 monitor机制运用不当, 可能会造成多线程程序的性能问题。在 JDK 5.0中, 引入了 Lock机制, 从而使开发者能更灵活的开发高性能的并发多线程程序, 可以替代以往 JDK中的 synchronized和 Monitor的 机制。但是, 要注意的是, 因为 Lock类只是一个普通类,  JVM无从得知 Lock对象的占用情况, 所以在线程 DUMP中, 也不会包含关于 Lock的信息,  关于死锁等问题, 就不如用 synchronized的编程方式容易识别。</p>
<h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><ol>
<li>死锁<br>在多线程程序的编写中, 如果不适当的运用同步机制, 则有可能造成程序的死锁, 经常表现为程序的停顿, 或者不再响应用户的请求。比如在下面这个示例中, 是个较为典型的死锁情况：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;Thread-1&quot; prio=5 tid=0x00acc490 nid=0xe50 waiting for monitor entry [0x02d3f000  </span><br><span class="line">..0x02d3fd68]  </span><br><span class="line">at deadlockthreads.TestThread.run(TestThread.java:31)  </span><br><span class="line">- waiting to lock &lt;0x22c19f18&gt; (a java.lang.Object)  </span><br><span class="line">- locked &lt;0x22c19f20&gt; (a java.lang.Object)  </span><br><span class="line">&quot;Thread-0&quot; prio=5 tid=0x00accdb0 nid=0xdec waiting for monitor entry [0x02cff000  </span><br><span class="line">..0x02cff9e8]  </span><br><span class="line">at deadlockthreads.TestThread.run(TestThread.java:31)  </span><br><span class="line">- waiting to lock &lt;0x22c19f20&gt; (a java.lang.Object)  </span><br><span class="line">- locked &lt;0x22c19f18&gt; (a java.lang.Object)  </span><br></pre></td></tr></table></figure>



<p>在 JAVA 5中加强了对死锁的检测。线程 Dump中可以直接报告出 Java级别的死锁, 如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Found one Java-level deadlock:  </span><br><span class="line">=============================  </span><br><span class="line">&quot;Thread-1&quot;:  </span><br><span class="line">waiting to lock monitor 0x0003f334 (object 0x22c19f18, a java.lang.Object),  </span><br><span class="line">which is held by &quot;Thread-0&quot;  </span><br><span class="line">&quot;Thread-0&quot;:  </span><br><span class="line">waiting to lock monitor 0x0003f314 (object 0x22c19f20, a java.lang.Object),  </span><br><span class="line">which is held by &quot;Thread-1&quot;   </span><br></pre></td></tr></table></figure>

<ol start="2">
<li>热锁<br>​        热锁, 也往往是导致系统性能瓶颈的主要因素。其表现特征为, 由于多个线程对临界区, 或者锁的竞争, 可能出现：</li>
</ol>
<ul>
<li>  频繁的线程的上下文切换：从操作系统对线程的调度来看, 当 线程在等待资源而阻塞的时候, 操作系统会将之切换出来, 放到等待的队列, 当线程获得资源之后, 调度算法会将这个线程切换进去, 放到执行队列中。    * 大量的系统调用：因为线程的上下文切换, 以及热锁的竞争, 或 者临界区的频繁的进出, 都可能导致大量的系统调用。    * 大部分 CPU开销用在 “系统态 ”：线程上下文切换, 和系统调用, 都会导致 CPU在 “系统态 ”运行, 换而言之, 虽然系统很忙碌, 但是 CPU用在 “用户态 ”的比例较小, 应用程序得不到充分的 CPU资源。</li>
<li> 随着 CPU数目的增多, 系统的性能反而下降。因为 CPU数目多, 同 时运行的线程就越多, 可能就会造成更频繁的线程上下文切换和系统态的 CPU开销, 从而导致更糟糕的性能。 *<br>上面的描述, 都是一个 scalability（可扩展性）很差的系统的表现。从整体的性能指标看, 由于线程热锁的存在, 程序的响应时间会变长, 吞吐量会降低。&lt; /span&gt;<br>​<br>那么, 怎么去了解 “热锁 ”出现在什么地方呢？一个重要的方法还是结合操作系统的各种工具观察系统资源使用状况, 以及收集 Java线程的 DUMP信息, 看线程都阻塞在什么方法上, 了解原因, 才能找到对应的解决方法。<br>​<br>我们曾经遇到过这样的例子, 程序运行时, 出现了以上指出的各种现象, 通过观察操作系统的资源使用统计信息, 以及线程 DUMP信息, 确定了程序中热锁的存在, 并发现大多数的线程状态都是 Waiting for monitor entry或者 Wait on monitor, 且是阻塞在压缩和解压缩的方法上。后来采用第三方的压缩包 javalib替代 JDK自带的压缩包后, 系统的性能提高了几倍。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/multithread/07.Fork-Join/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/multithread/07.Fork-Join/" class="post-title-link" itemprop="url">Java并发7: Fork/Join</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-03 00:00:00" itemprop="dateCreated datePublished" datetime="2017-04-03T00:00:00+08:00">2017-04-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-什么是Fork-Join框架"><a href="#1-什么是Fork-Join框架" class="headerlink" title="1. 什么是Fork/Join框架"></a>1. 什么是Fork/Join框架</h2><p>Fork/Join框架是Java7提供了的一个用于并行执行任务的框架， 是一个把大任务分割成若干个小任务，最终汇总每个小任务结果后得到大任务结果的框架。</p>
<p>我们再通过Fork和Join这两个单词来理解下Fork/Join框架，Fork就是把一个大任务切分为若干子任务并行的执行，Join就是合并这些子任务的执行结果，最后得到这个大任务的结果。比如计算1+2+。。＋10000，可以分割成10个子任务，每个子任务分别对1000个数进行求和，最终汇总这10个子任务的结果。Fork/Join的运行流程图如下：</p>
<p><img src="http://cdn2.infoqstatic.com/statics_s2_20170411-0445/resource/articles/fork-join-introduction/zh/resources/21.png" alt="img"></p>
<h2 id="2-工作窃取算法"><a href="#2-工作窃取算法" class="headerlink" title="2. 工作窃取算法"></a>2. 工作窃取算法</h2><p>工作窃取（work-stealing）算法是指某个线程从其他队列里窃取任务来执行。工作窃取的运行流程图如下：</p>
<p><img src="http://cdn2.infoqstatic.com/statics_s2_20170411-0445/resource/articles/fork-join-introduction/zh/resources/image3.png" alt="img"></p>
<p>那么为什么需要使用工作窃取算法呢？假如我们需要做一个比较大的任务，我们可以把这个任务分割为若干互不依赖的子任务，为了减少线程间的竞争，于是把这些子任务分别放到不同的队列里，并为每个队列创建一个单独的线程来执行队列里的任务，线程和队列一一对应，比如A线程负责处理A队列里的任务。但是有的线程会先把自己队列里的任务干完，而其他线程对应的队列里还有任务等待处理。干完活的线程与其等着，不如去帮其他线程干活，于是它就去其他线程的队列里窃取一个任务来执行。而在这时它们会访问同一个队列，所以为了减少窃取任务线程和被窃取任务线程之间的竞争，通常会使用双端队列，被窃取任务线程永远从双端队列的头部拿任务执行，而窃取任务的线程永远从双端队列的尾部拿任务执行。</p>
<p>工作窃取算法的优点是充分利用线程进行并行计算，并减少了线程间的竞争，其缺点是在某些情况下还是存在竞争，比如双端队列里只有一个任务时。并且消耗了更多的系统资源，比如创建多个线程和多个双端队列。</p>
<h2 id="3-Fork-Join框架的介绍"><a href="#3-Fork-Join框架的介绍" class="headerlink" title="3. Fork/Join框架的介绍"></a>3. Fork/Join框架的介绍</h2><p>我们已经很清楚Fork/Join框架的需求了，那么我们可以思考一下，如果让我们来设计一个Fork/Join框架，该如何设计？这个思考有助于你理解Fork/Join框架的设计。</p>
<p>第一步分割任务。首先我们需要有一个fork类来把大任务分割成子任务，有可能子任务还是很大，所以还需要不停的分割，直到分割出的子任务足够小。</p>
<p>第二步执行任务并合并结果。分割的子任务分别放在双端队列里，然后几个启动线程分别从双端队列里获取任务执行。子任务执行完的结果都统一放在一个队列里，启动一个线程从队列里拿数据，然后合并这些数据。</p>
<p>Fork/Join使用两个类来完成以上两件事情：</p>
<ul>
<li>ForkJoinTask：我们要使用ForkJoin框架，必须首先创建一个ForkJoin任务。它提供在任务中执行fork()和join()操作的机制，通常情况下我们不需要直接继承ForkJoinTask类，而只需要继承它的子类，Fork/Join框架提供了以下两个子类：    <ul>
<li>RecursiveAction：用于没有返回结果的任务。</li>
<li>RecursiveTask ：用于有返回结果的任务。</li>
</ul>
</li>
<li>ForkJoinPool ：ForkJoinTask需要通过ForkJoinPool来执行，任务分割出的子任务会添加到当前工作线程所维护的双端队列中，进入队列的头部。当一个工作线程的队列里暂时没有任务时，它会随机从其他工作线程的队列的尾部获取一个任务。</li>
</ul>
<h2 id="4-使用Fork-Join框架"><a href="#4-使用Fork-Join框架" class="headerlink" title="4. 使用Fork/Join框架"></a>4. 使用Fork/Join框架</h2><p>让我们通过一个简单的需求来使用下Fork／Join框架，需求是：计算1+2+3+4的结果。</p>
<p>使用Fork／Join框架首先要考虑到的是如何分割任务，如果我们希望每个子任务最多执行两个数的相加，那么我们设置分割的阈值是2，由于是4个数字相加，所以Fork／Join框架会把这个任务fork成两个子任务，子任务一负责计算1+2，子任务二负责计算3+4，然后再join两个子任务的结果。</p>
<p>因为是有结果的任务，所以必须继承RecursiveTask，实现代码如下：</p>
<p><img src="http://cdn2.infoqstatic.com/statics_s2_20170411-0445/resource/articles/fork-join-introduction/zh/resources/31.png" alt="img"></p>
<p><img src="http://cdn2.infoqstatic.com/statics_s2_20170411-0445/resource/articles/fork-join-introduction/zh/resources/eeeee.png" alt="img"></p>
<p>通过这个例子让我们再来进一步了解ForkJoinTask，ForkJoinTask与一般的任务的主要区别在于它需要实现compute方法，在这个方法里，首先需要判断任务是否足够小，如果足够小就直接执行任务。如果不足够小，就必须分割成两个子任务，每个子任务在调用fork方法时，又会进入compute方法，看看当前子任务是否需要继续分割成孙任务，如果不需要继续分割，则执行当前子任务并返回结果。使用join方法会等待子任务执行完并得到其结果。</p>
<h2 id="5-Fork-Join框架的异常处理"><a href="#5-Fork-Join框架的异常处理" class="headerlink" title="5. Fork/Join框架的异常处理"></a>5. Fork/Join框架的异常处理</h2><p>ForkJoinTask在执行的时候可能会抛出异常，但是我们没办法在主线程里直接捕获异常，所以ForkJoinTask提供了isCompletedAbnormally()方法来检查任务是否已经抛出异常或已经被取消了，并且可以通过ForkJoinTask的getException方法获取异常。使用如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(task.isCompletedAbnormally())</span><br><span class="line">&#123;</span><br><span class="line">    System.out.println(task.getException());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>getException方法返回Throwable对象，如果任务被取消了则返回CancellationException。如果任务没有完成或者没有抛出异常则返回null。</p>
<h2 id="6-Fork-Join框架的实现原理"><a href="#6-Fork-Join框架的实现原理" class="headerlink" title="6. Fork/Join框架的实现原理"></a>6. Fork/Join框架的实现原理</h2><p>ForkJoinPool由ForkJoinTask数组和ForkJoinWorkerThread数组组成，ForkJoinTask数组负责存放程序提交给ForkJoinPool的任务，而ForkJoinWorkerThread数组负责执行这些任务。</p>
<p>ForkJoinTask的fork方法实现原理。当我们调用ForkJoinTask的fork方法时，程序会调用ForkJoinWorkerThread的pushTask方法异步的执行这个任务，然后立即返回结果。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public final ForkJoinTask fork() &#123;         ((ForkJoinWorkerThread) Thread.currentThread())             .pushTask(this);         return this; &#125; </span><br></pre></td></tr></table></figure>
<p>pushTask方法把当前任务存放在ForkJoinTask 数组queue里。然后再调用ForkJoinPool的signalWork()方法唤醒或创建一个工作线程来执行任务。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">final void pushTask(ForkJoinTask t) &#123;</span><br><span class="line">        ForkJoinTask[] q; int s, m;</span><br><span class="line">        if ((q &#x3D; queue) !&#x3D; null) &#123;    &#x2F;&#x2F; ignore if queue removed</span><br><span class="line">            long u &#x3D; (((s &#x3D; queueTop) &amp; (m &#x3D; q.length - 1)) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">            UNSAFE.putOrderedObject(q, u, t);</span><br><span class="line">            queueTop &#x3D; s + 1;         &#x2F;&#x2F; or use putOrderedInt</span><br><span class="line">            if ((s -&#x3D; queueBase) &lt;&#x3D; 2)</span><br><span class="line">                pool.signalWork();</span><br><span class="line">	else if (s &#x3D;&#x3D; m)</span><br><span class="line">                growQueue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ForkJoinTask的join方法实现原理。Join方法的主要作用是阻塞当前线程并等待获取结果。让我们一起看看ForkJoinTask的join方法的实现，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public final V join() &#123;</span><br><span class="line">        if (doJoin() !&#x3D; NORMAL)</span><br><span class="line">            return reportResult();</span><br><span class="line">        else</span><br><span class="line">            return getRawResult();</span><br><span class="line">&#125;</span><br><span class="line">private V reportResult() &#123;</span><br><span class="line">        int s; Throwable ex;</span><br><span class="line">        if ((s &#x3D; status) &#x3D;&#x3D; CANCELLED)</span><br><span class="line">            throw new CancellationException();</span><br><span class="line">if (s &#x3D;&#x3D; EXCEPTIONAL &amp;&amp; (ex &#x3D; getThrowableException()) !&#x3D; null)</span><br><span class="line">            UNSAFE.throwException(ex);</span><br><span class="line">        return getRawResult();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先，它调用了doJoin()方法，通过doJoin()方法得到当前任务的状态来判断返回什么结果，任务状态有四种：已完成（NORMAL），被取消（CANCELLED），信号（SIGNAL）和出现异常（EXCEPTIONAL）。</p>
<ul>
<li>如果任务状态是已完成，则直接返回任务结果。</li>
<li>如果任务状态是被取消，则直接抛出CancellationException。</li>
<li>如果任务状态是抛出异常，则直接抛出对应的异常。</li>
</ul>
<p>让我们再来分析下doJoin()方法的实现代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private int doJoin() &#123;</span><br><span class="line">        Thread t; ForkJoinWorkerThread w; int s; boolean completed;</span><br><span class="line">        if ((t &#x3D; Thread.currentThread()) instanceof ForkJoinWorkerThread) &#123;</span><br><span class="line">            if ((s &#x3D; status) &lt; 0)</span><br><span class="line"> return s;</span><br><span class="line">            if ((w &#x3D; (ForkJoinWorkerThread)t).unpushTask(this)) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    completed &#x3D; exec();</span><br><span class="line">                &#125; catch (Throwable rex) &#123;</span><br><span class="line">                    return setExceptionalCompletion(rex);</span><br><span class="line">                &#125;</span><br><span class="line">                if (completed)</span><br><span class="line">                    return setCompletion(NORMAL);</span><br><span class="line">            &#125;</span><br><span class="line">            return w.joinTask(this);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">            return externalAwaitDone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在doJoin()方法里，首先通过查看任务的状态，看任务是否已经执行完了，如果执行完了，则直接返回任务状态，如果没有执行完，则从任务数组里取出任务并执行。如果任务顺利执行完成了，则设置任务状态为NORMAL，如果出现异常，则纪录异常，并将任务状态设置为EXCEPTIONAL。</p>
<h2 id="7-参考资料"><a href="#7-参考资料" class="headerlink" title="7. 参考资料"></a>7. 参考资料</h2><ul>
<li>JDK1.7源码</li>
<li><a target="_blank" rel="noopener" href="http://ifeve.com/fork-join-5/">http://ifeve.com/fork-join-5/</a></li>
</ul>
<h2 id="8-作者介绍"><a href="#8-作者介绍" class="headerlink" title="8. 作者介绍"></a>8. 作者介绍</h2><p><strong>方腾飞</strong>，花名清英，并发编程网站站长。目前在阿里巴巴微贷事业部工作。并发编程网：<a target="_blank" rel="noopener" href="http://ifeve.com/">http://ifeve.com</a>，个人微博：<a target="_blank" rel="noopener" href="http://weibo.com/kirals">http://weibo.com/kirals</a>，欢迎通过我的微博进行技术交流。</p>
<p>感谢<a target="_blank" rel="noopener" href="http://www.infoq.com/cn/bycategory.action?authorName=%E5%BC%A0%E9%BE%99">张龙</a>对本文的审校。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/docker/base/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/docker/base/" class="post-title-link" itemprop="url">Docker</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-03-24 00:00:00" itemprop="dateCreated datePublished" datetime="2017-03-24T00:00:00+08:00">2017-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-19 15:02:11" itemprop="dateModified" datetime="2021-04-19T15:02:11+08:00">2021-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Distributed/" itemprop="url" rel="index"><span itemprop="name">Distributed</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>网易镜像 <a target="_blank" rel="noopener" href="https://c.163yun.com/hub#/m/home/">https://c.163yun.com/hub#/m/home/</a></p>
<h1 id="修改数据源"><a href="#修改数据源" class="headerlink" title="修改数据源"></a>修改数据源</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod a+w /etc/sysconfig/docker</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 增加 ADD_REGISTRY=&#x27;--add-registry hub.c.163.com&#x27;</span></span></span><br></pre></td></tr></table></figure>
<h1 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h1><h2 id="image"><a href="#image" class="headerlink" title="image"></a>image</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image ls</span><br></pre></td></tr></table></figure>



<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE                         COMMAND               CREATED             STATUS              PORTS                   NAMES</span><br><span class="line">f7c2d84561dd        hub.c.163.com/public/centos   &quot;/usr/sbin/sshd -D&quot;   7 minutes ago       Up 7 minutes        0.0.0.0:32768-&gt;22/tcp   centos</span><br><span class="line"></span><br><span class="line">docker exec -it centos /bin/bash</span><br></pre></td></tr></table></figure>


<h2 id="文件拷贝"><a href="#文件拷贝" class="headerlink" title="文件拷贝"></a>文件拷贝</h2><ol>
<li>本地copy文件到container</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp ~/putMerge.jar hadoop0:~/</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>container文件copy到本地</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp hadoop0:~/putMerge.jar ~/</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>images 重命名</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker tag IMAGEID(镜像id) REPOSITORY:TAG（仓库：标签）</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">例子</span></span><br><span class="line">docker tag ca1b6b825289 reffs/xxxxxxx:v1.0</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum list installed | grep docker</span><br><span class="line">卸载：</span><br><span class="line"></span><br><span class="line">yum -y remove docker.x86_64</span><br><span class="line">重装：</span><br><span class="line"></span><br><span class="line">yum install docker-io</span><br><span class="line">启动：</span><br><span class="line"></span><br><span class="line">service docker start</span><br></pre></td></tr></table></figure>
<p>Docker 核心基础技术</p>
<ul>
<li>Namespace</li>
<li>cgroup</li>
</ul>
<p>linux Namespace</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setns(fd,..)</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ls -l /proc/1/ns</span><br><span class="line"></span><br><span class="line">ll /proc/1/ns/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun  5 15:20 cgroup -&gt; cgroup:[4026531835]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun  5 15:20 ipc -&gt; ipc:[4026531839]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 15 19:28 mnt -&gt; mnt:[4026531840]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 15 19:28 net -&gt; net:[4026531957]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun  5 15:20 pid -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 15 16:20 uts -&gt; uts:[4026531838]</span><br></pre></td></tr></table></figure>


<h2 id="cgroup-子系统"><a href="#cgroup-子系统" class="headerlink" title="cgroup 子系统"></a>cgroup 子系统</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lssubsys -m</span><br><span class="line"></span><br><span class="line">lssubsys -m</span><br><span class="line">cpuset /sys/fs/cgroup/cpuset</span><br><span class="line">cpu,cpuacct /sys/fs/cgroup/cpu,cpuacct</span><br><span class="line">memory /sys/fs/cgroup/memory</span><br><span class="line">devices /sys/fs/cgroup/devices</span><br><span class="line">freezer /sys/fs/cgroup/freezer</span><br><span class="line">net_cls /sys/fs/cgroup/net_cls</span><br><span class="line">blkio /sys/fs/cgroup/blkio</span><br><span class="line">perf_event /sys/fs/cgroup/perf_event</span><br><span class="line">hugetlb /sys/fs/cgroup/hugetlb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls /sys/fs/cgroup/cpu/mytest</span><br><span class="line"></span><br><span class="line">cgcreate -g cpu:mytest</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">aaronzhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">237</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">127</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aaronzhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
