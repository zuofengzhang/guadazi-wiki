<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Guadazi">
<meta property="og:url" content="http://example.com/page/19/index.html">
<meta property="og:site_name" content="Guadazi">
<meta property="og:locale">
<meta property="article:author" content="aaronzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/19/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>Guadazi</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Guadazi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Flink/AsyncApiScalaSink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Flink/AsyncApiScalaSink/" class="post-title-link" itemprop="url">Flink AsyncApiScalaSink</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:24" itemprop="dateModified" datetime="2021-04-12T17:33:24+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Flink-AsyncApiScalaSink"><a href="#Flink-AsyncApiScalaSink" class="headerlink" title="Flink AsyncApiScalaSink"></a>Flink AsyncApiScalaSink</h1><p>andrew建议：</p>
<ul>
<li>onCompeleted没有把IOException暴露给用户</li>
<li>链接配置之类的参数如何传递进去</li>
<li>反压机制如何做？sink经常遇到的问题，下游抖动会直接导致数据丢失</li>
<li>反压 限流 重试</li>
<li>支持batch，条数控制</li>
<li>checkpoint时，需要batch立即flush出去</li>
</ul>
<h2 id="Http-Client"><a href="#Http-Client" class="headerlink" title="Http Client"></a>Http Client</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore-nio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpasyncclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="AsyncApiScalaSink"><a href="#AsyncApiScalaSink" class="headerlink" title="AsyncApiScalaSink"></a>AsyncApiScalaSink</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.<span class="type">IOException</span></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.sink.&#123;<span class="type">RichSinkFunction</span>, <span class="type">SinkFunction</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.http._</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.entity.<span class="type">UrlEncodedFormEntity</span></span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.&#123;<span class="type">HttpEntityEnclosingRequestBase</span>, <span class="type">HttpPost</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.concurrent.<span class="type">FutureCallback</span></span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.<span class="type">DefaultConnectionKeepAliveStrategy</span></span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.nio.client.&#123;<span class="type">CloseableHttpAsyncClient</span>, <span class="type">HttpAsyncClients</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.message.<span class="type">BasicNameValuePair</span></span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.<span class="type">EntityUtils</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncApiScalaSink</span>[<span class="type">E</span>](<span class="params">httpInvoker: <span class="type">HttpInvoker</span>[<span class="type">E</span>]</span>) <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>[<span class="type">E</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> httpClient: <span class="type">CloseableHttpAsyncClient</span> = _</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    httpClient = <span class="type">HttpAsyncClients</span>.custom.setKeepAliveStrategy(<span class="type">DefaultConnectionKeepAliveStrategy</span>.<span class="type">INSTANCE</span>).build</span><br><span class="line">    httpClient.start()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">invoke</span></span>(value: <span class="type">E</span>, context: <span class="type">SinkFunction</span>.<span class="type">Context</span>[_]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> httpEntity: <span class="type">HttpEntityEnclosingRequestBase</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">val</span> method: <span class="type">String</span> = httpInvoker.getMethod</span><br><span class="line">    <span class="keyword">val</span> url: <span class="type">String</span> = httpInvoker.getUrl</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;GET&quot;</span> == method) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;POST&quot;</span> == method) &#123;</span><br><span class="line">      <span class="keyword">val</span> params1: util.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>] = httpInvoker.getParams(value)</span><br><span class="line">      <span class="keyword">val</span> params: util.<span class="type">List</span>[<span class="type">NameValuePair</span>] = <span class="keyword">new</span> util.<span class="type">ArrayList</span>[<span class="type">NameValuePair</span>]</span><br><span class="line">      <span class="keyword">if</span> (params1 != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">import</span> scala.collection.<span class="type">JavaConversions</span>._</span><br><span class="line">        <span class="keyword">for</span> (entry &lt;- params1.entrySet) &#123;</span><br><span class="line">          <span class="keyword">val</span> key: <span class="type">String</span> = entry.getKey</span><br><span class="line">          <span class="keyword">val</span> value1: <span class="type">String</span> = entry.getValue</span><br><span class="line">          params.add(<span class="keyword">new</span> <span class="type">BasicNameValuePair</span>(key, value1))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">val</span> entity: <span class="type">UrlEncodedFormEntity</span> = <span class="keyword">new</span> <span class="type">UrlEncodedFormEntity</span>(params, <span class="type">Consts</span>.<span class="type">UTF_8</span>)</span><br><span class="line">      httpEntity = <span class="keyword">new</span> <span class="type">HttpPost</span>(url)</span><br><span class="line">      httpEntity.setEntity(entity)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    httpClient.execute(httpEntity, <span class="keyword">new</span> <span class="type">FutureCallback</span>[<span class="type">HttpResponse</span>]() &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">completed</span></span>(response: <span class="type">HttpResponse</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> statusLine: <span class="type">StatusLine</span> = response.getStatusLine</span><br><span class="line">        <span class="keyword">val</span> httpStatusCode: <span class="type">Int</span> = statusLine.getStatusCode</span><br><span class="line">        <span class="keyword">var</span> content: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">val</span> entity: <span class="type">HttpEntity</span> = response.getEntity</span><br><span class="line">          content = <span class="type">EntityUtils</span>.toString(entity)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">          <span class="keyword">case</span> e: <span class="type">IOException</span> =&gt;</span><br><span class="line">            <span class="type">System</span>.err.print(e.getMessage)</span><br><span class="line">        &#125;</span><br><span class="line">        httpInvoker.onCompleted(value, httpStatusCode, content)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">failed</span></span>(ex: <span class="type">Exception</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        httpInvoker.onFailed(value, ex)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">cancelled</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">        httpInvoker.onCanceled(value)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">close</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    httpClient.close()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="HttpInvoker"><a href="#HttpInvoker" class="headerlink" title="HttpInvoker"></a>HttpInvoker</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.<span class="type">Serializable</span>;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Map</span>;</span><br><span class="line"></span><br><span class="line">public interface <span class="type">HttpInvoker</span>&lt;<span class="type">E</span>&gt; <span class="keyword">extends</span> <span class="type">Serializable</span> &#123;</span><br><span class="line">    <span class="type">Map</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt; getParams(<span class="type">E</span> e);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> getMethod();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> getUrl();</span><br><span class="line"></span><br><span class="line">    void onCompleted(<span class="type">E</span> value, int httpStatusCode, <span class="type">String</span> content);</span><br><span class="line"></span><br><span class="line">    void onFailed(<span class="type">E</span> value, <span class="type">Exception</span> ex);</span><br><span class="line"></span><br><span class="line">    void onCanceled(<span class="type">E</span> value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/HBase/HBase/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/HBase/HBase/" class="post-title-link" itemprop="url">HBase基础与开发实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:24" itemprop="dateModified" datetime="2021-04-12T17:33:24+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h1><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="避免数据热点"><a href="#避免数据热点" class="headerlink" title="避免数据热点"></a>避免数据热点</h3><p>加盐的过程本质上是对原有的主键加上一个字节的前缀，<br>如下面公式所示：<br>new_row_key = (++index % BUCKETS_NUMBER) + original_key</p>
<p>BUCKETS_NUMBER 为桶的个数。主键的分布决定了数据的分布，把主键<br>打散也就意味着数据打散。具体使用时，一般建议桶的数目等于 RegionServer 的<br>数目。</p>
<h3 id="多租户"><a href="#多租户" class="headerlink" title="多租户"></a>多租户</h3><p>我们开发了 DHS 系统（Didi HBase Service）进行项目管理，并且在 HBase 上通过 Namespace、RS Group 等技术来分割用户的资源、数据和权限。通过计算开销并计费的方法来管控资源分配</p>
<p>HBase 自带的 jxm 信息会汇总到 Region 和 RegionServer 级别的数据，管理员会经常用到，但是用户却很少关注这个级别。根据这种情况我们开发了 HBase 表级别的监控，并且会有权限控制，让业务 RD 只能看到和自己相关的表，清楚自己项目表的吞吐及存储占用情况</p>
<p>RegionServer Group，实现细节可以参照 HBase HBASE-6721 这个 Patch。滴滴在这个基础上作了一些分配策略上的优化，以便适合滴滴业务场景的修改。RS Group简单概括是指通过分配一批指定的RegionServer列表，成为一个RS Group，每个 Group 可以按需挂载不同的表，并且当 Group 内的表发生异常后，Region不会迁移到其他的 Group。这样，每个 Group 就相当于一个逻辑上的子集群，通过这种方式达到资源隔离的效果，降低管理成本，不必为每个高 SLA 的业务线单独搭集群。</p>
<h2 id="HDFS中文件的存储"><a href="#HDFS中文件的存储" class="headerlink" title="HDFS中文件的存储"></a>HDFS中文件的存储</h2><p><a target="_blank" rel="noopener" href="https://hbase.apache.org/book.html#trouble.namenode.hbase.objects">Browsing HDFS for HBase Objects</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/hbase/data/default/&lt;table_name&gt;/ab0ba9f7e0d2898a0f61aa687d3d4886/&lt;column_family&gt;/&lt;HFile_name&gt;</span><br></pre></td></tr></table></figure>
<p>如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/hbase/data/default/my_table/d177ff7276d2e46d69dc50f67f92643a/cf/</span><br></pre></td></tr></table></figure>
<p>HFile每bulkload一次，新增加的HFile序列号增加1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ./hadoop fs -ls /hbase/data/default/recommend_result/d177ff7276d2e46d69dc50f67f92643a/cf</span><br><span class="line">Found 2 items</span><br><span class="line">-rw-rw-rw-   3 tdw_hectorhe g_cdg_cft_data__cft 2791972087 2019-04-11 07:06 /hbase/data/default/recommend_result/d177ff7276d2e46d69dc50f67f92643a/cf/accd28866e6d40738849b4efb08ea154_SeqId_312_</span><br><span class="line">-rw-r--r--   3 hbaseadmin   users               2941438650 2019-04-11 04:07 /hbase/data/default/recommend_result/d177ff7276d2e46d69dc50f67f92643a/cf/ee29f8ad0fa14f508793108234242de4</span><br></pre></td></tr></table></figure>
<p>如上面的<code>seqId_1</code>，代表序列号为1，在major compact时，将合并成一个文件</p>
<p>如果存在多个HFile，就需要同时查询多个列族。</p>
<ol>
<li>一个region只保存在一个region server中，不会跨越region server，由hdfs保证高可用</li>
</ol>
<h3 id="client写入"><a href="#client写入" class="headerlink" title="client写入"></a>client写入</h3><p>通过client写入数据时，首先会把数据写入到memstore和WAL，数据到达一定的阈值，才会溢写到StoreFile，StoreFile也就是HFile</p>
<h2 id="zk存储"><a href="#zk存储" class="headerlink" title="zk存储"></a>zk存储</h2><h2 id="hbase-meta"><a href="#hbase-meta" class="headerlink" title="hbase meta"></a>hbase meta</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):053:0&gt; list_namespace_tables &#x27;hbase&#x27;</span><br><span class="line">TABLE </span><br><span class="line">meta      </span><br><span class="line">namespace </span><br><span class="line">rsgroup  </span><br><span class="line">3 row(s) in 0.0040 seconds</span><br></pre></td></tr></table></figure>





<h2 id="GET的过程"><a href="#GET的过程" class="headerlink" title="GET的过程"></a>GET的过程</h2><h2 id="Coprocessor"><a href="#Coprocessor" class="headerlink" title="Coprocessor"></a>Coprocessor</h2><h2 id="Phoenix"><a href="#Phoenix" class="headerlink" title="Phoenix"></a>Phoenix</h2><p>在没有 Phoenix 之前，用户如果需要分析 HBase 数据，只能从 HBase 拖出去或者绕过 HBase 直接读取 HDFS 上面的HFile 的方式进行，前者浪费了大量的网络IO，后者用不到 HBase 本身做的大量缓存和索引优化。Phoenix 使用 HBase 的协处理器机制，直接在 RegionServer 上执行算子逻辑，然后将算子的结果返回即可，也就是大数据中的“Move Operator to Data”理念。比如，用户执行“ <code>select count(*) from mytable where mytime &gt; timestamp’2018-11-11 0:00:00’</code> ”，在实际执行中，会先找到符合过滤条件的region，然后在RegionServer本地计算count，最后再对各个 Region 上的结果进行汇总。</p>
<p>索引是传统数据库中常见的技术，HBase 表中可以指定主键，对主键使用 LSM 算<br>法构建索引。Phoenix 中，用户在创建表的时候，可以指定索引列，可以是单列，<br>也可以是组合列。很多时候仅有主键索引是不够的，特别是对于列特别多的宽表，<br>为此，Phoenix 提供二级索引功能，用户能够对表中非主键的列添加索引，并可<br>以加入其它相关列到索引表中，如果某个查询涉及到的列全部在索引表中，直接<br>查询索引表即可，无需访问原数据表。索引表跟原表做到实时同步更新，以保证<br>数据一致性。</p>
<p><a target="_blank" rel="noopener" href="https://www.imooc.com/video/15575">imooc</a></p>
<p>@Controller<br>    @SessionAttributes({ “credentials”, “user” })</p>
<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><h3 id="HFile文件的元数据"><a href="#HFile文件的元数据" class="headerlink" title="HFile文件的元数据"></a>HFile文件的元数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -du -h /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/</span><br><span class="line">16.0 G  /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/0e950ca090d54eb2b98abffc2e285cfa_SeqId_4_</span><br><span class="line">16.0 G  /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/bfc0c2e4fae84ba19ad1eaf78ea04967_SeqId_4_</span><br><span class="line">16.0 G  /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/e5f3675a6b0040faa695ec3b35b2e951_SeqId_4_</span><br><span class="line">6.1 G   /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/f5c2d2461e0f4eb58ed6c75aa1ae9ffa_SeqId_4_</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hbase hfile -m -f /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/0e950ca090d54eb2b98abffc2e285cfa_SeqId_4_</span><br><span class="line"></span><br><span class="line">2020-03-18 14:19:37,389 INFO  [main] hfile.CacheConfig: Created cacheConfig: CacheConfig:disabled</span><br><span class="line">Block index size as per heapsize: 5288</span><br><span class="line">reader=/hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/0e950ca090d54eb2b98abffc2e285cfa_SeqId_4_,</span><br><span class="line">    compression=none,</span><br><span class="line">    cacheConf=CacheConfig:disabled,</span><br><span class="line">    firstKey=0632079511/i:v/1584411652893/Put,</span><br><span class="line">    lastKey=0938227441/i:v/1584411652893/Put,</span><br><span class="line">    avgKeyLen=23,</span><br><span class="line">    avgValueLen=1837,</span><br><span class="line">    entries=9189138,</span><br><span class="line">    length=17212333944</span><br><span class="line">Trailer:</span><br><span class="line">    fileinfoOffset=17212333262,</span><br><span class="line">    loadOnOpenDataOffset=17212330707,</span><br><span class="line">    dataIndexCount=73,</span><br><span class="line">    metaIndexCount=0,</span><br><span class="line">    totalUncomressedBytes=17207143638,</span><br><span class="line">    entryCount=9189138,</span><br><span class="line">    compressionCodec=NONE,</span><br><span class="line">    uncompressedDataIndexSize=9529760,</span><br><span class="line">    numDataIndexLevels=2,</span><br><span class="line">    firstDataBlockOffset=0,</span><br><span class="line">    lastDataBlockOffset=17212236283,</span><br><span class="line">    comparatorClassName=org.apache.hadoop.hbase.KeyValue$KeyComparator,</span><br><span class="line">    majorVersion=2,</span><br><span class="line">    minorVersion=3</span><br><span class="line">Fileinfo:</span><br><span class="line">    BULKLOAD_SOURCE_TASK = attempt_20200317094633_0002_r_000001_0</span><br><span class="line">    BULKLOAD_TIMESTAMP = \x00\x00\x01p\xE6\x81\x87\xD0</span><br><span class="line">    DELETE_FAMILY_COUNT = \x00\x00\x00\x00\x00\x00\x00\x00</span><br><span class="line">    EARLIEST_PUT_TS = \x00\x00\x01p\xE6K3\x1D</span><br><span class="line">    EXCLUDE_FROM_MINOR_COMPACTION = \x00</span><br><span class="line">    KEY_VALUE_VERSION = \x00\x00\x00\x01</span><br><span class="line">    MAJOR_COMPACTION_KEY = \xFF</span><br><span class="line">    MAX_MEMSTORE_TS_KEY = \x00\x00\x00\x00\x00\x00\x00\x00</span><br><span class="line">    TIMERANGE = 1584411652893....1584411652893</span><br><span class="line">    hfile.AVG_KEY_LEN = 23</span><br><span class="line">    hfile.AVG_VALUE_LEN = 1837</span><br><span class="line">    hfile.LASTKEY = \x00\x0A0938227441\x01iv\x00\x00\x01p\xE6K3\x1D\x04</span><br><span class="line">Mid-key: \x00\x09078540676\x00\x7F\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF</span><br><span class="line">Bloom filter:</span><br><span class="line">    Not present</span><br><span class="line">Delete Family Bloom filter:</span><br><span class="line">    Not present</span><br></pre></td></tr></table></figure>

<h2 id="WAL"><a href="#WAL" class="headerlink" title="WAL"></a>WAL</h2><h3 id="写入模型优化"><a href="#写入模型优化" class="headerlink" title="写入模型优化"></a>写入模型优化</h3><p>WAL写入模型</p>
<p>了解了HLog的结构之后，我们就开始研究HLog的写入模型。HLog的写入可以分为三个阶段，首先将数据对&lt;HLogKey,WALEdit&gt;写入本地缓存，然后再将本地缓存写入文件系统，最后执行sync操作同步到磁盘。在以前老的写入模型中，上述三步都由工作线程独自完成，如下图所示：</p>
<p><img src="_v_images/20200815154403071_1496305947.png" alt="103"></p>
<p>上图中，本地缓存写入文件系统那个步骤工作线程需要持有updateLock执行，不同工作线程之间必然会恶性竞争；不仅如此，在Sync HDFS这步中，工作线程之间需要抢占flushLock，因为Sync操作是一个耗时操作，抢占这个锁会导致写入性能大幅降低。</p>
<p>所幸的是，来自中国（准确的来说，是来自小米，鼓掌）的3位工程师意识到了这个问题，进而提出了一种新的写入模型并被官方采纳。根据官方测试，新写入模型的吞吐量比之前提升3倍多，单台RS写入吞吐量介于12150～31520，5台RS组成的集群写入吞吐量介于22000～70000（见HBASE-8755）。下图是小米官方给出来的对比测试结果：</p>
<p><img src="_v_images/20200815154402968_1974951896.png" alt="104"></p>
<p>在新写入模型中，本地缓存写入文件系统以及Sync HDFS都交给了新的独立线程完成，并引入一个Notify线程通知工作线程是否已经Sync成功，采用这种机制消除上述锁竞争，具体如下图所示：</p>
<p><img src="_v_images/20200815154402863_279526558.png" alt="105"></p>
<p>1. 上文中提到工作线程在写入WALEdit之后并没有进行Sync，而是等到释放行锁阻塞在syncedTillHere变量上，等待AsyncNotifier线程唤醒。</p>
<p>2. 工作线程将WALEdit写入本地Buffer之后，会生成一个自增变量txid，携带此txid唤醒AsyncWriter线程</p>
<p>3. AsyncWriter线程会取出本地Buffer中的所有WALEdit，写入HDFS。注意该线程会比较传入的txid和已经写入的最大txid（writtenTxid），如果传入的txid小于writteTxid，表示该txid对应的WALEdit已经写入，直接跳过</p>
<p>4. AsyncWriter线程将所有WALEdit写入HDFS之后携带maxTxid唤醒AsyncFlusher线程</p>
<p>5. AsyncFlusher线程将所有写入文件系统的WALEdit统一Sync刷新到磁盘</p>
<p>6. 数据全部落盘之后调用setFlushedTxid方法唤醒AyncNotifier线程</p>
<p>7. AyncNotifier线程会唤醒所有阻塞在变量syncedTillHere的工作线程，工作线程被唤醒之后表示WAL写入完成，后面再执行MVCC结束写事务，推进全局读取点，本次更新才会对用户可见</p>
<p>通过上述过程的梳理可以知道，新写入模型采取了多线程模式独立完成写文件系统、sync磁盘操作，避免了之前多工作线程恶性抢占锁的问题。同时，工作线程在将WALEdit写入本地Buffer之后并没有马上阻塞，而是释放行锁之后阻塞等待WALEdit落盘，这样可以尽可能地避免行锁竞争，提高写入性能。</p>
<p>wal写入数据写入经历三步:</p>
<ol>
<li>写入本地缓存</li>
<li>写入hdfs</li>
<li>flush hdfs</li>
</ol>
<p>旧的写入模型，工作线程自己写入hdfs和flush，为了避免一致性问题，需要分别竞争updateLock和flushLock, 工作线程在单个线程中完成，写了hdfs，立即直接flush</p>
<p>新的写入模型，将写hdfs和flush hdfs分别由两个单独的线程(AsyncWriter和AsyncFlusher)处理，落盘后回调工作线程；<br>为了避免多个线程同时写入冲突，给每个要写入的文件生成一个自增的txid，写hdfs的线程会把所有的文件全部写入到hdfs，<br>如果工作线程要写的txid小于max txid，代表已经写过了。</p>
<h2 id="memstore"><a href="#memstore" class="headerlink" title="memstore"></a>memstore</h2><h3 id="MSLAB"><a href="#MSLAB" class="headerlink" title="MSLAB"></a>MSLAB</h3><p>LAB 对 GC 的优化</p>
<h3 id="ConcurrentSkipListMap"><a href="#ConcurrentSkipListMap" class="headerlink" title="ConcurrentSkipListMap"></a>ConcurrentSkipListMap</h3><h3 id="CompactingMemStore"><a href="#CompactingMemStore" class="headerlink" title="CompactingMemStore"></a>CompactingMemStore</h3><h2 id="HBase-clonesnapshot-限流实现原理"><a href="#HBase-clonesnapshot-限流实现原理" class="headerlink" title="HBase clonesnapshot 限流实现原理"></a>HBase clonesnapshot 限流实现原理</h2><h2 id="scanner"><a href="#scanner" class="headerlink" title="scanner"></a>scanner</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Flink/DataSourceReplay/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Flink/DataSourceReplay/" class="post-title-link" itemprop="url">Flink: 数据源重放</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:24" itemprop="dateModified" datetime="2021-04-12T17:33:24+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="flink-table-api"><a href="#flink-table-api" class="headerlink" title="flink-table-api"></a>flink-table-api</h1><h2 id="Hippo和Tube如何实现重放"><a href="#Hippo和Tube如何实现重放" class="headerlink" title="Hippo和Tube如何实现重放?"></a>Hippo和Tube如何实现重放?</h2><h3 id="FlinkHippoConsumer"><a href="#FlinkHippoConsumer" class="headerlink" title="FlinkHippoConsumer"></a>FlinkHippoConsumer</h3><h2 id="举一反三"><a href="#举一反三" class="headerlink" title="举一反三"></a>举一反三</h2><h3 id="org-apache-flink-streaming-api-functions-source-RichParallelSourceFunction"><a href="#org-apache-flink-streaming-api-functions-source-RichParallelSourceFunction" class="headerlink" title="org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction"></a>org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction</h3><p>构建并行数据流的基础类，在执行时，运行时将执行与源配置的并行一样多的该函数的并行实例。</p>
<h2 id="org-apache-flink-types-Row"><a href="#org-apache-flink-types-Row" class="headerlink" title="org.apache.flink.types.Row"></a>org.apache.flink.types.Row</h2><p>一行数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[]  fields</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/skill/Image-round-protrait/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/skill/Image-round-protrait/" class="post-title-link" itemprop="url">Java图片处理二--合成圆形头像(类似于QQ群聊)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:23" itemprop="dateModified" datetime="2021-04-12T17:33:23+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p> <a href="/Java/Image-zip-square-portrait/">上一篇</a> 介绍了Java合成方形群头像的方法，方形群头像由于易于定位且不涉及形状填充和拼接，实现起来相对简单，本篇介绍的圆形头像方案则复杂很多。</p>
</blockquote>
<p>先看一下圆形头像的样子</p>
<p><img src="/images/java/image/round-portrait.png" alt="圆形头像样例"></p>
<p>从例子可以看出有如下几个特性:</p>
<ol>
<li>每张图片都是圆形的，涉及图片的剪切和图片填充到形状</li>
<li>当图片的个数多于1时，就要考虑图片的遮盖。</li>
<li>图片个数多余1时，需考虑图片的位置：2个是正对角线方向，3、4、5分别是正三角形、正四边形和正五边形</li>
</ol>
<p>接下来，从上面的三点介绍：</p>
<h1 id="图片的形状填充"><a href="#图片的形状填充" class="headerlink" title="图片的形状填充"></a>图片的形状填充</h1><p>在Java图形库(<code>java.awt</code>)中，存在图片形状填充的API，提供了<a target="_blank" rel="noopener" href="http://tool.oschina.net/apidocs/apidoc?api=jdk-zh">Area</a>工具，通过Area可以方便的实现图片的填充.  Area 类可以根据指定的 Shape 对象创建区域几何形状。如果 Shape 还不是封闭的，则显式地封闭几何形状。由 Shape 的几何形状指定的填充规则（奇偶或缠绕）用于确定得到的封闭区域。 </p>
<h2 id="Area填充"><a href="#Area填充" class="headerlink" title="Area填充"></a>Area填充</h2><p>步骤如下:</p>
<ul>
<li>创建Shape</li>
<li>创建Area</li>
<li>建立画板，设置与Area的交集</li>
<li>绘制待填充的图片</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> objectImageSize = <span class="number">260</span>;</span><br><span class="line"><span class="keyword">int</span> originImageSize = <span class="number">260</span>;</span><br><span class="line"><span class="comment">// 1. 创建Shape，这里定义了一个Polygon的Shape</span></span><br><span class="line"><span class="keyword">int</span> xpoints[] = &#123; <span class="number">20</span>, <span class="number">70</span>, <span class="number">130</span>, <span class="number">240</span> &#125;;</span><br><span class="line"><span class="keyword">int</span> ypoints[] = &#123; <span class="number">20</span>, <span class="number">150</span>, <span class="number">100</span>, <span class="number">130</span> &#125;;</span><br><span class="line">Polygon polygon = <span class="keyword">new</span> Polygon(xpoints, ypoints, <span class="number">4</span>);</span><br><span class="line"><span class="comment">// 2. 创建Area，并将Shape添加到Area</span></span><br><span class="line">Area tempArea = <span class="keyword">new</span> Area();</span><br><span class="line">tempArea.add(<span class="keyword">new</span> Area(polygon));</span><br><span class="line"><span class="comment">// 3. 建立画板</span></span><br><span class="line">BufferedImage tempBufferImage = <span class="keyword">new</span> BufferedImage(objectImageSize, objectImageSize, BufferedImage.TYPE_INT_RGB); <span class="comment">// 定义画板的大小和颜色</span></span><br><span class="line">Graphics2D g2d = tempBufferImage.createGraphics(); <span class="comment">// 创建</span></span><br><span class="line"></span><br><span class="line">g2d.setColor(Color.pink);</span><br><span class="line">g2d.fillRect(<span class="number">0</span>, <span class="number">0</span>, objectImageSize, objectImageSize); <span class="comment">//使用颜色填充，作为背景色</span></span><br><span class="line"><span class="comment">// 消除锯齿</span></span><br><span class="line">g2d.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING, RenderingHints.VALUE_TEXT_ANTIALIAS_ON);</span><br><span class="line">g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span><br><span class="line"><span class="comment">// 设置与Area的交集</span></span><br><span class="line">g2d.setClip(tempArea);</span><br><span class="line"><span class="comment">// 4. 绘制待填充的图片：设置了与Area的交集之后，绘制图片将只在交集内绘制</span></span><br><span class="line">BufferedImage bufferedImage = ImageUtil.resize2(<span class="string">&quot;lt.png&quot;</span>, originImageSize, originImageSize, <span class="keyword">true</span>);</span><br><span class="line">g2d.drawImage(bufferedImage, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">g2d.dispose(); <span class="comment">// 关闭绘图区</span></span><br><span class="line"><span class="comment">// 5. 输出绘图区</span></span><br><span class="line">String format = <span class="string">&quot;JPG&quot;</span>;</span><br><span class="line">ImageIO.write(tempBufferImage, format, <span class="keyword">new</span> File(<span class="string">&quot;result.jpg&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>见上面的结果:<br><img src="/images/java/image/area-clip.jpg"></p>
<h2 id="Area剪切"><a href="#Area剪切" class="headerlink" title="Area剪切"></a>Area剪切</h2><p>Area可以实现区域的交集、并集、互减和组合区域并减去其交集， 本例使用Area互减实现圆形的互减。下面演示</p>
<p>实现月牙形状</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Ellipse2D.Double circle1 = <span class="keyword">new</span> Ellipse2D.Double(<span class="number">50</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">tempArea.add(<span class="keyword">new</span> Area(circle1)); <span class="comment">// 定义Area 1</span></span><br><span class="line">Ellipse2D.Double circle2 = <span class="keyword">new</span> Ellipse2D.Double(<span class="number">100</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">tempArea.subtract(<span class="keyword">new</span> Area(circle2)); <span class="comment">// 减去Area 2</span></span><br></pre></td></tr></table></figure>
<p>看效果</p>
<p><img src="/images/java/image/area-crescent.jpg"></p>
<h1 id="圆形头像"><a href="#圆形头像" class="headerlink" title="圆形头像"></a>圆形头像</h1><p>接下来实现圆形头像，基本上就是图片的定位，亲，高中几何学的怎么样？</p>
<h2 id="图形Item坐标信息"><a href="#图形Item坐标信息" class="headerlink" title="图形Item坐标信息"></a>图形Item坐标信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class ItemConfig &#123;</span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * item的大小, 圆的最小外切矩形</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		int itemSize;</span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * 留白区域大小</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		int whiteSize;</span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * item起始坐标</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		int[][] itemLoaction;</span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * 切口圆的坐标</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		int[][] subtractLocation;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="计算坐标"><a href="#计算坐标" class="headerlink" title="计算坐标"></a>计算坐标</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">ItemConfig itemConfig = <span class="keyword">new</span> ItemConfig();</span><br><span class="line">iconCount = iconCount &gt; <span class="number">5</span> ? <span class="number">5</span> : iconCount;<span class="comment">// 图标最多五个</span></span><br><span class="line"><span class="keyword">int</span> borderWidth = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">int</span> whiteSize = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">int</span> r;</span><br><span class="line"><span class="keyword">switch</span> (iconCount) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="keyword">int</span> itemSize = imageSize - <span class="number">2</span> * borderWidth;</span><br><span class="line">      <span class="keyword">int</span> x = borderWidth, y = borderWidth;</span><br><span class="line">      itemConfig.itemSize = itemSize;</span><br><span class="line">      itemConfig.whiteSize = <span class="number">10</span>;</span><br><span class="line">      itemConfig.itemLoaction = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>] = x;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>] = y;</span><br><span class="line">      itemConfig.subtractLocation = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      itemConfig.whiteSize = <span class="number">10</span>;</span><br><span class="line">      r = (<span class="keyword">int</span>) ((imageSize - <span class="number">2</span> * borderWidth + <span class="number">2</span> * itemConfig.whiteSize) / (<span class="number">2</span> + Math.sqrt(<span class="number">2</span>)));</span><br><span class="line">      itemConfig.itemSize = r * <span class="number">2</span>;</span><br><span class="line">      itemConfig.itemLoaction = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>] = borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>] = borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>] = imageSize - <span class="number">2</span> * r - itemConfig.whiteSize - borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>] = imageSize - <span class="number">2</span> * r - itemConfig.whiteSize - borderWidth;</span><br><span class="line"></span><br><span class="line">      itemConfig.subtractLocation = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">0</span>][<span class="number">0</span>] = (<span class="keyword">int</span>) (itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>] - <span class="number">1.5</span> * itemConfig.whiteSize);</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">0</span>][<span class="number">1</span>] = (<span class="keyword">int</span>) (itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>] - <span class="number">1.5</span> * itemConfig.whiteSize);</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">1</span>] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      itemConfig.whiteSize = whiteSize;</span><br><span class="line">      r = (<span class="keyword">int</span>) ((imageSize - <span class="number">2</span> * borderWidth) / (<span class="number">2</span> + Math.sqrt(<span class="number">3</span>))) + itemConfig.whiteSize / <span class="number">2</span>;</span><br><span class="line">      itemConfig.itemSize = <span class="number">2</span> * r;</span><br><span class="line"></span><br><span class="line">      itemConfig.itemLoaction = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>] = (imageSize - <span class="number">2</span> * borderWidth) / <span class="number">2</span> + borderWidth - r;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>] = borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>] = borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>] = imageSize - borderWidth - <span class="number">2</span> * r;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>] = imageSize - borderWidth - <span class="number">2</span> * r;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>] = imageSize - borderWidth - <span class="number">2</span> * r;</span><br><span class="line"></span><br><span class="line">      itemConfig.subtractLocation = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">0</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">0</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">1</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">1</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">2</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">2</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      whiteSize = <span class="number">10</span>;</span><br><span class="line">      itemConfig.whiteSize = whiteSize;</span><br><span class="line">      r = (<span class="keyword">int</span>) ((imageSize - <span class="number">2.0</span> * borderWidth) / <span class="number">4</span> + whiteSize);</span><br><span class="line">      itemConfig.itemSize = <span class="number">2</span> * r;</span><br><span class="line"></span><br><span class="line">      itemConfig.itemLoaction = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>] = borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>] = borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>] = imageSize - borderWidth - whiteSize - <span class="number">2</span> * r;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>] = imageSize - borderWidth - whiteSize - <span class="number">2</span> * r;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      itemConfig.subtractLocation = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">0</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">1</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">2</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">3</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">3</span>][<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      whiteSize = <span class="number">10</span>;</span><br><span class="line">      itemConfig.whiteSize = whiteSize;</span><br><span class="line">      r = (<span class="keyword">int</span>) ((imageSize - <span class="number">2.0</span> * borderWidth)</span><br><span class="line">      / (<span class="number">2</span> * (Math.cos(Math.toRadians(<span class="number">18</span>)) + Math.cos(Math.toRadians(<span class="number">54</span>))) + <span class="number">2</span>)) + whiteSize;</span><br><span class="line">      itemConfig.itemSize = <span class="number">2</span> * r;</span><br><span class="line"></span><br><span class="line">      itemConfig.itemLoaction = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">5</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>] = (imageSize - <span class="number">2</span> * borderWidth) / <span class="number">2</span> - r + borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>] = borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>] = borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>] = (<span class="keyword">int</span>) (<span class="number">2</span> * r * Math.cos(Math.toRadians(<span class="number">54</span>))) + borderWidth;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>] = (<span class="keyword">int</span>) (borderWidth + <span class="number">2</span> * r * Math.sin(Math.toRadians(<span class="number">18</span>)));</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>] = imageSize - borderWidth - <span class="number">2</span> * r;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">0</span>] = (<span class="keyword">int</span>) (imageSize - borderWidth - <span class="number">2</span> * r</span><br><span class="line">      - <span class="number">2</span> * r * Math.sin(Math.toRadians(<span class="number">18</span>)));</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">4</span>][<span class="number">0</span>] = imageSize - borderWidth - <span class="number">2</span> * r;</span><br><span class="line">      itemConfig.itemLoaction[<span class="number">4</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      itemConfig.subtractLocation = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">5</span>][<span class="number">2</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">0</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">0</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">1</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">1</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">2</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">2</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">2</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">3</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">4</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">3</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">4</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">3</span>][<span class="number">1</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">4</span>][<span class="number">0</span>] = itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">0</span>] - itemConfig.itemLoaction[<span class="number">4</span>][<span class="number">0</span>];</span><br><span class="line">      itemConfig.subtractLocation[<span class="number">4</span>][<span class="number">1</span>] = itemConfig.itemLoaction[<span class="number">0</span>][<span class="number">1</span>] - itemConfig.itemLoaction[<span class="number">4</span>][<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="绘制圆形头像"><a href="#绘制圆形头像" class="headerlink" title="绘制圆形头像"></a>绘制圆形头像</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ItemConfig itemConfig = calcLocation(<span class="number">480</span>, <span class="number">5</span>);</span><br><span class="line">BufferedImage imageNew = <span class="keyword">new</span> BufferedImage(<span class="number">480</span>, <span class="number">480</span>, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">Graphics2D graphics2DNew = imageNew.createGraphics();</span><br><span class="line">graphics2DNew.setColor(Color.white);</span><br><span class="line">graphics2DNew.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">480</span>, <span class="number">480</span>);</span><br><span class="line">graphics2DNew.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span><br><span class="line">graphics2DNew.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING, RenderingHints.VALUE_TEXT_ANTIALIAS_ON);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; itemConfig.itemLoaction.length; i++) &#123;</span><br><span class="line">  String fileName = urls.get(i);</span><br><span class="line">  Area tempArea = <span class="keyword">new</span> Area();</span><br><span class="line">  Ellipse2D.Double circle0 = <span class="keyword">new</span> Ellipse2D.Double(<span class="number">10</span>, <span class="number">10</span>, itemConfig.itemSize - <span class="number">2</span> * itemConfig.whiteSize,</span><br><span class="line">  itemConfig.itemSize - <span class="number">2</span> * itemConfig.whiteSize);</span><br><span class="line">  tempArea.add(<span class="keyword">new</span> Area(circle0));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (itemConfig.subtractLocation != <span class="keyword">null</span> &amp;&amp; itemConfig.subtractLocation[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Ellipse2D.Double circle1 = <span class="keyword">new</span> Ellipse2D.Double(itemConfig.subtractLocation[i][<span class="number">0</span>],</span><br><span class="line">    itemConfig.subtractLocation[i][<span class="number">1</span>], itemConfig.itemSize, itemConfig.itemSize);</span><br><span class="line">    tempArea.subtract(<span class="keyword">new</span> Area(circle1));</span><br><span class="line">  &#125;</span><br><span class="line">  graphics2DNew.drawImage(fillImageToModel(fileName, itemConfig.itemSize, tempArea),</span><br><span class="line">  itemConfig.itemLoaction[i][<span class="number">0</span>], itemConfig.itemLoaction[i][<span class="number">1</span>], <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">graphics2DNew.dispose();</span><br><span class="line"><span class="keyword">return</span> imageNew;</span><br></pre></td></tr></table></figure>


<p>效果上面已经有了…</p>
<hr>
<p>参考文献:</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Flink/Flink-datasource/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Flink/Flink-datasource/" class="post-title-link" itemprop="url">Flink: 数据源重放</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:24" itemprop="dateModified" datetime="2021-04-12T17:33:24+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="flink-table-api"><a href="#flink-table-api" class="headerlink" title="flink-table-api"></a>flink-table-api</h1><h2 id="Hippo和Tube如何实现重放"><a href="#Hippo和Tube如何实现重放" class="headerlink" title="Hippo和Tube如何实现重放?"></a>Hippo和Tube如何实现重放?</h2><h3 id="FlinkHippoConsumer"><a href="#FlinkHippoConsumer" class="headerlink" title="FlinkHippoConsumer"></a>FlinkHippoConsumer</h3><h2 id="举一反三"><a href="#举一反三" class="headerlink" title="举一反三"></a>举一反三</h2><h3 id="org-apache-flink-streaming-api-functions-source-RichParallelSourceFunction"><a href="#org-apache-flink-streaming-api-functions-source-RichParallelSourceFunction" class="headerlink" title="org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction"></a>org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction</h3><p>构建并行数据流的基础类，在执行时，运行时将执行与源配置的并行一样多的该函数的并行实例。</p>
<h2 id="org-apache-flink-types-Row"><a href="#org-apache-flink-types-Row" class="headerlink" title="org.apache.flink.types.Row"></a>org.apache.flink.types.Row</h2><p>一行数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[]  fields</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/database/MySQL/syntax_5_sample/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/database/MySQL/syntax_5_sample/" class="post-title-link" itemprop="url">MySQL SQL语法样例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-07-29 00:00:00" itemprop="dateCreated datePublished" datetime="2016-07-29T00:00:00+08:00">2016-07-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:23" itemprop="dateModified" datetime="2021-04-12T17:33:23+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DataBase/" itemprop="url" rel="index"><span itemprop="name">DataBase</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>建立如下的表格:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tdb_goods;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------------------------------+---------------+------------+-------------+---------+------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                                                             <span class="operator">|</span> goods_cate    <span class="operator">|</span> brand_name <span class="operator">|</span> goods_price <span class="operator">|</span> is_show <span class="operator">|</span> is_saleoff <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------------------------------------------------------+---------------+------------+-------------+---------+------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> R510VC <span class="number">15.6</span>英寸笔记本                                                  <span class="operator">|</span> 笔记本        <span class="operator">|</span> 华硕       <span class="operator">|</span>    <span class="number">3399.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> Y400N <span class="number">14.0</span>英寸笔记本电脑                                               <span class="operator">|</span> 笔记本        <span class="operator">|</span> 联想       <span class="operator">|</span>    <span class="number">4899.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本                                                  <span class="operator">|</span> 游戏本        <span class="operator">|</span> 雷神       <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">4</span> <span class="operator">|</span> X550CC <span class="number">15.6</span>英寸笔记本                                                  <span class="operator">|</span> 笔记本        <span class="operator">|</span> 华硕       <span class="operator">|</span>    <span class="number">2799.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> X240(<span class="number">20</span>ALA0EYCD) <span class="number">12.5</span>英寸超极本                                        <span class="operator">|</span> 超级本        <span class="operator">|</span> 联想       <span class="operator">|</span>    <span class="number">4999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">6</span> <span class="operator">|</span> U330P <span class="number">13.3</span>英寸超极本                                                   <span class="operator">|</span> 超级本        <span class="operator">|</span> 联想       <span class="operator">|</span>    <span class="number">4299.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> SVP13226SCB <span class="number">13.3</span>英寸触控超极本                                         <span class="operator">|</span> 超级本        <span class="operator">|</span> 索尼       <span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">8</span> <span class="operator">|</span> iPad mini MD531CH<span class="operator">/</span>A <span class="number">7.9</span>英寸平板电脑                                    <span class="operator">|</span> 平板电脑      <span class="operator">|</span> 苹果       <span class="operator">|</span>    <span class="number">1998.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">9</span> <span class="operator">|</span> iPad Air MD788CH<span class="operator">/</span>A <span class="number">9.7</span>英寸平板电脑 （<span class="number">16</span>G WiFi版）                      <span class="operator">|</span> 平板电脑      <span class="operator">|</span> 苹果       <span class="operator">|</span>    <span class="number">3388.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">10</span> <span class="operator">|</span>  iPad mini ME279CH<span class="operator">/</span>A 配备 Retina 显示屏 <span class="number">7.9</span>英寸平板电脑 （<span class="number">16</span>G WiFi版） <span class="operator">|</span> 平板电脑      <span class="operator">|</span> 苹果       <span class="operator">|</span>    <span class="number">2788.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">11</span> <span class="operator">|</span> IdeaCentre C340 <span class="number">20</span>英寸一体电脑                                         <span class="operator">|</span> 台式机        <span class="operator">|</span> 联想       <span class="operator">|</span>    <span class="number">3499.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">12</span> <span class="operator">|</span> Vostro <span class="number">3800</span><span class="operator">-</span>R1206 台式电脑                                             <span class="operator">|</span> 台式机        <span class="operator">|</span> 戴尔       <span class="operator">|</span>    <span class="number">2899.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">13</span> <span class="operator">|</span> iMac ME086CH<span class="operator">/</span>A <span class="number">21.5</span>英寸一体电脑                                        <span class="operator">|</span> 台式机        <span class="operator">|</span> 苹果       <span class="operator">|</span>    <span class="number">9188.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">14</span> <span class="operator">|</span> AT7<span class="number">-7414</span>LP 台式电脑 （i5<span class="number">-3450</span>四核 <span class="number">4</span>G <span class="number">500</span>G <span class="number">2</span>G独显 DVD 键鼠 Linux ）     <span class="operator">|</span> 台式机        <span class="operator">|</span> 宏碁       <span class="operator">|</span>    <span class="number">3699.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">15</span> <span class="operator">|</span> Z220SFF F4F06PA工作站                                                  <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span> 惠普       <span class="operator">|</span>    <span class="number">4288.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">16</span> <span class="operator">|</span> PowerEdge T110 II服务器                                                <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span> 戴尔       <span class="operator">|</span>    <span class="number">5388.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">17</span> <span class="operator">|</span> Mac Pro MD878CH<span class="operator">/</span>A 专业级台式电脑                                       <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span> 苹果       <span class="operator">|</span>   <span class="number">28888.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">18</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备                                                  <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 索尼       <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">19</span> <span class="operator">|</span> 商务双肩背包                                                           <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 索尼       <span class="operator">|</span>      <span class="number">99.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">20</span> <span class="operator">|</span> X3250 M4机架式服务器 <span class="number">2583</span>i14                                           <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span> IBM        <span class="operator">|</span>    <span class="number">6888.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">21</span> <span class="operator">|</span> 玄龙精英版 笔记本散热器                                                <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 九州风神   <span class="operator">|</span>       <span class="number">0.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">22</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备                                                  <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 索尼       <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">23</span> <span class="operator">|</span> 商务双肩背包                                                           <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 索尼       <span class="operator">|</span>      <span class="number">99.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------+---------------+------------+-------------+---------+------------+</span></span><br></pre></td></tr></table></figure>
<p>计算所有商品的平均价格</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">AS</span> &quot;average price&quot; <span class="keyword">FROM</span> tdb_goods;</span><br></pre></td></tr></table></figure>
<p>评价价格保留两位小数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ROUND(<span class="built_in">AVG</span>(goods_price),<span class="number">2</span>) <span class="keyword">AS</span> &quot;average price&quot; <span class="keyword">FROM</span> tdb_goods;</span><br></pre></td></tr></table></figure>
<p>计算高于平均价格的商品</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price<span class="operator">&gt;=</span><span class="number">5635.36</span>;</span><br></pre></td></tr></table></figure>
<p>使用子查询查询价格高于平均价格的商品信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price<span class="operator">&gt;=</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods</span><br><span class="line">    );</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                       <span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本            <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> SVP13226SCB <span class="number">13.3</span>英寸触控超极本   <span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">13</span> <span class="operator">|</span> iMac ME086CH<span class="operator">/</span>A <span class="number">21.5</span>英寸一体电脑  <span class="operator">|</span>    <span class="number">9188.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">17</span> <span class="operator">|</span> Mac Pro MD878CH<span class="operator">/</span>A 专业级台式电脑 <span class="operator">|</span>   <span class="number">28888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">18</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备            <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">20</span> <span class="operator">|</span> X3250 M4机架式服务器 <span class="number">2583</span>i14     <span class="operator">|</span>    <span class="number">6888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">22</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备            <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>使用子查询 计算高于平均价格的所有商品的评价价格</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price<span class="operator">&gt;=</span>(<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">AVG</span>(goods_price) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">10780.0000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"></span><br><span class="line">使用avg函数时, 只有一条记录, 其他字段的信息只显示第一条.</span><br><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price,<span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price<span class="operator">&gt;=</span>(<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods);</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+-------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name            <span class="operator">|</span> goods_price <span class="operator">|</span> <span class="built_in">AVG</span>(goods_price) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+-------------+------------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本 <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span>    <span class="number">10780.0000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+-------------+------------------+</span></span><br></pre></td></tr></table></figure>
<p>利用子查询查询比”超极本”贵的商品信息(这里的”贵”就体现于多条记录比较时的处理)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> goods_price <span class="keyword">from</span> tdb_goods <span class="keyword">where</span> goods_cate<span class="operator">=</span><span class="string">&#x27;超级本&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4299.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods </span><br><span class="line"><span class="keyword">WHERE</span> goods_price <span class="operator">&gt;</span><span class="keyword">ANY</span> (</span><br><span class="line">    <span class="keyword">select</span> goods_price <span class="keyword">from</span> tdb_goods <span class="keyword">where</span> goods_cate<span class="operator">=</span><span class="string">&#x27;超级本&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                       <span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> Y400N <span class="number">14.0</span>英寸笔记本电脑         <span class="operator">|</span>    <span class="number">4899.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本            <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> X240(<span class="number">20</span>ALA0EYCD) <span class="number">12.5</span>英寸超极本  <span class="operator">|</span>    <span class="number">4999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> SVP13226SCB <span class="number">13.3</span>英寸触控超极本   <span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">13</span> <span class="operator">|</span> iMac ME086CH<span class="operator">/</span>A <span class="number">21.5</span>英寸一体电脑  <span class="operator">|</span>    <span class="number">9188.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">16</span> <span class="operator">|</span> PowerEdge T110 II服务器          <span class="operator">|</span>    <span class="number">5388.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">17</span> <span class="operator">|</span> Mac Pro MD878CH<span class="operator">/</span>A 专业级台式电脑 <span class="operator">|</span>   <span class="number">28888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">18</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备            <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">20</span> <span class="operator">|</span> X3250 M4机架式服务器 <span class="number">2583</span>i14     <span class="operator">|</span>    <span class="number">6888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">22</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备            <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price <span class="operator">&gt;</span> <span class="keyword">ALL</span> (</span><br><span class="line">    <span class="keyword">select</span> goods_price <span class="keyword">from</span> tdb_goods <span class="keyword">where</span> goods_cate<span class="operator">=</span><span class="string">&#x27;超级本&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                       <span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本            <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">13</span> <span class="operator">|</span> iMac ME086CH<span class="operator">/</span>A <span class="number">21.5</span>英寸一体电脑  <span class="operator">|</span>    <span class="number">9188.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">17</span> <span class="operator">|</span> Mac Pro MD878CH<span class="operator">/</span>A 专业级台式电脑 <span class="operator">|</span>   <span class="number">28888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price <span class="operator">=</span> <span class="keyword">ANY</span> (</span><br><span class="line">    <span class="keyword">select</span> goods_price <span class="keyword">from</span> tdb_goods <span class="keyword">where</span> goods_cate<span class="operator">=</span><span class="string">&#x27;超级本&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+---------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                      <span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+---------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> X240(<span class="number">20</span>ALA0EYCD) <span class="number">12.5</span>英寸超极本 <span class="operator">|</span>    <span class="number">4999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">6</span> <span class="operator">|</span> U330P <span class="number">13.3</span>英寸超极本            <span class="operator">|</span>    <span class="number">4299.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> SVP13226SCB <span class="number">13.3</span>英寸触控超极本  <span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+---------------------------------+-------------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>多表更新:<br>参照分类表更新商品表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> tdb_goods_cates(</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> cate_id <span class="type">SMALLINT</span> UNSIGNED <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> cate_name <span class="type">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> COLUMNS <span class="keyword">FROM</span> tdb_goods_cates;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field     <span class="operator">|</span> Type                 <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> cate_id   <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cate_name <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">40</span>)          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tdb_goods_cates(cate_name)  <span class="keyword">select</span> goods_cate <span class="keyword">from</span> tdb_goods </span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> goods_cate;</span><br><span class="line">Query OK, <span class="number">7</span> <span class="keyword">rows</span> affected (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tdb_goods_cates;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------------+</span></span><br><span class="line"><span class="operator">|</span> cate_id <span class="operator">|</span> cate_name     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------------+</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span> 台式机        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span> 游戏本        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span> 平板电脑      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">4</span> <span class="operator">|</span> 笔记本        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">5</span> <span class="operator">|</span> 笔记本配件    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">6</span> <span class="operator">|</span> 超级本        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">7</span> <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> tdb_goods</span><br><span class="line">  <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tdb_goods_cates</span><br><span class="line">    <span class="keyword">ON</span> goods_cate <span class="operator">=</span> cate_name</span><br><span class="line">    <span class="keyword">SET</span> goods_cate<span class="operator">=</span>cate_id;</span><br><span class="line">Query OK, <span class="number">23</span> <span class="keyword">rows</span> affected (<span class="number">0.08</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tdb_goods\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">1</span></span><br><span class="line"> goods_name: R510VC <span class="number">15.6</span>英寸笔记本</span><br><span class="line"> goods_cate: <span class="number">4</span></span><br><span class="line"> brand_name: 华硕</span><br><span class="line">goods_price: <span class="number">3399.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">2</span></span><br><span class="line"> goods_name: Y400N <span class="number">14.0</span>英寸笔记本电脑</span><br><span class="line"> goods_cate: <span class="number">4</span></span><br><span class="line"> brand_name: 联想</span><br><span class="line">goods_price: <span class="number">4899.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">3</span></span><br><span class="line"> goods_name: G150TH <span class="number">15.6</span>英寸游戏本</span><br><span class="line"> goods_cate: <span class="number">2</span></span><br><span class="line"> brand_name: 雷神</span><br><span class="line">goods_price: <span class="number">8499.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> goods_brands(</span><br><span class="line">    id TINYINT AUTO_INCREMENT <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">    brand_name <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">SELECT</span> brand_name <span class="keyword">FROM</span> tdb_goods <span class="keyword">GROUP</span> <span class="keyword">BY</span> brand_name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> goods_brands;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> brand_name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 联想       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 雷神       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 索尼       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> IBM        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> 苹果       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">6</span> <span class="operator">|</span> 戴尔       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">7</span> <span class="operator">|</span> 宏碁       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8</span> <span class="operator">|</span> 惠普       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9</span> <span class="operator">|</span> 华硕       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span> 九州风神   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> tdb_goods <span class="keyword">INNER</span> <span class="keyword">JOIN</span> goods_brands</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">on</span> tdb_goods.brand_name<span class="operator">=</span>goods_brands.brand_name</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">set</span> tdb_goods.brand_name<span class="operator">=</span>goods_brands.id;</span><br><span class="line">Query OK, <span class="number">23</span> <span class="keyword">rows</span> affected (<span class="number">0.09</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tdb_goods\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">1</span></span><br><span class="line"> goods_name: R510VC <span class="number">15.6</span>英寸笔记本</span><br><span class="line"> goods_cate: <span class="number">4</span></span><br><span class="line"> brand_name: <span class="number">9</span></span><br><span class="line">goods_price: <span class="number">3399.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">2</span></span><br><span class="line"> goods_name: Y400N <span class="number">14.0</span>英寸笔记本电脑</span><br><span class="line"> goods_cate: <span class="number">4</span></span><br><span class="line"> brand_name: <span class="number">1</span></span><br><span class="line">goods_price: <span class="number">4899.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DESC</span> tdb_goods;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type                   <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id    <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">150</span>)           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_cate  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">40</span>)            <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> brand_name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">40</span>)            <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_price <span class="operator">|</span> <span class="type">decimal</span>(<span class="number">15</span>,<span class="number">3</span>) unsigned <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0.000</span>   <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> is_show     <span class="operator">|</span> tinyint(<span class="number">1</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> is_saleoff  <span class="operator">|</span> tinyint(<span class="number">1</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tdb_goods</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> CHANGE goods_cate cate_id <span class="type">SMALLINT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> CHANGE brand_name brand_id <span class="type">SMALLINT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line">Query OK, <span class="number">23</span> <span class="keyword">rows</span> affected (<span class="number">0.17</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DESC</span> tdb_goods;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type                   <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id    <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">150</span>)           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cate_id     <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> brand_id    <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_price <span class="operator">|</span> <span class="type">decimal</span>(<span class="number">15</span>,<span class="number">3</span>) unsigned <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0.000</span>   <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> is_show     <span class="operator">|</span> tinyint(<span class="number">1</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> is_saleoff  <span class="operator">|</span> tinyint(<span class="number">1</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改类名</span><br><span class="line"><span class="keyword">desc</span> tdb_goods_brands;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field      <span class="operator">|</span> Type        <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> id         <span class="operator">|</span> tinyint(<span class="number">4</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> brand_name <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">20</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tdb_goods_brands change id brand_id tinyint(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span> ;</span><br><span class="line">Query OK, <span class="number">13</span> <span class="keyword">rows</span> affected (<span class="number">0.20</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">desc</span> tdb_goods_brands;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field      <span class="operator">|</span> Type        <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> brand_id   <span class="operator">|</span> tinyint(<span class="number">4</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> brand_name <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">20</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br></pre></td></tr></table></figure>
<p>删除商品名称重复记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">查找名称相同的记录</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> t1.goods_name <span class="keyword">having</span> <span class="built_in">count</span>(t1.goods_name)<span class="operator">&gt;=</span><span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+---------+----------+-------------+---------+------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name            <span class="operator">|</span> cate_id <span class="operator">|</span> brand_id <span class="operator">|</span> goods_price <span class="operator">|</span> is_show <span class="operator">|</span> is_saleoff <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+---------+----------+-------------+---------+------------+</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">18</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备 <span class="operator">|</span>       <span class="number">5</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">19</span> <span class="operator">|</span> 商务双肩背包          <span class="operator">|</span>       <span class="number">5</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>      <span class="number">99.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+---------+----------+-------------+---------+------------+</span></span><br><span class="line"></span><br><span class="line">错误的写法:</span><br><span class="line"><span class="keyword">delete</span> tt1 <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> tt1 <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line"> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> t1.goods_name <span class="keyword">having</span> <span class="built_in">count</span>(t1.goods_name)<span class="operator">&gt;=</span><span class="number">2</span>) <span class="keyword">as</span> tt2</span><br><span class="line"> <span class="keyword">on</span> tt1.goods_name<span class="operator">=</span>tt2.goods_name <span class="keyword">and</span> tt1.goods_id<span class="operator">&gt;</span>tt2.goods_id;</span><br><span class="line">Query OK, <span class="number">24</span> <span class="keyword">rows</span> affected (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line">正确的写法:</span><br><span class="line"><span class="keyword">delete</span> tt1 <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> tt1 <span class="keyword">left</span> <span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> t1.goods_name </span><br><span class="line">    <span class="keyword">having</span> <span class="built_in">count</span>(t1.goods_name)<span class="operator">&gt;=</span><span class="number">2</span>) <span class="keyword">as</span> tt2 </span><br><span class="line">    <span class="keyword">on</span> tt1.goods_name<span class="operator">=</span>tt2.goods_name </span><br><span class="line">    <span class="keyword">where</span> tt1.goods_id<span class="operator">&gt;</span>tt2.goods_id;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="Delete中包含left-join"><a href="#Delete中包含left-join" class="headerlink" title="Delete中包含left join"></a>Delete中包含left join</h2><ol>
<li>左侧的表是待删除的表</li>
<li>不能关联成功的要过滤掉</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tbl_pps_nc_group_member</span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> #fromUserId#</span><br><span class="line"><span class="keyword">and</span> group_id <span class="keyword">in</span> (<span class="keyword">SELECT</span> group_id <span class="keyword">FROM</span> tbl_pps_nc_group <span class="keyword">where</span> user_id <span class="operator">=</span> #myUserId# );</span><br></pre></td></tr></table></figure>
<p>与</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_pps_nc_group_member nm</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tbl_pps_nc_group ng <span class="keyword">ON</span> nm.user_id <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">AND</span> nm.group_id<span class="operator">=</span>ng.group_id <span class="keyword">AND</span> ng.user_id <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> ng.group_id <span class="keyword">is</span> <span class="keyword">NOT</span> <span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<h1 id="在好友关系中获取对方的信息"><a href="#在好友关系中获取对方的信息" class="headerlink" title="在好友关系中获取对方的信息"></a>在好友关系中获取对方的信息</h1><p>对于好友关系来说，是彼此的关系，可以不分先后，如果要区分邀请和被邀请，就必须考虑。<br>假设存在两个表格:<br>第一个表格是用户信息表<code>t_user_info</code>，用于记录用户的信息。<br>第二个表格是好友关系表<code>t_friend</code>, 用于记录用户的好友关系。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_user_info (</span><br><span class="line">	user_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> auto_increment,</span><br><span class="line">	`name` <span class="type">VARCHAR</span>(<span class="number">10</span>),</span><br><span class="line">	phone <span class="type">VARCHAR</span>(<span class="number">11</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_friend (</span><br><span class="line">	 friend_ref_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> auto_increment,</span><br><span class="line"> 	 from_user_id <span class="type">int</span>,</span><br><span class="line">     to_user_id <span class="type">int</span>,</span><br><span class="line">	 `status` TINYINT(<span class="number">1</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>如果要获取对方的信息，邀请者获取得到的是被邀请者的信息，而被邀请者获取得到的是邀请者的信息。<br>状态值<code>status</code>代表 0：待验证，1：已添加，2：已拒绝，4：待对方验证，5: 对方已添加，6：对方已拒绝</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	u.`name` <span class="keyword">AS</span> userName,</span><br><span class="line">	u.phone <span class="keyword">AS</span> userPhone,</span><br><span class="line">	u.user_id <span class="keyword">AS</span> userId,</span><br><span class="line">	<span class="keyword">CASE</span> <span class="keyword">WHEN</span> f.from_user_id <span class="operator">=</span> <span class="string">&#x27;1018&#x27;</span> <span class="keyword">THEN</span> 	f.`status` <span class="operator">+</span> <span class="number">4</span> <span class="keyword">ELSE</span> f.`status` <span class="keyword">END</span> <span class="keyword">AS</span> `status`</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	t_friend f</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_user_info u </span><br><span class="line">	<span class="keyword">ON</span> (u.user_id <span class="operator">=</span> f.from_user_id 	<span class="keyword">AND</span> f.to_user_id <span class="operator">=</span> <span class="string">&#x27;1018&#x27;</span> )</span><br><span class="line">		<span class="keyword">OR</span> (u.user_id <span class="operator">=</span> f.to_user_id <span class="keyword">AND</span> f.from_user_id <span class="operator">=</span> <span class="string">&#x27;1018&#x27;</span> )</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	u.user_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>
<p><strong>[总结]</strong></p>
<ol>
<li><code>left join</code>中的<code>on</code>语句, 是在被关联表满足<code>on</code>条件才会关联，否则显示为<code>null</code>, 因此通过判断右侧是否为空，可以判断是否满足条件</li>
<li>关联条件是另一个技巧, 取对方的<code>id</code>条件</li>
</ol>
<h1 id="Explain解析查询"><a href="#Explain解析查询" class="headerlink" title="Explain解析查询"></a>Explain解析查询</h1><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/zhuxineli/article/details/14455029">MYSQL explain详解</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/multithread/03.volatile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/multithread/03.volatile/" class="post-title-link" itemprop="url">Java多线程3: volatile</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-07-28 16:00:00" itemprop="dateCreated datePublished" datetime="2016-07-28T16:00:00+08:00">2016-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:23" itemprop="dateModified" datetime="2021-04-12T17:33:23+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/Java/advanced-engineer-outline/">&lt;&lt;Java高级软件工程师知识结构</a></p>
<pre><code>Java多线程是Java基础的重要的一部分,支持多线程是Java的重要特性之一. 主要包括如下内容:</code></pre>
<blockquote>
<ol>
<li><a href="/Java/multithread/01.base/">Java多线程1: 线程生命周期和多线程基础</a></li>
<li><a href="/Java/multithread/02.Lock-Semaphore-Atomic/">Java多线程2: Lock、信号量、原子量与队列</a></li>
<li><a href="/Java/multithread/03.volatile/">Java多线程3: volatile</a></li>
<li><a href="/Java/multithread/04.thread-synchronization/">Java多线程4: 同步锁与Java线程同步方法比较</a></li>
<li><a href="/Java/multithread/05.ThreadPool/">Java多线程5: 线程池</a></li>
<li><a href="/Java/multithread/06.BlockingQueue/">Java多线程6: Java阻塞队列与生产者消费者模式</a></li>
</ol>
</blockquote>
<h1 id="volatile用处"><a href="#volatile用处" class="headerlink" title="volatile用处"></a>volatile用处</h1><p>在JDK1.2之前,Java的内存模型实现总是从主存（即共享内存）读取变量. 为了获得最佳速度,允许线程保存共享成员变量的私有拷贝,而且只当线程进入或者离开同步代码块时才将私有拷贝与共享内存中的原始值进行比较,在当前的Java内存模型下,线程可以把变量保存在本地内存（比如机器的寄存器）中,而不是直接在主存中进行读写,这就可能造成一个线程在主存中修改了一个变量的值,而另外一个线程还继续使用它在寄存器中的变量值的拷贝,造成数据的不一致,</p>
<p>volatile 指示JVM这个变量不稳定,每次使用它都到主存中进行读取,一般说来,多任务环境下,各任务间共享的变量都应该加volatile修饰符,</p>
<p>volatile 修饰的成员变量在每次被线程访问时, 都强迫从共享内存中重读该成员变量的值, 而且, 当成员变量发生变化时, 强迫线程将变化值回写到共享内存, 这样在任何时刻, 两个不同的线程总是看到某个成员变量的同一个值,</p>
<h1 id="使用同步解决变量不一致问题"><a href="#使用同步解决变量不一致问题" class="headerlink" title="使用同步解决变量不一致问题"></a>使用同步解决变量不一致问题</h1><p>内存可见性:<br>在一个任意对象上执行同步语句,目的是为了让该线程在进入和离开同步代码块时,将该线程中的所有变量的私有拷贝与共享内存中的原始值进行比较,从而发现没有用volatile标记的变量所发生的变化</p>
<p>加锁（synchronized同步）的功能不仅仅局限于互斥行为, 同时还存在另外一个重要的方面：内存可见性, 我们不仅希望防止某个线程正在使用对象状态而另一个线程在同时修改该状态, 而且还希望确保当一个线程修改了对象状态后, 其他线程能够看到该变化, 而线程的同步恰恰也能够实现这一点, 内置锁可以用于确保某个线程以一种可预测的方式来查看另一个线程的执行结果, 为了确保所有的线程都能看到共享变量的最新值, 可以在所有执行读操作或写操作的线程上加上同一把锁, 下图示例了同步的可见性保证,</p>
<p><img src="/images/java/multithread/03.volatile/sychronized-sample.png"></p>
<p>当线程A执行某个同步代码块时, 线程B随后进入由同一个锁保护的同步代码块, 这种情况下可以保证, 当锁被释放前, A看到的所有变量值（锁释放前 , A看到的变量包括y和x）在B获得同一个锁后同样可以由B看到, 换句话说, 当线程B执行由锁保护的同步代码块时, 可以看到线程A之前在同一个锁保护的同步代码块中的所有操作结果, 如果在线程A unlock M之后, 线程B才进入lock M, 那么线程B都可以看到线程A unlock M之前的操作, 可以得到i=1,j=1, 如果在线程B unlock M之后, 线程A才进入lock M, 那么线程B就不一定能看到线程A中的操作, 因此j的值就不一定是1</p>
<h1 id="volatile同步机制"><a href="#volatile同步机制" class="headerlink" title="volatile同步机制"></a>volatile同步机制</h1><p>volatile 是一种稍弱的同步机制,在访问 volatile 变量时不会执行加锁操作,也就不会执行线程阻塞,因此 volatile 变量是一种比 synchronized 关键字更轻量级的同步机制,</p>
<blockquote>
<p>在两个或者更多的线程需要访问的成员变量上使用volatile, 当要访问的变量已在synchronized代码块中, 或者为常量时, 没必要使用volatile, 由于使用volatile屏蔽掉了JVM中必要的代码优化, 所以在效率上比较低, 因此一定在必要时才使用此关键字</p>
</blockquote>
<h1 id="实际现象"><a href="#实际现象" class="headerlink" title="实际现象"></a>实际现象</h1><p>对于非volatile修饰的变量, 尽管jvm的优化, 会导致变量的可见性问题, 但这种可见性的问题也只是在短时间内高并发的情况下发生, CPU执行时会很快刷新Cache, 一般的情况下很难出现, 而且出现这种问题是不可预测的, 与jvm、机器配置环境等都有关</p>
<h1 id="正确使用Volatile变量"><a href="#正确使用Volatile变量" class="headerlink" title="正确使用Volatile变量"></a>正确使用Volatile变量</h1><p>当且仅当满足以下所有条件时,才应该使用volatile变量：</p>
<ol>
<li>对变量的写入操作不依赖变量的当前值,或者你能确保只有单个线程更新变量的值</li>
<li>该变量没有包含在具有其他变量的不变式中</li>
</ol>
<p>关于正确使用Volatile请参考: <a target="_blank" rel="noopener" href="http://www.ibm.com/developerworks/cn/java/j-jtp06197.html">Java 理论与实践: 正确使用 Volatile 变量</a></p>
<hr>
<p>【参考文献】:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/ns_code/article/details/17101369">【Java并发编程】之五：volatile变量修饰符—意料之外的问题（含代码） </a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/ns_code/article/details/17382679">【Java并发编程】之十八：第五篇中volatile意外问题的正确分析解答（含代码）</a></li>
<li>《深入Java虚拟机——JVM高级特性与最佳实践》</li>
<li><a target="_blank" rel="noopener" href="http://www.ibm.com/developerworks/cn/java/j-jtp06197.html">Java 理论与实践: 正确使用 Volatile 变量</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/skill/Image-zip-square-portrait/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/skill/Image-zip-square-portrait/" class="post-title-link" itemprop="url">Java图片处理一(压缩图片与生成微信头像)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-07-14 14:58:00" itemprop="dateCreated datePublished" datetime="2016-07-14T14:58:00+08:00">2016-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:23" itemprop="dateModified" datetime="2021-04-12T17:33:23+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="读入图片-本地图片和网络图片"><a href="#读入图片-本地图片和网络图片" class="headerlink" title="读入图片(本地图片和网络图片)"></a>读入图片(本地图片和网络图片)</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">InputStream <span class="title">readImageFromPath</span><span class="params">(String filePath)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (filePath.startsWith(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">            URL url = <span class="keyword">null</span>;</span><br><span class="line">            HttpURLConnection conn;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                url = <span class="keyword">new</span> URL(filePath);</span><br><span class="line">                conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">                conn.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">                conn.connect();</span><br><span class="line">                InputStream inputStream = conn.getInputStream();</span><br><span class="line">                <span class="keyword">return</span> inputStream;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(filePath));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BufferedImage bi = ImageIO.read(readImageFromPath(filePath));</span></span><br></pre></td></tr></table></figure>
<h1 id="压缩图像"><a href="#压缩图像" class="headerlink" title="压缩图像"></a>压缩图像</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图片缩放</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath</span></span><br><span class="line"><span class="comment"> *            图片路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> height</span></span><br><span class="line"><span class="comment"> *            高度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> width</span></span><br><span class="line"><span class="comment"> *            宽度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bb</span></span><br><span class="line"><span class="comment"> *            比例不对时是否需要补白</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">BufferedImage <span class="title">resize2</span><span class="params">(String filePath, <span class="keyword">int</span> height, <span class="keyword">int</span> width, <span class="keyword">boolean</span> bb)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">double</span> ratio = <span class="number">0</span>; <span class="comment">// 缩放比例</span></span><br><span class="line">		BufferedImage bi = ImageIO.read(readImageFromPath(filePath));</span><br><span class="line">		Image itemp = bi.getScaledInstance(width, height,</span><br><span class="line">				Image.SCALE_SMOOTH);</span><br><span class="line">		<span class="comment">// 计算比例</span></span><br><span class="line">		<span class="keyword">if</span> ((bi.getHeight() &gt; height) || (bi.getWidth() &gt; width)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (bi.getHeight() &gt; bi.getWidth()) &#123;</span><br><span class="line">				ratio = (<span class="keyword">new</span> Integer(height)).doubleValue()</span><br><span class="line">						/ bi.getHeight();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				ratio = (<span class="keyword">new</span> Integer(width)).doubleValue() / bi.getWidth();</span><br><span class="line">			&#125;</span><br><span class="line">			AffineTransformOp op = <span class="keyword">new</span> AffineTransformOp(</span><br><span class="line">					AffineTransform.getScaleInstance(ratio, ratio), <span class="keyword">null</span>);</span><br><span class="line">			itemp = op.filter(bi, <span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bb) &#123;</span><br><span class="line">			BufferedImage image = <span class="keyword">new</span> BufferedImage(width, height,</span><br><span class="line">					BufferedImage.TYPE_INT_RGB);</span><br><span class="line">			Graphics2D g = image.createGraphics();</span><br><span class="line">			g.setColor(Color.white);</span><br><span class="line">			g.fillRect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">			<span class="keyword">if</span> (width == itemp.getWidth(<span class="keyword">null</span>))</span><br><span class="line">				g.drawImage(itemp, <span class="number">0</span>, (height - itemp.getHeight(<span class="keyword">null</span>)) / <span class="number">2</span>,</span><br><span class="line">						itemp.getWidth(<span class="keyword">null</span>), itemp.getHeight(<span class="keyword">null</span>),</span><br><span class="line">						Color.white, <span class="keyword">null</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				g.drawImage(itemp, (width - itemp.getWidth(<span class="keyword">null</span>)) / <span class="number">2</span>, <span class="number">0</span>,</span><br><span class="line">						itemp.getWidth(<span class="keyword">null</span>), itemp.getHeight(<span class="keyword">null</span>),</span><br><span class="line">						Color.white, <span class="keyword">null</span>);</span><br><span class="line">			g.dispose();</span><br><span class="line">			itemp = image;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (BufferedImage) itemp;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="生成微信头像"><a href="#生成微信头像" class="headerlink" title="生成微信头像"></a>生成微信头像</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageElement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> left;</span><br><span class="line">	<span class="keyword">int</span> top;</span><br><span class="line">	BufferedImage bufferedImage;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最多行列数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> MAX_GRIDS = <span class="number">3</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 行间距</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> spacing = <span class="number">5</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 边距</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> border = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图片的目标大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> width = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ImageCombinationUtil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成组合头像</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> paths</span></span><br><span class="line"><span class="comment"> *            用户图像</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCombinationOfhead</span><span class="params">(List&lt;String&gt; paths)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> pathSize = paths.size();</span><br><span class="line">	<span class="keyword">if</span> (pathSize == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageCount = MAX_GRIDS * MAX_GRIDS;</span><br><span class="line">	<span class="keyword">int</span> imageCount = pathSize &gt; maxImageCount ? maxImageCount : pathSize;</span><br><span class="line">	<span class="keyword">int</span> grids = (<span class="keyword">int</span>) Math.ceil(Math.sqrt(imageCount));</span><br><span class="line">	grids = grids &gt; MAX_GRIDS ? MAX_GRIDS : grids;</span><br><span class="line">	<span class="keyword">int</span> hrow = imageCount / grids;</span><br><span class="line">	<span class="keyword">int</span> rows = hrow + (imageCount - hrow * grids &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">int</span> columnCountOfLastRow = imageCount - (rows - <span class="number">1</span>) * grids;</span><br><span class="line">	<span class="keyword">int</span> columns = imageCount / rows;</span><br><span class="line">	columns = imageCount - columns * rows &gt; <span class="number">0</span> ? columns + <span class="number">1</span> : columns;</span><br><span class="line">	System.out.println(<span class="string">&quot;imageCount :&quot;</span> + pathSize + <span class="string">&quot;\t grids :&quot;</span> + grids</span><br><span class="line">			+ <span class="string">&quot;\trows:&quot;</span> + rows + <span class="string">&quot;\t columns:&quot;</span> + columns</span><br><span class="line">			+ <span class="string">&quot;\t columnsOfLastRow:&quot;</span> + columnCountOfLastRow);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>[] matrix = <span class="keyword">new</span> <span class="keyword">int</span>[rows];</span><br><span class="line">	Arrays.fill(matrix, grids);</span><br><span class="line">	matrix[<span class="number">0</span>] = columnCountOfLastRow;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 计算每个图片的尺寸</span></span><br><span class="line">	<span class="keyword">int</span> imageMeasure = (width - <span class="number">2</span> * border - (grids - <span class="number">1</span>)</span><br><span class="line">			* spacing)</span><br><span class="line">			/ grids;</span><br><span class="line"></span><br><span class="line">	List&lt;ImageElement&gt; imageElements = <span class="keyword">new</span> ArrayList&lt;ImageElement&gt;();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; imageCount; i++) &#123;</span><br><span class="line">		ImageElement imageMatrix = <span class="keyword">new</span> ImageElement();</span><br><span class="line">		imageMatrix.bufferedImage = ImageCombinationUtil.resize2(paths.get(i),</span><br><span class="line">				imageMeasure, imageMeasure, <span class="keyword">true</span>);</span><br><span class="line">		imageElements.add(imageMatrix);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 计算坐标</span></span><br><span class="line">	<span class="keyword">int</span> top = border;</span><br><span class="line">	top = rows &lt; grids ? top + (spacing + imageMeasure) * (grids - rows)</span><br><span class="line">			/ <span class="number">2</span> : top;</span><br><span class="line">	<span class="keyword">int</span> imageIndex = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> row = <span class="number">0</span>; row &lt; matrix.length; row++) &#123;</span><br><span class="line">		<span class="keyword">int</span> column = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> left = border;</span><br><span class="line">		left = matrix[row] &lt; grids ? left + (spacing + imageMeasure)</span><br><span class="line">				* (grids - matrix[row])/<span class="number">2</span> : left;</span><br><span class="line">		<span class="keyword">while</span> (column &lt; matrix[row]) &#123;</span><br><span class="line">			imageElements.get(imageIndex).left = left + column</span><br><span class="line">					* (imageMeasure + spacing);</span><br><span class="line">			imageElements.get(imageIndex).top = top + row</span><br><span class="line">					* (imageMeasure + spacing);</span><br><span class="line">			imageIndex++;</span><br><span class="line">			column++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建画板</span></span><br><span class="line">	BufferedImage outImage1 = <span class="keyword">new</span> BufferedImage(width,</span><br><span class="line">			width, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">	<span class="comment">// 生成画布</span></span><br><span class="line">	Graphics g = outImage1.getGraphics();</span><br><span class="line">	Graphics2D g2d = (Graphics2D) g;</span><br><span class="line">	<span class="comment">// 设置背景色</span></span><br><span class="line">	g2d.setBackground(<span class="keyword">new</span> Color(<span class="number">231</span>, <span class="number">231</span>, <span class="number">231</span>));</span><br><span class="line">	<span class="comment">// 通过使用当前绘图表面的背景色进行填充来清除指定的矩形。</span></span><br><span class="line">	g2d.clearRect(<span class="number">0</span>, <span class="number">0</span>, width, width);</span><br><span class="line">	<span class="comment">// 绘制</span></span><br><span class="line">	<span class="keyword">for</span> (ImageElement imageElement : imageElements) &#123;</span><br><span class="line">		g2d.drawImage(imageElement.bufferedImage, imageElement.left,</span><br><span class="line">				imageElement.top, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">// 需要改变颜色的话在这里绘上颜色。可能会用到AlphaComposite类</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	String outPath = <span class="string">&quot;d:\\&quot;</span> + System.currentTimeMillis() + <span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">	String format = <span class="string">&quot;JPG&quot;</span>;</span><br><span class="line">	ImageIO.write(outImage1, format, <span class="keyword">new</span> File(outPath));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果</p>
<p><img src="/images/java/util/imageCombinResult.png"></p>
<h1 id="图像转化为InputStream"><a href="#图像转化为InputStream" class="headerlink" title="图像转化为InputStream"></a>图像转化为InputStream</h1><p>方便直接从内存上传到服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">InputStream <span class="title">image2InputStream</span><span class="params">(BufferedImage bufferedImage)</span> </span>&#123;</span><br><span class="line">	InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">	ByteArrayOutputStream outputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">	ImageOutputStream imageOutputStream = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		imageOutputStream = ImageIO.createImageOutputStream(outputStream);</span><br><span class="line">		ImageIO.write(bufferedImage, <span class="string">&quot;JPG&quot;</span>, imageOutputStream);</span><br><span class="line">		inputStream = <span class="keyword">new</span> ByteArrayInputStream(outputStream.toByteArray());</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> inputStream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/network/uploadAndReceiveImages/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/network/uploadAndReceiveImages/" class="post-title-link" itemprop="url">图片上传与接收</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-07-13 11:00:00" itemprop="dateCreated datePublished" datetime="2016-07-13T11:00:00+08:00">2016-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:23" itemprop="dateModified" datetime="2021-04-12T17:33:23+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaWeb/" itemprop="url" rel="index"><span itemprop="name">JavaWeb</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="服务端接收图片"><a href="#服务端接收图片" class="headerlink" title="服务端接收图片"></a>服务端接收图片</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> excu;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    MultipartHttpServletRequest multipartRequest = (MultipartHttpServletRequest)request;</span><br><span class="line">    MultipartFile multipartFile = multipartRequest.getFile(CommonConstant.FORM_NAME);</span><br><span class="line">    LogUtil.trace(<span class="string">&quot;--&gt;上传图片=multipartFile:&quot;</span> + multipartFile);</span><br><span class="line"></span><br><span class="line">    String originalName = multipartFile.getOriginalFilename();</span><br><span class="line">    LogUtil.trace(<span class="string">&quot;--&gt;上传图片=originaName:&quot;</span> + originalName+<span class="string">&quot; multipartFileSize:&quot;</span> + multipartFile.getSize());</span><br><span class="line"></span><br><span class="line">    InputStream inputStream = multipartFile.getInputStream();</span><br><span class="line">    <span class="keyword">long</span> size = inputStream.available();</span><br><span class="line">    LogUtil.trace(<span class="string">&quot;--&gt;上传图片=file size:&quot;</span> + size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> == size || size == -<span class="number">1</span> || <span class="keyword">null</span> == userId || <span class="string">&quot;&quot;</span>.equals(userId)) &#123;</span><br><span class="line">        excu = <span class="keyword">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        excu = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(excu) &#123;</span><br><span class="line">        originalName = System.currentTimeMillis() + <span class="string">&quot;&quot;</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>)</span><br><span class="line">                + originalName.substring(originalName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="keyword">boolean</span> isUploadSuccess = QiniuUploadUtil.uploadFileToQiniu(“userImgBucketName”, originalName,</span><br><span class="line">                inputStream);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(isUploadSuccess) &#123;</span><br><span class="line">            String imageUrl = “userImgURL” + originalName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/Java/skill/pinyin4j/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java/skill/pinyin4j/" class="post-title-link" itemprop="url">pinyin4j</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-07-13 08:58:00" itemprop="dateCreated datePublished" datetime="2016-07-13T08:58:00+08:00">2016-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-12 17:33:23" itemprop="dateModified" datetime="2021-04-12T17:33:23+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">cn2Spell</span><span class="params">(String chinese)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (chinese == <span class="keyword">null</span> || chinese.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        StringBuffer pybf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">char</span>[] arr = chinese.toCharArray();</span><br><span class="line">        HanyuPinyinOutputFormat defaultFormat = <span class="keyword">new</span> HanyuPinyinOutputFormat();</span><br><span class="line">        defaultFormat.setCaseType(HanyuPinyinCaseType.LOWERCASE);</span><br><span class="line">        defaultFormat.setToneType(HanyuPinyinToneType.WITHOUT_TONE);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[i] &gt; <span class="number">128</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String[] str = PinyinHelper.toHanyuPinyinStringArray(</span><br><span class="line">                            arr[i], defaultFormat);</span><br><span class="line">                    <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    pybf.append(PinyinHelper.toHanyuPinyinStringArray(</span><br><span class="line">                            arr[i], defaultFormat)[<span class="number">0</span>]);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (BadHanyuPinyinOutputFormatCombination e) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pybf.append(arr[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pybf.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/18/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/20/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">aaronzhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">235</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">126</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aaronzhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
