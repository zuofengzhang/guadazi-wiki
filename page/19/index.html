<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Guadazi">
<meta property="og:url" content="http://example.com/page/19/index.html">
<meta property="og:site_name" content="Guadazi">
<meta property="og:locale">
<meta property="article:author" content="aaronzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/19/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>Guadazi</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Guadazi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Flink/02.%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F_%E7%A7%92%E7%BA%A7%E7%BB%9F%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Flink/02.%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F_%E7%A7%92%E7%BA%A7%E7%BB%9F%E8%AE%A1/" class="post-title-link" itemprop="url">亿级流量秒级统计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:30" itemprop="dateModified" datetime="2021-04-04T09:10:30+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>#【亿级流量 秒级统计】</p>
<p><strong>AI、ML、DL、ANN、CNN</strong> 蛰伏数十年，就为这个大数据时代。</p>
<p>AI正以前所未有的速度改变世界，影响着我们生活的方方面面，AI走进人们的生活将成为未来的新常态。<br>而大数据和计算能力像水和氧气一样支撑着AI，我们的数据从手机端、服务器日志</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Flink/AsyncApiScalaSink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Flink/AsyncApiScalaSink/" class="post-title-link" itemprop="url">Flink AsyncApiScalaSink</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:30" itemprop="dateModified" datetime="2021-04-04T09:10:30+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Flink-AsyncApiScalaSink"><a href="#Flink-AsyncApiScalaSink" class="headerlink" title="Flink AsyncApiScalaSink"></a>Flink AsyncApiScalaSink</h1><p>andrew建议：</p>
<ul>
<li>onCompeleted没有把IOException暴露给用户</li>
<li>链接配置之类的参数如何传递进去</li>
<li>反压机制如何做？sink经常遇到的问题，下游抖动会直接导致数据丢失</li>
<li>反压 限流 重试</li>
<li>支持batch，条数控制</li>
<li>checkpoint时，需要batch立即flush出去</li>
</ul>
<h2 id="Http-Client"><a href="#Http-Client" class="headerlink" title="Http Client"></a>Http Client</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore-nio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpasyncclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="AsyncApiScalaSink"><a href="#AsyncApiScalaSink" class="headerlink" title="AsyncApiScalaSink"></a>AsyncApiScalaSink</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.<span class="type">IOException</span></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.sink.&#123;<span class="type">RichSinkFunction</span>, <span class="type">SinkFunction</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.http._</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.entity.<span class="type">UrlEncodedFormEntity</span></span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.&#123;<span class="type">HttpEntityEnclosingRequestBase</span>, <span class="type">HttpPost</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.concurrent.<span class="type">FutureCallback</span></span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.<span class="type">DefaultConnectionKeepAliveStrategy</span></span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.nio.client.&#123;<span class="type">CloseableHttpAsyncClient</span>, <span class="type">HttpAsyncClients</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.message.<span class="type">BasicNameValuePair</span></span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.<span class="type">EntityUtils</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncApiScalaSink</span>[<span class="type">E</span>](<span class="params">httpInvoker: <span class="type">HttpInvoker</span>[<span class="type">E</span>]</span>) <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>[<span class="type">E</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> httpClient: <span class="type">CloseableHttpAsyncClient</span> = _</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    httpClient = <span class="type">HttpAsyncClients</span>.custom.setKeepAliveStrategy(<span class="type">DefaultConnectionKeepAliveStrategy</span>.<span class="type">INSTANCE</span>).build</span><br><span class="line">    httpClient.start()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">invoke</span></span>(value: <span class="type">E</span>, context: <span class="type">SinkFunction</span>.<span class="type">Context</span>[_]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> httpEntity: <span class="type">HttpEntityEnclosingRequestBase</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">val</span> method: <span class="type">String</span> = httpInvoker.getMethod</span><br><span class="line">    <span class="keyword">val</span> url: <span class="type">String</span> = httpInvoker.getUrl</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;GET&quot;</span> == method) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;POST&quot;</span> == method) &#123;</span><br><span class="line">      <span class="keyword">val</span> params1: util.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>] = httpInvoker.getParams(value)</span><br><span class="line">      <span class="keyword">val</span> params: util.<span class="type">List</span>[<span class="type">NameValuePair</span>] = <span class="keyword">new</span> util.<span class="type">ArrayList</span>[<span class="type">NameValuePair</span>]</span><br><span class="line">      <span class="keyword">if</span> (params1 != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">import</span> scala.collection.<span class="type">JavaConversions</span>._</span><br><span class="line">        <span class="keyword">for</span> (entry &lt;- params1.entrySet) &#123;</span><br><span class="line">          <span class="keyword">val</span> key: <span class="type">String</span> = entry.getKey</span><br><span class="line">          <span class="keyword">val</span> value1: <span class="type">String</span> = entry.getValue</span><br><span class="line">          params.add(<span class="keyword">new</span> <span class="type">BasicNameValuePair</span>(key, value1))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">val</span> entity: <span class="type">UrlEncodedFormEntity</span> = <span class="keyword">new</span> <span class="type">UrlEncodedFormEntity</span>(params, <span class="type">Consts</span>.<span class="type">UTF_8</span>)</span><br><span class="line">      httpEntity = <span class="keyword">new</span> <span class="type">HttpPost</span>(url)</span><br><span class="line">      httpEntity.setEntity(entity)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    httpClient.execute(httpEntity, <span class="keyword">new</span> <span class="type">FutureCallback</span>[<span class="type">HttpResponse</span>]() &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">completed</span></span>(response: <span class="type">HttpResponse</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> statusLine: <span class="type">StatusLine</span> = response.getStatusLine</span><br><span class="line">        <span class="keyword">val</span> httpStatusCode: <span class="type">Int</span> = statusLine.getStatusCode</span><br><span class="line">        <span class="keyword">var</span> content: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">val</span> entity: <span class="type">HttpEntity</span> = response.getEntity</span><br><span class="line">          content = <span class="type">EntityUtils</span>.toString(entity)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">          <span class="keyword">case</span> e: <span class="type">IOException</span> =&gt;</span><br><span class="line">            <span class="type">System</span>.err.print(e.getMessage)</span><br><span class="line">        &#125;</span><br><span class="line">        httpInvoker.onCompleted(value, httpStatusCode, content)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">failed</span></span>(ex: <span class="type">Exception</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        httpInvoker.onFailed(value, ex)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">cancelled</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">        httpInvoker.onCanceled(value)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">close</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    httpClient.close()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="HttpInvoker"><a href="#HttpInvoker" class="headerlink" title="HttpInvoker"></a>HttpInvoker</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.<span class="type">Serializable</span>;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Map</span>;</span><br><span class="line"></span><br><span class="line">public interface <span class="type">HttpInvoker</span>&lt;<span class="type">E</span>&gt; <span class="keyword">extends</span> <span class="type">Serializable</span> &#123;</span><br><span class="line">    <span class="type">Map</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt; getParams(<span class="type">E</span> e);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> getMethod();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> getUrl();</span><br><span class="line"></span><br><span class="line">    void onCompleted(<span class="type">E</span> value, int httpStatusCode, <span class="type">String</span> content);</span><br><span class="line"></span><br><span class="line">    void onFailed(<span class="type">E</span> value, <span class="type">Exception</span> ex);</span><br><span class="line"></span><br><span class="line">    void onCanceled(<span class="type">E</span> value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Flink/DataSourceReplay/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Flink/DataSourceReplay/" class="post-title-link" itemprop="url">Flink: 数据源重放</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:30" itemprop="dateModified" datetime="2021-04-04T09:10:30+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="flink-table-api"><a href="#flink-table-api" class="headerlink" title="flink-table-api"></a>flink-table-api</h1><h2 id="Hippo和Tube如何实现重放"><a href="#Hippo和Tube如何实现重放" class="headerlink" title="Hippo和Tube如何实现重放?"></a>Hippo和Tube如何实现重放?</h2><h3 id="FlinkHippoConsumer"><a href="#FlinkHippoConsumer" class="headerlink" title="FlinkHippoConsumer"></a>FlinkHippoConsumer</h3><h2 id="举一反三"><a href="#举一反三" class="headerlink" title="举一反三"></a>举一反三</h2><h3 id="org-apache-flink-streaming-api-functions-source-RichParallelSourceFunction"><a href="#org-apache-flink-streaming-api-functions-source-RichParallelSourceFunction" class="headerlink" title="org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction"></a>org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction</h3><p>构建并行数据流的基础类，在执行时，运行时将执行与源配置的并行一样多的该函数的并行实例。</p>
<h2 id="org-apache-flink-types-Row"><a href="#org-apache-flink-types-Row" class="headerlink" title="org.apache.flink.types.Row"></a>org.apache.flink.types.Row</h2><p>一行数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[]  fields</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Flink/Flink-base/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Flink/Flink-base/" class="post-title-link" itemprop="url">Flink核心知识点梳理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:30" itemprop="dateModified" datetime="2021-04-04T09:10:30+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a>Flink</h1><p><img src="_v_images/flink-structure.svg" alt="The processes involved in executing a Flink dataflow"></p>
<h2 id="stateful-stream-processing"><a href="#stateful-stream-processing" class="headerlink" title="stateful stream processing"></a>stateful stream processing</h2><p>processFunction</p>
<p>低阶API<br>构建一些新的组件<br>比如 利用定时做一定情况下的匹配和缓存<br>灵活，开发比较复杂</p>
<p>凌晨更新  注册定时器 </p>
<h2 id="state"><a href="#state" class="headerlink" title="state"></a>state</h2><p>状态托管<br>operator state 算子状态<br>keyed state<br>State Backend (rocksdb + hdfs)</p>
<h2 id="checkpoint"><a href="#checkpoint" class="headerlink" title="checkpoint"></a>checkpoint</h2><p>barrier</p>
<h2 id="DataStream-广播"><a href="#DataStream-广播" class="headerlink" title="DataStream 广播"></a>DataStream 广播</h2><h2 id="CoLocationGroup"><a href="#CoLocationGroup" class="headerlink" title="CoLocationGroup"></a>CoLocationGroup</h2><h2 id="SlotSharingGroup"><a href="#SlotSharingGroup" class="headerlink" title="SlotSharingGroup"></a>SlotSharingGroup</h2><h3 id="如何自定义-Window？"><a href="#如何自定义-Window？" class="headerlink" title="如何自定义 Window？"></a>如何自定义 Window？</h3><p>1、Window Assigner</p>
<p>负责将元素分配到不同的 window。</p>
<p>Window API 提供了自定义的 WindowAssigner 接口，我们可以实现 WindowAssigner 的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public abstract Collection&lt;W&gt; assignWindows(T element, long timestamp)</span><br></pre></td></tr></table></figure>
<p>方法。同时，对于基于 Count 的 window 而言，默认采用了 GlobalWindow 的 window assigner，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyBy.window(GlobalWindows.create())</span><br></pre></td></tr></table></figure>
<p>2、Trigger</p>
<p>Trigger 即触发器，定义何时或什么情况下移除 window</p>
<p>我们可以指定触发器来覆盖 WindowAssigner 提供的默认触发器。 请注意，指定的触发器不会添加其他触发条件，但会替换当前触发器。</p>
<p>3、Evictor（可选）</p>
<p>驱逐者，即保留上一 window 留下的某些元素</p>
<p>4、通过 apply WindowFunction 来返回 DataStream 类型数据。</p>
<p>利用 Flink 的内部窗口机制和 DataStream API 可以实现自定义的窗口逻辑，例如 session window。</p>
<h3 id="EventTime-amp-ProcessTime-amp-IngestionTime"><a href="#EventTime-amp-ProcessTime-amp-IngestionTime" class="headerlink" title="EventTime &amp; ProcessTime &amp; IngestionTime"></a>EventTime &amp; ProcessTime &amp; IngestionTime</h3><p> Event time programs must specify how to generate <em>Event Time Watermarks</em>, which is the mechanism that signals progress in event time</p>
<p>Internally, <em>ingestion time</em> is treated much like <em>event time</em>, but with automatic timestamp assignment and automatic watermark generation.</p>
<h2 id="watermark"><a href="#watermark" class="headerlink" title="watermark"></a>watermark</h2><p>kafka的每个分区event-time到来的时间不一致</p>
<p>using Flink’s Kafka-partition-aware watermark generation. watermarks are generated inside the Kafka consumer, per Kafka partition, and the per-partition watermarks are merged in the same way as watermarks are merged on stream shuffles.</p>
<p>watermark在每个kafka分区的kafka消费者中产生，每个分区的watermark合并起来，如在stream shuffle中合并watermark一样</p>
<h2 id="HadoopOutputFormat"><a href="#HadoopOutputFormat" class="headerlink" title="HadoopOutputFormat"></a>HadoopOutputFormat</h2><p>flink hbase connector</p>
<h2 id="算子之间数据传递，是如何序列化的"><a href="#算子之间数据传递，是如何序列化的" class="headerlink" title="算子之间数据传递，是如何序列化的"></a>算子之间数据传递，是如何序列化的</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Flink/Flink-datasource/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Flink/Flink-datasource/" class="post-title-link" itemprop="url">Flink: 数据源重放</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:30" itemprop="dateModified" datetime="2021-04-04T09:10:30+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="flink-table-api"><a href="#flink-table-api" class="headerlink" title="flink-table-api"></a>flink-table-api</h1><h2 id="Hippo和Tube如何实现重放"><a href="#Hippo和Tube如何实现重放" class="headerlink" title="Hippo和Tube如何实现重放?"></a>Hippo和Tube如何实现重放?</h2><h3 id="FlinkHippoConsumer"><a href="#FlinkHippoConsumer" class="headerlink" title="FlinkHippoConsumer"></a>FlinkHippoConsumer</h3><h2 id="举一反三"><a href="#举一反三" class="headerlink" title="举一反三"></a>举一反三</h2><h3 id="org-apache-flink-streaming-api-functions-source-RichParallelSourceFunction"><a href="#org-apache-flink-streaming-api-functions-source-RichParallelSourceFunction" class="headerlink" title="org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction"></a>org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction</h3><p>构建并行数据流的基础类，在执行时，运行时将执行与源配置的并行一样多的该函数的并行实例。</p>
<h2 id="org-apache-flink-types-Row"><a href="#org-apache-flink-types-Row" class="headerlink" title="org.apache.flink.types.Row"></a>org.apache.flink.types.Row</h2><p>一行数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[]  fields</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/HBase/HBase/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/HBase/HBase/" class="post-title-link" itemprop="url">HBase基础与开发实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:30" itemprop="dateModified" datetime="2021-04-04T09:10:30+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h1><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="避免数据热点"><a href="#避免数据热点" class="headerlink" title="避免数据热点"></a>避免数据热点</h3><p>加盐的过程本质上是对原有的主键加上一个字节的前缀，<br>如下面公式所示：<br>new_row_key = (++index % BUCKETS_NUMBER) + original_key</p>
<p>BUCKETS_NUMBER 为桶的个数。主键的分布决定了数据的分布，把主键<br>打散也就意味着数据打散。具体使用时，一般建议桶的数目等于 RegionServer 的<br>数目。</p>
<h3 id="多租户"><a href="#多租户" class="headerlink" title="多租户"></a>多租户</h3><p>我们开发了 DHS 系统（Didi HBase Service）进行项目管理，并且在 HBase 上通过 Namespace、RS Group 等技术来分割用户的资源、数据和权限。通过计算开销并计费的方法来管控资源分配</p>
<p>HBase 自带的 jxm 信息会汇总到 Region 和 RegionServer 级别的数据，管理员会经常用到，但是用户却很少关注这个级别。根据这种情况我们开发了 HBase 表级别的监控，并且会有权限控制，让业务 RD 只能看到和自己相关的表，清楚自己项目表的吞吐及存储占用情况</p>
<p>RegionServer Group，实现细节可以参照 HBase HBASE-6721 这个 Patch。滴滴在这个基础上作了一些分配策略上的优化，以便适合滴滴业务场景的修改。RS Group简单概括是指通过分配一批指定的RegionServer列表，成为一个RS Group，每个 Group 可以按需挂载不同的表，并且当 Group 内的表发生异常后，Region不会迁移到其他的 Group。这样，每个 Group 就相当于一个逻辑上的子集群，通过这种方式达到资源隔离的效果，降低管理成本，不必为每个高 SLA 的业务线单独搭集群。</p>
<h2 id="HDFS中文件的存储"><a href="#HDFS中文件的存储" class="headerlink" title="HDFS中文件的存储"></a>HDFS中文件的存储</h2><p><a target="_blank" rel="noopener" href="https://hbase.apache.org/book.html#trouble.namenode.hbase.objects">Browsing HDFS for HBase Objects</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/hbase/data/default/&lt;table_name&gt;/ab0ba9f7e0d2898a0f61aa687d3d4886/&lt;column_family&gt;/&lt;HFile_name&gt;</span><br></pre></td></tr></table></figure>
<p>如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/hbase/data/default/my_table/d177ff7276d2e46d69dc50f67f92643a/cf/</span><br></pre></td></tr></table></figure>
<p>HFile每bulkload一次，新增加的HFile序列号增加1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ./hadoop fs -ls /hbase/data/default/recommend_result/d177ff7276d2e46d69dc50f67f92643a/cf</span><br><span class="line">Found 2 items</span><br><span class="line">-rw-rw-rw-   3 tdw_hectorhe g_cdg_cft_data__cft 2791972087 2019-04-11 07:06 /hbase/data/default/recommend_result/d177ff7276d2e46d69dc50f67f92643a/cf/accd28866e6d40738849b4efb08ea154_SeqId_312_</span><br><span class="line">-rw-r--r--   3 hbaseadmin   users               2941438650 2019-04-11 04:07 /hbase/data/default/recommend_result/d177ff7276d2e46d69dc50f67f92643a/cf/ee29f8ad0fa14f508793108234242de4</span><br></pre></td></tr></table></figure>
<p>如上面的<code>seqId_1</code>，代表序列号为1，在major compact时，将合并成一个文件</p>
<p>如果存在多个HFile，就需要同时查询多个列族。</p>
<ol>
<li>一个region只保存在一个region server中，不会跨越region server，由hdfs保证高可用</li>
</ol>
<h3 id="client写入"><a href="#client写入" class="headerlink" title="client写入"></a>client写入</h3><p>通过client写入数据时，首先会把数据写入到memstore和WAL，数据到达一定的阈值，才会溢写到StoreFile，StoreFile也就是HFile</p>
<h2 id="zk存储"><a href="#zk存储" class="headerlink" title="zk存储"></a>zk存储</h2><h2 id="hbase-meta"><a href="#hbase-meta" class="headerlink" title="hbase meta"></a>hbase meta</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):053:0&gt; list_namespace_tables &#x27;hbase&#x27;</span><br><span class="line">TABLE </span><br><span class="line">meta      </span><br><span class="line">namespace </span><br><span class="line">rsgroup  </span><br><span class="line">3 row(s) in 0.0040 seconds</span><br></pre></td></tr></table></figure>





<h2 id="GET的过程"><a href="#GET的过程" class="headerlink" title="GET的过程"></a>GET的过程</h2><h2 id="Coprocessor"><a href="#Coprocessor" class="headerlink" title="Coprocessor"></a>Coprocessor</h2><h2 id="Phoenix"><a href="#Phoenix" class="headerlink" title="Phoenix"></a>Phoenix</h2><p>在没有 Phoenix 之前，用户如果需要分析 HBase 数据，只能从 HBase 拖出去或者绕过 HBase 直接读取 HDFS 上面的HFile 的方式进行，前者浪费了大量的网络IO，后者用不到 HBase 本身做的大量缓存和索引优化。Phoenix 使用 HBase 的协处理器机制，直接在 RegionServer 上执行算子逻辑，然后将算子的结果返回即可，也就是大数据中的“Move Operator to Data”理念。比如，用户执行“ <code>select count(*) from mytable where mytime &gt; timestamp’2018-11-11 0:00:00’</code> ”，在实际执行中，会先找到符合过滤条件的region，然后在RegionServer本地计算count，最后再对各个 Region 上的结果进行汇总。</p>
<p>索引是传统数据库中常见的技术，HBase 表中可以指定主键，对主键使用 LSM 算<br>法构建索引。Phoenix 中，用户在创建表的时候，可以指定索引列，可以是单列，<br>也可以是组合列。很多时候仅有主键索引是不够的，特别是对于列特别多的宽表，<br>为此，Phoenix 提供二级索引功能，用户能够对表中非主键的列添加索引，并可<br>以加入其它相关列到索引表中，如果某个查询涉及到的列全部在索引表中，直接<br>查询索引表即可，无需访问原数据表。索引表跟原表做到实时同步更新，以保证<br>数据一致性。</p>
<p><a target="_blank" rel="noopener" href="https://www.imooc.com/video/15575">imooc</a></p>
<p>@Controller<br>    @SessionAttributes({ “credentials”, “user” })</p>
<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><h3 id="HFile文件的元数据"><a href="#HFile文件的元数据" class="headerlink" title="HFile文件的元数据"></a>HFile文件的元数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -du -h /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/</span><br><span class="line">16.0 G  /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/0e950ca090d54eb2b98abffc2e285cfa_SeqId_4_</span><br><span class="line">16.0 G  /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/bfc0c2e4fae84ba19ad1eaf78ea04967_SeqId_4_</span><br><span class="line">16.0 G  /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/e5f3675a6b0040faa695ec3b35b2e951_SeqId_4_</span><br><span class="line">6.1 G   /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/f5c2d2461e0f4eb58ed6c75aa1ae9ffa_SeqId_4_</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hbase hfile -m -f /hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/0e950ca090d54eb2b98abffc2e285cfa_SeqId_4_</span><br><span class="line"></span><br><span class="line">2020-03-18 14:19:37,389 INFO  [main] hfile.CacheConfig: Created cacheConfig: CacheConfig:disabled</span><br><span class="line">Block index size as per heapsize: 5288</span><br><span class="line">reader=/hbase/data/default/dal_hx_lct_700_800/999fdd6a2ed426fcb33d202195fdd7d2/i/0e950ca090d54eb2b98abffc2e285cfa_SeqId_4_,</span><br><span class="line">    compression=none,</span><br><span class="line">    cacheConf=CacheConfig:disabled,</span><br><span class="line">    firstKey=0632079511/i:v/1584411652893/Put,</span><br><span class="line">    lastKey=0938227441/i:v/1584411652893/Put,</span><br><span class="line">    avgKeyLen=23,</span><br><span class="line">    avgValueLen=1837,</span><br><span class="line">    entries=9189138,</span><br><span class="line">    length=17212333944</span><br><span class="line">Trailer:</span><br><span class="line">    fileinfoOffset=17212333262,</span><br><span class="line">    loadOnOpenDataOffset=17212330707,</span><br><span class="line">    dataIndexCount=73,</span><br><span class="line">    metaIndexCount=0,</span><br><span class="line">    totalUncomressedBytes=17207143638,</span><br><span class="line">    entryCount=9189138,</span><br><span class="line">    compressionCodec=NONE,</span><br><span class="line">    uncompressedDataIndexSize=9529760,</span><br><span class="line">    numDataIndexLevels=2,</span><br><span class="line">    firstDataBlockOffset=0,</span><br><span class="line">    lastDataBlockOffset=17212236283,</span><br><span class="line">    comparatorClassName=org.apache.hadoop.hbase.KeyValue$KeyComparator,</span><br><span class="line">    majorVersion=2,</span><br><span class="line">    minorVersion=3</span><br><span class="line">Fileinfo:</span><br><span class="line">    BULKLOAD_SOURCE_TASK = attempt_20200317094633_0002_r_000001_0</span><br><span class="line">    BULKLOAD_TIMESTAMP = \x00\x00\x01p\xE6\x81\x87\xD0</span><br><span class="line">    DELETE_FAMILY_COUNT = \x00\x00\x00\x00\x00\x00\x00\x00</span><br><span class="line">    EARLIEST_PUT_TS = \x00\x00\x01p\xE6K3\x1D</span><br><span class="line">    EXCLUDE_FROM_MINOR_COMPACTION = \x00</span><br><span class="line">    KEY_VALUE_VERSION = \x00\x00\x00\x01</span><br><span class="line">    MAJOR_COMPACTION_KEY = \xFF</span><br><span class="line">    MAX_MEMSTORE_TS_KEY = \x00\x00\x00\x00\x00\x00\x00\x00</span><br><span class="line">    TIMERANGE = 1584411652893....1584411652893</span><br><span class="line">    hfile.AVG_KEY_LEN = 23</span><br><span class="line">    hfile.AVG_VALUE_LEN = 1837</span><br><span class="line">    hfile.LASTKEY = \x00\x0A0938227441\x01iv\x00\x00\x01p\xE6K3\x1D\x04</span><br><span class="line">Mid-key: \x00\x09078540676\x00\x7F\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF</span><br><span class="line">Bloom filter:</span><br><span class="line">    Not present</span><br><span class="line">Delete Family Bloom filter:</span><br><span class="line">    Not present</span><br></pre></td></tr></table></figure>

<h2 id="WAL"><a href="#WAL" class="headerlink" title="WAL"></a>WAL</h2><h3 id="写入模型优化"><a href="#写入模型优化" class="headerlink" title="写入模型优化"></a>写入模型优化</h3><p>WAL写入模型</p>
<p>了解了HLog的结构之后，我们就开始研究HLog的写入模型。HLog的写入可以分为三个阶段，首先将数据对&lt;HLogKey,WALEdit&gt;写入本地缓存，然后再将本地缓存写入文件系统，最后执行sync操作同步到磁盘。在以前老的写入模型中，上述三步都由工作线程独自完成，如下图所示：</p>
<p><img src="_v_images/20200815154403071_1496305947.png" alt="103"></p>
<p>上图中，本地缓存写入文件系统那个步骤工作线程需要持有updateLock执行，不同工作线程之间必然会恶性竞争；不仅如此，在Sync HDFS这步中，工作线程之间需要抢占flushLock，因为Sync操作是一个耗时操作，抢占这个锁会导致写入性能大幅降低。</p>
<p>所幸的是，来自中国（准确的来说，是来自小米，鼓掌）的3位工程师意识到了这个问题，进而提出了一种新的写入模型并被官方采纳。根据官方测试，新写入模型的吞吐量比之前提升3倍多，单台RS写入吞吐量介于12150～31520，5台RS组成的集群写入吞吐量介于22000～70000（见HBASE-8755）。下图是小米官方给出来的对比测试结果：</p>
<p><img src="_v_images/20200815154402968_1974951896.png" alt="104"></p>
<p>在新写入模型中，本地缓存写入文件系统以及Sync HDFS都交给了新的独立线程完成，并引入一个Notify线程通知工作线程是否已经Sync成功，采用这种机制消除上述锁竞争，具体如下图所示：</p>
<p><img src="_v_images/20200815154402863_279526558.png" alt="105"></p>
<p>1. 上文中提到工作线程在写入WALEdit之后并没有进行Sync，而是等到释放行锁阻塞在syncedTillHere变量上，等待AsyncNotifier线程唤醒。</p>
<p>2. 工作线程将WALEdit写入本地Buffer之后，会生成一个自增变量txid，携带此txid唤醒AsyncWriter线程</p>
<p>3. AsyncWriter线程会取出本地Buffer中的所有WALEdit，写入HDFS。注意该线程会比较传入的txid和已经写入的最大txid（writtenTxid），如果传入的txid小于writteTxid，表示该txid对应的WALEdit已经写入，直接跳过</p>
<p>4. AsyncWriter线程将所有WALEdit写入HDFS之后携带maxTxid唤醒AsyncFlusher线程</p>
<p>5. AsyncFlusher线程将所有写入文件系统的WALEdit统一Sync刷新到磁盘</p>
<p>6. 数据全部落盘之后调用setFlushedTxid方法唤醒AyncNotifier线程</p>
<p>7. AyncNotifier线程会唤醒所有阻塞在变量syncedTillHere的工作线程，工作线程被唤醒之后表示WAL写入完成，后面再执行MVCC结束写事务，推进全局读取点，本次更新才会对用户可见</p>
<p>通过上述过程的梳理可以知道，新写入模型采取了多线程模式独立完成写文件系统、sync磁盘操作，避免了之前多工作线程恶性抢占锁的问题。同时，工作线程在将WALEdit写入本地Buffer之后并没有马上阻塞，而是释放行锁之后阻塞等待WALEdit落盘，这样可以尽可能地避免行锁竞争，提高写入性能。</p>
<p>wal写入数据写入经历三步:</p>
<ol>
<li>写入本地缓存</li>
<li>写入hdfs</li>
<li>flush hdfs</li>
</ol>
<p>旧的写入模型，工作线程自己写入hdfs和flush，为了避免一致性问题，需要分别竞争updateLock和flushLock, 工作线程在单个线程中完成，写了hdfs，立即直接flush</p>
<p>新的写入模型，将写hdfs和flush hdfs分别由两个单独的线程(AsyncWriter和AsyncFlusher)处理，落盘后回调工作线程；<br>为了避免多个线程同时写入冲突，给每个要写入的文件生成一个自增的txid，写hdfs的线程会把所有的文件全部写入到hdfs，<br>如果工作线程要写的txid小于max txid，代表已经写过了。</p>
<h2 id="memstore"><a href="#memstore" class="headerlink" title="memstore"></a>memstore</h2><h3 id="MSLAB"><a href="#MSLAB" class="headerlink" title="MSLAB"></a>MSLAB</h3><p>LAB 对 GC 的优化</p>
<h3 id="ConcurrentSkipListMap"><a href="#ConcurrentSkipListMap" class="headerlink" title="ConcurrentSkipListMap"></a>ConcurrentSkipListMap</h3><h3 id="CompactingMemStore"><a href="#CompactingMemStore" class="headerlink" title="CompactingMemStore"></a>CompactingMemStore</h3><h2 id="HBase-clonesnapshot-限流实现原理"><a href="#HBase-clonesnapshot-限流实现原理" class="headerlink" title="HBase clonesnapshot 限流实现原理"></a>HBase clonesnapshot 限流实现原理</h2><h2 id="scanner"><a href="#scanner" class="headerlink" title="scanner"></a>scanner</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Hadoop/HDFS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Hadoop/HDFS/" class="post-title-link" itemprop="url">HDFS基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:30" itemprop="dateModified" datetime="2021-04-04T09:10:30+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>NameNode 保存这个文件的数据块信息</li>
<li>DataNode 存储实际的文件</li>
<li>当MR启动的时候，首先获取所要处理的文件的块信息和节点信息，然后在这些节点上同时启动任务，在数据所在节点上同时处理</li>
</ul>
<p>MapReduce是底层编程语言，您需要专业知识才能在此级别工作。工程师在Map Reduce上开发了一个名为Hive的层，以便用户可以使用SQL来处理HDFS中存储的数据。Hive将这些SQL查询转换为一系列Map Reduce，然后调度执行。因此，Hive极大地简化了数据处理任务。但是Hive使用底层Map Reduce体系结构，这是用于处理数据的另一层</p>
<p>Impala 一旦部署在Hadoop集群中，它将在每个数据节点上运行自己的进程，并完全跳过MapReduce阶段。一旦收到一个SQL，Impala master节点调度数据所在的节点上直接执行任务。因为它跳过MapReduce转换阶段并直接在节点上执行，所以它可以完成每秒钟的SQL查询</p>
<p>当您在Hive中启动查询时，在背景地图中，Reduce会出现在启动查询需要花费大量时间的画面中，就像您在Impala中启动查询一样，它使用自己的体系结构，即MPP(大规模并行处理)而不是Map Reduce来从HDFS获取结果。它在内存中执行查询，总是比磁盘快。</p>
<p>It’s an HDFS quirk. A file that’s currently being written to will appear to have a size of 0 but once it’s closed it will show its true size</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/Impala/Impala-why-faster-than-hive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/Impala/Impala-why-faster-than-hive/" class="post-title-link" itemprop="url">Impala: why faster than hive</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:30" itemprop="dateModified" datetime="2021-04-04T09:10:30+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h1 id="Impala"><a href="#Impala" class="headerlink" title="Impala"></a>Impala</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/16755599/how-does-impala-provide-faster-query-response-compared-to-hive">How does impala provide faster query response compared to hive</a></p>
</blockquote>
<p>Impala = SQL on HDFS<br>Hive = SQL on Hadoop</p>
<p>impala darmon running on datanode<br>cache some of the data that is in HDFS</p>
<h2 id="why-fast"><a href="#why-fast" class="headerlink" title="why fast"></a>why fast</h2><blockquote>
<p>why Impala is faster than Hive in Query processing? Below are the some key points.</p>
</blockquote>
<ul>
<li>While processing SQL-like queries, Impala does not write intermediate results on disk(like in Hive MapReduce); instead full SQL processing is done in memory, which makes it faster.</li>
<li>With Impala, the query starts its execution instantly compared to MapReduce, which may take significant time to start processing larger SQL queries and this adds more time in processing.</li>
<li>Impala Query Planner uses smart algorithms to execute queries in multiple stages in parallel nodes to provide results faster, avoiding sorting and shuffle steps, which may be unnecessary in most of the cases.</li>
<li>Impala has information about each data block in HDFS, so when processing the query, it takes advantage of this knowledge to distribute queries more evenly in all DataNodes.</li>
<li>There exists Impala daemon, which runs on each DataNode. These are responsible for processing queries.When query submitted, impalad(Impala daemon) reads and writes to data file and parallelizes the query by distributing the work to all other Impala nodes in the Impala cluster.</li>
<li>Another key reason for fast performance is that Impala first generates assembly-level code for each query. The assembly code executes faster than any other code framework because while Impala queries are running natively in memory, having a framework will add additional delay in the execution due to the framework overhead.</li>
</ul>
<ol>
<li>在处理类似sql的查询时，Impala不会在磁盘上写入中间结果(如Hive MapReduce);相反，SQL处理完全是在内存中完成的，这使它更快。</li>
<li>不使用map/reduce, 将数据fork到jvm和流量穿透是非常昂贵的。Impala将查询任务分割成子任务，在数据所在的节点上，各个节点独立并行运行，最后再单个节点上汇总结果。</li>
<li>与MapReduce相比，Impala查询立即开始执行，MapReduce可能会花费大量时间来开始处理较大的SQL查询，这会增加处理时间。</li>
<li>Impala Query Planner使用智能算法在并行节点中的多个stage执行查询，以更快地提供结果，避免sortinh和shuffle步骤，这在大多数情况下可能是不必要的。</li>
<li>Impala拥有关于HDFS每个数据块的信息，因此在处理查询时，它利用这些知识在所有数据节点中更均匀地分布查询。</li>
<li>存在在每个DataNode上运行的Impala守护进程。它们负责处理查询。当提交查询时，impalad(Impala守护进程)对数据文件进行读写操作，并通过将工作分配给Impala集群中的所有其他Impala节点来并行化查询。</li>
<li>快速性能的另一个关键原因是Impala首先为每个查询生成汇编级别的代码。汇编代码的执行速度比任何其他代码框架都快，因为Impala查询在本机的内存中运行时，拥有一个框架会由于框架开销而增加额外的执行延迟。</li>
<li>它使用hdfs存储，对于大文件来说速度很快。它尽可能多地缓存查询、结果和数据。</li>
<li>它支持新的文件格式，如parquet，即列式存储格式。使用这种格式，数据扫描量更少</li>
</ol>
<p>Impala在内存中的处理所有查询，因此节点上的内存限制肯定是一个因素。必须有足够的内存来支持生成的数据集，在复杂的连接操作期间，数据集可能会成倍增长。如果查询开始处理数据，结果数据集无法装入可用内存，则查询将失败。</p>
<h3 id="disadvantage"><a href="#disadvantage" class="headerlink" title="disadvantage"></a>disadvantage</h3><ol>
<li>不支持UDF和自定义序列化</li>
<li>impala查询是HiveSQL的子集</li>
<li>hive支持存储和查询，而impala只能查询</li>
</ol>
<h2 id="Impala-doesn’t-provide-fault-tolerance-compared-to-Hive"><a href="#Impala-doesn’t-provide-fault-tolerance-compared-to-Hive" class="headerlink" title="Impala doesn’t provide fault-tolerance compared to Hive"></a>Impala doesn’t provide fault-tolerance compared to Hive</h2><p>so if there is a problem during your query then it’s gone. </p>
<blockquote>
<p>Definitely for ETL type of jobs where failure of one job would be costly I would recommend Hive, but Impala can be awesome for small ad-hoc queries, for example for data scientists or business analysts who just want to take a look and analyze some data without building robust jobs. Also from my personal experience, Impala is still not very mature, and I’ve seen some crashes sometimes when the amount of data is larger than available memory.</p>
</blockquote>
<p>对于ETL类型的工作，如果一个工作的失败代价很高，我会推荐Hive，但是Impala对于小的特别查询来说可能是很棒的，例如对于那些只想查看和分析一些数据而不想构建健壮工作的数据科学家或业务分析师来说。从我个人的经验来看，Impala还不太成熟，有时当数据量超过可用内存时，我会看到一些崩溃。</p>
<blockquote>
<p>This means if your join, sort, or group by didn’t fit in memory, Impala would just kill the query. No warning. Just dead. Hive would never do that because it’s underlying processing architecture has no problem doing that.</p>
</blockquote>
<p>这就意味着，内存不能承载join sort或group运算，Impala会无告警的立即kill掉查询，直接失败。而hive离线处理架构可以轻松处理，不会死掉</p>
<h2 id="MPP"><a href="#MPP" class="headerlink" title="MPP"></a>MPP</h2><blockquote>
<p>Impala uses MPP(massively parallel processing) unlike Hive which uses MapReduce under the hood, which involves some initial overheads (as Charles sir has specified). Massively parallel processing is a type of computing that uses many separate CPUs running in parallel to execute a single program where each CPU has it’s own dedicated memory. The very fact that Impala, being MPP based, doesn’t involve the overheads of a MapReduce jobs viz. job setup and creation, slot assignment, split creation, map generation etc., makes it blazingly fast.</p>
</blockquote>
<p>Impala提供了更快的响应，因为它使用了MPP(大规模并行处理)，而Hive在底层使用了MapReduce，这涉及到一些初始开销(正如Charles sir所指定的)。大规模并行处理是一种计算类型，它使用许多单独的并行运行的CPU来执行单个程序，其中每个CPU都有自己的专用内存。Impala是基于MPP的，它不涉及MapReduce作业的开销，即作业设置和创建、插槽分配、分割创建、地图生成等，这使得它的运行速度非常快。</p>
<blockquote>
<p>But that doesn’t mean that Impala is the solution to all your problems. Being highly memory intensive (MPP), it is not a good fit for tasks that require heavy data operations like joins etc., as you just can’t fit everything into the memory. This is where Hive is a better fit.</p>
</blockquote>
<p>MPP 作为高度内存密集型的运算，因为无法将所有的数据放入内存，并不适合需要大数据量的操作(如join)；反而Hive更适合</p>
<p>实时的对部分数据即时查询适合Impala，对大数据的批处理请求，适合Hive</p>
<h2 id="Impala-not-always-faster-than-hive"><a href="#Impala-not-always-faster-than-hive" class="headerlink" title="Impala not always faster than hive"></a>Impala not always faster than hive</h2><blockquote>
<p>In my current job we used to make all the querys with Impala, the biggest query (like 800 million rows after 8 joins) was taking from 2 to 20 mins (depending if the tables where already on memory or not) I migrate that Query to Hive, partitioned the tables and create buckets on them, now it takes 3–4 mins, It may be a few more seconds than the best 2 mins with Impala but it’s much more fast if we consider that most of the time Impala takes 12–18 mins.</p>
</blockquote>
<p>在我目前的工作中，使用Impala进行所有的查询，最大的查询(比如8个连接后的8亿行)需要2到20分钟(取决于表是否已经在内存中);我将该查询迁移到Hive，对表进行分区并在其上创建桶，现在需要3到4分钟，这可能比Impala最好的2分钟多几秒钟，但如果我们考虑Impala大部分时间需要12到18分钟，速度会快得多。 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/bigdata/clickhouse/ClickHouse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/bigdata/clickhouse/ClickHouse/" class="post-title-link" itemprop="url">ClickHouse： one of the fastest olap engine</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-10 14:58:00" itemprop="dateCreated datePublished" datetime="2016-08-10T14:58:00+08:00">2016-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:28" itemprop="dateModified" datetime="2021-04-04T09:10:28+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index"><span itemprop="name">bigdata</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ClickHouse"><a href="#ClickHouse" class="headerlink" title="ClickHouse"></a>ClickHouse</h1><p><a target="_blank" rel="noopener" href="https://clickhouse.yandex/docs/zh/">官方文档</a></p>
<h1 id="Clickhouse"><a href="#Clickhouse" class="headerlink" title="Clickhouse"></a>Clickhouse</h1><p><a target="_blank" rel="noopener" href="https://clickhouse.yandex/">offical website</a> <a target="_blank" rel="noopener" href="https://github.com/ClickHouse/ClickHouse/">github</a><br><a target="_blank" rel="noopener" href="https://github.com/ClickHouse-China/ClickhouseMeetup">meetup backup</a></p>
<h2 id="why-do-we-need-ClickHouse"><a href="#why-do-we-need-ClickHouse" class="headerlink" title="why do we need ClickHouse"></a>why do we need ClickHouse</h2><ul>
<li>交互式查询</li>
<li>持续追加数据</li>
</ul>
<blockquote>
<p>Hypothesis<br>If we have good enough column-oriented DBMS,<br>we could store all our data in non-aggregated form<br>(raw pageviews and sessions) and generate all the reports on the fly,<br>to allow infinite customization.</p>
</blockquote>
<p>愿景：<br>足够好的列式DBMS，可以存储所有非聚合数据(原始的浏览数据和会话)，可以在线生成所有的报告，拥有足够的个性化</p>
<h3 id="yandex数据量"><a href="#yandex数据量" class="headerlink" title="yandex数据量"></a>yandex数据量</h3><ul>
<li><blockquote>
<p>30 trillions of rows (as of 2019)</p>
</blockquote>
</li>
<li><blockquote>
<p>600 servers</p>
</blockquote>
</li>
<li>  total throughput of query processing is up to two terabytes per second</li>
</ul>
<h2 id="feature"><a href="#feature" class="headerlink" title="feature"></a>feature</h2><ul>
<li>  column-oriented 列数存储</li>
<li>  distributed 分布式</li>
<li>  linearly scalable 线性扩展</li>
<li>  fault-tolerant 容错</li>
<li>  data ingestion in realtime 实时数据摄取</li>
<li>  realtime (sub-second) queries 实时亚秒级查询</li>
<li>  support of SQL dialect + extensions 支持SQL方言和扩展</li>
</ul>
<h2 id="why-fast"><a href="#why-fast" class="headerlink" title="why fast"></a>why fast</h2><h3 id="High-level-architecture-架构"><a href="#High-level-architecture-架构" class="headerlink" title="High level architecture 架构"></a>High level architecture 架构</h3><p>— Scale-out shared nothing; 横向伸缩无共享</p>
<p>— Massive Parallel Processing; MPP</p>
<h3 id="Data-storage-optimizations-存储优化"><a href="#Data-storage-optimizations-存储优化" class="headerlink" title="Data storage optimizations 存储优化"></a>Data storage optimizations 存储优化</h3><p>— Column-oriented storage; 列式存储</p>
<p>— Merge Tree;</p>
<p>— Sparse index; 稀疏index</p>
<p>— Data compression; 数据压缩</p>
<h3 id="Algorithmic-optimizations-算法优化"><a href="#Algorithmic-optimizations-算法优化" class="headerlink" title="Algorithmic optimizations 算法优化"></a>Algorithmic optimizations 算法优化</h3><p>Best algorithms in the world…<br>… are happy to be used in ClickHouse.</p>
<p>— Volnitsky substring search</p>
<p>— Hyperscan and RE2</p>
<p>— SIMD JSON</p>
<p>— HDR Histograms</p>
<p>— Roaring Bitmaps</p>
<p>…</p>
<h3 id="Low-level-optimizations-底层优化"><a href="#Low-level-optimizations-底层优化" class="headerlink" title="Low-level optimizations 底层优化"></a>Low-level optimizations 底层优化</h3><p>Optimizations for CPU instruction sets<br>using SIMD processing. 使用SIMD优化CPU指令集</p>
<p>— SIMD text parsing</p>
<p>— SIMD data filtering</p>
<p>— SIMD decompression</p>
<p>— SIMD string operations</p>
<p>…</p>
<h3 id="Specializations-of-algorithms…"><a href="#Specializations-of-algorithms…" class="headerlink" title="Specializations of algorithms…"></a>Specializations of algorithms…</h3><p>… and attention to detail:</p>
<p>— uniq, uniqExact, uniqCombined, uniqUpTo;</p>
<p>— quantile, quantileTiming, quantileExact, quantileTDigest, quantileWeighted;</p>
<p>— 40+ specializations of GROUP BY;</p>
<p>— algorithms optimize itself for data distribution:<br>LZ4 decompression with Bayesian Bandits.</p>
<h3 id="Interfaces"><a href="#Interfaces" class="headerlink" title="Interfaces"></a>Interfaces</h3><p>HTTP REST</p>
<p>clickhouse-client</p>
<p>JDBC, ODBC</p>
<p>(new) MySQL protocol compatibility</p>
<p>Python, PHP, Perl, Go,<br>Node.js, Ruby, C++, .NET, Scala, R, Julia, Rust</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/database/MySQL/syntax_5_sample/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aaronzhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Guadazi">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/database/MySQL/syntax_5_sample/" class="post-title-link" itemprop="url">MySQL SQL语法样例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-07-29 00:00:00" itemprop="dateCreated datePublished" datetime="2016-07-29T00:00:00+08:00">2016-07-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-04 09:10:28" itemprop="dateModified" datetime="2021-04-04T09:10:28+08:00">2021-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DataBase/" itemprop="url" rel="index"><span itemprop="name">DataBase</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>建立如下的表格:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tdb_goods;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------------------------------+---------------+------------+-------------+---------+------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                                                             <span class="operator">|</span> goods_cate    <span class="operator">|</span> brand_name <span class="operator">|</span> goods_price <span class="operator">|</span> is_show <span class="operator">|</span> is_saleoff <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------------------------------------------------------+---------------+------------+-------------+---------+------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> R510VC <span class="number">15.6</span>英寸笔记本                                                  <span class="operator">|</span> 笔记本        <span class="operator">|</span> 华硕       <span class="operator">|</span>    <span class="number">3399.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> Y400N <span class="number">14.0</span>英寸笔记本电脑                                               <span class="operator">|</span> 笔记本        <span class="operator">|</span> 联想       <span class="operator">|</span>    <span class="number">4899.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本                                                  <span class="operator">|</span> 游戏本        <span class="operator">|</span> 雷神       <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">4</span> <span class="operator">|</span> X550CC <span class="number">15.6</span>英寸笔记本                                                  <span class="operator">|</span> 笔记本        <span class="operator">|</span> 华硕       <span class="operator">|</span>    <span class="number">2799.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> X240(<span class="number">20</span>ALA0EYCD) <span class="number">12.5</span>英寸超极本                                        <span class="operator">|</span> 超级本        <span class="operator">|</span> 联想       <span class="operator">|</span>    <span class="number">4999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">6</span> <span class="operator">|</span> U330P <span class="number">13.3</span>英寸超极本                                                   <span class="operator">|</span> 超级本        <span class="operator">|</span> 联想       <span class="operator">|</span>    <span class="number">4299.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> SVP13226SCB <span class="number">13.3</span>英寸触控超极本                                         <span class="operator">|</span> 超级本        <span class="operator">|</span> 索尼       <span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">8</span> <span class="operator">|</span> iPad mini MD531CH<span class="operator">/</span>A <span class="number">7.9</span>英寸平板电脑                                    <span class="operator">|</span> 平板电脑      <span class="operator">|</span> 苹果       <span class="operator">|</span>    <span class="number">1998.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">9</span> <span class="operator">|</span> iPad Air MD788CH<span class="operator">/</span>A <span class="number">9.7</span>英寸平板电脑 （<span class="number">16</span>G WiFi版）                      <span class="operator">|</span> 平板电脑      <span class="operator">|</span> 苹果       <span class="operator">|</span>    <span class="number">3388.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">10</span> <span class="operator">|</span>  iPad mini ME279CH<span class="operator">/</span>A 配备 Retina 显示屏 <span class="number">7.9</span>英寸平板电脑 （<span class="number">16</span>G WiFi版） <span class="operator">|</span> 平板电脑      <span class="operator">|</span> 苹果       <span class="operator">|</span>    <span class="number">2788.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">11</span> <span class="operator">|</span> IdeaCentre C340 <span class="number">20</span>英寸一体电脑                                         <span class="operator">|</span> 台式机        <span class="operator">|</span> 联想       <span class="operator">|</span>    <span class="number">3499.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">12</span> <span class="operator">|</span> Vostro <span class="number">3800</span><span class="operator">-</span>R1206 台式电脑                                             <span class="operator">|</span> 台式机        <span class="operator">|</span> 戴尔       <span class="operator">|</span>    <span class="number">2899.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">13</span> <span class="operator">|</span> iMac ME086CH<span class="operator">/</span>A <span class="number">21.5</span>英寸一体电脑                                        <span class="operator">|</span> 台式机        <span class="operator">|</span> 苹果       <span class="operator">|</span>    <span class="number">9188.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">14</span> <span class="operator">|</span> AT7<span class="number">-7414</span>LP 台式电脑 （i5<span class="number">-3450</span>四核 <span class="number">4</span>G <span class="number">500</span>G <span class="number">2</span>G独显 DVD 键鼠 Linux ）     <span class="operator">|</span> 台式机        <span class="operator">|</span> 宏碁       <span class="operator">|</span>    <span class="number">3699.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">15</span> <span class="operator">|</span> Z220SFF F4F06PA工作站                                                  <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span> 惠普       <span class="operator">|</span>    <span class="number">4288.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">16</span> <span class="operator">|</span> PowerEdge T110 II服务器                                                <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span> 戴尔       <span class="operator">|</span>    <span class="number">5388.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">17</span> <span class="operator">|</span> Mac Pro MD878CH<span class="operator">/</span>A 专业级台式电脑                                       <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span> 苹果       <span class="operator">|</span>   <span class="number">28888.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">18</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备                                                  <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 索尼       <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">19</span> <span class="operator">|</span> 商务双肩背包                                                           <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 索尼       <span class="operator">|</span>      <span class="number">99.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">20</span> <span class="operator">|</span> X3250 M4机架式服务器 <span class="number">2583</span>i14                                           <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span> IBM        <span class="operator">|</span>    <span class="number">6888.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">21</span> <span class="operator">|</span> 玄龙精英版 笔记本散热器                                                <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 九州风神   <span class="operator">|</span>       <span class="number">0.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">22</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备                                                  <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 索尼       <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">23</span> <span class="operator">|</span> 商务双肩背包                                                           <span class="operator">|</span> 笔记本配件    <span class="operator">|</span> 索尼       <span class="operator">|</span>      <span class="number">99.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------+---------------+------------+-------------+---------+------------+</span></span><br></pre></td></tr></table></figure>
<p>计算所有商品的平均价格</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">AS</span> &quot;average price&quot; <span class="keyword">FROM</span> tdb_goods;</span><br></pre></td></tr></table></figure>
<p>评价价格保留两位小数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ROUND(<span class="built_in">AVG</span>(goods_price),<span class="number">2</span>) <span class="keyword">AS</span> &quot;average price&quot; <span class="keyword">FROM</span> tdb_goods;</span><br></pre></td></tr></table></figure>
<p>计算高于平均价格的商品</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price<span class="operator">&gt;=</span><span class="number">5635.36</span>;</span><br></pre></td></tr></table></figure>
<p>使用子查询查询价格高于平均价格的商品信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price<span class="operator">&gt;=</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods</span><br><span class="line">    );</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                       <span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本            <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> SVP13226SCB <span class="number">13.3</span>英寸触控超极本   <span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">13</span> <span class="operator">|</span> iMac ME086CH<span class="operator">/</span>A <span class="number">21.5</span>英寸一体电脑  <span class="operator">|</span>    <span class="number">9188.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">17</span> <span class="operator">|</span> Mac Pro MD878CH<span class="operator">/</span>A 专业级台式电脑 <span class="operator">|</span>   <span class="number">28888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">18</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备            <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">20</span> <span class="operator">|</span> X3250 M4机架式服务器 <span class="number">2583</span>i14     <span class="operator">|</span>    <span class="number">6888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">22</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备            <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>使用子查询 计算高于平均价格的所有商品的评价价格</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price<span class="operator">&gt;=</span>(<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods);</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">AVG</span>(goods_price) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">10780.0000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"></span><br><span class="line">使用avg函数时, 只有一条记录, 其他字段的信息只显示第一条.</span><br><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price,<span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price<span class="operator">&gt;=</span>(<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(goods_price) <span class="keyword">FROM</span> tdb_goods);</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+-------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name            <span class="operator">|</span> goods_price <span class="operator">|</span> <span class="built_in">AVG</span>(goods_price) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+-------------+------------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本 <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span>    <span class="number">10780.0000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+-------------+------------------+</span></span><br></pre></td></tr></table></figure>
<p>利用子查询查询比”超极本”贵的商品信息(这里的”贵”就体现于多条记录比较时的处理)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> goods_price <span class="keyword">from</span> tdb_goods <span class="keyword">where</span> goods_cate<span class="operator">=</span><span class="string">&#x27;超级本&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4299.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods </span><br><span class="line"><span class="keyword">WHERE</span> goods_price <span class="operator">&gt;</span><span class="keyword">ANY</span> (</span><br><span class="line">    <span class="keyword">select</span> goods_price <span class="keyword">from</span> tdb_goods <span class="keyword">where</span> goods_cate<span class="operator">=</span><span class="string">&#x27;超级本&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                       <span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> Y400N <span class="number">14.0</span>英寸笔记本电脑         <span class="operator">|</span>    <span class="number">4899.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本            <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> X240(<span class="number">20</span>ALA0EYCD) <span class="number">12.5</span>英寸超极本  <span class="operator">|</span>    <span class="number">4999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> SVP13226SCB <span class="number">13.3</span>英寸触控超极本   <span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">13</span> <span class="operator">|</span> iMac ME086CH<span class="operator">/</span>A <span class="number">21.5</span>英寸一体电脑  <span class="operator">|</span>    <span class="number">9188.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">16</span> <span class="operator">|</span> PowerEdge T110 II服务器          <span class="operator">|</span>    <span class="number">5388.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">17</span> <span class="operator">|</span> Mac Pro MD878CH<span class="operator">/</span>A 专业级台式电脑 <span class="operator">|</span>   <span class="number">28888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">18</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备            <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">20</span> <span class="operator">|</span> X3250 M4机架式服务器 <span class="number">2583</span>i14     <span class="operator">|</span>    <span class="number">6888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">22</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备            <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price <span class="operator">&gt;</span> <span class="keyword">ALL</span> (</span><br><span class="line">    <span class="keyword">select</span> goods_price <span class="keyword">from</span> tdb_goods <span class="keyword">where</span> goods_cate<span class="operator">=</span><span class="string">&#x27;超级本&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                       <span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> G150TH <span class="number">15.6</span>英寸游戏本            <span class="operator">|</span>    <span class="number">8499.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">13</span> <span class="operator">|</span> iMac ME086CH<span class="operator">/</span>A <span class="number">21.5</span>英寸一体电脑  <span class="operator">|</span>    <span class="number">9188.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">17</span> <span class="operator">|</span> Mac Pro MD878CH<span class="operator">/</span>A 专业级台式电脑 <span class="operator">|</span>   <span class="number">28888.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------------------------------+-------------+</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">SELECT</span> goods_id,goods_name,goods_price <span class="keyword">FROM</span> tdb_goods <span class="keyword">WHERE</span> goods_price <span class="operator">=</span> <span class="keyword">ANY</span> (</span><br><span class="line">    <span class="keyword">select</span> goods_price <span class="keyword">from</span> tdb_goods <span class="keyword">where</span> goods_cate<span class="operator">=</span><span class="string">&#x27;超级本&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+---------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name                      <span class="operator">|</span> goods_price <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+---------------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> X240(<span class="number">20</span>ALA0EYCD) <span class="number">12.5</span>英寸超极本 <span class="operator">|</span>    <span class="number">4999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">6</span> <span class="operator">|</span> U330P <span class="number">13.3</span>英寸超极本            <span class="operator">|</span>    <span class="number">4299.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> SVP13226SCB <span class="number">13.3</span>英寸触控超极本  <span class="operator">|</span>    <span class="number">7999.000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+---------------------------------+-------------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>多表更新:<br>参照分类表更新商品表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> tdb_goods_cates(</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> cate_id <span class="type">SMALLINT</span> UNSIGNED <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> cate_name <span class="type">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> COLUMNS <span class="keyword">FROM</span> tdb_goods_cates;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field     <span class="operator">|</span> Type                 <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> cate_id   <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cate_name <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">40</span>)          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tdb_goods_cates(cate_name)  <span class="keyword">select</span> goods_cate <span class="keyword">from</span> tdb_goods </span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> goods_cate;</span><br><span class="line">Query OK, <span class="number">7</span> <span class="keyword">rows</span> affected (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tdb_goods_cates;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------------+</span></span><br><span class="line"><span class="operator">|</span> cate_id <span class="operator">|</span> cate_name     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------------+</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span> 台式机        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span> 游戏本        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span> 平板电脑      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">4</span> <span class="operator">|</span> 笔记本        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">5</span> <span class="operator">|</span> 笔记本配件    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">6</span> <span class="operator">|</span> 超级本        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">7</span> <span class="operator">|</span> 服务器<span class="operator">/</span>工作站 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> tdb_goods</span><br><span class="line">  <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tdb_goods_cates</span><br><span class="line">    <span class="keyword">ON</span> goods_cate <span class="operator">=</span> cate_name</span><br><span class="line">    <span class="keyword">SET</span> goods_cate<span class="operator">=</span>cate_id;</span><br><span class="line">Query OK, <span class="number">23</span> <span class="keyword">rows</span> affected (<span class="number">0.08</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tdb_goods\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">1</span></span><br><span class="line"> goods_name: R510VC <span class="number">15.6</span>英寸笔记本</span><br><span class="line"> goods_cate: <span class="number">4</span></span><br><span class="line"> brand_name: 华硕</span><br><span class="line">goods_price: <span class="number">3399.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">2</span></span><br><span class="line"> goods_name: Y400N <span class="number">14.0</span>英寸笔记本电脑</span><br><span class="line"> goods_cate: <span class="number">4</span></span><br><span class="line"> brand_name: 联想</span><br><span class="line">goods_price: <span class="number">4899.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">3</span></span><br><span class="line"> goods_name: G150TH <span class="number">15.6</span>英寸游戏本</span><br><span class="line"> goods_cate: <span class="number">2</span></span><br><span class="line"> brand_name: 雷神</span><br><span class="line">goods_price: <span class="number">8499.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> goods_brands(</span><br><span class="line">    id TINYINT AUTO_INCREMENT <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">    brand_name <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">SELECT</span> brand_name <span class="keyword">FROM</span> tdb_goods <span class="keyword">GROUP</span> <span class="keyword">BY</span> brand_name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> goods_brands;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> brand_name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 联想       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 雷神       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 索尼       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> IBM        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> 苹果       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">6</span> <span class="operator">|</span> 戴尔       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">7</span> <span class="operator">|</span> 宏碁       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8</span> <span class="operator">|</span> 惠普       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9</span> <span class="operator">|</span> 华硕       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span> 九州风神   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> tdb_goods <span class="keyword">INNER</span> <span class="keyword">JOIN</span> goods_brands</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">on</span> tdb_goods.brand_name<span class="operator">=</span>goods_brands.brand_name</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">set</span> tdb_goods.brand_name<span class="operator">=</span>goods_brands.id;</span><br><span class="line">Query OK, <span class="number">23</span> <span class="keyword">rows</span> affected (<span class="number">0.09</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tdb_goods\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">1</span></span><br><span class="line"> goods_name: R510VC <span class="number">15.6</span>英寸笔记本</span><br><span class="line"> goods_cate: <span class="number">4</span></span><br><span class="line"> brand_name: <span class="number">9</span></span><br><span class="line">goods_price: <span class="number">3399.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   goods_id: <span class="number">2</span></span><br><span class="line"> goods_name: Y400N <span class="number">14.0</span>英寸笔记本电脑</span><br><span class="line"> goods_cate: <span class="number">4</span></span><br><span class="line"> brand_name: <span class="number">1</span></span><br><span class="line">goods_price: <span class="number">4899.000</span></span><br><span class="line">    is_show: <span class="number">1</span></span><br><span class="line"> is_saleoff: <span class="number">0</span></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DESC</span> tdb_goods;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type                   <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id    <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">150</span>)           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_cate  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">40</span>)            <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> brand_name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">40</span>)            <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_price <span class="operator">|</span> <span class="type">decimal</span>(<span class="number">15</span>,<span class="number">3</span>) unsigned <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0.000</span>   <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> is_show     <span class="operator">|</span> tinyint(<span class="number">1</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> is_saleoff  <span class="operator">|</span> tinyint(<span class="number">1</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tdb_goods</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> CHANGE goods_cate cate_id <span class="type">SMALLINT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> CHANGE brand_name brand_id <span class="type">SMALLINT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line">Query OK, <span class="number">23</span> <span class="keyword">rows</span> affected (<span class="number">0.17</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DESC</span> tdb_goods;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type                   <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id    <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">150</span>)           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cate_id     <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> brand_id    <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> goods_price <span class="operator">|</span> <span class="type">decimal</span>(<span class="number">15</span>,<span class="number">3</span>) unsigned <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0.000</span>   <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> is_show     <span class="operator">|</span> tinyint(<span class="number">1</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> is_saleoff  <span class="operator">|</span> tinyint(<span class="number">1</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+------------------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改类名</span><br><span class="line"><span class="keyword">desc</span> tdb_goods_brands;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field      <span class="operator">|</span> Type        <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> id         <span class="operator">|</span> tinyint(<span class="number">4</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> brand_name <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">20</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tdb_goods_brands change id brand_id tinyint(<span class="number">4</span>) <span class="keyword">not</span> <span class="keyword">null</span> ;</span><br><span class="line">Query OK, <span class="number">13</span> <span class="keyword">rows</span> affected (<span class="number">0.20</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">desc</span> tdb_goods_brands;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field      <span class="operator">|</span> Type        <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> brand_id   <span class="operator">|</span> tinyint(<span class="number">4</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> brand_name <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">20</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br></pre></td></tr></table></figure>
<p>删除商品名称重复记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">查找名称相同的记录</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> t1.goods_name <span class="keyword">having</span> <span class="built_in">count</span>(t1.goods_name)<span class="operator">&gt;=</span><span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+---------+----------+-------------+---------+------------+</span></span><br><span class="line"><span class="operator">|</span> goods_id <span class="operator">|</span> goods_name            <span class="operator">|</span> cate_id <span class="operator">|</span> brand_id <span class="operator">|</span> goods_price <span class="operator">|</span> is_show <span class="operator">|</span> is_saleoff <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+---------+----------+-------------+---------+------------+</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">18</span> <span class="operator">|</span>  HMZ<span class="operator">-</span>T3W 头戴显示设备 <span class="operator">|</span>       <span class="number">5</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>    <span class="number">6999.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">19</span> <span class="operator">|</span> 商务双肩背包          <span class="operator">|</span>       <span class="number">5</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>      <span class="number">99.000</span> <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------+---------+----------+-------------+---------+------------+</span></span><br><span class="line"></span><br><span class="line">错误的写法:</span><br><span class="line"><span class="keyword">delete</span> tt1 <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> tt1 <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line"> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> t1.goods_name <span class="keyword">having</span> <span class="built_in">count</span>(t1.goods_name)<span class="operator">&gt;=</span><span class="number">2</span>) <span class="keyword">as</span> tt2</span><br><span class="line"> <span class="keyword">on</span> tt1.goods_name<span class="operator">=</span>tt2.goods_name <span class="keyword">and</span> tt1.goods_id<span class="operator">&gt;</span>tt2.goods_id;</span><br><span class="line">Query OK, <span class="number">24</span> <span class="keyword">rows</span> affected (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line">正确的写法:</span><br><span class="line"><span class="keyword">delete</span> tt1 <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> tt1 <span class="keyword">left</span> <span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tdb_goods <span class="keyword">as</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> t1.goods_name </span><br><span class="line">    <span class="keyword">having</span> <span class="built_in">count</span>(t1.goods_name)<span class="operator">&gt;=</span><span class="number">2</span>) <span class="keyword">as</span> tt2 </span><br><span class="line">    <span class="keyword">on</span> tt1.goods_name<span class="operator">=</span>tt2.goods_name </span><br><span class="line">    <span class="keyword">where</span> tt1.goods_id<span class="operator">&gt;</span>tt2.goods_id;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="Delete中包含left-join"><a href="#Delete中包含left-join" class="headerlink" title="Delete中包含left join"></a>Delete中包含left join</h2><ol>
<li>左侧的表是待删除的表</li>
<li>不能关联成功的要过滤掉</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tbl_pps_nc_group_member</span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> #fromUserId#</span><br><span class="line"><span class="keyword">and</span> group_id <span class="keyword">in</span> (<span class="keyword">SELECT</span> group_id <span class="keyword">FROM</span> tbl_pps_nc_group <span class="keyword">where</span> user_id <span class="operator">=</span> #myUserId# );</span><br></pre></td></tr></table></figure>
<p>与</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_pps_nc_group_member nm</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tbl_pps_nc_group ng <span class="keyword">ON</span> nm.user_id <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">AND</span> nm.group_id<span class="operator">=</span>ng.group_id <span class="keyword">AND</span> ng.user_id <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> ng.group_id <span class="keyword">is</span> <span class="keyword">NOT</span> <span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<h1 id="在好友关系中获取对方的信息"><a href="#在好友关系中获取对方的信息" class="headerlink" title="在好友关系中获取对方的信息"></a>在好友关系中获取对方的信息</h1><p>对于好友关系来说，是彼此的关系，可以不分先后，如果要区分邀请和被邀请，就必须考虑。<br>假设存在两个表格:<br>第一个表格是用户信息表<code>t_user_info</code>，用于记录用户的信息。<br>第二个表格是好友关系表<code>t_friend</code>, 用于记录用户的好友关系。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_user_info (</span><br><span class="line">	user_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> auto_increment,</span><br><span class="line">	`name` <span class="type">VARCHAR</span>(<span class="number">10</span>),</span><br><span class="line">	phone <span class="type">VARCHAR</span>(<span class="number">11</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_friend (</span><br><span class="line">	 friend_ref_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> auto_increment,</span><br><span class="line"> 	 from_user_id <span class="type">int</span>,</span><br><span class="line">     to_user_id <span class="type">int</span>,</span><br><span class="line">	 `status` TINYINT(<span class="number">1</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>如果要获取对方的信息，邀请者获取得到的是被邀请者的信息，而被邀请者获取得到的是邀请者的信息。<br>状态值<code>status</code>代表 0：待验证，1：已添加，2：已拒绝，4：待对方验证，5: 对方已添加，6：对方已拒绝</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	u.`name` <span class="keyword">AS</span> userName,</span><br><span class="line">	u.phone <span class="keyword">AS</span> userPhone,</span><br><span class="line">	u.user_id <span class="keyword">AS</span> userId,</span><br><span class="line">	<span class="keyword">CASE</span> <span class="keyword">WHEN</span> f.from_user_id <span class="operator">=</span> <span class="string">&#x27;1018&#x27;</span> <span class="keyword">THEN</span> 	f.`status` <span class="operator">+</span> <span class="number">4</span> <span class="keyword">ELSE</span> f.`status` <span class="keyword">END</span> <span class="keyword">AS</span> `status`</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	t_friend f</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t_user_info u </span><br><span class="line">	<span class="keyword">ON</span> (u.user_id <span class="operator">=</span> f.from_user_id 	<span class="keyword">AND</span> f.to_user_id <span class="operator">=</span> <span class="string">&#x27;1018&#x27;</span> )</span><br><span class="line">		<span class="keyword">OR</span> (u.user_id <span class="operator">=</span> f.to_user_id <span class="keyword">AND</span> f.from_user_id <span class="operator">=</span> <span class="string">&#x27;1018&#x27;</span> )</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	u.user_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>
<p><strong>[总结]</strong></p>
<ol>
<li><code>left join</code>中的<code>on</code>语句, 是在被关联表满足<code>on</code>条件才会关联，否则显示为<code>null</code>, 因此通过判断右侧是否为空，可以判断是否满足条件</li>
<li>关联条件是另一个技巧, 取对方的<code>id</code>条件</li>
</ol>
<h1 id="Explain解析查询"><a href="#Explain解析查询" class="headerlink" title="Explain解析查询"></a>Explain解析查询</h1><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/zhuxineli/article/details/14455029">MYSQL explain详解</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/18/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/20/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">aaronzhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">240</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aaronzhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
